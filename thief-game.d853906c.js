function e(e){return e&&e.__esModule?e.default:e}var t,o,r,a,n,s,i,l,f,u,c,d,p,h,m,x,g,y,v,M,T,S,_,w,b,I,A,C,P,k,L,R=globalThis,D={},W={},G=R.parcelRequire550f;null==G&&((G=function(e){if(e in D)return D[e].exports;if(e in W){var t=W[e];delete W[e];var o={id:e,exports:{}};return D[e]=o,t.call(o.exports,o,o.exports),o.exports}var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(e,t){W[e]=t},R.parcelRequire550f=G);var V=G.register;V("cmoHh",function(e,t){!function(e,t,o){function r(e){var t,o=this,r=(t=0xefc8249d,function(e){e=String(e);for(var o=0;o<e.length;o++){var r=.02519603282416938*(t+=e.charCodeAt(o));t=r>>>0,r-=t,r*=t,t=r>>>0,r-=t,t+=0x100000000*r}return(t>>>0)*23283064365386963e-26});o.next=function(){var e=2091639*o.s0+23283064365386963e-26*o.c;return o.s0=o.s1,o.s1=o.s2,o.s2=e-(o.c=0|e)},o.c=1,o.s0=r(" "),o.s1=r(" "),o.s2=r(" "),o.s0-=r(e),o.s0<0&&(o.s0+=1),o.s1-=r(e),o.s1<0&&(o.s1+=1),o.s2-=r(e),o.s2<0&&(o.s2+=1)}function a(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function n(e,t){var o=new r(e),n=t&&t.state,s=o.next;return s.int32=function(){return 0x100000000*o.next()|0},s.double=function(){return s()+(2097152*s()|0)*11102230246251565e-32},s.quick=s,n&&("object"==typeof n&&a(n,o),s.state=function(){return a(o,{})}),s}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.alea=n}(0,e,"function"==typeof define&&define)}),V("euRi5",function(e,t){!function(e,t,o){function r(e){var t=this,o="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:o+=e;for(var r=0;r<o.length+64;r++)t.x^=o.charCodeAt(r),t.next()}function a(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function n(e,t){var o=new r(e),n=t&&t.state,s=function(){return(o.next()>>>0)/0x100000000};return s.double=function(){do var e=o.next()>>>11,t=(o.next()>>>0)/0x100000000,r=(e+t)/2097152;while(0===r)return r},s.int32=o.next,s.quick=s,n&&("object"==typeof n&&a(n,o),s.state=function(){return a(o,{})}),s}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.xor128=n}(0,e,"function"==typeof define&&define)}),V("hDsEw",function(e,t){!function(e,t,o){function r(e){var t=this,o="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^(e^e<<1))|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:o+=e;for(var r=0;r<o.length+64;r++)t.x^=o.charCodeAt(r),r==o.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function a(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function n(e,t){var o=new r(e),n=t&&t.state,s=function(){return(o.next()>>>0)/0x100000000};return s.double=function(){do var e=o.next()>>>11,t=(o.next()>>>0)/0x100000000,r=(e+t)/2097152;while(0===r)return r},s.int32=o.next,s.quick=s,n&&("object"==typeof n&&a(n,o),s.state=function(){return a(o,{})}),s}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.xorwow=n}(0,e,"function"==typeof define&&define)}),V("3J2Zm",function(e,t){!function(e,t,o){function r(e){var t=this;t.next=function(){var e,o,r=t.x,a=t.i;return e=r[a],e^=e>>>7,o=e^e<<24^((e=r[a+1&7])^e>>>10)^((e=r[a+3&7])^e>>>3)^((e=r[a+4&7])^e<<7),e=r[a+7&7],e^=e<<13,o^=e^e<<9,r[a]=o,t.i=a+1&7,o};var o,r=e,a=[];if(r===(0|r))a[0]=r;else for(o=0,r=""+r;o<r.length;++o)a[7&o]=a[7&o]<<15^r.charCodeAt(o)+a[o+1&7]<<13;for(;a.length<8;)a.push(0);for(o=0;o<8&&0===a[o];++o);for(8==o?a[7]=-1:a[o],t.x=a,t.i=0,o=256;o>0;--o)t.next()}function a(e,t){return t.x=e.x.slice(),t.i=e.i,t}function n(e,t){null==e&&(e=+new Date);var o=new r(e),n=t&&t.state,s=function(){return(o.next()>>>0)/0x100000000};return s.double=function(){do var e=o.next()>>>11,t=(o.next()>>>0)/0x100000000,r=(e+t)/2097152;while(0===r)return r},s.int32=o.next,s.quick=s,n&&(n.x&&a(n,o),s.state=function(){return a(o,{})}),s}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.xorshift7=n}(0,e,"function"==typeof define&&define)}),V("6Px8M",function(e,t){!function(e,t,o){function r(e){var t=this;t.next=function(){var e,o,r=t.w,a=t.X,n=t.i;return t.w=r=r+0x61c88647|0,o=a[n+34&127],e=a[n=n+1&127],o^=o<<13,e^=e<<17,o^=o>>>15,e^=e>>>12,o=a[n]=o^e,t.i=n,o+(r^r>>>16)|0},!function(e,t){var o,r,a,n,s,i=[],l=128;for(t===(0|t)?(r=t,t=null):(t+="\0",r=0,l=Math.max(l,t.length)),a=0,n=-32;n<l;++n)t&&(r^=t.charCodeAt((n+32)%t.length)),0===n&&(s=r),r^=r<<10,r^=r>>>15,r^=r<<4,r^=r>>>13,n>=0&&(s=s+0x61c88647|0,a=0==(o=i[127&n]^=r+s)?a+1:0);for(a>=128&&(i[127&(t&&t.length||0)]=-1),a=127,n=512;n>0;--n)r=i[a+34&127],o=i[a=a+1&127],r^=r<<13,o^=o<<17,r^=r>>>15,o^=o>>>12,i[a]=r^o;e.w=s,e.X=i,e.i=a}(t,e)}function a(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function n(e,t){null==e&&(e=+new Date);var o=new r(e),n=t&&t.state,s=function(){return(o.next()>>>0)/0x100000000};return s.double=function(){do var e=o.next()>>>11,t=(o.next()>>>0)/0x100000000,r=(e+t)/2097152;while(0===r)return r},s.int32=o.next,s.quick=s,n&&(n.X&&a(n,o),s.state=function(){return a(o,{})}),s}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.xor4096=n}(0,e,"function"==typeof define&&define)}),V("lDm0S",function(e,t){!function(e,t,o){function r(e){var t=this,o="";t.next=function(){var e=t.b,o=t.c,r=t.d,a=t.a;return e=e<<25^e>>>7^o,o=o-r|0,r=r<<24^r>>>8^a,a=a-e|0,t.b=e=e<<20^e>>>12^o,t.c=o=o-r|0,t.d=r<<16^o>>>16^a,t.a=a-e|0},t.a=0,t.b=0,t.c=-0x61c88647,t.d=0x517cc1b7,e===Math.floor(e)?(t.a=e/0x100000000|0,t.b=0|e):o+=e;for(var r=0;r<o.length+20;r++)t.b^=o.charCodeAt(r),t.next()}function a(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function n(e,t){var o=new r(e),n=t&&t.state,s=function(){return(o.next()>>>0)/0x100000000};return s.double=function(){do var e=o.next()>>>11,t=(o.next()>>>0)/0x100000000,r=(e+t)/2097152;while(0===r)return r},s.int32=o.next,s.quick=s,n&&("object"==typeof n&&a(n,o),s.state=function(){return a(o,{})}),s}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.tychei=n}(0,e,"function"==typeof define&&define)}),V("kjyEk",function(e,t){}),V("bZifA",function(e,t){e.exports=import.meta.resolve("bv6MN")}),V("9qMhI",function(e,t){e.exports=import.meta.resolve("i01ZK")}),V("fYODv",function(e,t){e.exports=import.meta.resolve("kMLeN")}),V("fZvEG",function(e,t){e.exports=import.meta.resolve("7QAkA")}),V("cbMOk",function(e,t){e.exports=import.meta.resolve("extGj")}),V("il31g",function(e,t){e.exports=import.meta.resolve("fmPyc")}),V("86fkK",function(e,t){e.exports=import.meta.resolve("9stv3")}),V("gc0x6",function(e,t){e.exports=import.meta.resolve("iFwHo")}),V("9y2j6",function(e,t){e.exports=import.meta.resolve("cUkcS")}),V("f6SOA",function(e,t){e.exports=import.meta.resolve("3WoZq")}),V("ky2OH",function(e,t){e.exports=import.meta.resolve("4CRTl")}),V("c4aYR",function(e,t){e.exports=import.meta.resolve("byhsW")}),V("i9Hc6",function(e,t){e.exports=import.meta.resolve("9W38z")}),V("4qPCJ",function(e,t){e.exports=import.meta.resolve("57ec6")}),V("cOvAc",function(e,t){e.exports=import.meta.resolve("4Xt2t")}),V("l7VP5",function(e,t){e.exports=import.meta.resolve("7CMGD")}),V("GXUFG",function(e,t){e.exports=import.meta.resolve("5OaqH")}),V("ahYBJ",function(e,t){e.exports=import.meta.resolve("eMbVa")}),V("6gEAv",function(e,t){e.exports=import.meta.resolve("3axOF")}),V("eAM39",function(e,t){e.exports=import.meta.resolve("e7FGC")}),V("79dd6",function(e,t){e.exports=import.meta.resolve("ePtUz")}),V("kFQ7m",function(e,t){e.exports=import.meta.resolve("54JTP")}),V("coJNA",function(e,t){e.exports=import.meta.resolve("f4kGs")}),V("5iPq3",function(e,t){e.exports=import.meta.resolve("gIhaU")}),V("7wbJU",function(e,t){e.exports=import.meta.resolve("lqqo8")}),V("es8xU",function(e,t){e.exports=import.meta.resolve("cLwSE")}),V("1tzXL",function(e,t){e.exports=import.meta.resolve("2KH0C")}),V("3oNvH",function(e,t){e.exports=import.meta.resolve("cpKKf")}),V("6NJnm",function(e,t){e.exports=import.meta.resolve("5MeQP")}),V("913qQ",function(e,t){e.exports=import.meta.resolve("2JDpK")}),V("eR3jk",function(e,t){e.exports=import.meta.resolve("2zYEJ")}),V("kLy4D",function(e,t){e.exports=import.meta.resolve("2t9RE")}),V("fyy7J",function(e,t){e.exports=import.meta.resolve("iY5Cd")}),V("j1itu",function(e,t){e.exports=import.meta.resolve("3aopE")}),V("9EmTp",function(e,t){e.exports=import.meta.resolve("3tTcy")}),V("3IaJ1",function(e,t){e.exports=import.meta.resolve("8L9C2")}),V("cfnuz",function(e,t){e.exports=import.meta.resolve("cGSNL")}),V("5Eei7",function(e,t){e.exports=import.meta.resolve("iv3Fr")}),V("fbQUH",function(e,t){e.exports=import.meta.resolve("iTJrg")}),V("z6FJY",function(e,t){e.exports=import.meta.resolve("6QPv3")}),V("csNnr",function(e,t){e.exports=import.meta.resolve("l0nd4")}),V("lwVjt",function(e,t){e.exports=import.meta.resolve("2n0fD")}),V("aw75f",function(e,t){e.exports=import.meta.resolve("fOp9V")}),V("gJf4b",function(e,t){e.exports=import.meta.resolve("i4uwn")}),V("gWaKj",function(e,t){e.exports=import.meta.resolve("bFVB0")}),V("hnMpe",function(e,t){e.exports=import.meta.resolve("auuxb")}),V("6cGgY",function(e,t){e.exports=import.meta.resolve("ejcPD")}),V("8rnx8",function(e,t){e.exports=import.meta.resolve("dGQlG")}),V("j8GRe",function(e,t){e.exports=import.meta.resolve("c1reW")}),V("lvgrG",function(e,t){e.exports=import.meta.resolve("jbZGh")}),V("kUtJa",function(e,t){e.exports=import.meta.resolve("4p6yy")}),V("alWWz",function(e,t){e.exports=import.meta.resolve("7PaKC")}),V("goBDs",function(e,t){e.exports=import.meta.resolve("1HfrD")}),V("i8Uwd",function(e,t){e.exports=import.meta.resolve("h9RJn")}),V("OUSAv",function(e,t){e.exports=import.meta.resolve("2s5z3")}),V("kzjl8",function(e,t){e.exports=import.meta.resolve("je4sD")}),V("3bVzR",function(e,t){e.exports=import.meta.resolve("91ASO")}),V("ePvn4",function(e,t){e.exports=import.meta.resolve("4LHFu")}),V("dp5QF",function(e,t){e.exports=import.meta.resolve("3FIlr")}),V("evxcG",function(e,t){e.exports=import.meta.resolve("bM3ty")}),V("63vGw",function(e,t){e.exports=import.meta.resolve("fa9Lk")}),V("gE7wT",function(e,t){e.exports=import.meta.resolve("7iXif")}),V("2EAaD",function(e,t){e.exports=import.meta.resolve("iHnDX")}),V("bgV1c",function(e,t){e.exports=import.meta.resolve("b2dYG")}),V("5eFZQ",function(e,t){e.exports=import.meta.resolve("59BJY")}),V("2D0Ne",function(e,t){e.exports=import.meta.resolve("gxLBn")}),V("buzUW",function(e,t){e.exports=import.meta.resolve("5dgAQ")}),V("azFs4",function(e,t){e.exports=import.meta.resolve("3OCXI")}),V("fJQmZ",function(e,t){e.exports=import.meta.resolve("k5TMc")}),V("gLU2l",function(e,t){e.exports=import.meta.resolve("9w33w")}),V("5gFXt",function(e,t){e.exports=import.meta.resolve("4kHlF")}),V("9XfEf",function(e,t){e.exports=import.meta.resolve("UrS1Y")}),V("49Btu",function(e,t){e.exports=import.meta.resolve("9uOV6")}),V("kJjXM",function(e,t){e.exports=import.meta.resolve("6HjCO")}),V("1tYMJ",function(e,t){e.exports=import.meta.resolve("d5XXc")}),V("6TE9j",function(e,t){e.exports=import.meta.resolve("2lEVY")}),V("g38fU",function(e,t){e.exports=import.meta.resolve("la8N0")}),V("3rS96",function(e,t){e.exports=import.meta.resolve("7cL8R")}),V("43O7W",function(e,t){e.exports=import.meta.resolve("2wBmK")}),V("c9jO4",function(e,t){e.exports=import.meta.resolve("jALpK")}),V("5Kerx",function(e,t){e.exports=import.meta.resolve("b9dEt")}),V("iVLRE",function(e,t){e.exports=import.meta.resolve("fFe5r")}),V("emH6d",function(e,t){e.exports=import.meta.resolve("lbRhG")}),V("3qCyM",function(e,t){e.exports=import.meta.resolve("fpGvS")}),V("6vESL",function(e,t){e.exports=import.meta.resolve("1sKsl")}),V("fFW7g",function(e,t){e.exports=import.meta.resolve("gm0uu")}),V("2sujD",function(e,t){e.exports=import.meta.resolve("gYm3j")}),V("feMzH",function(e,t){e.exports=import.meta.resolve("binTT")}),V("c1jIH",function(e,t){e.exports=import.meta.resolve("kOvrs")}),V("cKCCq",function(e,t){e.exports=import.meta.resolve("f7gll")}),V("6yygh",function(e,t){e.exports=import.meta.resolve("kxaoK")}),V("01KdD",function(e,t){e.exports=import.meta.resolve("1IHGt")}),V("eok2J",function(e,t){e.exports=import.meta.resolve("d1AT3")}),V("kvYlb",function(e,t){e.exports=import.meta.resolve("iTS30")}),V("cldiI",function(e,t){e.exports=import.meta.resolve("dgv1C")}),V("eYFx7",function(e,t){e.exports=import.meta.resolve("3lODt")}),V("6qxt0",function(e,t){e.exports=import.meta.resolve("nwoyO")}),V("5lXXf",function(e,t){e.exports=import.meta.resolve("hLJrX")}),V("hfY5Y",function(e,t){e.exports=import.meta.resolve("7NNoN")}),V("bA3sa",function(e,t){e.exports=import.meta.resolve("aGpum")}),V("8k0Qi",function(e,t){e.exports=import.meta.resolve("iOuyX")}),V("7uKsU",function(e,t){e.exports=import.meta.resolve("iYi3V")}),V("fmmGn",function(e,t){e.exports=import.meta.resolve("jjy9s")}),V("QOeWk",function(e,t){e.exports=import.meta.resolve("7xPeO")}),V("kZqd6",function(e,t){e.exports=import.meta.resolve("1cPlO")}),V("7PTXP",function(e,t){e.exports=import.meta.resolve("8p5cP")}),V("bPoGH",function(e,t){e.exports=import.meta.resolve("8Jj6R")}),V("jqF9D",function(e,t){e.exports=import.meta.resolve("5u3ZN")}),V("jaqDX",function(e,t){e.exports=import.meta.resolve("clDJP")}),V("aPs4K",function(e,t){e.exports=import.meta.resolve("fnIha")}),V("6yDab",function(e,t){e.exports=import.meta.resolve("dxxv5")}),V("iBHcZ",function(e,t){e.exports=import.meta.resolve("bGEJc")}),V("kY7X2",function(e,t){e.exports=import.meta.resolve("goGEv")}),V("9NjUG",function(e,t){e.exports=import.meta.resolve("5phrJ")}),V("hlpqA",function(e,t){e.exports=import.meta.resolve("hZpxD")}),V("fFs4W",function(e,t){e.exports=import.meta.resolve("kSjuO")}),V("1JXKA",function(e,t){e.exports=import.meta.resolve("814wp")}),V("iULM2",function(e,t){e.exports=import.meta.resolve("6XNTC")}),V("5VcJO",function(e,t){e.exports=import.meta.resolve("eSN3y")}),V("cXQUF",function(e,t){e.exports=import.meta.resolve("9fotz")}),V("3gHhF",function(e,t){e.exports=import.meta.resolve("eseEk")}),V("iHYo6",function(e,t){e.exports=import.meta.resolve("fHEVh")}),V("j20ob",function(e,t){e.exports=import.meta.resolve("aR76A")}),V("j9Rz8",function(e,t){e.exports=import.meta.resolve("6SX6V")}),V("lpSrB",function(e,t){e.exports=import.meta.resolve("6vqpv")}),V("8DaLD",function(e,t){e.exports=import.meta.resolve("4GKs5")}),V("fqr9g",function(e,t){e.exports=import.meta.resolve("kOipz")}),V("e8ETw",function(e,t){e.exports=import.meta.resolve("f3MqY")}),V("jr8SH",function(e,t){e.exports=import.meta.resolve("8Eo8p")}),V("20azL",function(e,t){e.exports=import.meta.resolve("6Z9FR")}),V("a81ga",function(e,t){e.exports=import.meta.resolve("2BOzR")}),V("6to09",function(e,t){e.exports=import.meta.resolve("iFNVa")}),V("4olbl",function(e,t){e.exports=import.meta.resolve("bb2lS")}),V("adztJ",function(e,t){e.exports=import.meta.resolve("bJNpV")}),V("bvaO7",function(e,t){e.exports=import.meta.resolve("bTEcp")}),V("6GfQf",function(e,t){e.exports=import.meta.resolve("4m6Oj")}),V("7DKaJ",function(e,t){e.exports=import.meta.resolve("2keaG")}),V("irMWQ",function(e,t){e.exports=import.meta.resolve("coxSt")}),V("bb9lM",function(e,t){e.exports=import.meta.resolve("9mWWx")}),V("60j7T",function(e,t){e.exports=import.meta.resolve("iS60i")}),V("i2oiA",function(e,t){e.exports=import.meta.resolve("bFY2K")}),V("4lBTY",function(e,t){e.exports=import.meta.resolve("4VzTB")}),V("fbmZR",function(e,t){e.exports=import.meta.resolve("fH358")}),V("1VbLw",function(e,t){e.exports=import.meta.resolve("becxf")}),V("gv37W",function(e,t){e.exports=import.meta.resolve("6loVt")}),V("8IcSg",function(e,t){e.exports=import.meta.resolve("15Nl2")}),V("1zJJr",function(e,t){e.exports=import.meta.resolve("4tFQo")}),V("cKgmk",function(e,t){e.exports=import.meta.resolve("eX20J")}),V("9IP2s",function(e,t){e.exports=import.meta.resolve("hVslI")}),V("84YcX",function(e,t){e.exports=import.meta.resolve("gwtMM")}),V("4LBOi",function(e,t){e.exports=import.meta.resolve("eVH90")}),V("7wOfL",function(e,t){e.exports=import.meta.resolve("j31GE")}),V("dUgaz",function(e,t){e.exports=import.meta.resolve("g59Cn")}),V("gDkOj",function(e,t){e.exports=import.meta.resolve("3M7dG")}),V("gwZ7I",function(e,t){e.exports=import.meta.resolve("bodxv")}),V("dEvUk",function(e,t){e.exports=import.meta.resolve("aD9LH")}),V("5RC1f",function(e,t){e.exports=import.meta.resolve("hiMs1")}),V("ef2yI",function(e,t){e.exports=import.meta.resolve("5N2Ks")}),V("9U36H",function(e,t){e.exports=import.meta.resolve("dxQIJ")}),V("jopYq",function(e,t){e.exports=import.meta.resolve("35PQn")}),V("98tHU",function(e,t){e.exports=import.meta.resolve("boWMm")}),V("8R99b",function(e,t){e.exports=import.meta.resolve("iI5Sk")}),V("ih1IF",function(e,t){e.exports=import.meta.resolve("icWuP")}),V("6phI5",function(e,t){e.exports=import.meta.resolve("8kRcq")}),V("3vzqZ",function(e,t){e.exports=import.meta.resolve("k6kBH")}),V("kbVk5",function(e,t){e.exports=import.meta.resolve("64BGF")}),V("hN6aL",function(e,t){e.exports=import.meta.resolve("gdcwz")}),V("lpCzF",function(e,t){e.exports=import.meta.resolve("4q8Ah")}),V("4AA8Z",function(e,t){e.exports=import.meta.resolve("9onoo")}),V("hjwgF",function(e,t){e.exports=import.meta.resolve("93Pnl")}),V("2L2dz",function(e,t){e.exports=import.meta.resolve("jpS1l")}),V("lnokg",function(e,t){e.exports=import.meta.resolve("lqfpT")}),V("4NcZF",function(e,t){e.exports=import.meta.resolve("94dJT")}),V("k91ZK",function(e,t){e.exports=import.meta.resolve("igW24")}),V("5vx2L",function(e,t){e.exports=import.meta.resolve("lqEqF")}),V("dUPla",function(e,t){e.exports=import.meta.resolve("8RJZ0")}),V("dNXo7",function(e,t){e.exports=import.meta.resolve("9wrD0")}),V("kWhL5",function(e,t){e.exports=import.meta.resolve("lSD3i")}),V("abc0D",function(e,t){e.exports=import.meta.resolve("2z5r6")}),V("bUQ7X",function(e,t){e.exports=import.meta.resolve("6WfXi")}),V("1UIEn",function(e,t){e.exports=import.meta.resolve("9T16N")}),V("9xXTA",function(e,t){e.exports=import.meta.resolve("k7LDh")}),V("65bcZ",function(e,t){e.exports=import.meta.resolve("gLbJJ")}),V("ibeat",function(e,t){e.exports=import.meta.resolve("4qtqX")}),V("dOUlx",function(e,t){e.exports=import.meta.resolve("z6pdh")}),V("lnBdv",function(e,t){e.exports=import.meta.resolve("boWBX")}),V("lk4MI",function(e,t){e.exports=import.meta.resolve("jChss")}),V("2xGbt",function(e,t){e.exports=import.meta.resolve("idVW7")}),V("2iuwm",function(e,t){e.exports=import.meta.resolve("10oTp")}),V("4UyVN",function(e,t){e.exports=import.meta.resolve("9N3Jq")}),V("bkjeq",function(e,t){e.exports=import.meta.resolve("j8EMJ")}),V("fvBmS",function(e,t){e.exports=import.meta.resolve("fQh6R")}),V("crxnL",function(e,t){e.exports=import.meta.resolve("25foy")}),V("gzzaD",function(e,t){e.exports=import.meta.resolve("7gDyW")}),V("iGImZ",function(e,t){e.exports=import.meta.resolve("6OquI")}),V("jKUkR",function(e,t){e.exports=import.meta.resolve("itpEm")}),V("iY97d",function(e,t){e.exports=import.meta.resolve("agqIY")}),V("21LRM",function(e,t){e.exports=import.meta.resolve("jhJBF")}),V("8TOse",function(e,t){e.exports=import.meta.resolve("1RMnM")}),V("jYgPh",function(e,t){e.exports=import.meta.resolve("aawqd")}),V("idNdC",function(e,t){e.exports=import.meta.resolve("7Azq2")}),V("c4Ce0",function(e,t){e.exports=import.meta.resolve("bO5O6")}),V("i8P7h",function(e,t){e.exports=import.meta.resolve("cMgfB")}),V("bylK6",function(e,t){e.exports=import.meta.resolve("i0tVX")}),V("hBwm9",function(e,t){e.exports=import.meta.resolve("haQJd")}),V("ixeqe",function(e,t){e.exports=import.meta.resolve("dykwD")}),V("dVRqe",function(e,t){e.exports=import.meta.resolve("5ub3k")}),V("2mOzt",function(e,t){e.exports=import.meta.resolve("73yPj")}),V("a3Gmu",function(e,t){e.exports=import.meta.resolve("dZmc2")}),V("jM4en",function(e,t){e.exports=import.meta.resolve("cnQQj")}),V("dvEhF",function(e,t){e.exports=import.meta.resolve("1osIE")}),V("84XP6",function(e,t){e.exports=import.meta.resolve("fSADa")}),V("fOTiD",function(e,t){e.exports=import.meta.resolve("3CnbG")}),V("2cy5S",function(e,t){e.exports=import.meta.resolve("6XV2Z")}),V("dLq2X",function(e,t){e.exports=import.meta.resolve("3a0i6")}),V("1Fbg9",function(e,t){e.exports=import.meta.resolve("k0M7k")}),V("fFqvL",function(e,t){e.exports=import.meta.resolve("euI2B")});class E extends Array{constructor(...e){super(...e)}static fromValues(e,t){return new E(e,t)}static create(){return new E(0,0)}static clone(e){return new E(e[0],e[1])}equals(e){return this[0]===e[0]&&this[1]===e[1]}equalsValues(e,t){return this[0]===e&&this[1]===t}copy(e){this[0]=e[0],this[1]=e[1]}set(e,t){this[0]=e,this[1]=t}add(e){return E.fromValues(this[0]+e[0],this[1]+e[1])}subtract(e){return E.fromValues(this[0]-e[0],this[1]-e[1])}multiply(e){return E.fromValues(this[0]*e[0],this[1]*e[1])}scale(e){return E.fromValues(this[0]*e,this[1]*e)}scaleAndAdd(e,t){return E.fromValues(this[0]+e[0]*t,this[1]+e[1]*t)}distance(e){return Math.hypot(this[0]-e[0],this[1]-e[1])}squaredDistance(e){let t=this[0]-e[0],o=this[1]-e[1];return t*t+o*o}len(){return Math.hypot(this[0],this[1])}squaredLen(e){let t=this[0],o=this[1];return t*t+o*o}negate(){return E.fromValues(-this[0],-this[1])}dot(e){return this[0]*e[0]+this[1]*e[1]}lerp(e,t){return E.fromValues(this[0]+t*(e[0]-this[0]),this[1]+t*(e[1]-this[1]))}zero(){this[0]=0,this[1]=0}static copy(e,t){e[0]=t[0],e[1]=t[1]}static set(e,t,o){e[0]=t,e[1]=o}static add(e,t,o){e[0]=t[0]+o[0],e[1]=t[1]+o[1]}static subtract(e,t,o){e[0]=t[0]-o[0],e[1]=t[1]-o[1]}static multiply(e,t,o){e[0]=t[0]*o[0],e[1]=t[1]*o[1]}static scale(e,t,o){e[0]=t[0]*o,e[1]=t[1]*o}static scaleAndAdd(e,t,o,r){e[0]=t[0]+o[0]*r,e[1]=t[1]+o[1]*r}static distance(e,t){return Math.hypot(e[0]-t[0],e[1]-t[1])}static squaredDistance(e,t){let o=e[0]-t[0],r=e[1]-t[1];return o*o+r*r}static len(e){return Math.hypot(e[0],e[1])}static squaredLen(e){let t=e[0],o=e[1];return t*t+o*o}static negate(e,t){e[0]=-t[0],e[1]=-t[1]}static dot(e,t){return e[0]*t[0]+e[1]*t[1]}static lerp(e,t,o,r){e[0]=t[0]+r*(o[0]-t[0]),e[1]=t[1]+r*(o[1]-t[1])}static zero(e){e[0]=0,e[1]=0}}(t=k||(k={})).create=function(){return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},t.copy=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]},t.ortho=function(e,t,o,r,a,n,s){let i=1/(t-o),l=1/(r-a),f=1/(n-s);e[0]=-2*i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*f,e[11]=0,e[12]=(t+o)*i,e[13]=(a+r)*l,e[14]=(s+n)*f,e[15]=1};var B=((o=B||{})[o.Damage=0]="Damage",o[o.GuardChase=1]="GuardChase",o[o.GuardInvestigate=2]="GuardInvestigate",o[o.GuardSeeThief=3]="GuardSeeThief",o[o.GuardHearThief=4]="GuardHearThief",o[o.GuardDownWarning=5]="GuardDownWarning",o[o.GuardAwakesWarning=6]="GuardAwakesWarning",o[o.GuardExamineStolenTreasure=7]="GuardExamineStolenTreasure",o[o.GuardWarningResponse=8]="GuardWarningResponse",o[o.GuardHearGuard=9]="GuardHearGuard",o[o.GuardSpotDownedGuard=10]="GuardSpotDownedGuard",o[o.GuardSeeTorchLit=11]="GuardSeeTorchLit",o[o.GuardSeeUnlitTorch=12]="GuardSeeUnlitTorch",o[o.GuardEndChase=13]="GuardEndChase",o[o.GuardFinishInvestigating=14]="GuardFinishInvestigating",o[o.GuardFinishLooking=15]="GuardFinishLooking",o[o.GuardFinishListening=16]="GuardFinishListening",o[o.GuardFinishLightingTorch=17]="GuardFinishLightingTorch",o[o.GuardFinishLookingAtLitTorch=18]="GuardFinishLookingAtLitTorch",o[o.GuardStirring=19]="GuardStirring",o[o.GuardSpotStolenTreasure=20]="GuardSpotStolenTreasure",o[o.GuardSeeTorchDoused=21]="GuardSeeTorchDoused",o);class N{constructor(){this.currentSpeech="",this.currentSpeaker=void 0,this.currentSpeechAbove=!1,this.currentSpeechTimeRemaining=0,this.notification="",this.notificationMaxTurns=0,this.notificationWorldPos=E.create(),this.notificationTimeRemaining=0}setSpeech(e,t,o){this.currentSpeech=e,this.currentSpeaker=t,this.currentSpeechAbove=o,this.currentSpeechTimeRemaining=2}setNotification(e,t,o=1,r=2){this.notification=e,this.notificationWorldPos=t instanceof ey?t:E.clone(t),this.notificationTimeRemaining=r,this.notificationMaxTurns=o}setNotificationHold(e,t){this.notification=e,this.notificationWorldPos=t instanceof ey?t:E.clone(t),this.notificationTimeRemaining=1/0,this.notificationMaxTurns=1}updateNotification(){--this.notificationMaxTurns,this.notificationMaxTurns<=0&&(this.notificationTimeRemaining=0,this.notificationMaxTurns=0)}isSpeechBubbleVisible(){return this.currentSpeechTimeRemaining>0}isNotificationVisible(){return this.notificationTimeRemaining>0}animate(e){this.currentSpeechTimeRemaining=Math.max(0,this.currentSpeechTimeRemaining-e),this.notificationTimeRemaining=Math.max(0,this.notificationTimeRemaining-e)}toggleShow(e){this.notificationTimeRemaining=this.notificationTimeRemaining>0?0:2,this.currentSpeechTimeRemaining>0?this.currentSpeechTimeRemaining=0:void 0!==this.currentSpeaker&&""!==this.currentSpeech&&(this.currentSpeechTimeRemaining=2,this.currentSpeechAbove=this.currentSpeaker.pos[1]>=e[1])}reset(){this.currentSpeech="",this.currentSpeaker=void 0,this.currentSpeechAbove=!1,this.currentSpeechTimeRemaining=0,this.notification="",this.notificationWorldPos=new E(0,0),this.notificationTimeRemaining=0,this.notificationMaxTurns=0}}var F={},O={linear:function(e,t,o,r){return(o-t)*e/r+t},easeInQuad:function(e,t,o,r){return(o-t)*(e/=r)*e+t},easeOutQuad:function(e,t,o,r){return-(o-t)*(e/=r)*(e-2)+t},easeInOutQuad:function(e,t,o,r){var a=o-t;return(e/=r/2)<1?a/2*e*e+t:-a/2*(--e*(e-2)-1)+t},easeInCubic:function(e,t,o,r){return(o-t)*(e/=r)*e*e+t},easeOutCubic:function(e,t,o,r){return(o-t)*((e=e/r-1)*e*e+1)+t},easeInOutCubic:function(e,t,o,r){var a=o-t;return(e/=r/2)<1?a/2*e*e*e+t:a/2*((e-=2)*e*e+2)+t},easeInQuart:function(e,t,o,r){return(o-t)*(e/=r)*e*e*e+t},easeOutQuart:function(e,t,o,r){return-(o-t)*((e=e/r-1)*e*e*e-1)+t},easeInOutQuart:function(e,t,o,r){var a=o-t;return(e/=r/2)<1?a/2*e*e*e*e+t:-a/2*((e-=2)*e*e*e-2)+t},easeInQuint:function(e,t,o,r){return(o-t)*(e/=r)*e*e*e*e+t},easeOutQuint:function(e,t,o,r){return(o-t)*((e=e/r-1)*e*e*e*e+1)+t},easeInOutQuint:function(e,t,o,r){var a=o-t;return(e/=r/2)<1?a/2*e*e*e*e*e+t:a/2*((e-=2)*e*e*e*e+2)+t},easeInSine:function(e,t,o,r){var a=o-t;return-a*Math.cos(e/r*(Math.PI/2))+a+t},easeOutSine:function(e,t,o,r){return(o-t)*Math.sin(e/r*(Math.PI/2))+t},easeInOutSine:function(e,t,o,r){return-(o-t)/2*(Math.cos(Math.PI*e/r)-1)+t},easeInExpo:function(e,t,o,r){return 0==e?t:(o-t)*Math.pow(2,10*(e/r-1))+t},easeOutExpo:function(e,t,o,r){var a=o-t;return e==r?t+a:a*(-Math.pow(2,-10*e/r)+1)+t},easeInOutExpo:function(e,t,o,r){var a=o-t;return 0===e?t:e===r?t+a:(e/=r/2)<1?a/2*Math.pow(2,10*(e-1))+t:a/2*(-Math.pow(2,-10*--e)+2)+t},easeInCirc:function(e,t,o,r){return-(o-t)*(Math.sqrt(1-(e/=r)*e)-1)+t},easeOutCirc:function(e,t,o,r){return(o-t)*Math.sqrt(1-(e=e/r-1)*e)+t},easeInOutCirc:function(e,t,o,r){var a=o-t;return(e/=r/2)<1?-a/2*(Math.sqrt(1-e*e)-1)+t:a/2*(Math.sqrt(1-(e-=2)*e)+1)+t},easeInElastic:function(e,t,o,r){var a,n,s,i=o-t;return(s=1.70158,n=0,a=i,0===e)?t:1==(e/=r)?t+i:(n||(n=.3*r),a<Math.abs(i)?(a=i,s=n/4):s=n/(2*Math.PI)*Math.asin(i/a),-(a*Math.pow(2,10*(e-=1))*Math.sin(2*Math.PI*(e*r-s)/n))+t)},easeOutElastic:function(e,t,o,r){var a,n,s,i=o-t;return(s=1.70158,n=0,a=i,0===e)?t:1==(e/=r)?t+i:(n||(n=.3*r),a<Math.abs(i)?(a=i,s=n/4):s=n/(2*Math.PI)*Math.asin(i/a),a*Math.pow(2,-10*e)*Math.sin(2*Math.PI*(e*r-s)/n)+i+t)},easeInOutElastic:function(e,t,o,r){var a,n,s,i=o-t;return(s=1.70158,n=0,a=i,0===e)?t:2==(e/=r/2)?t+i:(n||(n=.3*1.5*r),a<Math.abs(i)?(a=i,s=n/4):s=n/(2*Math.PI)*Math.asin(i/a),e<1)?-.5*(a*Math.pow(2,10*(e-=1))*Math.sin(2*Math.PI*(e*r-s)/n))+t:a*Math.pow(2,-10*(e-=1))*Math.sin(2*Math.PI*(e*r-s)/n)*.5+i+t},easeInBack:function(e,t,o,r,a){return void 0===a&&(a=1.70158),(o-t)*(e/=r)*e*((a+1)*e-a)+t},easeOutBack:function(e,t,o,r,a){return void 0===a&&(a=1.70158),(o-t)*((e=e/r-1)*e*((a+1)*e+a)+1)+t},easeInOutBack:function(e,t,o,r,a){var n=o-t;return(void 0===a&&(a=1.70158),(e/=r/2)<1)?n/2*(e*e*(((a*=1.525)+1)*e-a))+t:n/2*((e-=2)*e*(((a*=1.525)+1)*e+a)+2)+t},easeInBounce:function(e,t,o,r){var a,n=o-t;return a=O.easeOutBounce(r-e,0,n,r),n-a+t},easeOutBounce:function(e,t,o,r){var a=o-t;return(e/=r)<1/2.75?7.5625*e*e*a+t:e<2/2.75?a*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?a*(7.5625*(e-=2.25/2.75)*e+.9375)+t:a*(7.5625*(e-=2.625/2.75)*e+.984375)+t},easeInOutBounce:function(e,t,o,r){var a=o-t;return e<r/2?.5*O.easeInBounce(2*e,0,a,r)+t:.5*O.easeOutBounce(2*e-r,0,a,r)+.5*a+t}};F=O;class z{update(e){return!1}currentTile(){return{}}}class H extends z{constructor(e,t,o=0,r=-1){super(),this.time=0,this.tileInfo=e,this.activeFrame=o,this.frameDuration=t,this.removeOnFinish=!1,this.loops=r}update(e){this.time+=e;let t=this.frameDuration instanceof Array?this.frameDuration[this.activeFrame]:this.frameDuration;return this.time>t&&(this.activeFrame++,this.activeFrame>=this.tileInfo.length&&(this.activeFrame=0,this.loops>0&&this.loops--),this.time=0),0===this.loops}currentTile(){return this.tileInfo[this.activeFrame]}}class X extends z{constructor(e,t){super(),this.time=0,this.offset=E.clone(e[0].pt0),this.tileInfo=t,this.activeFrame=0,this.frameStep=1,this.activePt=0,this.tweenSeq=e,this.removeOnFinish=!1}update(e){let t=this.tweenSeq[this.activePt].pt0,o=this.tweenSeq[this.activePt].pt1,r=this.tweenSeq[this.activePt].duration,a=this.tweenSeq[this.activePt].fn;return void 0===t||void 0==o||(this.time=Math.min(this.time+e,r),this.time>=0&&(this.offset[0]=a(this.time,t[0],o[0],r),this.offset[1]=a(this.time,t[1],o[1],r)),this.time==r&&(this.activePt++,this.time=0,this.activeFrame++),this.activeFrame>=this.tileInfo.length&&(this.activeFrame=0),this.activePt===this.tweenSeq.length)}currentTile(){return this.tileInfo[this.activeFrame]}}class q extends z{constructor(e,t,o){super(),this.offset=new E,this.duration=0,this.period=1,this.time=0,this.tile=e,this.duration=t,this.period=o}update(e){return this.duration>0?this.time=Math.min(this.time+e,this.duration):this.time+=e,this.duration>0&&this.time===this.duration}get intensity(){return Math.sin(this.time/this.period)}agbr_color_to_tuple(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]}abgr_tuple_to_color(e,t,o,r){return(Math.floor(e%256)<<24|Math.floor(t%256)<<16|Math.floor(o%256)<<8|Math.floor(r%256))>>>0}blend(e,t,o){let r=this.agbr_color_to_tuple(e),a=this.agbr_color_to_tuple(t),n=r.map((e,t)=>e*o+a[t]*(1-o));return this.abgr_tuple_to_color(n[0],n[1],n[2],n[3])}currentTile(){let e=this.intensity;return{textureIndex:this.tile.textureIndex,color:void 0!==this.tile.color&&void 0!==this.tile.unlitColor?this.blend(this.tile.color,this.tile.unlitColor,(1+e)/2):0xffffffff}}}class Y extends z{constructor(e,t,o,r,a,n=new E(0,0),s=0,i=0){super(),this.time=0,this.tileInfo=e,this.offset=new E,this.centerPos=n,this.radius=t,this.speed=o,this.startingPos=r,this.duration=a,this.posRadians=r,this.removeOnFinish=!1}update(e){return this.duration>0?this.time=Math.min(this.time+e,this.duration):this.time+=e,this.posRadians+=this.speed*e,this.offset[0]=this.centerPos[0]+Math.cos(this.posRadians)*this.radius,this.offset[1]=this.centerPos[1]+Math.sin(this.posRadians)*this.radius,this.time===this.duration}currentTile(){return this.tileInfo}}var U=((r=U||{})[r.idle=0]="idle",r[r.dimmed=1]="dimmed",r[r.off=2]="off",r);class j extends z{constructor(e,t,o,r,a,n,s){super(),this.activeFrame=0,this.time=0,this.dimDuration=300,this.idleTiles=a,this.dimTile=n,this.offTile=s,this.lightId=t,this.lightVector=o,this.state=e,this.item=r}update(e){if(null!==this.item&&(this.item.type===ex.TorchUnlit&&(this.state=2),this.item.type!==ex.TorchUnlit&&2===this.state&&(this.state=0,this.lightVector[this.lightId]=0)),this.time+=e,2==this.state)return!1;let t=this.lightVector[this.lightId];if(0==t&&Math.random()>.995**(60*e)?(this.state=1,t=1.5):t>0&&(t=Math.max(t-3*e,0)),0==t){this.state=0;let e=this.idleTiles[this.activeFrame][1];this.time>=e&&(this.time=0,this.activeFrame++,this.activeFrame>=this.idleTiles.length&&(this.activeFrame=0))}return this.lightVector[this.lightId]=t,!1}currentTile(){return 0==this.state?this.idleTiles[this.activeFrame][0]:1==this.state?this.dimTile:this.offTile}}function K(e,t,o,r,a,n){for(let s=t;s<r;++s)for(let t=o;t<a;++t)e.cells.at(s,t).type=n}function $(e){return e<ep.Wall0000&&e!==ep.GroundWater}function Q(e){return e>=ep.Wall0000&&e<=ep.OneWayWindowS}function J(e){return e>=ep.OneWayWindowE&&e<=ep.OneWayWindowS}function Z(e){return e>=ep.Wall0000&&e<=ep.DoorEW}var ee=((a=ee||{})[a.Patrol=0]="Patrol",a[a.Look=1]="Look",a[a.LookAtTorch=2]="LookAtTorch",a[a.Listen=3]="Listen",a[a.ChaseVisibleTarget=4]="ChaseVisibleTarget",a[a.MoveToLastSighting=5]="MoveToLastSighting",a[a.InvestigateLastSighting=6]="InvestigateLastSighting",a[a.MoveToLastSound=7]="MoveToLastSound",a[a.MoveToGuardShout=8]="MoveToGuardShout",a[a.MoveToDownedGuard=9]="MoveToDownedGuard",a[a.MoveToMissingTreasure=10]="MoveToMissingTreasure",a[a.LookAtMissingTreasure=11]="LookAtMissingTreasure",a[a.WakeGuard=12]="WakeGuard",a[a.MoveToTorch=13]="MoveToTorch",a[a.LightTorch=14]="LightTorch",a[a.Unconscious=15]="Unconscious",a);class et{constructor(e,t){this.dir=E.fromValues(1,0),this.mode=0,this.modePrev=0,this.angry=!1,this.hasTorch=!1,this.hasPurse=!1,this.hasVaultKey=!1,this.torchAnimation=null,this.speaking=!1,this.hasMoved=!1,this.heardThief=!1,this.heardThiefClosest=!1,this.heardAlarm=!1,this.hearingGuard=!1,this.heardGuard=!1,this.animation=null,this.goals=[],this.modeTimeout=0;let o=e[t];this.pos=E.clone(o),this.heardGuardPos=E.create(),this.goal=E.clone(o),this.patrolPath=e,this.patrolPathIndex=t,this.updateDirInitial()}overheadIcon(){return 15===this.mode?em.Unconscious:4===this.mode?em.Chasing:eo(this.mode)?this.angry?em.Angry:em.Relaxed:em.Alerted}posAnimated(){let e=this.animation?.offset??E.create(),t=E.create();return E.add(t,this.pos,e),t}allowsMoveOntoFrom(e){if(this.goals.length<=0)return!0;let t=this.goals[0];if(t.equals(this.pos)||t.equals(e))return!1;let o=Math.floor((this.pos[0]+e[0])/2),r=Math.floor((this.pos[1]+e[1])/2);return t[0]!==o||t[1]!==r}moving(){if(this.goals.length<=0)return!1;let e=this.goals[0];return!this.pos.equals(e)}chooseMoves(e){switch(this.mode){case 0:this.goals=this.choosePatrolStep(e);break;case 1:case 2:case 3:case 15:this.goals=this.chooseMoveTowardPosition(this.pos,e.gameMap);break;case 4:case 5:case 6:case 8:case 7:this.goals=this.chooseMoveTowardPosition(this.goal,e.gameMap);break;case 9:case 10:case 11:case 12:case 13:case 14:this.goals=this.chooseMoveTowardAdjacentToPosition(this.goal,e.gameMap)}}bestAvailableMove(e,t,o){let r=!1;for(let a of e)if(t.guardMoveCost(this.pos,a)!=1/0){if(o.pos.equals(a)){r=!0;continue}if(!t.isGuardAtVec(a))return[a,r]}return[this.pos,r]}act(e,t){let o=E.clone(this.pos),r=e.gameMap,a=e.player,n=e.levelStats;if(15!==this.mode&&!eo(this.mode)){let e=+!!this.moving();this.seesActor(r,a,e)&&(this.mode=4)}switch(this.heardThief&&15!==this.mode&&4!==this.mode&&(eo(this.mode)&&!this.heardThiefClosest?(this.mode=3,this.modeTimeout=2+e.rng.randomInRange(4),this.goals=this.chooseMoveTowardPosition(this.pos,e.gameMap)):9!==this.mode&&(E.copy(this.goal,a.pos),eo(this.mode)?this.goals=this.chooseMoveTowardPosition(this.pos,e.gameMap):this.goals=this.chooseMoveTowardPosition(this.goal,e.gameMap),this.mode=this.heardAlarm?10:7,this.modeTimeout=4+e.rng.randomInRange(2))),this.mode){case 0:if(this.makeBestAvailableMove(r,a),this.pos.equals(this.patrolPath[this.patrolPathIndex])){if(this.pos.equals(o)){let e=this.patrolPath[Math.max(0,this.patrolPathIndex+this.patrolPath.length-2)%this.patrolPath.length];if(o.equals(e)){let e=1===this.patrolPath.length,t=r.tryGetPosLookAt(this.pos,e);void 0!==t&&ea(this.dir,this.pos,t)}}}else this.enterPatrolMode(r);break;case 1:case 3:this.makeBestAvailableMove(r,a),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 2:this.makeBestAvailableMove(r,a),ea(this.dir,this.pos,this.goal),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 4:if(E.copy(this.goal,a.pos),this.adjacentTo(a.pos)&&!this.pos.equals(a.pos)){if(ea(this.dir,this.pos,this.goal),4===this.modePrev){a.damagedLastTurn||t.push({speaker:this,speechType:B.Damage});let o=E.create(),r=E.create();E.subtract(r,a.pos,this.pos),E.scale(r,r,.5),this.animation=new X([{pt0:o,pt1:r,duration:.1,fn:F.easeInQuad},{pt0:r,pt1:o,duration:.1,fn:F.easeOutQuad}],[]),a.applyDamage(1),aV(e,a.health),aG(e),aM(e,a.pos[0]-this.pos[0],a.pos[1]-this.pos[1]),++n.damageTaken}}else this.goals=this.chooseMoveTowardPosition(this.goal,r),this.makeBestAvailableMove(r,a);break;case 5:this.makeBestAvailableMove(r,a),this.pos.equals(this.goal)?(this.mode=6,this.modeTimeout=5):this.pos.equals(o)&&(this.modeTimeout-=1),this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 6:this.makeBestAvailableMove(r,a),this.modeTimeout>=3&&this.pos.equals(this.goal)&&this.tryStepGoalForward(e),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 7:case 8:this.makeBestAvailableMove(r,a),this.pos.equals(o)&&(this.modeTimeout-=1),this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 9:this.makeBestAvailableMove(r,a),this.cardinallyAdjacentTo(this.goal)?r.guards.find(e=>e.pos.equals(this.goal)&&15===e.mode)?(this.mode=12,this.modeTimeout=3):(this.modeTimeout=0,this.enterPatrolMode(r)):this.pos.equals(o)&&(this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r));break;case 10:this.makeBestAvailableMove(r,a),this.cardinallyAdjacentTo(this.goal)?(this.mode=11,this.modeTimeout=4):this.pos.equals(o)?(this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r)):this.modeTimeout=3;break;case 11:this.makeBestAvailableMove(r,a),this.pos.equals(o)&&this.cardinallyAdjacentTo(this.goal)&&ea(this.dir,this.pos,this.goal),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 12:this.makeBestAvailableMove(r,a),this.pos.equals(o)&&ea(this.dir,this.pos,this.goal),--this.modeTimeout;let s=r.guards.find(e=>e.pos.equals(this.goal)&&15===e.mode);void 0!==s?this.modeTimeout<=0&&(s.modeTimeout=0,this.enterPatrolMode(r)):(this.modeTimeout=0,this.enterPatrolMode(r));break;case 13:this.makeBestAvailableMove(r,a),r.items.some(e=>e.pos.equals(this.goal)&&e.type===ex.TorchLit)?this.enterPatrolMode(r):this.cardinallyAdjacentTo(this.goal)?(this.mode=14,this.modeTimeout=5):this.pos.equals(o)?(this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r)):this.modeTimeout=3;break;case 14:if(this.makeBestAvailableMove(r,a),--this.modeTimeout,ea(this.dir,this.pos,this.goal),this.modeTimeout<=0){var i=r,l=this.goal;for(let e of i.items)e.type===ex.TorchUnlit&&e.pos.equals(l)&&(e.type=ex.TorchLit);let e=en(r,this.pos);void 0===e?this.enterPatrolMode(r):(E.copy(this.goal,e.pos),this.cardinallyAdjacentTo(this.goal)?(this.mode=14,this.modeTimeout=5):(this.mode=13,this.modeTimeout=3))}break;case 15:this.modeTimeout<=0&&(this.modeTimeout=0,this.angry=!0,this.enterPatrolMode(r))}}postActSense(e,t,o,r,a,n){if(15!==this.mode){if(this.seesActor(e,t)?eo(this.mode)&&!this.adjacentTo(t.pos)?(this.mode=1,this.modeTimeout=2+n.randomInRange(4)):this.mode=4:4===this.mode&&4===this.modePrev&&(this.mode=5,this.modeTimeout=3),this.heardGuard&&1!==this.mode&&4!==this.mode&&5!==this.mode&&6!==this.mode&&7!==this.mode&&9!==this.mode&&12!==this.mode&&(this.mode=8,this.modeTimeout=2+n.randomInRange(4),E.copy(this.goal,this.heardGuardPos)),4!==this.mode&&9!==this.mode&&12!==this.mode){for(let t of e.guards)if(t!==this&&15===t.mode&&this.seesActor(e,t)){E.copy(this.goal,t.pos),this.mode=9,this.angry=!0,this.modeTimeout=3;break}}if(!this.angry&&eo(this.mode)){let t=e.treasures.find(t=>t.stolen&&this.seesPosition(e,t.posTreasure));void 0!==t&&(this.mode=10,E.copy(this.goal,t.posTreasure),this.angry=!0,this.modeTimeout=3)}if(this.hasTorch&&0===this.mode){let t=en(e,this.pos);void 0!==t&&(E.copy(this.goal,t.pos),this.cardinallyAdjacentTo(this.goal)?(this.mode=14,this.modeTimeout=5):(this.mode=13,this.modeTimeout=3))}!this.hasTorch&&eo(this.mode)&&null!==t.itemUsed&&64>=E.squaredDistance(this.pos,t.itemUsed.pos)&&ei(e,this.pos,t.itemUsed.pos)&&(t.itemUsed.type===ex.TorchLit?(E.copy(this.goal,t.itemUsed.pos),this.mode=2,this.modeTimeout=2+n.randomInRange(4)):t.itemUsed.type===ex.TorchUnlit&&r.push({speaker:this,speechType:B.GuardSeeTorchDoused})),8===this.mode&&es(e,this.pos,this.goal)&&e.guards.some(e=>e.pos.equals(this.goal))&&E.copy(this.goal,this.pos)}this.heardThief=!1,this.heardThiefClosest=!1,this.heardAlarm=!1;let s=function(e,t,o){if(t==e)return;let r=o<=64;switch(t){case 0:switch(e){case 1:return B.GuardFinishLooking;case 2:return B.GuardFinishLookingAtLitTorch;case 3:return B.GuardFinishListening;case 7:return B.GuardFinishInvestigating;case 8:case 5:case 6:return B.GuardEndChase;case 14:return r?B.GuardFinishLightingTorch:void 0;case 15:return B.GuardAwakesWarning;default:return}case 1:return B.GuardSeeThief;case 2:return B.GuardSeeTorchLit;case 3:return B.GuardHearThief;case 4:if(5!=e&&6!==e)return B.GuardChase;break;case 14:if(0===e&&r)return B.GuardSeeUnlitTorch;break;case 5:case 6:break;case 7:return B.GuardInvestigate;case 8:return B.GuardHearGuard;case 13:if(14!==e&&r)return B.GuardSeeUnlitTorch;break;case 9:return B.GuardSpotDownedGuard;case 12:return B.GuardDownWarning;case 10:return B.GuardSpotStolenTreasure;case 11:return B.GuardExamineStolenTreasure}}(this.modePrev,this.mode,E.squaredDistance(this.pos,t.pos));if(void 0!==s&&r.push({speaker:this,speechType:s}),this.mode!==this.modePrev)switch(this.mode){case 4:a.push({posShouter:E.clone(this.pos),posGoal:E.clone(t.pos),angry:!1}),++o.numSpottings;break;case 12:case 11:a.push({posShouter:E.clone(this.pos),posGoal:E.clone(this.goal),angry:!0})}}tryStepGoalForward(e){let t=E.create();if(E.add(t,this.pos,this.dir),0===e.gameMap.guardMoveCost(this.pos,t))return void E.copy(this.goal,t);let o=[E.fromValues(this.pos[0]-this.dir[1],this.pos[1]+this.dir[0]),E.fromValues(this.pos[0]+this.dir[1],this.pos[1]-this.dir[0])];if((o=o.filter(t=>0===e.gameMap.guardMoveCost(this.pos,t))).length>0){let t=e.rng.randomInRange(o.length);E.copy(this.goal,o[t])}}cardinallyAdjacentTo(e){let t=Math.abs(e[0]-this.pos[0]),o=Math.abs(e[1]-this.pos[1]);return 1==t&&0==o||0==t&&1==o}adjacentTo(e){let t=e[0]-this.pos[0],o=e[1]-this.pos[1];return 2>Math.abs(t)&&2>Math.abs(o)}seesActor(e,t,o=0){return this.seesPositionInternal(e,t.pos,t.hidden(e),es,o)}seesPosition(e,t){return this.seesPositionInternal(e,t,!1,ei,0)}seesPositionInternal(e,t,o,r,a){let n=E.create();if(E.subtract(n,t,this.pos),4!==this.mode&&E.dot(this.dir,n)<a)return!1;let s=e.cells.atVec(t).lit>0;if(E.squaredLen(n)>=this.sightCutoff(s)&&(n[0]!==2*this.dir[0]||n[1]!==2*this.dir[1]))return!1;if(eo(this.mode)&&!this.angry||Math.abs(n[0])>=2||Math.abs(n[1])>=2){if(o||!r(e,this.pos,t))return!1}else if(this.pos[0]!==t[0]&&this.pos[1]!==t[1]&&(e.cells.at(this.pos[0],t[1]).blocksSight||e.cells.at(t[0],this.pos[1]).blocksSight))return!1;return!0}hidden(e){return!!e.cells.atVec(this.pos).hidesPlayer}sightCutoff(e){return 4===this.mode?e?75:33:!eo(this.mode)||this.angry?e?75:15:e?40:3}enterPatrolMode(e){this.patrolPathIndex=e.patrolPathIndexForResume(this.patrolPath,this.patrolPathIndex,this.pos),this.mode=0}choosePatrolStep(e){return this.pos.equals(this.patrolPath[this.patrolPathIndex])&&(this.patrolPathIndex=(this.patrolPathIndex+1)%this.patrolPath.length),this.chooseMoveTowardPosition(this.patrolPath[this.patrolPathIndex],e.gameMap)}makeBestAvailableMove(e,t){let[o,r]=this.bestAvailableMove(this.goals,e,t);if(!o.equals(this.pos)){ea(this.dir,this.pos,o);let e=E.create();E.subtract(e,this.pos,o);let t=E.create();this.animation=new X([{pt0:e,pt1:t,duration:.2,fn:F.linear}],[]),E.copy(this.pos,o)}r&&(this.mode=4,ea(this.dir,this.pos,t.pos))}updateDirInitial(){let e=(this.patrolPathIndex+1)%this.patrolPath.length;ea(this.dir,this.pos,this.patrolPath[e])}chooseMoveTowardPosition(e,t){let o={posMin:E.fromValues(Math.max(0,this.pos[0]-1),Math.max(0,this.pos[1]-1)),posMax:E.fromValues(Math.min(t.cells.sizeX,this.pos[0]+2),Math.min(t.cells.sizeY,this.pos[1]+2))},r=t.computeDistancesToPosition(e,o);return t.nextPositions(r,this.pos)}chooseMoveTowardAdjacentToPosition(e,t){let o={posMin:E.fromValues(Math.max(0,this.pos[0]-1),Math.max(0,this.pos[1]-1)),posMax:E.fromValues(Math.min(t.cells.sizeX,this.pos[0]+2),Math.min(t.cells.sizeY,this.pos[1]+2))},r=t.computeDistancesToAdjacentToPosition(e,o);return t.nextPositions(r,this.pos)}}function eo(e){return 0===e||13===e||14===e}function er(e){for(let t of e.gameMap.guards)t.chooseMoves(e)}function ea(e,t,o){let r=E.create();E.subtract(r,o,t);let a=E.fromValues(-e[1],e[0]),n=E.dot(e,r),s=E.dot(a,r);n>=Math.abs(s)||(-n>Math.abs(s)?E.negate(e,e):s>=0?E.copy(e,a):E.negate(e,a))}function en(e,t){let o,r=65;for(let a of e.items)if(a.type===ex.TorchUnlit){let n=E.squaredDistance(a.pos,t);if(n>=r||!ei(e,t,a.pos))continue;r=n,o=a}return o}function es(e,t,o){let r=t[0],a=t[1],n=o[0]-r,s=o[1]-a,i=Math.abs(n),l=Math.abs(s),f=n>0?1:-1,u=s>0?1:-1,c=l-i,d=i+l-1,p=d;for(i*=2,l*=2;p>0;){if(c>0)a+=u,c-=i;else{if(0===c){let t=e.cells.at(r,a+u);if(t.blocksSight||t.isWindow&&p>1&&p<d-1)return!1}r+=f,c+=l}let t=e.cells.at(r,a);if(t.blocksSight||t.isWindow&&p>1&&p<d-1)return!1;--p}return!0}function ei(e,t,o){let r=t[0],a=t[1],n=o[0]-r,s=o[1]-a,i=Math.abs(n),l=Math.abs(s),f=n>0?1:-1,u=s>0?1:-1,c=l-i,d=i+l-1;for(i*=2,l*=2;d>0;){if(c>0)a+=u,c-=i;else{var p;if(0===c&&((p=e.cells.at(r,a+u)).blocksSight||J(p.type)))return!1;r+=f,c+=l}let t=e.cells.at(r,a);if(t.blocksSight||J(t.type))return!1;--d}return!0}let el=[E.fromValues(-1,0),E.fromValues(1,0),E.fromValues(0,-1),E.fromValues(0,1)];class ef{constructor(e,t,o){this.sizeX=e,this.sizeY=t,this.values=new Uint8Array(e*t),this.fill(o)}fill(e){this.values.fill(+!!e)}get(e,t){return 0!==this.values[this.sizeX*t+e]}set(e,t,o){this.values[this.sizeX*t+e]=+!!o}}class eu{constructor(e,t,o){this.sizeX=e,this.sizeY=t,this.values=new Int32Array(e*t),this.fill(o)}fill(e){this.values.fill(e)}get(e,t){return this.values[this.sizeX*t+e]}set(e,t,o){this.values[this.sizeX*t+e]=o}}class ec{constructor(e,t,o){this.sizeX=e,this.sizeY=t,this.values=new Float64Array(e*t),this.fill(o)}fill(e){this.values.fill(e)}get(e,t){return this.values[this.sizeX*t+e]}set(e,t,o){this.values[this.sizeX*t+e]=o}}var ed=((n=ed||{})[n.Manor=0]="Manor",n[n.ManorRed=1]="ManorRed",n[n.Mansion=2]="Mansion",n[n.Fortress=3]="Fortress",n[n.Warrens=4]="Warrens",n),ep=((s=ep||{})[s.GroundNormal=0]="GroundNormal",s[s.GroundGrass=1]="GroundGrass",s[s.GroundWater=2]="GroundWater",s[s.GroundMarble=3]="GroundMarble",s[s.GroundWood=4]="GroundWood",s[s.GroundWoodCreaky=5]="GroundWoodCreaky",s[s.GroundVault=6]="GroundVault",s[s.GroundTreasure=7]="GroundTreasure",s[s.Wall0000=8]="Wall0000",s[s.Wall0001=9]="Wall0001",s[s.Wall0010=10]="Wall0010",s[s.Wall0011=11]="Wall0011",s[s.Wall0100=12]="Wall0100",s[s.Wall0101=13]="Wall0101",s[s.Wall0110=14]="Wall0110",s[s.Wall0111=15]="Wall0111",s[s.Wall1000=16]="Wall1000",s[s.Wall1001=17]="Wall1001",s[s.Wall1010=18]="Wall1010",s[s.Wall1011=19]="Wall1011",s[s.Wall1100=20]="Wall1100",s[s.Wall1101=21]="Wall1101",s[s.Wall1110=22]="Wall1110",s[s.Wall1111=23]="Wall1111",s[s.OneWayWindowE=24]="OneWayWindowE",s[s.OneWayWindowW=25]="OneWayWindowW",s[s.OneWayWindowN=26]="OneWayWindowN",s[s.OneWayWindowS=27]="OneWayWindowS",s[s.PortcullisNS=28]="PortcullisNS",s[s.PortcullisEW=29]="PortcullisEW",s[s.DoorNS=30]="DoorNS",s[s.DoorEW=31]="DoorEW",s[s.GardenDoorNS=32]="GardenDoorNS",s[s.GardenDoorEW=33]="GardenDoorEW",s);class eh{constructor(e,t){this.sizeX=e,this.sizeY=t;let o=e*t;this.values=Array(o);for(let e=0;e<o;++e)this.values[e]=this.emptyCell()}at(e,t){if(e<0||e>=this.sizeX||t<0||t>=this.sizeY)return this.emptyCell();let o=this.sizeX*t+e;return this.values[o]}atVec(e){return this.at(e[0],e[1])}index(e,t){return this.sizeX*t+e}indexVec(e){return this.index(e[0],e[1])}emptyCell(){return{type:1,moveCost:1/0,blocksPlayerMove:!1,blocksPlayerSight:!1,blocksSight:!1,blocksSound:!1,hidesPlayer:!1,isWindow:!1,lit:0,litAnim:0,litSrc:new Set,seen:!1,identified:!1}}}var em=((i=em||{})[i.Relaxed=0]="Relaxed",i[i.Angry=1]="Angry",i[i.Alerted=2]="Alerted",i[i.Chasing=3]="Chasing",i[i.Unconscious=4]="Unconscious",i),ex=((l=ex||{})[l.Chair=0]="Chair",l[l.Table=1]="Table",l[l.BedL=2]="BedL",l[l.BedR=3]="BedR",l[l.DrawersShort=4]="DrawersShort",l[l.DrawersTall=5]="DrawersTall",l[l.Bookshelf=6]="Bookshelf",l[l.Shelf=7]="Shelf",l[l.Stove=8]="Stove",l[l.Bush=9]="Bush",l[l.Coin=10]="Coin",l[l.Health=11]="Health",l[l.DoorNS=12]="DoorNS",l[l.DoorEW=13]="DoorEW",l[l.LockedDoorNS=14]="LockedDoorNS",l[l.LockedDoorEW=15]="LockedDoorEW",l[l.PortcullisNS=16]="PortcullisNS",l[l.PortcullisEW=17]="PortcullisEW",l[l.TorchUnlit=18]="TorchUnlit",l[l.TorchLit=19]="TorchLit",l[l.TorchCarry=20]="TorchCarry",l[l.PurseCarry=21]="PurseCarry",l[l.Key=22]="Key",l[l.KeyCarry=23]="KeyCarry",l[l.VaultTreasureBox=24]="VaultTreasureBox",l[l.EmptyVaultTreasureBox=25]="EmptyVaultTreasureBox",l[l.LootedVaultTreasureBox=26]="LootedVaultTreasureBox",l[l.Note=27]="Note",l[l.TreasureLock=28]="TreasureLock",l[l.TreasurePlinth=29]="TreasurePlinth",l[l.TreasureA=30]="TreasureA",l[l.TreasureB=31]="TreasureB",l[l.TreasureC=32]="TreasureC",l[l.TreasureD=33]="TreasureD",l[l.TreasureE=34]="TreasureE",l);let eg={0:!1,1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,10:!1,11:!1,12:!1,13:!1,14:!1,15:!1,16:!1,17:!1,18:!1,19:!1,20:!1,21:!1,22:!1,23:!1,24:!1,25:!1,26:!1,27:!1,28:!0,29:!1,30:!0,31:!0,32:!0,33:!0,34:!0};class ey{constructor(e,t){this.itemUsed=null,this.animation=null,this.torchAnimation=null,this.pickTarget=null,this.lightActive=!1,this.idle=!1,this.idleCursorAnimation=null,this.idleCursorType="orbs",this.pos=E.clone(e),this.dir=E.fromValues(0,-1),this.healthMax=t?3:5,this.health=this.healthMax,this.loot=0,this.noisy=!1,this.preNoisy=!1,this.noiseOffset=E.fromValues(0,0),this.noisyAnim=0,this.hasVaultKey=!1,this.damagedLastTurn=!1,this.turnsRemainingUnderwater=7}applyDamage(e){this.health-=Math.min(e,this.health),this.damagedLastTurn=!0}hidden(e){return!this.lightActive&&void 0===e.guards.find(e=>e.mode==ee.ChaseVisibleTarget)&&(!!e.cells.atVec(this.pos).hidesPlayer||2==e.cells.atVec(this.pos).type&&!!(this.turnsRemainingUnderwater>0))}}let ev=[{lx:-1,ly:-1,rx:-1,ry:1,nx:-1,ny:0},{lx:-1,ly:1,rx:1,ry:1,nx:0,ny:1},{lx:1,ly:1,rx:1,ry:-1,nx:1,ny:0},{lx:1,ly:-1,rx:-1,ry:-1,nx:0,ny:-1}],eM=[{lx:-1,ly:-1,rx:-1,ry:-1,nx:-1,ny:-1},{lx:-1,ly:-1,rx:-1,ry:1,nx:-1,ny:0},{lx:-1,ly:1,rx:-1,ry:1,nx:-1,ny:1},{lx:-1,ly:1,rx:1,ry:1,nx:0,ny:1},{lx:1,ly:1,rx:1,ry:1,nx:1,ny:1},{lx:1,ly:1,rx:1,ry:-1,nx:1,ny:0},{lx:1,ly:-1,rx:1,ry:-1,nx:1,ny:-1},{lx:1,ly:-1,rx:-1,ry:-1,nx:0,ny:-1}],eT=[{dx:1,dy:0,cost:2},{dx:-1,dy:0,cost:2},{dx:0,dy:1,cost:2},{dx:0,dy:-1,cost:2},{dx:-1,dy:-1,cost:3},{dx:1,dy:-1,cost:3},{dx:-1,dy:1,cost:3},{dx:1,dy:1,cost:3}];class eS{constructor(e){this.cells=e,this.patrolRegions=[],this.patrolRoutes=[],this.items=[],this.guards=[],this.playerStartPos=E.create(),this.lightCount=0,this.numPreRevealedCells=0,this.backtrackingCoefficient=1,this.bookTitle=new Map,this.treasures=[],this.rooms=[],this.adjacencies=[]}hasLootAt(e){return this.items.some(t=>t.pos.equals(e)&&(10===t.type||t.type>=30||11===t.type||24===t.type))}collectLootAt(e){let t=[],o=this.items.some(t=>28===t.type&&t.pos.equals(e));return this.items=this.items.filter(r=>!r.pos.equals(e)||(10===r.type||11===r.type?(t.push(r),!1):r.type>=30&&!o?(t.push(r),!1):24!==r.type||(t.push(r),!1))),t}collectAllLoot(){let e=0;for(let t of(this.items=this.items.filter(t=>10!=t.type||(++e,!1)),this.guards))t.hasPurse&&(++e,t.hasPurse=!1);return e}identifyAdjacentCells(e){let t=Math.max(e[0]-1,0),o=Math.max(e[1]-1,0),r=Math.min(e[0]+2,this.cells.sizeX),a=Math.min(e[1]+2,this.cells.sizeY);for(let e=t;e<r;++e)for(let t=o;t<a;++t)this.cells.at(e,t).identified=!0}allSeen(){return!this.cells.values.some(e=>!e.seen)}numCells(){return this.cells.values.length}numCellsSeen(){let e=0;for(let t of this.cells.values)t.seen&&++e;return e}fractionRevealed(){return(this.numCellsSeen()-this.numPreRevealedCells)/(this.numCells()-this.numPreRevealedCells)}markAllSeen(){for(let e of this.cells.values)e.seen=!0,e.identified=!0}markAllUnseen(){for(let e of this.cells.values)e.seen=!1,e.identified=!1}recomputeVisibility(e){this.recomputeVisibilityFromPos(e);let t=E.create();for(let o of el)this.playerCanSeeInDirection(e,o)&&(E.add(t,e,o),this.recomputeVisibilityFromPos(t))}recomputeVisibilityFromPos(e){for(let t of ev)this.computeVisibility(e[0],e[1],e[0],e[1],t.lx,t.ly,t.rx,t.ry)}playerCanSeeInDirection(e,t){let o=E.create();return E.add(o,e,t),!(o[0]<0)&&!(o[1]<0)&&!(o[0]>=this.cells.sizeX)&&!(o[1]>=this.cells.sizeY)&&!this.cells.at(o[0],o[1]).blocksPlayerSight}computeVisibility(e,t,o,r,a,n,s,i){if(o<0||r<0||o>=this.cells.sizeX||r>=this.cells.sizeY)return;let l=o-e,f=r-t;if(l**2+f**2>400)return;l*=2,f*=2;let u=this.cells.at(o,r);if(u.seen=!0,!u.blocksPlayerSight){for(let e=0;e<2;++e)for(let t=0;t<2;++t){let u=o+2*e-1,c=r+2*t-1,d=l+2*e-1,p=f+2*t-1;u>=0&&c>=0&&u<this.cells.sizeX&&c<this.cells.sizeY&&!(a*p>n*d)&&!(d*i>p*s)&&(this.cells.at(u,c).seen=!0)}for(let u of ev){let c=l+u.lx,d=f+u.ly,p=l+u.rx,h=f+u.ry,[m,x]=a*d>n*c?[a,n]:[c,d],[g,y]=s*h>i*p?[p,h]:[s,i];g*x>y*m&&this.computeVisibility(e,t,o+u.nx,r+u.ny,m,x,g,y)}}}computeLighting(e){let t=new Set;for(let o of(null!==e&&this.cells.atVec(e.pos).type>=8&&t.add(this.cells.atVec(e.pos)),this.guards)){let e=this.cells.at(o.pos[0],o.pos[1]);e.type>=8&&t.add(e)}for(let e of this.cells.values)e.lit=0,e.litSrc.clear();let o=0;for(let e of this.items)19===e.type&&(this.castLight(e.pos,45,o,t),o++),8===e.type&&(this.castLight(e.pos,25,o,t),o++),18==e.type&&o++;for(let e of this.guards)e.hasTorch&&(e.mode!==ee.Unconscious&&this.castLight(e.pos,15,o,t),o++);null!==e&&e.lightActive&&this.castLight(e.pos,0,o,t),o++,this.lightCount=o}castLight(e,t,o,r){for(let a of(this.cells.at(e[0],e[1]).lit=1,eM))this.castLightRecursive(e[0],e[1],e[0]+a.nx,e[1]+a.ny,a.lx,a.ly,a.rx,a.ry,t,o,r)}castLightRecursive(e,t,o,r,a,n,s,i,l,f,u){if(o<0||r<0||o>=this.cells.sizeX||r>=this.cells.sizeY)return;let c=o-e,d=r-t;if(c**2+d**2>l)return;let p=this.cells.at(o,r);if(!p.litSrc.has(f)){let e=c**2+d**2;p.lit+=1/(.5*e+1),p.lit=Math.min(p.lit,1),p.litSrc.add(f)}if((!p.blocksSight||u.has(p))&&s*n>i*a)for(let p of(c*=2,d*=2,eM)){let h=c+p.lx,m=d+p.ly,x=c+p.rx,g=d+p.ry,[y,v]=a*m>n*h?[a,n]:[h,m],[M,T]=s*g>i*x?[x,g]:[s,i];y*T>v*M||this.castLightRecursive(e,t,o+p.nx,r+p.ny,y,v,M,T,l,f,u)}}allLootCollected(){return void 0===this.items.find(e=>10==e.type)}isGuardAt(e,t){return void 0!=this.guards.find(o=>o.hasMoved&&o.pos.equalsValues(e,t))}isGuardAtVec(e){return void 0!=this.guards.find(t=>t.hasMoved&&t.pos.equals(e))}guardMoveCost(e,t){let o=this.cells.atVec(t).moveCost;return o===1/0?o:e[0]!=t[0]&&e[1]!=t[1]&&(this.cells.at(e[0],t[1]).moveCost>=64||this.cells.at(t[0],e[1]).moveCost>=64)?1/0:o}posNextBest(e,t){let o=1/0,r=E.clone(t),a=E.fromValues(Math.max(0,t[0]-1),Math.max(0,t[1]-1)),n=E.fromValues(Math.min(this.cells.sizeX,t[0]+2),Math.min(this.cells.sizeY,t[1]+2));for(let s=a[0];s<n[0];++s)for(let i=a[1];i<n[1];++i){let a=e.get(s,i);if(a==1/0)continue;let n=E.fromValues(s,i);this.guardMoveCost(t,n)!=1/0&&!this.isGuardAtVec(n)&&a<o&&(o=a,r=n)}return r}nextPositions(e,t){let o=E.fromValues(Math.max(0,t[0]-1),Math.max(0,t[1]-1)),r=E.fromValues(Math.min(this.cells.sizeX,t[0]+2),Math.min(this.cells.sizeY,t[1]+2)),a=[];for(let n=o[0];n<r[0];++n)for(let s=o[1];s<r[1];++s){let o=e.get(n,s);if(o===1/0)continue;let r=E.fromValues(n,s);if(this.guardMoveCost(t,r)===1/0)continue;let i=Math.abs(t[0]-r[0])+Math.abs(t[1]-r[1]);a.push([o,i,r])}return a.sort((e,t)=>e[0]!==t[0]?e[0]-t[0]:e[1]-t[1]),a.map(e=>e[2])}patrolPathIndexForResume(e,t,o){let r=this.computeDistancesToPosition(o,void 0),a=t;for(let t=0;t<e.length;++t){let t=e[a],o=this.posNextBest(r,t),n=e[(a+e.length-1)%e.length],s=E.create();E.subtract(s,t,o);let i=E.create();if(E.subtract(i,t,n),E.dot(s,i)>0)break;a=(a+1)%e.length}return a}computeDistancesToPosition(e,t){return console.assert(e[0]>=0),console.assert(e[1]>=0),console.assert(e[0]<this.cells.sizeX),console.assert(e[1]<this.cells.sizeY),this.computeDistanceField([{priority:0,pos:E.clone(e)}],t)}computeDistancesToPositionSubrect(e,t,o,r,a){return console.assert(e[0]>=t),console.assert(e[1]>=o),console.assert(e[0]<r),console.assert(e[1]<a),this.computeDistanceFieldSubrect([{priority:0,pos:E.clone(e)}],t,o,r,a)}computeDistancesToAdjacentToPosition(e,t){let o=[];for(let t of el){let r=E.clone(e).add(t);if(r[0]<0||r[1]<0||r[0]>=this.cells.sizeX||r[1]>=this.cells.sizeY)continue;let a=this.cells.atVec(r);a.moveCost!==1/0&&o.push({priority:a.moveCost,pos:r})}return this.computeDistanceField(o,t)}computeDistanceField(e,t){let o=this.cells.sizeX,r=this.cells.sizeY,a=[],n=new ec(o,r,1/0);for(let t of e)ew(a,t);let s=void 0===t?1:this.numNavigableSquaresInRect(t);for(;a.length>0&&s>0;){let e=e_(a);if(!(e.priority>=n.get(e.pos[0],e.pos[1])))for(let i of(n.set(e.pos[0],e.pos[1],e.priority),void 0!==t&&e.pos[0]>=t.posMin[0]&&e.pos[1]>=t.posMin[1]&&e.pos[0]<t.posMax[0]&&e.pos[1]<t.posMax[1]&&--s,eT)){let t=E.fromValues(e.pos[0]+i.dx,e.pos[1]+i.dy);if(t[0]<0||t[1]<0||t[0]>=o||t[1]>=r)continue;let s=this.guardMoveCost(e.pos,t);if(s==1/0)continue;let l=e.priority+s+i.cost;l<n.get(t[0],t[1])&&ew(a,{priority:l,pos:t})}}return n}numNavigableSquaresInRect(e){let t=0;for(let o=e.posMin[0];o<e.posMax[0];++o)for(let r=e.posMin[1];r<e.posMax[1];++r)this.cells.at(o,r).moveCost!==1/0&&++t;return t}computeDistanceFieldSubrect(e,t,o,r,a){console.assert(t>=0),console.assert(o>=0),console.assert(r<=this.cells.sizeX),console.assert(a<=this.cells.sizeY);let n=r-t,s=a-o,i=[],l=new ec(n,s,1/0);for(let r of e)ew(i,{priority:r.priority,pos:[r.pos[0]-t,r.pos[1]-o]});for(;i.length>0;){let e=e_(i);if(e.priority>=l.get(e.pos[0],e.pos[1]))continue;l.set(e.pos[0],e.pos[1],e.priority);let r=E.fromValues(e.pos[0]+t,e.pos[1]+o);for(let a of eT){let f=E.fromValues(e.pos[0]+a.dx,e.pos[1]+a.dy);if(f[0]<0||f[1]<0||f[0]>=n||f[1]>=s)continue;let u=E.fromValues(f[0]+t,f[1]+o),c=this.guardMoveCost(r,u);if(c==1/0)continue;let d=e.priority+c+a.cost;d<l.get(f[0],f[1])&&ew(i,{priority:d,pos:f})}}return l}guardsInEarshot(e,t){let o=this.cells.sizeX,r=this.cells.sizeY,a=new Map;for(let e of this.guards)e.mode!==ee.Unconscious&&a.set(o*e.pos[1]+e.pos[0],e);let n=[],s=new ec(o,r,1/0),i=[];for(ew(n,{priority:0,pos:e});n.length>0;){let e=e_(n);if(e.priority>=s.get(e.pos[0],e.pos[1]))continue;s.set(e.pos[0],e.pos[1],e.priority);let l=a.get(o*e.pos[1]+e.pos[0]);for(let a of(void 0!==l&&i.push(l),eT)){let i=E.fromValues(e.pos[0]+a.dx,e.pos[1]+a.dy);if(i[0]<0||i[1]<0||i[0]>=o||i[1]>=r)continue;let l=e.priority+a.cost;l>t||this.cells.at(i[0],i[1]).blocksSound||l>=s.get(i[0],i[1])||ew(n,{priority:l,pos:i})}}return i}tryGetPosLookAt(e,t){let o=e[0],r=e[1];if(t){let e=this.items.filter(e=>2>Math.abs(e.pos[0]-o)&&2>Math.abs(e.pos[1]-r)&&(15===e.type||14===e.type));if(e.find(e=>e.pos[0]===o-1&&e.pos[1]===r))return E.fromValues(o+1,r);if(e.find(e=>e.pos[0]===o+1&&e.pos[1]===r))return E.fromValues(o-1,r);if(e.find(e=>e.pos[0]===o&&e.pos[1]===r-1))return E.fromValues(o,r+1);else if(e.find(e=>e.pos[0]===o&&e.pos[1]===r+1))return E.fromValues(o,r-1);if(o>0&&30===this.cells.at(o-1,r).type)return E.fromValues(o+1,r);if(o<this.cells.sizeX-1&&30===this.cells.at(o+1,r).type)return E.fromValues(o-1,r);if(r>0&&31===this.cells.at(o,r-1).type)return E.fromValues(o,r+1);else if(r<this.cells.sizeY-1&&31==this.cells.at(o,r+1).type)return E.fromValues(o,r-1)}if(o>0&&25==this.cells.at(o-1,r).type)return E.fromValues(o-1,r);if(o<this.cells.sizeX-1&&24==this.cells.at(o+1,r).type)return E.fromValues(o+1,r);if(r>0&&27==this.cells.at(o,r-1).type)return E.fromValues(o,r-1);if(r<this.cells.sizeY-1&&26==this.cells.at(o,r+1).type)return E.fromValues(o,r+1);if(this.items.find(t=>t.pos.equals(e)&&0===t.type)){let e=this.items.filter(e=>2>Math.abs(e.pos[0]-o)&&2>Math.abs(e.pos[1]-r)&&(1===e.type||19===e.type||18===e.type));if(e.find(e=>e.pos[0]===o-1&&e.pos[1]===r))return E.fromValues(o-1,r);if(e.find(e=>e.pos[0]===o+1&&e.pos[1]===r))return E.fromValues(o+1,r);if(e.find(e=>e.pos[0]===o&&e.pos[1]===r-1))return E.fromValues(o,r-1);if(e.find(e=>e.pos[0]===o&&e.pos[1]===r+1))return E.fromValues(o,r+1)}}}function e_(e){let t=e[0];e[0]=e[e.length-1],e.pop();let o=0,r=e.length;for(;;){let t=o,a=2*o+1;a<r&&e[a].priority<e[t].priority&&(t=a);let n=a+1;if(n<r&&e[n].priority<e[t].priority&&(t=n),t==o)break;[e[o],e[t]]=[e[t],e[o]],o=t}return t}function ew(e,t){e.push(t);let o=e.length-1;for(;o>0;){let t=Math.floor((o-1)/2);if(e[o].priority>=e[t].priority)break;[e[o],e[t]]=[e[t],e[o]],o=t}}function eb(e,t){let o=e.indexOf(t);e.splice(o,1)}var eI=((f={})[f.Exterior=0]="Exterior",f[f.PublicCourtyard=1]="PublicCourtyard",f[f.PublicRoom=2]="PublicRoom",f[f.PrivateCourtyard=3]="PrivateCourtyard",f[f.PrivateRoom=4]="PrivateRoom",f[f.Vault=5]="Vault",f[f.Bedroom=6]="Bedroom",f[f.Dining=7]="Dining",f[f.PublicLibrary=8]="PublicLibrary",f[f.PrivateLibrary=9]="PrivateLibrary",f[f.Kitchen=10]="Kitchen",f[f.Treasure=11]="Treasure",f[f.TreasureCourtyard=12]="TreasureCourtyard",f[f.LockedTreasure=13]="LockedTreasure",f[f.LockedTreasureCourtyard=14]="LockedTreasureCourtyard",f[f.ThroneRoom=15]="ThroneRoom",f),eA=((u={})[u.Standard=0]="Standard",u[u.GateFront=1]="GateFront",u[u.GateBack=2]="GateBack",u[u.Locked=3]="Locked",u);function eC(e,t){let[o,r]=t;return!!(e.at(o-1,r).type>=ep.PortcullisNS)||!!(e.at(o+1,r).type>=ep.PortcullisNS)||!!(e.at(o,r-1).type>=ep.PortcullisNS)||!!(e.at(o,r+1).type>=ep.PortcullisNS)}function eP(e,t){let[o,r]=t;return!!(J(e.at(o-1,r).type)||J(e.at(o+1,r).type)||J(e.at(o,r-1).type)||J(e.at(o,r+1).type))}function ek(e,t){let[o,r]=t;return!!(Q(e.at(o-1,r).type)||Q(e.at(o+1,r).type)||Q(e.at(o,r-1).type)||Q(e.at(o,r+1).type))}function eL(e,t){return!(e.cells.atVec(t).type>=ep.Wall0000)&&(!!(t[0]>=0)&&!!(e.cells.at(t[0]-1,t[1]).type>=ep.Wall0000)||!!(t[1]>=0)&&!!(e.cells.at(t[0],t[1]-1).type>=ep.Wall0000)||!!(t[0]+1<e.cells.sizeX)&&!!(e.cells.at(t[0]+1,t[1]).type>=ep.Wall0000)||!!(t[1]+1<e.cells.sizeY)&&!!(e.cells.at(t[0],t[1]+1).type>=ep.Wall0000))}function eR(e,t,o,r,a,n){let s=n.sizeX,i=n.sizeY,l=[];{let u=[];{let e=[];for(let t=0;t<s;++t){let s=o.get(t,0),i=o.get(t+1,0),f=r.get(t,0),u={origin:E.fromValues(s,f),dir:E.fromValues(1,0),length:i-s,roomLeft:a[n.get(t,0)],roomRight:a[0],nextMatching:null,door:!1,doorType:eA.Standard};u.nextMatching=u,e.push(u),l.push(u)}u.push(e)}for(let e=1;e<i;++e){let t=[];function f(e,o,r,n,s){if(r-o<=0)return;let i={origin:E.fromValues(o,e),dir:E.fromValues(1,0),length:r-o,roomLeft:a[n],roomRight:a[s],nextMatching:null,door:!1,doorType:eA.Standard};i.nextMatching=i,t.push(i),l.push(i)}let s=0,i=0;for(;s<o.sizeX&&i<o.sizeX;){let t=s<o.sizeX?o.get(s,e):1/0,a=i<o.sizeX?o.get(i,e-1):1/0,l=r.get(Math.max(0,Math.max(s,i)-1),e);t<a?(f(l,t,Math.min(a,s+1<o.sizeX?o.get(s+1,e):1/0),s>=n.sizeX?0:n.get(s,e),i<=0?0:n.get(i-1,e-1)),++s):(f(l,a,Math.min(t,i+1<o.sizeX?o.get(i+1,e-1):1/0),s<=0?0:n.get(s-1,e),i>=n.sizeX?0:n.get(i,e-1)),++i)}u.push(t)}{let e=[];for(let t=0;t<s;++t){let s=o.get(t,i-1),f=o.get(t+1,i-1),u=r.get(t,i),c={origin:E.fromValues(s,u),dir:E.fromValues(1,0),length:f-s,roomLeft:a[0],roomRight:a[n.get(t,i-1)],nextMatching:null,door:!1,doorType:eA.Standard};c.nextMatching=c,e.push(c),l.push(c)}u.push(e)}if(e)for(let e=0;e<u.length;++e){let t=u[e],o=0,r=t.length-1;for(;o<=r;)eD(t[o],t[r]),o+=1,r-=1}if(t){let e=0,t=u.length-1;for(;e<t;){let o=u[e],r=u[t];console.assert(o.length==r.length);for(let e=0;e<o.length;++e)eD(o[e],r[e]);e+=1,t-=1}}}{let f=[];{let e=[];for(let t=0;t<i;++t){let s=r.get(0,t),i=r.get(0,t+1),f=o.get(0,t),u={origin:E.fromValues(f,s),dir:E.fromValues(0,1),length:i-s,roomLeft:a[0],roomRight:a[n.get(0,t)],nextMatching:null,door:!1,doorType:eA.Standard};u.nextMatching=u,e.push(u),l.push(u)}f.push(e)}for(let e=1;e<s;++e){let t=[];function u(e,o,r,n,s){if(r-o<=0)return;let i={origin:E.fromValues(e,o),dir:E.fromValues(0,1),length:r-o,roomLeft:a[n],roomRight:a[s],nextMatching:null,door:!1,doorType:eA.Standard};i.nextMatching=i,t.push(i),l.push(i)}let s=0,i=0;for(;s<r.sizeY&&i<r.sizeY;){let t=s<r.sizeY?r.get(e-1,s):1/0,a=i<r.sizeY?r.get(e,i):1/0,l=o.get(e,Math.max(0,Math.max(s,i)-1));t<a?(u(l,t,Math.min(a,s+1<r.sizeY?r.get(e-1,s+1):1/0),s>=n.sizeY?0:n.get(e-1,s),i<=0?0:n.get(e,i-1)),++s):(u(l,a,Math.min(t,i+1<r.sizeY?r.get(e,i+1):1/0),s<=0?0:n.get(e-1,s-1),i>=n.sizeY?0:n.get(e,i)),++i)}f.push(t)}{let e=[];for(let t=0;t<i;++t){let i=r.get(s-1,t),f=r.get(s-1,t+1),u=o.get(s,t),c={origin:E.fromValues(u,i),dir:E.fromValues(0,1),length:f-i,roomLeft:a[n.get(s-1,t)],roomRight:a[0],nextMatching:null,door:!1,doorType:eA.Standard};c.nextMatching=c,e.push(c),l.push(c)}f.push(e)}if(t)for(let e=0;e<f.length;++e){let t=f[e],o=Math.floor(t.length/2);for(let e=0;e<o;++e)eD(t[e],t[t.length-1-e])}if(e){let e=0,t=f.length-1;for(;e<t;){let o=f[e],r=f[t];for(let e=0;e<o.length;++e)eD(o[e],r[e]);e+=1,t-=1}}}return l}function eD(e,t){eW(e).nextMatching=t,eW(t).nextMatching=e}function eW(e){let t=e;for(;null!==t.nextMatching&&t.nextMatching!==e;)t=t.nextMatching;return t}function eG(e){eW(e).nextMatching=e.nextMatching,e.nextMatching=e}function eV(e){let t=[],o=e;for(;;){let r=o.nextMatching;if(t.push(o),null===r||r===e)break;o=r}return t}function eE(e){for(let t of e)t.roomLeft.edges.push(t),t.roomRight.edges.push(t)}function eB(e,t,o){let r=o.roomLeft,a=o.roomRight;for(let e of a.edges)e!==o&&(r.edges.push(e),e.roomLeft===a?e.roomLeft=r:(console.assert(e.roomRight===a),e.roomRight=r));let n=E.fromValues(Math.min(r.posMin[0],a.posMin[0]),Math.min(r.posMin[1],a.posMin[1])),s=E.fromValues(Math.max(r.posMax[0],a.posMax[0]),Math.max(r.posMax[1],a.posMax[1]));for(E.copy(r.posMin,n),E.copy(r.posMax,s),r.depth=Math.min(r.depth,a.depth),eG(o),eb(t,o),eb(r.edges,o),eb(e,a);function(e,t){for(let o of t.edges)for(let r of t.edges){if(o===r||!function(e,t){if(1!==Math.abs(e.dir.dot(t.dir)))return!1;let o=E.create();E.scaleAndAdd(o,e.origin,e.dir,e.length);let r=E.create();if(E.scaleAndAdd(r,t.origin,t.dir,t.length),t.roomLeft===e.roomLeft&&t.roomRight===e.roomRight){if(o.equals(t.origin))return!0;else if(r.equals(e.origin))return!0}else if(t.roomLeft===e.roomRight&&t.roomRight===e.roomLeft){if(o.equals(r))return!0;else if(e.origin.equals(t.origin))return!0}return!1}(o,r))continue;let a=o.dir[0]>=0?Math.min(o.origin[0],r.origin[0]):Math.max(o.origin[0],r.origin[0]),n=o.dir[1]>=0?Math.min(o.origin[1],r.origin[1]):Math.max(o.origin[1],r.origin[1]),s=o.length+r.length;o.origin[0]=a,o.origin[1]=n,o.length=s,eG(o),eG(r),o.door=o.door||r.door,o.doorType=Math.max(o.doorType,r.doorType);let i=o.roomLeft===t?o.roomRight:o.roomLeft;return eb(t.edges,r),eb(i.edges,r),eb(e,r),!0}return!1}(t,r););}function eN(e,t,o){let r=new Set;for(let a of t){if(r.has(a))continue;let t=eV(a);for(let e of t)r.add(e);if((console.assert(t.every(e=>e.length===a.length)),!(a.length<2))&&o(a))for(let o of t)o.door||(o.door=!0,o.doorType=eA.Standard,function(e,t,o){if(t!==o)for(let r of e)r.group===t&&(r.group=o)}(e,o.roomLeft.group,o.roomRight.group))}}let eF=["Alien","Aliens","Amulet","Amulets","Arm","Arms","Armor","Armor","Arrow","Arrows","Attack","Attacks","Aura","Aurae","Awakening","Awakenings","Axe","Axes","Bane","Banes","Battle-Axe","Battle-Axes","Blood","Bloods","Breath","Breaths","Captive","Captives","Castle","Castles","Catacomb","Catacombs","Cave","Caves","Chamber","Chambers","Champion","Champions","Child","Children","Citadel","Citadels","City","Cities","Claw","Claws","Cow","Cows","Crown","Crowns","Crusade","Crusades","Crystal","Crystals","Curse","Curses","Dagger","Daggers","Daughter","Daughters","Dawn","Dawn","Day","Days","Dungeon","Dungeons","Dragon","Dragons","Eye","Eyes","Field","Fields","Fire","Fires","Fist","Fists","Forest","Forests","Fortress","Fortresses","Fugitive","Fugitives","Game","Games","Gem","Gems","Guardian","Guardians","Hand","Hands","Helm","Helms","Horde","Hordes","Hour","Hours","Keep","Keeps","Key","Keys","Knight","Knights","Land","Lands","Legend","Legends","Lord","Lords","Master","Masters","Mercenary","Mercenaries","Mind","Minds","Mine","Mines","Minion","Minions","Mirror","Mirrors","Night","Nights","Moon","Moons","Omen","Omens","Orb","Orbs","Path","Paths","Pit","Pits","Plague","Plagues","Pool","Pools","Potion","Potions","Prince","Princes","Princess","Princesses","Prison","Prisons","Prisoner","Prisoners","Prophecy","Prophecies","Quest","Quests","Rampage","Rampages","Realm","Realms","Reaper","Reapers","Rebirth","Rebirths","Return","Returns","Revenge","Revenges","Ring","Rings","Rise","Rise","River","Rivers","Scroll","Scrolls","Serpent","Serpents","Servant","Servants","Shadow","Shadows","Shield","Shields","Sign","Signs","Siren","Sirens","Slave","Slaves","Son","Sons","Spawn","Spawn","Spear","Spears","Spell","Spells","Sphere","Spheres","Staff","Staves","Stronghold","Strongholds","Sword","Swords","Thief","Thieves","Threat","Threats","Throne","Thrones","Tower","Towers","Trail","Trails","Trial","Trials","Valley","Valleys","Wand","Wands","Warrior","Warriors","Weapon","Weapons","Wind","Winds","Witch","Witches","Wizard","Wizards"],eO=["Adventure","Agony","the Ancients","Anger","Avenging","Battle","Beholding","Brilliance","Danger","Darkness","Death","Deception","Despair","Destiny","Destruction","Disease","Ecstacy","Enchantment","Enlightenment","Eternity","Evil","Falsehood","Famine","Fantasy","Fate","Fear","Flame","Foretelling","Forewarning","Fortune","Fury","Gallantry","Gingivitis","the Gods","Intrigue","Keeping","Legend","the Living Dead","Lore","Madness","Magic","Menace","Midnight","Might","Murder","Mystery","Power","Prophecy","Radiance","Rebellion","Reckoning","Remembrance","Shadow","Sickness","Strength","Suffering","Terror","Time","Truth","the Undead","the Universe","Unraveling","Valor","Vengeance","Venom","War"],ez=["Administrative Law","Arbitrage","Attorney-Client Privilege","Attractive Nuisances","Bankruptcy","Civil Procedure","Community Property","Comparative Legal Traditions","Contract Law","Consideration","Corporate Finance","Corporate Taxation","Criminal Law","Cross-Examination","Damages","Discovery","Economics","Embezzlement","Estate Planning","Estoppel","Homicide","Income Taxation","Intangible Property","International Transactions","Intestate Succession","Probate","Promissory Estoppel","Property","Quid Pro Quo","Reckless Disregard","Regulatory Policy","Securities Regulation","Security Interests","Statutory Law","Torts","Trial Procedure","Wills, Trusts, and Estates"];function eH(e,t,o,r){let a=[...ez];r.shuffleArray(a);let n=0,s=[...eF];r.shuffleArray(s);let i=0,l=new Map;for(let e of t){let t=[];for(let r of o)r.pos[0]>=e.posMin[0]&&r.pos[1]>=e.posMin[1]&&r.pos[0]<e.posMax[0]&&r.pos[1]<e.posMax[1]&&t.push(r);t.length>0&&l.set(e,t)}for(let t of l){let o=t[0],l=t[1],f=E.create(),u=E.create();o.posMax[0]-o.posMin[0]>=o.posMax[1]-o.posMin[1]?(E.set(f,1,0),E.set(u,0,-1)):(E.set(f,0,-1),E.set(u,1,0)),l.sort((e,t)=>{let o=E.dot(f,e.pos),r=E.dot(f,t.pos);return o<r?-1:o>r?1:(o=E.dot(u,e.pos))<(r=E.dot(u,t.pos))?-1:+(o>r)});let c=[];for(let e=0;e<l.length;++e){let e;if(o.privateRoom){let t=s[i];i=(i+1)%s.length,e=t+" of "+eO[r.randomInRange(eO.length)]}else e=a[n],n=(n+1)%a.length;c.push(e)}c.sort((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"}));for(let t=0;t<l.length;++t)e.set(l[t],c[t])}}function eX(e,t,o){e.items.push({pos:E.clone(t),type:o,topLayer:eg[o]})}function eq(e,t,o){eC(e.cells,t)||(o==ex.TorchUnlit||o==ex.TorchLit)&&eP(e.cells,t)||eX(e,t,o)}function eY(e,t){return 0===e||.05>t.random()?ex.TorchUnlit:ex.TorchLit}function eU(e,t){return .25>t.random()?ex.Table:eY(e,t)}function ej(e){return e>=ex.DoorNS&&e<=ex.PortcullisEW}function eK(e){return e===ex.DrawersTall||e===ex.Bookshelf||e===ex.Shelf||e===ex.Stove||e===ex.TreasureLock}function e$(e){switch(e){case ex.Chair:case ex.Table:case ex.DrawersShort:case ex.DrawersTall:case ex.Bookshelf:case ex.Shelf:case ex.Bush:return!0;default:return!1}}function eQ(e,t){let o=new Set;for(let t of e)t.roomType!==eI.Exterior&&t.roomType!==eI.Vault&&o.add(t);let r=new Set,a=[],n=Array.from(o);return!function e(n){a.push(n),r.add(n);let s=[...n.edges];for(let i of(t.shuffleArray(s),s)){if(!i.door)continue;let t=i.roomLeft===n?i.roomRight:i.roomLeft;!r.has(t)&&o.has(t)&&(e(t),a.push(n))}}(n[t.randomInRange(n.length)]),--a.length,function(e){let t=[];for(let o of e)t.push({room:o,nodeNext:null,nodePrev:null,visited:!1});for(let o=0;o<e.length;++o)t[o].nodeNext=t[(o+1)%t.length],t[o].nodePrev=t[(o+t.length-1)%t.length];return t}(a)}function eJ(e,t,o){let r=e4(eQ(t,o),e,o);return console.assert(1===r.length),r}function eZ(e){for(let t of e)if(null!==t.nodeNext&&null!==t.nodePrev&&t.nodeNext.room===t.nodePrev.room)return t}function e0(e,t,o,r,a,n){let s=a.filter(t=>t.door&&e2(e,t.roomLeft)&&e2(e,t.roomRight));n.shuffleArray(s);let i=[],l=new Map,f=26-2*t;for(let e of s){let t=e.roomLeft,o=e.roomRight,r=l.get(t);void 0===r&&(r=[],l.set(t,r));let a=l.get(o);void 0===a&&(a=[],l.set(o,a));let s=eZ(r),u=eZ(a);if(s)if(u){if(!function(e,t,o){if(e6(e,t)){if(!function(e,t){let o=e.nodePrev,r=e.nodeNext;for(;;){if(o===r)return o===t;if(null===o||null===r||o===e||r===e||o.room!==r.room)return!1;o=o.nodePrev,r=r.nodeNext}}(e,t)||4>=e8(e))return!1}else if(e8(e)+e8(t)+2>o)return!1;return!0}(s,u,f))continue;let e={room:t,nodeNext:null,nodePrev:null,visited:!1},c={room:o,nodeNext:null,nodePrev:null,visited:!1},d=s.nodeNext,p=u.nodeNext;s.nodeNext=c,c.nodePrev=s,c.nodeNext=p,null!==p&&(p.nodePrev=c),u.nodeNext=e,e.nodePrev=u,e.nodeNext=d,null!==d&&(d.nodePrev=e),r.push(e),a.push(c),i.push(e),i.push(c),e6(s,u)||(.5>n.random()?e5(s,i,l):e5(u,i,l))}else{if(e8(s)+2>f)continue;let e={room:t,nodeNext:null,nodePrev:null,visited:!1},n={room:o,nodeNext:null,nodePrev:null,visited:!1},l=s.nodeNext;s.nodeNext=n,n.nodePrev=s,n.nodeNext=e,e.nodePrev=n,e.nodeNext=l,null!==l&&(l.nodePrev=e),r.push(e),a.push(n),i.push(e),i.push(n)}else if(u){if(e8(u)+2>f)continue;let e={room:t,nodeNext:null,nodePrev:null,visited:!1},n={room:o,nodeNext:null,nodePrev:null,visited:!1},s=u.nodeNext;u.nodeNext=e,e.nodePrev=u,e.nodeNext=n,n.nodePrev=e,n.nodeNext=s,null!==s&&(s.nodePrev=n),r.push(e),a.push(n),i.push(e),i.push(n)}else{let e={room:t,nodeNext:null,nodePrev:null,visited:!1},n={room:o,nodeNext:null,nodePrev:null,visited:!1};e.nodeNext=n,e.nodePrev=n,n.nodeNext=e,n.nodePrev=e,r.push(e),a.push(n),i.push(e),i.push(n)}}for(let t of r){if(!e2(e,t))continue;{let e=l.get(t);if(void 0!==e&&e.length>0)continue}let o=t.edges.filter(t=>t.door&&e2(e,t.roomLeft)&&e2(e,t.roomRight));if(0===o.length)continue;let r=o[n.randomInRange(o.length)],a=r.roomLeft,s=r.roomRight,f=l.get(a);void 0===f&&(f=[],l.set(a,f));let u=l.get(s);void 0===u&&(u=[],l.set(s,u));let c={room:a,nodeNext:null,nodePrev:null,visited:!1},d={room:s,nodeNext:null,nodePrev:null,visited:!1};c.nodeNext=d,c.nodePrev=d,d.nodeNext=c,d.nodePrev=c,f.push(c),u.push(d),i.push(c),i.push(d)}for(let e of i)e.visited=!1;for(let e of i){if(e.visited)continue;if(e8(e)>2){e7(e);continue}let t=Number.MAX_SAFE_INTEGER,o=[],r=e.nodeNext,a=e.room,s=r.room,i=l.get(a),f=l.get(s);for(let r of i){if(r===e)continue;let a=e8(r);a>t||(a<t&&(t=a,o.length=0),o.push([e,r]))}for(let e of f){if(e===r)continue;let a=e8(e);a>t||(a<t&&(t=a,o.length=0),o.push([r,e]))}if(0===o.length){e7(e);continue}let[u,c]=o[n.randomInRange(o.length)],d=u.nodePrev,p=c.nodePrev;d.nodeNext=c,c.nodePrev=d,p.nodeNext=u,u.nodePrev=p,e7(e)}for(let e of s){let t=e.roomLeft,o=e.roomRight,r=l.get(t);void 0===r&&(r=[],l.set(t,r));let a=l.get(o);void 0===a&&(a=[],l.set(o,a));let n=e1(r),s=e1(a);if(void 0===n||void 0===s||e6(n,s))continue;let f=e8(n),u=e8(s);if(f>2&&u>2)continue;let c={room:t,nodeNext:null,nodePrev:null,visited:!1},d={room:o,nodeNext:null,nodePrev:null,visited:!1},p=n.nodeNext,h=s.nodePrev;n.nodeNext=s,s.nodePrev=n,h.nodeNext=d,d.nodePrev=h,d.nodeNext=c,c.nodePrev=d,c.nodeNext=p,p.nodePrev=c,r.push(c),a.push(d),i.push(c),i.push(d)}return t>=8&&(i=i.concat(eQ(r,n))),e4(i,o,n)}function e1(e){let t;if(void 0===e)return;let o=Number.MAX_SAFE_INTEGER;for(let r of e){let e=e8(r);e<o&&(o=e,t=r)}return t}function e2(e,t){return t.roomType!==eI.Vault&&(t.roomType!==eI.Exterior||e===ed.Warrens&&!(t.gridX<0))}function e5(e,t,o){if(null!==e.nodePrev)for(e.nodePrev.nodeNext=null;;){let r=e.nodeNext;e.nodePrev=null,e.nodeNext=null,eb(t,e);let a=o.get(e.room);if(void 0!==a&&eb(a,e),null===r)break;e=r}}function e4(e,t,o){for(let t of e)t.visited=!1;let r=[];for(let a of e){if(a.visited)continue;if(null==a.nodeNext&&null==a.nodePrev){a.visited=!0;continue}let e=function(e){let t=e;for(;null!=t.nodePrev&&(t=t.nodePrev)!=e;);return t}(a),n=[],s=new Set;for(let r=e;null!=r&&!r.visited;r=r.nodeNext){r.visited=!0;let e=r.nodeNext,a=r.nodePrev;if(null==e||null==a)continue;let i=r.room,l=e.room,f=a.room;s.add(i);let u=E.create();if(e9(u,i,f,t),l===f){let e=function(e,t){let o=[];for(let r=t.posMin[0];r<t.posMax[0];++r)t.posMin[1]>0&&e.cells.at(r,t.posMin[1]-1).type==ep.OneWayWindowS&&0===e.cells.at(r,t.posMin[1]).moveCost&&o.push(E.fromValues(r,t.posMin[1])),t.posMax[1]<e.cells.sizeY&&e.cells.at(r,t.posMax[1]).type==ep.OneWayWindowN&&0===e.cells.at(r,t.posMax[1]-1).moveCost&&o.push(E.fromValues(r,t.posMax[1]-1));for(let r=t.posMin[1];r<t.posMax[1];++r)t.posMin[0]>0&&e.cells.at(t.posMin[0]-1,r).type==ep.OneWayWindowW&&0===e.cells.at(t.posMin[0],r).moveCost&&o.push(E.fromValues(t.posMin[0],r)),t.posMax[0]<e.cells.sizeX&&e.cells.at(t.posMax[0],r).type==ep.OneWayWindowE&&0===e.cells.at(t.posMax[0]-1,r).moveCost&&o.push(E.fromValues(t.posMax[0]-1,r));if(o.length>0)return o;for(let r of e.items)r.type==ex.Chair&&r.pos[0]>=t.posMin[0]&&r.pos[1]>=t.posMin[1]&&r.pos[0]<t.posMax[0]&&r.pos[1]<t.posMax[1]&&o.push(E.clone(r.pos));return o}(t,i),r=E.create();for(let a of(e.length>0?E.copy(r,e[o.randomInRange(e.length)]):te(r,i,f,t),tt(t,i,u,r)))n.push(a);n.push(E.clone(r));let a=t.tryGetPosLookAt(r,!1);if(void 0!==a){let e=E.create();E.subtract(e,a,r),function(e,t){let o=E.create();for(let r=t.length-1;r>0&&(E.subtract(o,t[r],t[r-1]),!o.equals(e));--r)if(0>=E.dot(o,e))return!0;return!1}(e,n)&&n.push(E.clone(r))}n.push(E.clone(r)),n.push(E.clone(r)),E.copy(u,r)}let c=E.create();for(let e of(e9(c,i,l,t),tt(t,i,u,c)))n.push(e)}let i=e3(n,o.randomInRange(n.length)),l=Array.from(s),f=l.reduce((e,t)=>Math.min(e,t.depth),1/0),u=l.reduce((e,t)=>Math.max(e,t.depth),0);r.push({path:i,minRoomDepth:f,maxRoomDepth:u})}return o.shuffleArray(r),r}function e3(e,t){let o=[];for(let r=t;r<e.length;++r)o.push(e[r]);for(let r=0;r<t;++r)o.push(e[r]);return o}function e6(e,t){let o=e;for(;;){if(o===t)return!0;if(null===o.nodeNext||(o=o.nodeNext)===e)break}return!1}function e8(e){let t=0,o=e;for(;++t,null!==o.nodeNext&&(o=o.nodeNext)!==e;);return t}function e7(e){let t=e;for(;t.visited=!0,null!==t.nodeNext&&(t=t.nodeNext)!==e;);}function e9(e,t,o,r){for(let a of t.edges)if(a.roomLeft===t&&a.roomRight===o||a.roomLeft===o&&a.roomRight===t){for(let t=1;t<a.length;++t){E.scaleAndAdd(e,a.origin,a.dir,t);let o=r.cells.atVec(e).type;if(o>=ep.PortcullisNS&&o<=ep.GardenDoorEW)return}for(let t=1;t<a.length;++t)if(E.scaleAndAdd(e,a.origin,a.dir,t),r.cells.atVec(e).type<=ep.GroundTreasure)return;E.scaleAndAdd(e,a.origin,a.dir,Math.floor(a.length/2));return}E.zero(e)}function te(e,t,o,r){for(let a of t.edges)if(a.roomLeft===t&&a.roomRight===o){let n=E.create();e9(n,t,o,r);let s=E.fromValues(-a.dir[1],a.dir[0]);E.scaleAndAdd(e,n,s,2),0!=r.cells.at(e[0],e[1]).moveCost&&E.scaleAndAdd(e,n,s,1);return}else if(a.roomLeft===o&&a.roomRight===t){let n=E.create();e9(n,t,o,r);let s=E.fromValues(a.dir[1],-a.dir[0]);E.scaleAndAdd(e,n,s,2),0!=r.cells.at(e[0],e[1]).moveCost&&E.scaleAndAdd(e,n,s,1);return}E.zero(e)}function tt(e,t,o,r){let a=Math.max(0,t.posMin[0]-1),n=Math.max(0,t.posMin[1]-1),s=Math.min(e.cells.sizeX,t.posMax[0]+1),i=Math.min(e.cells.sizeY,t.posMax[1]+1),l=e.computeDistancesToPositionSubrect(r,a,n,s,i),f=E.clone(o),u=[];for(;!f.equals(r);){u.push(E.clone(f));let o=function(e,t,o,r){let a=1/0,n=E.clone(r),s=Math.max(0,t.posMin[0]-1),i=Math.max(0,t.posMin[1]-1),l=Math.min(e.cells.sizeX,t.posMax[0]+1),f=Math.min(e.cells.sizeY,t.posMax[1]+1),u=E.fromValues(Math.max(s,r[0]-1),Math.max(i,r[1]-1)),c=E.fromValues(Math.min(l,r[0]+2),Math.min(f,r[1]+2));for(let t=u[0];t<c[0];++t)for(let l=u[1];l<c[1];++l){let f=o.get(t-s,l-i);if(f==1/0)continue;let u=E.fromValues(t,l);e.guardMoveCost(r,u)!=1/0&&f<a&&(a=f,n=u)}if(n.equals(r)){console.log("failed to proceed");for(let e=u[0];e<c[0];++e)for(let t=u[1];t<c[1];++t){let r=o.get(e-s,t-i);console.log(e,t,r)}}return n}(e,t,l,f);if(o.equals(f))break;E.copy(f,o)}return u}function to(e,t,o,r,a,n){if(e<2)return;if(e<8)return void tr(e,t,o,r,a,n);let s=o.find(e=>e.roomType===eI.Vault);if(void 0===s)return void tr(e,t,o,r,a,n);let i=[ep.GroundGrass,ep.GroundMarble,ep.GroundWood];for(let e of s.edges)if(e.doorType===eA.Locked){let o=e.origin,r=e.roomLeft.roomType===eI.Vault?e.roomRight:e.roomLeft;for(let n=0;n<e.length;n++){if(t.cells.atVec(o).type===ep.DoorEW||t.cells.atVec(o).type===ep.DoorNS){if(0===e.dir[0])for(let e of[-1,1]){let n=o.add(new E(e,0));if(i.includes(t.cells.atVec(n).type))return void a.push({path:[n],minRoomDepth:r.depth,maxRoomDepth:r.depth})}if(0===e.dir[1])for(let e of[-1,1]){let n=o.add(new E(0,e));if(i.includes(t.cells.atVec(n).type))return void a.push({path:[n],minRoomDepth:r.depth,maxRoomDepth:r.depth})}}o=o.add(e.dir)}}}function tr(e,t,o,r,a,n){let s=new ef(t.cells.sizeX,t.cells.sizeY,!1);for(let e of a)for(let t of e.path)s.set(t[0],t[1],!0);for(let e of t.items)(e.type===ex.Coin||e.type===ex.Health||e.type>=ex.TreasureA||e.type===ex.Note)&&s.set(e.pos[0],e.pos[1],!0);let i=[];if(e>=4)for(let e of t.items){if(e.type!==ex.Chair||s.get(e.pos[0],e.pos[1]))continue;let o=!1;for(let r of t.items){if(r.type===ex.Table){if(Math.abs(r.pos[0]-e.pos[0])+Math.abs(r.pos[1]-e.pos[1])===1){o=!0;break}}}o&&i.push(e.pos)}for(let e of o){for(let o=e.posMin[0];o<e.posMax[0];++o)e.posMin[1]>0&&(t.cells.at(o,e.posMin[1]-1).type!=ep.OneWayWindowS||0!==t.cells.at(o,e.posMin[1]).moveCost||t.cells.at(o,e.posMin[1]+1).moveCost===1/0||s.get(o,e.posMin[1])||i.push(E.fromValues(o,e.posMin[1]))),e.posMax[1]<t.cells.sizeY&&(t.cells.at(o,e.posMax[1]).type!=ep.OneWayWindowN||0!==t.cells.at(o,e.posMax[1]-1).moveCost||t.cells.at(o,e.posMax[1]-2).moveCost===1/0||s.get(o,e.posMax[1]-1)||i.push(E.fromValues(o,e.posMax[1]-1)));for(let o=e.posMin[1];o<e.posMax[1];++o)e.posMin[0]>0&&(t.cells.at(e.posMin[0]-1,o).type!=ep.OneWayWindowW||0!==t.cells.at(e.posMin[0],o).moveCost||t.cells.at(e.posMin[0]+1,o).moveCost===1/0||s.get(e.posMin[0],o)||i.push(E.fromValues(e.posMin[0],o))),e.posMax[0]<t.cells.sizeX&&(t.cells.at(e.posMax[0],o).type!=ep.OneWayWindowE||0!==t.cells.at(e.posMax[0]-1,o).moveCost||t.cells.at(e.posMax[0]-2,o).moveCost===1/0||s.get(e.posMax[0]-1,o)||i.push(E.fromValues(e.posMax[0]-1,o)))}if(i.length>0){let e=i[n.randomInRange(i.length)];for(let t of o)if(e[0]>=t.posMin[0]&&e[1]>=t.posMin[1]&&e[0]<t.posMax[0]&&e[1]<t.posMax[1]){let o=n.randomInRange(a.length+1);a.splice(o,0,{path:[E.clone(e)],minRoomDepth:t.depth,maxRoomDepth:t.depth});return}}}function ta(e){return(e.roomType===eI.PublicRoom||e.roomType===eI.PrivateRoom)&&!(e.posMax[0]-e.posMin[0]<5)&&!(e.posMax[1]-e.posMin[1]<5)}function tn(e){if(e.roomType!==eI.PublicRoom&&e.roomType!==eI.PrivateRoom)return!1;let t=e.posMax[0]-e.posMin[0],o=e.posMax[1]-e.posMin[1];return!(3>Math.min(t,o)||Math.max(t,o)>7||tx(e))}function ts(e,t){let o=e-Math.floor(e);return e=Math.floor(e),t.random()<o&&++e,e}function ti(e){if(e.roomType!==eI.PublicRoom)return!1;let t=e.posMax[0]-e.posMin[0],o=e.posMax[1]-e.posMin[1];return!(4>Math.min(t,o)||5>Math.max(t,o))}function tl(e){if(e.roomType!==eI.PrivateRoom)return!1;let t=e.posMax[0]-e.posMin[0],o=e.posMax[1]-e.posMin[1];return!(4>Math.min(t,o)||5>Math.max(t,o))}function tf(e,t,o){let r=0;for(let a of e.edges){if(!a.door)continue;let n=-a.dir[1],s=a.dir[0];a.roomLeft===e&&(n=-n,s=-s),n===t&&s===o&&++r}return r}function tu(e,t,o){t=-t,o=-o;let r=E.fromValues(t,o),a=E.create(),n=E.create();t>0?E.set(n,e.posMin[0]-1,0):t<0?E.set(n,e.posMax[0],0):o>0?E.set(n,0,e.posMin[1]-1):E.set(n,0,e.posMax[1]);let s=1/0;for(let t of e.edges)t.door&&(E.scaleAndAdd(a,t.origin,t.dir,Math.floor(t.length/2)),E.subtract(a,a,n),s=Math.min(s,E.dot(r,a)));return console.assert(s>=0),s}function tc(e){if(e.roomType!==eI.PublicRoom&&e.roomType!==eI.PrivateRoom||e.depth<2||tx(e))return!1;let t=e.posMax[0]-e.posMin[0];if(t<3)return!1;let o=e.posMax[1]-e.posMin[1];if(o<3||t<4&&o<5||t<5&&o<4)return!1;if(t<o){if(tf(e,0,-1)>0&&tf(e,0,1)>0)return!1}else if(o<t){if(tf(e,-1,0)>0&&tf(e,1,0)>0)return!1}else if(tf(e,0,-1)>0&&tf(e,0,1)>0&&tf(e,-1,0)>0&&tf(e,1,0)>0)return!1;return!0}function td(e){if(e.depth<2||e.roomType!==eI.PublicRoom&&e.roomType!==eI.PrivateRoom&&e.roomType!==eI.PublicCourtyard&&e.roomType!==eI.PrivateCourtyard&&e.roomType!==eI.Bedroom)return!1;let t=e.posMax[0]-e.posMin[0];if((1&t)==0||t<3||t>7)return!1;let o=e.posMax[1]-e.posMin[1];return(1&o)!=0&&!(o<3)&&!(o>7)}function tp(e,t,o,r){let a=t.posMax[0]-t.posMin[0],n=t.posMax[1]-t.posMin[1],s=t.posMin[0]+Math.floor((a-1)/2),i=t.posMin[1]+Math.floor((n-1)/2);K(e,s,i,s+1,i+1,ep.GroundTreasure),eX(e,E.fromValues(s,i),ex.TreasurePlinth),t.roomType===eI.LockedTreasure&&eX(e,E.fromValues(s,i),ex.TreasureLock),(a>=5||n>=5)&&(eq(e,E.fromValues(t.posMin[0],t.posMin[1]),eY(o,r)),eq(e,E.fromValues(t.posMax[0]-1,t.posMin[1]),eY(o,r)),eq(e,E.fromValues(t.posMin[0],t.posMax[1]-1),eY(o,r)),eq(e,E.fromValues(t.posMax[0]-1,t.posMax[1]-1),eY(o,r)))}function th(e,t,o,r){let a=t.posMax[0]-t.posMin[0],n=t.posMax[1]-t.posMin[1],s=t.posMin[0]+Math.floor((a-1)/2),i=t.posMin[1]+Math.floor((n-1)/2);a>3&&n>3?K(e,Math.max(t.posMin[0]+1,s-1),Math.max(t.posMin[1]+1,i-1),Math.min(t.posMax[0]-1,s+2),Math.min(t.posMax[1]-1,i+2),ep.GroundVault):K(e,s,i,s+1,i+1,ep.GroundTreasure),eX(e,E.fromValues(s,i),ex.TreasurePlinth),t.roomType===eI.LockedTreasureCourtyard&&eX(e,E.fromValues(s,i),ex.TreasureLock),(a>=5||n>=5)&&(eq(e,E.fromValues(t.posMin[0],t.posMin[1]),eY(o,r)),eq(e,E.fromValues(t.posMax[0]-1,t.posMin[1]),eY(o,r)),eq(e,E.fromValues(t.posMin[0],t.posMax[1]-1),eY(o,r)),eq(e,E.fromValues(t.posMax[0]-1,t.posMax[1]-1),eY(o,r)))}function tm(e,t,o,r){let a=e.sizeX,n=e.sizeY,s=new eu(a,n,0),i=[];i.push({roomType:eI.Exterior,group:0,depth:0,betweenness:0,privateRoom:!1,posMin:E.fromValues(0,0),posMax:E.fromValues(0,0),edges:[],gridX:-1,gridY:-1});let l=r===ed.Mansion||r===ed.Warrens?eI.Exterior:eI.PublicCourtyard;for(let r=0;r<a;++r)for(let a=0;a<n;++a){let n=i.length;s.set(r,a,n),i.push({roomType:e.get(r,a)?eI.PublicRoom:l,group:n,depth:0,betweenness:0,privateRoom:!1,posMin:E.fromValues(t.get(r,a)+1,o.get(r,a)+1),posMax:E.fromValues(t.get(r+1,a),o.get(r,a+1)),edges:[],gridX:r,gridY:a})}return[i,s]}function tx(e){for(let t of e.edges)if(t.door){if(t.roomLeft===e&&t.roomRight.roomType===eI.Exterior)return!0;else if(t.roomRight===e&&t.roomLeft.roomType===eI.Exterior)return!0}return!1}function tg(e){switch(e){case eI.PublicCourtyard:case eI.PrivateCourtyard:case eI.TreasureCourtyard:case eI.LockedTreasureCourtyard:return!0;case eI.Exterior:case eI.PublicRoom:case eI.PrivateRoom:case eI.Vault:case eI.Bedroom:case eI.Dining:case eI.PublicLibrary:case eI.PrivateLibrary:case eI.Kitchen:case eI.Treasure:case eI.LockedTreasure:case eI.ThroneRoom:return!1}}function ty(e){return e.edges.reduce((e,t)=>e+ +!!t.door,0)}function tv(e){var t,o;return!(e.roomType!==eI.PublicRoom||(t=e,o=eI.Exterior,t.edges.some(e=>e.door&&(e.roomLeft===t?e.roomRight.roomType:e.roomLeft.roomType)===o)))}function tM(e){let t=e.length,o=[];for(let r of e)r.roomType===eI.Exterior?r.depth=0:function(e){for(let t of e.edges)if(t.door&&t.doorType!==eA.Locked){if(t.roomLeft===e){if(t.roomRight.roomType===eI.Exterior)return!0}else if(t.roomLeft.roomType===eI.Exterior)return!0}return!1}(r)?(r.depth=1,o.push(r)):r.depth=t;for(let e=0;e<o.length;++e){let t=o[e],r=t.depth+1;for(let e of t.edges){if(!e.door)continue;let a=e.roomLeft==t?e.roomRight:e.roomLeft;a.depth>r&&(a.depth=r,o.push(a))}}}function tT(e){for(let t of e)t.betweenness=0;for(let t of e){let o=new Map,r=new Map,a=new Map;for(let t of e)a.set(t,1/0),r.set(t,0),o.set(t,0);a.set(t,0),o.set(t,1);let n=[];n.push(t);let s=[];for(;;){let e=n.shift();if(void 0===e)break;s.push(e);let t=(a.get(e)??0)+1;for(let r of e.edges){if(!r.door)continue;let a=r.roomLeft===e?r.roomRight:r.roomLeft;a.roomType!==eI.Exterior&&(a.depth===1/0&&(a.depth=t,n.push(a)),a.depth===t&&o.set(a,(o.get(a)??0)+(o.get(e)??0)))}}let i=t.roomType===eI.Exterior?10:1;for(;;){let e=s.pop();if(void 0===e)break;let n=(a.get(e)??0)-1,l=o.get(e)??1,f=r.get(e)??0;for(let s of e.edges){if(!s.door)continue;let u=s.roomLeft===e?s.roomRight:s.roomLeft;if(a.get(u)!==n)continue;let c=(o.get(u)??0)/l*(1+f);r.set(u,c),e!==t&&(e.betweenness+=f*i)}}}}function tS(e){let t=new Map;for(let o of e)for(let r of(t.set(o,new Map),e))t.get(o).set(r,1/0);for(let o of e)for(let e of(t.get(o).set(o,0),o.edges)){if(!e.door)continue;let r=e.roomLeft===o?e.roomRight:e.roomLeft;t.get(o).set(r,1)}for(let o of e)for(let r of e)for(let a of e){let e=t.get(r).get(a),n=t.get(r).get(o),s=t.get(o).get(a);e>n+s&&t.get(r).set(a,n+s)}let o=new Set,r=e[0],a=0;for(;o.size<e.length;){o.add(r);let n=r,s=1/0;for(let a of e)if(a!==r&&!o.has(a)){let e=t.get(r).get(a);e<s&&(n=a,s=e)}if(s===1/0)break;r=n,a+=s}return a/(e.length-1)}function t_(e,t,o,r){let a=[];for(let r of e){if(r.roomType===eI.Exterior||t>=8&&r.depth<3||o===ed.Fortress&&tg(r.roomType))continue;let e=0;for(let t of r.edges)t.door&&++e;e<=1&&a.push(r)}if(a.length>0){r.shuffleArray(a),a.sort((e,t)=>tb(e)-tb(t));let e=a[0];for(let t of(e.roomType=eI.Vault,e.edges))t.door&&(t.doorType=eA.Locked)}}function tw(e,t,o,r){let a=0;for(let t of e)a=Math.max(a,t.depth);let n=e.length-1,s=Math.floor(n/4),i=0,l=a;for(;l>0;){for(let t of e)(t.roomType==eI.PublicRoom||t.roomType==eI.PublicCourtyard)&&t.depth==l&&(t.roomType=t.roomType==eI.PublicRoom?eI.PrivateRoom:eI.PrivateCourtyard,t.privateRoom=!0,t.roomType==eI.PrivateRoom&&(i+=1));if(i>=s)break;l-=1}for(;;){let t=!1;for(let o of e)if(o.roomType==eI.PrivateCourtyard){for(let e of o.edges)if((e.roomLeft!=o?e.roomLeft:e.roomRight).roomType==eI.PublicCourtyard){o.roomType=eI.PublicCourtyard,o.privateRoom=!0,t=!0;break}}if(!t)break}for(let a of(t>4&&o!==ed.Fortress&&t_(e,t,o,r),e)){if(a.roomType!==eI.PrivateRoom)continue;let e=a.posMax[0]-a.posMin[0],t=a.posMax[1]-a.posMin[1];if(e<3&&t<3||e*t>25)continue;let o=0;for(let e of a.edges)e.door&&++o;o>2||(a.roomType=eI.Bedroom)}if(o===ed.Fortress)for(let t of tI(e,tc,1,r))t.roomType=eI.ThroneRoom;if(n>=8)for(let t of tI(e,tn,1,r))t.roomType=eI.Kitchen;for(let t of tI(e,ta,Math.ceil(e.length/21),r))t.roomType=eI.Dining;for(let t of tI(e,ti,Math.ceil(e.length/42),r))t.roomType=eI.PublicLibrary;for(let t of tI(e,tl,Math.ceil(e.length/42),r))t.roomType=eI.PrivateLibrary;let f=0;for(let t of e)(t.roomType===eI.PublicLibrary||t.roomType===eI.PrivateLibrary)&&(f+=(t.posMax[0]-t.posMin[0])*(t.posMax[1]-t.posMin[1]));if(f>=30||9===t){let o=f>=60;for(let a of tI(e,td,9===t?2:1,r))tg(a.roomType)?a.roomType=o?eI.LockedTreasureCourtyard:eI.TreasureCourtyard:a.roomType=o?eI.LockedTreasure:eI.Treasure}}function tb(e){return(e.posMax[0]-e.posMin[0])*(e.posMax[1]-e.posMin[1])}function tI(e,t,o,r){let a=e.filter(t);return r.shuffleArray(a),a.slice(0,o)}function tA(e,t){let o=0,r=0;for(let e of t)o=Math.max(o,e.posMax[0]),r=Math.max(r,e.posMax[1]);return o+=1,r+=1,e!==ed.Warrens?(o+=2,r+=2):(o+=1,r+=1),new eS(new eh(o,r))}function tC(e,t,o,r){let a;return t===ed.Warrens?a=E.fromValues(Math.floor(r.cells.sizeX/2),1):(a=tP(o,r),0===e&&(a[0]-=Math.max(0,4-a[1]),a[1]=Math.max(0,a[1]-4))),a}function tP(e,t){let o,r,a;for(let t of e)t.door&&0!==t.dir[0]&&t.roomLeft.roomType!==eI.Exterior&&t.roomRight.roomType===eI.Exterior&&(void 0!==a&&t.origin[1]>a.origin[1]||(a=t));if(void 0===a)return E.fromValues(0,0);a.roomLeft.roomType===eI.Exterior?(o=a.roomRight,r=a.roomLeft):(o=a.roomLeft,r=a.roomRight);let n=E.create();return te(n,r,o,t),n}function tk(e,t,o,r,a,n){let s=function(e){let t=new ef(e.cells.sizeX,e.cells.sizeY,!1);for(let o of e.items)e$(o.type)&&t.set(o.pos[0],o.pos[1],!0);return t}(o),i=function(e,t){let o=new ef(e.cells.sizeX,e.cells.sizeY,!1);for(let t=0;t<e.cells.sizeX;++t)for(let r=0;r<e.cells.sizeY;++r){let a=e.cells.at(t,r).type;(a===ep.GroundWater||a>=ep.Wall0000)&&o.set(t,r,!0)}for(let e of t)if(1===e.path.length)for(let t of e.path)o.set(t[0],t[1],!0);for(let t of e.items)e$(t.type)||o.set(t.pos[0],t.pos[1],!0);return o}(o,r),l=0;for(let r of t)if(r.roomType===eI.ThroneRoom){if(l>=e)break;tL(i,s,r.posMin,r.posMax,o,n)&&++l}for(let r of t){if(r.roomType!==eI.Vault)continue;let t=n.randomInRange(3)+n.randomInRange(3);for(a===ed.Fortress&&(t+=2);t>0&&(--t,!(l>=e));)tL(i,s,r.posMin,r.posMax,o,n)&&++l}for(let r of t){if(l>=e)break;if(r.roomType===eI.Exterior||r.roomType===eI.Vault||(r.roomType===eI.PublicCourtyard||r.roomType===eI.PrivateCourtyard)&&.75>n.random())continue;let t=0;for(let e of r.edges)e.door&&(t+=1);t<2&&tL(i,s,r.posMin,r.posMax,o,n)&&++l}for(let r of t){var f;if(l>=e)break;((f=r.roomType)===eI.PrivateRoom||f===eI.Bedroom)&&!(.5>n.random())&&tL(i,s,r.posMin,r.posMax,o,n)&&++l}let u=t.filter(e=>e.roomType!==eI.Exterior&&!tg(e.roomType));n.shuffleArray(u);for(let t=0;t<1e3&&l<e;++t){let e=u[t%u.length];tL(i,s,e.posMin,e.posMax,o,n)&&++l}console.assert(l===e)}function tL(e,t,o,r,a,n){let s=[];for(let a=o[0];a<r[0];++a)for(let n=o[1];n<r[1];++n)!e.get(a,n)&&t.get(a,n)&&s.push(E.fromValues(a,n));if(0===s.length){for(let t=o[0];t<r[0];++t)for(let a=o[1];a<r[1];++a)e.get(t,a)||s.push(E.fromValues(t,a));if(0===s.length)return!1}let i=s[n.randomInRange(s.length)];return eX(a,i,ex.Coin),e.set(i[0],i[1],!0),!0}function tR(e,t,o){let r=e.items.filter(e=>e.type===ex.Bookshelf);o.shuffleArray(r);let a=new Map;for(let e of t){let t=[];for(let o of r)o.pos[0]>=e.posMin[0]&&o.pos[1]>=e.posMin[1]&&o.pos[0]<e.posMax[0]&&o.pos[1]<e.posMax[1]&&t.push(o);t.length>0&&a.set(e,t)}for(let r of e.items.filter(e=>e.type===ex.TreasurePlinth)){let n=o.randomInRange(5);eX(e,r.pos,ex.TreasureA+n);let s={switches:[],numSwitchesUsed:0,posTreasure:E.clone(r.pos),stolen:!1};if(e.treasures.push(s),!e.items.some(e=>e.type===ex.TreasureLock&&e.pos.equals(r.pos)))continue;let i=[];for(let e=3;e>0&&0===i.length;--e)for(let o of t){let t=a.get(o);void 0!==t&&t.length>=e&&i.push(t)}let l=new Set;for(let t of e.items)(t.type===ex.Coin||t.type===ex.Health||t.type===ex.Note)&&l.add(t.pos[0]*e.cells.sizeY+t.pos[1]);let f=e.items.filter(t=>(t.type===ex.DrawersShort||t.type===ex.DrawersTall||t.type===ex.Shelf)&&!l.has(t.pos[0]*e.cells.sizeY+t.pos[1]));if(0===i.length||0===f.length){e.items=e.items.filter(e=>!(e.type===ex.TreasureLock&&e.pos.equals(r.pos))),e.cells.atVec(r.pos).blocksPlayerMove=!1;continue}let u=i[o.randomInRange(i.length)],c="";for(let t=Math.min(u.length,3);t>0;--t){let t=u.pop();c.length>0&&(c+="\n");let o=e.bookTitle.get(t).split(" ")[0];o.endsWith(",")&&(o=o.substring(0,o.length-1)),c+=o,s.switches.push(E.clone(t.pos))}let d=f[o.randomInRange(f.length)].pos,p={pos:E.clone(d),type:ex.Note,topLayer:eg[ex.Note]};e.items.push(p),e.bookTitle.set(p,c)}e.items.sort((e,t)=>e.type===ex.TreasureLock&&t.type!==ex.TreasureLock?1:e.type!==ex.TreasureLock&&t.type===ex.TreasureLock?-1:0)}function tD(e,t,o,r){if(e<1)return;let a=1+Math.floor((9-e)/4);tW([eI.Kitchen],t,o,r)&&--a,a>0&&tW([eI.Kitchen,eI.Dining],t,o,r)&&--a;for(let e=10;e>0&&a>0;--e)tW([eI.Kitchen,eI.Dining,eI.Bedroom],t,o,r)&&--a}function tW(e,t,o,r){let a=o.filter(t=>e.includes(t.roomType));if(0===a.length)return!1;for(let e=0;e<10;++e){let e=a[r.randomInRange(a.length)];if(function(e,t,o,r){let a=[];for(let r=e[0];r<t[0];++r)for(let n=e[1];n<t[1];++n){let e=E.fromValues(r,n);(function(e,t){let o=t.cells.atVec(e).type;if(o===ep.GroundWater||o>=ep.Wall0000)return!1;let r=!1;for(let o of t.items)if(o.pos.equals(e)){if(o.type!==ex.Table)return!1;r=!0}return r})(e,o)&&a.push(e)}return 0!==a.length&&(eX(o,a[r.randomInRange(a.length)],ex.Health),!0)}(e.posMin,e.posMax,t,r))return!0}return!1}function tG(e,t,o,r,a,n){if(!(e<=0)){if(a&&o.length>0){let r=o.filter(e=>e.path.length>1&&e.minRoomDepth>0);0===r.length&&(r=[...o]),r.sort((e,t)=>e.minRoomDepth-t.minRoomDepth);let a=Math.floor(r.length/2),s=r[a];o=o.filter(e=>e!==s);let i=new et(s.path,0);e>1&&n.randomInRange(5+e)<e&&(i.hasTorch=!0),i.hasVaultKey=!0,t.guards.push(i)}if(r>0&&e<4){let a=o.findIndex(e=>e.path.length<=1);if(a>=0){let s=o[a];o.splice(a,1);let i=new et(s.path,0);e>1&&n.randomInRange(5+e)<e&&(i.hasTorch=!0),i.hasPurse=!0,r--,t.guards.push(i)}}for(let a of o){let o=new et(a.path,0);e>1&&n.randomInRange(5+e)<e&&(a.path.length>1||!t.items.some(e=>e.pos.equals(a.path[0])))&&(o.hasTorch=!0),r>0&&(o.hasPurse=!0,r--),t.guards.push(o)}if(1===e){let e=t.items.filter(e=>e.type===ex.PortcullisEW).sort((e,t)=>e.pos[1]-t.pos[1]);if(e.length>=1){let o=e[0].pos,r=t.guards[0];E.set(r.pos,o[0],o[1]+1),E.set(r.dir,0,-1),r.enterPatrolMode(t)}}console.assert(0===r)}}function tV(e){let t=e.cells.sizeX,o=e.cells.sizeY;for(let r=0;r<t;++r)for(let t=0;t<o;++t){let o=e.cells.at(r,t),a=o.type,n=a>=ep.Wall0000&&a<=ep.Wall1111,s=J(a),i=a==ep.GroundWater;o.moveCost=n||s?1/0:64*!!i,o.blocksPlayerMove=n,o.blocksPlayerSight=n&&a!==ep.Wall0000,o.blocksSight=n,o.blocksSound=n,o.hidesPlayer=!1,o.isWindow=s}for(let t of e.items){let o=e.cells.atVec(t.pos),r=t.type;o.moveCost=Math.max(o.moveCost,function(e){switch(e){case 0:return 32;case 1:case 2:case 3:return 64;case 4:case 5:case 6:case 7:case 8:case 18:case 19:case 28:case 29:case 24:case 25:case 26:case 30:case 31:case 32:case 33:case 34:return 1/0;case 9:return 10;case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 20:case 21:case 22:case 23:case 27:return 0}}(r)),(r===ex.DoorNS||r===ex.DoorEW||r===ex.LockedDoorNS||r===ex.LockedDoorEW)&&(o.blocksPlayerSight=!0),(r===ex.DoorNS||r===ex.DoorEW||r===ex.LockedDoorNS||r===ex.LockedDoorEW||r===ex.PortcullisNS||r===ex.PortcullisEW||r===ex.Bush||r===ex.DrawersTall||r===ex.Bookshelf||r===ex.Shelf||r===ex.Stove)&&(o.blocksSight=!0),(r===ex.Table||r===ex.Bush||r===ex.BedL||r===ex.BedR)&&(o.hidesPlayer=!0),eK(r)&&(o.blocksPlayerMove=!0)}}function tE(e){for(let o=0;o<e.sizeX;++o)for(let r=0;r<e.sizeY;++r){var t;e.at(o,r).type==ep.Wall0000&&(e.at(o,r).type=(t=function(e,t,o){let r=e.sizeX,a=e.sizeY,n=0;return o<a-1&&Z(e.at(t,o+1).type)&&(n|=8),o>0&&Z(e.at(t,o-1).type)&&(n|=4),t<r-1&&Z(e.at(t+1,o).type)&&(n|=2),t>0&&Z(e.at(t-1,o).type)&&(n|=1),n}(e,o,r),ep.Wall0000+t))}}function tB(e,t,o,r){let a=t.sizeX,n=e.sizeY,s=Number.MIN_SAFE_INTEGER;for(let t=0;t<n;++t)s=Math.max(s,-e.get(0,t));s+=o;for(let t=0;t<a+1;++t)for(let o=0;o<n;++o)e.set(t,o,e.get(t,o)+s);let i=Number.MIN_SAFE_INTEGER;for(let e=0;e<a;++e)i=Math.max(i,-t.get(e,0));i+=r;for(let e=0;e<a;++e)for(let o=0;o<n+1;++o)t.set(e,o,t.get(e,o)+i)}function tN(e,t,o,r){let a=t.sizeX,n=t.sizeY;console.assert(e.sizeX===a),console.assert(e.sizeY===n),console.assert(o>=0),console.assert(r>=0),console.assert(o<a),console.assert(r<n),console.assert(!t.get(o,r));let s=new ef(a,n,!1),i=new eu(a,n,0),l=new eu(a,n,0);!function o(r,f,u,c,d){s.set(r,f,!0),i.set(r,f,u),l.set(r,f,u);let p=0,h=!1;for(let[e,m]of[[1,0],[0,1],[-1,0],[0,-1]]){let x=r+e,g=f+m;x<0||x>=a||g<0||g>=n||t.get(x,g)||(s.get(x,g)?(x!==c||g!==d)&&l.set(r,f,Math.min(l.get(r,f),i.get(x,g))):(o(x,g,u+1,r,f),++p,l.get(x,g)>=u&&(h=!0),l.set(r,f,Math.min(l.get(r,f),l.get(x,g)))))}c>=0?h&&e.set(r,f,!1):p>1&&e.set(r,f,!1)}(o,r,0,-1,-1)}function tF(e,t,o,r){let a=e.sizeX,n=e.sizeY;for(let s of o){let o=s.pos[0]-r.posMin[0],i=s.pos[1]-r.posMin[1],l=[];for(let[e,r]of[[1,0],[0,1],[-1,0],[0,-1]]){let s=o+e,f=i+r;s<0||f<0||s>=a||f>=n||t.get(s,f)||l.push([s,f])}if(s.type===ex.BedL)for(let[e,r]of[[1,0],[0,1],[0,-1]]){let s=o+e+1,f=i+r;s<0||f<0||s>=a||f>=n||t.get(s,f)||l.push([s,f])}if(1===l.length){let[t,o]=l[0];e.set(t,o,!1)}}}function tO(e){let t=[];for(let o=0;o<e.sizeX;++o)for(let r=0;r<e.sizeY;++r)e.get(o,r)&&t.push(E.fromValues(o,r));return t}function tz(e,t){for(let o of e.items)if(o.pos.equals(t))return!0;for(let o of e.guards)if(o.pos.equals(t))return!0;return!1}function tH(e,t,o,r,a){for(let n=1;n<o.length;++n){let s,i=o[n];switch(i.roomType){case eI.Exterior:s=t===ed.Warrens?ep.GroundNormal:ep.GroundGrass;break;case eI.PublicCourtyard:s=ep.GroundGrass;break;case eI.PublicRoom:s=ep.GroundWood;break;case eI.PrivateCourtyard:s=ep.GroundGrass;break;case eI.PrivateRoom:s=ep.GroundMarble;break;case eI.Vault:s=ep.GroundVault;break;case eI.Bedroom:s=ep.GroundMarble;break;case eI.Dining:s=i.privateRoom?ep.GroundMarble:ep.GroundWood;break;case eI.PublicLibrary:s=ep.GroundWood;break;case eI.PrivateLibrary:s=ep.GroundMarble;break;case eI.Kitchen:s=ep.GroundWood;break;case eI.Treasure:s=i.privateRoom?ep.GroundMarble:ep.GroundWood;break;case eI.TreasureCourtyard:s=ep.GroundGrass;break;case eI.LockedTreasure:s=i.privateRoom?ep.GroundMarble:ep.GroundWood;break;case eI.LockedTreasureCourtyard:s=ep.GroundGrass;break;case eI.ThroneRoom:s=ep.GroundWood}K(r,i.posMin[0],i.posMin[1],i.posMax[0],i.posMax[1],s),i.roomType===eI.PublicCourtyard||i.roomType===eI.PrivateCourtyard?function(e,t,o,r){let a=t.posMax[0]-t.posMin[0],n=t.posMax[1]-t.posMin[1];if(a>=5&&n>=5)K(e,t.posMin[0]+1,t.posMin[1]+1,t.posMax[0]-1,t.posMax[1]-1,ep.GroundWater);else if(a>=2&&n>=2){let s=[ex.Bush,ex.Bush,ex.Bush,ex.Bush];a>2&&n>2&&s.push(eY(o,r)),r.shuffleArray(s);let i=[E.fromValues(t.posMin[0],t.posMin[1]),E.fromValues(t.posMax[0]-1,t.posMin[1]),E.fromValues(t.posMin[0],t.posMax[1]-1),E.fromValues(t.posMax[0]-1,t.posMax[1]-1)];for(let t=0;t<i.length;++t){let o=i[t];e.cells.atVec(o).type===ep.GroundGrass&&eq(e,o,s[t])}}}(r,i,e,a):i.roomType===eI.PublicRoom||i.roomType===eI.PrivateRoom?function(e,t,o,r){let a=t.posMax[0]-t.posMin[0],n=t.posMax[1]-t.posMin[1];if(a>=5&&n>=5){if(t.roomType===eI.PrivateRoom)a>n?a>7&&K(e,t.posMin[0]+3,t.posMin[1]+1,t.posMax[0]-3,t.posMax[1]-1,ep.GroundWater):n>a?n>7&&K(e,t.posMin[0]+1,t.posMin[1]+3,t.posMax[0]-1,t.posMax[1]-3,ep.GroundWater):a>=7?(K(e,t.posMin[0]+3,t.posMin[1]+1,t.posMax[0]-3,t.posMax[1]-1,ep.GroundWater),K(e,t.posMin[0]+1,t.posMin[1]+3,t.posMax[0]-1,t.posMax[1]-3,ep.GroundWater)):K(e,t.posMin[0]+1,t.posMin[1]+1,t.posMax[0]-1,t.posMax[1]-1,ep.GroundWater);else if(a>n)for(let o=t.posMin[0]+3;o<t.posMax[0]-3;++o)eX(e,E.fromValues(o,t.posMin[1]+1),ex.Chair),eX(e,E.fromValues(o,t.posMax[1]-2),ex.Chair);else if(n>a)for(let o=t.posMin[1]+3;o<t.posMax[1]-3;++o)eX(e,E.fromValues(t.posMin[0]+1,o),ex.Chair),eX(e,E.fromValues(t.posMax[0]-2,o),ex.Chair);else 5===a&&5===n&&(eX(e,E.fromValues(t.posMin[0]+1,t.posMin[1]+1),ex.Table),eX(e,E.fromValues(t.posMin[0]+2,t.posMin[1]+1),ex.Chair),eX(e,E.fromValues(t.posMin[0]+1,t.posMin[1]+2),ex.Chair),eX(e,E.fromValues(t.posMax[0]-2,t.posMax[1]-2),eY(o,r)));if(a>5||n>5){if(e.cells.at(t.posMin[0]+1,t.posMin[1]+1).type=ep.Wall0000,e.cells.at(t.posMax[0]-2,t.posMin[1]+1).type=ep.Wall0000,e.cells.at(t.posMin[0]+1,t.posMax[1]-2).type=ep.Wall0000,e.cells.at(t.posMax[0]-2,t.posMax[1]-2).type=ep.Wall0000,a>n){let a=Math.floor(n/2);eX(e,E.fromValues(t.posMin[0]+1,t.posMin[1]+a),eU(o,r)),eX(e,E.fromValues(t.posMax[0]-2,t.posMax[1]-(a+1)),eU(o,r))}else if(n>a){let n=Math.floor(a/2);eX(e,E.fromValues(t.posMin[0]+n,t.posMin[1]+1),eU(o,r)),eX(e,E.fromValues(t.posMax[0]-(n+1),t.posMax[1]-2),eU(o,r))}}}else if(5==a&&n>=3&&(t.roomType==eI.PublicRoom||.33333>r.random())){let a=Array(n-2).fill(ex.Table);a.push(eY(o,r)),r.shuffleArray(a);for(let o=1;o<n-1;++o)eX(e,E.fromValues(t.posMin[0]+1,t.posMin[1]+o),ex.Chair),eX(e,E.fromValues(t.posMin[0]+2,t.posMin[1]+o),a[o-1]),eX(e,E.fromValues(t.posMin[0]+3,t.posMin[1]+o),ex.Chair)}else if(5==n&&a>=3&&(t.roomType==eI.PublicRoom||.33333>r.random())){let n=Array(a-2).fill(ex.Table);n.push(eY(o,r)),r.shuffleArray(n);for(let o=1;o<a-1;++o)eX(e,E.fromValues(t.posMin[0]+o,t.posMin[1]+1),ex.Chair),eX(e,E.fromValues(t.posMin[0]+o,t.posMin[1]+2),n[o-1]),eX(e,E.fromValues(t.posMin[0]+o,t.posMin[1]+3),ex.Chair)}else if(a>n&&(1&n)==1&&.66667>r.random()){let a=Math.floor(t.posMin[1]+n/2),s=t.roomType==eI.PublicRoom?ex.Table:ex.Chair,i=[eY(o,r),s];r.shuffleArray(i),eq(e,E.fromValues(t.posMin[0]+1,a),i[0]),eq(e,E.fromValues(t.posMax[0]-2,a),i[1])}else if(n>a&&(1&a)==1&&.66667>r.random()){let n=Math.floor(t.posMin[0]+a/2),s=t.roomType==eI.PublicRoom?ex.Table:ex.Chair,i=[eY(o,r),s];r.shuffleArray(i),eq(e,E.fromValues(n,t.posMin[1]+1),i[0]),eq(e,E.fromValues(n,t.posMax[1]-2),i[1])}else if(a>=5&&3===n){let a=Math.floor(t.posMin[1]+n/2);eq(e,E.fromValues(t.posMin[0]+1,a),eY(o,r)),eq(e,E.fromValues(t.posMax[0]-2,a),eY(o,r))}else if(n>=5&&3===a){let n=Math.floor(t.posMin[0]+a/2);eq(e,E.fromValues(n,t.posMin[1]+1),eY(o,r)),eq(e,E.fromValues(n,t.posMax[1]-2),eY(o,r))}else if(a>=3&&n>=3){let a=t.roomType==eI.PublicRoom?ex.Table:ex.Chair,n=[eY(o,r),a,a,a];r.shuffleArray(n),eq(e,E.fromValues(t.posMin[0],t.posMin[1]),n[0]),eq(e,E.fromValues(t.posMax[0]-1,t.posMin[1]),n[1]),eq(e,E.fromValues(t.posMin[0],t.posMax[1]-1),n[2]),eq(e,E.fromValues(t.posMax[0]-1,t.posMax[1]-1),n[3])}}(r,i,e,a):i.roomType===eI.Vault?function(e,t,o){let r=t.posMax[0]-t.posMin[0],a=t.posMax[1]-t.posMin[1],n=new ef(r,a,!0),s=new ef(r,a,!1),i=new ef(r,a,!1),l=E.create(),f=E.create();for(let o of t.edges)for(let r=0;r<o.length;++r)if(E.scaleAndAdd(l,o.origin,o.dir,r),!(e.cells.atVec(l).type<ep.PortcullisNS)){E.set(f,-o.dir[1],o.dir[0]);for(let e=-2;e<3;++e)E.scaleAndAdd(l,o.origin,o.dir,r),E.scaleAndAdd(l,l,f,e),l[0]>=t.posMin[0]&&l[1]>=t.posMin[1]&&l[0]<t.posMax[0]&&l[1]<t.posMax[1]&&s.set(l[0]-t.posMin[0],l[1]-t.posMin[1],!0)}if(r>=5&&a>=5){let o=[E.fromValues(t.posMin[0]+1,t.posMin[1]+1),E.fromValues(t.posMax[0]-2,t.posMin[1]+1),E.fromValues(t.posMin[0]+1,t.posMax[1]-2),E.fromValues(t.posMax[0]-2,t.posMax[1]-2)];if(!o.some(e=>s.get(e[0]-t.posMin[0],e[1]-t.posMin[1])))for(let t of o)e.cells.atVec(t).type=ep.Wall0000}let u=!1,c=0,d=0;for(let o=0;o<r;++o)for(let r=0;r<a;++r){if(!$(e.cells.at(o+t.posMin[0],r+t.posMin[1]).type)){i.set(o,r,!0),s.set(o,r,!0);continue}eC(e.cells,E.fromValues(o+t.posMin[0],r+t.posMin[1]))&&(u=!0,c=o,d=r)}if(!u)return;let p=[ex.VaultTreasureBox,ex.VaultTreasureBox,ex.DrawersTall,ex.DrawersShort,ex.Chair,ex.Table,ex.Bookshelf,ex.Shelf,ex.TorchUnlit];o.shuffleArray(p);let h=[];for(let r=0;;r=(r+1)%p.length){for(let e=0;e<n.values.length;++e)n.values[e]=+!s.values[e];tN(n,i,c,d),tF(n,i,h,t);let a=tO(n);if(0===a.length)break;let l=a[o.randomInRange(a.length)];console.assert(n.get(l[0],l[1])),console.assert(!i.get(l[0],l[1]));let f=p[r],u={pos:E.fromValues(l[0]+t.posMin[0],l[1]+t.posMin[1]),type:f,topLayer:eg[f]};e.items.push(u),h.push(u),i.set(l[0],l[1],!0),s.set(l[0],l[1],!0),f===ex.VaultTreasureBox&&(p.splice(r,1),--r)}}(r,i,a):i.roomType===eI.Bedroom?function(e,t,o,r){let a,n,s=t.posMax[0]-t.posMin[0],i=t.posMax[1]-t.posMin[1],l=new ef(s,i,!0),f=new ef(s,i,!1),u=new ef(s,i,!1),c=new ef(s,i,!1),d=E.create();for(let o=0;o<s;++o)for(let r=0;r<i;++r)d.set(o+t.posMin[0],r+t.posMin[1]),$(e.cells.atVec(d).type)?eC(e.cells,d)&&(f.set(o,r,!0),u.set(o,r,!0),a=o,n=r):(c.set(o,r,!0),f.set(o,r,!0),u.set(o,r,!0)),(eP(e.cells,d)||!eL(e,d))&&u.set(o,r,!0);if(void 0===a||void 0===n)return;let p=[];for(let o=t.posMin[0];o<t.posMax[0]-1;++o)for(let r=t.posMin[1];r<t.posMax[1];++r){let a=E.fromValues(o,r),n=E.fromValues(o+1,r);!ek(e.cells,a)&&!ek(e.cells,n)||tz(e,a)||tz(e,n)||eC(e.cells,a)||eC(e.cells,n)||(2!==s||r===t.posMin[1]||r===t.posMax[1]-1)&&p.push(a)}let h=[];if(p.length>0){let o=p[r.randomInRange(p.length)],a=E.fromValues(o[0]+1,o[1]),n={pos:E.clone(o),type:ex.BedL,topLayer:eg[ex.BedL]},s={pos:E.clone(a),type:ex.BedR,topLayer:eg[ex.BedR]};e.items.push(n),e.items.push(s),h.push(n);let i=o[0]-t.posMin[0],l=o[1]-t.posMin[1];c.set(i,l,!0),c.set(i+1,l,!0),f.set(i,l,!0),f.set(i+1,l,!0),u.set(i,l,!0),u.set(i+1,l,!0)}let m=[ex.DrawersTall,ex.DrawersShort,ex.Chair,ex.Chair,ex.Table,ex.Bookshelf,eY(o,r)];for(let o of(r.shuffleArray(m),m)){let s=!function(e){switch(e){case ex.Bookshelf:case ex.DrawersShort:case ex.VaultTreasureBox:case ex.EmptyVaultTreasureBox:case ex.LootedVaultTreasureBox:case ex.DrawersTall:case ex.Shelf:case ex.TorchUnlit:case ex.TorchLit:case ex.Stove:return!0;default:return!1}}(o)?f:u;for(let e=0;e<l.values.length;++e)l.values[e]=+!s.values[e];tN(l,c,a,n),tF(l,c,h,t);let i=tO(l);if(0===i.length)break;let d=i[r.randomInRange(i.length)];console.assert(l.get(d[0],d[1])),console.assert(!c.get(d[0],d[1]));let p={pos:E.fromValues(d[0]+t.posMin[0],d[1]+t.posMin[1]),type:o,topLayer:eg[o]};e.items.push(p),h.push(p),c.set(d[0],d[1],!0),f.set(d[0],d[1],!0),u.set(d[0],d[1],!0)}}(r,i,e,a):i.roomType===eI.Dining?function(e,t,o,r){let a=t.posMin[0],n=t.posMin[1],s=t.posMax[0]-t.posMin[0],i=t.posMax[1]-t.posMin[1];if(s>=i){let t=n+Math.floor(i/2);if((1&s)==0){eq(e,E.fromValues(a+1,t),eY(o,r)),eq(e,E.fromValues(a+s-2,t),eY(o,r));for(let o=a+2;o<a+s-2;++o)eX(e,E.fromValues(o,t-1),ex.Chair),eX(e,E.fromValues(o,t),ex.Table),eX(e,E.fromValues(o,t+1),ex.Chair)}else{let n=a+(s-1)/2;eq(e,E.fromValues(n,t),eY(o,r));for(let o=a+1;o<n;++o)eX(e,E.fromValues(o,t-1),ex.Chair),eX(e,E.fromValues(o,t),ex.Table),eX(e,E.fromValues(o,t+1),ex.Chair);for(let o=n+1;o<a+s-1;++o)eX(e,E.fromValues(o,t-1),ex.Chair),eX(e,E.fromValues(o,t),ex.Table),eX(e,E.fromValues(o,t+1),ex.Chair)}}else{let t=a+Math.floor(s/2);if((1&i)==0){eq(e,E.fromValues(t,n+1),eY(o,r)),eq(e,E.fromValues(t,n+i-2),eY(o,r));for(let o=n+2;o<n+i-2;++o)eX(e,E.fromValues(t-1,o),ex.Chair),eX(e,E.fromValues(t,o),ex.Table),eX(e,E.fromValues(t+1,o),ex.Chair)}else{let a=n+(i-1)/2;eq(e,E.fromValues(t,a),eY(o,r));for(let o=n+1;o<a;++o)eX(e,E.fromValues(t-1,o),ex.Chair),eX(e,E.fromValues(t,o),ex.Table),eX(e,E.fromValues(t+1,o),ex.Chair);for(let o=a+1;o<n+i-1;++o)eX(e,E.fromValues(t-1,o),ex.Chair),eX(e,E.fromValues(t,o),ex.Table),eX(e,E.fromValues(t+1,o),ex.Chair)}}}(r,i,e,a):i.roomType===eI.Kitchen?function(e,t,o,r){let a=t.posMax[0]-t.posMin[0],n=t.posMax[1]-t.posMin[1],s=[],i=a>n||a===n&&function(e){let t=0;for(let o of e.edges)0===o.dir[1]&&o.door&&++t;return t}(t)<=function(e){let t=0;for(let o of e.edges)0===o.dir[0]&&o.door&&++t;return t}(t);if(i){for(let e=0;e<a;++e)s.push(E.fromValues(e+t.posMin[0],t.posMin[1])),s.push(E.fromValues(e+t.posMin[0],t.posMax[1]-1));let e=(t.posMin[0]+t.posMax[0])/2;s.sort((t,o)=>Math.abs(t[0]-e)-Math.abs(o[0]-e))}else{for(let e=0;e<n;++e)s.push(E.fromValues(t.posMin[0],e+t.posMin[1])),s.push(E.fromValues(t.posMax[0]-1,e+t.posMin[1]));let e=(t.posMin[1]+t.posMax[1])/2;s.sort((t,o)=>Math.abs(t[1]-e)-Math.abs(o[1]-e))}s=s.filter(t=>!eC(e.cells,t)&&ek(e.cells,t));let l=ts(a*n/10,r),f=ts(s.length/3,r),u=ts(s.length/2,r);for(let t of s)eP(e.cells,t)?u>0&&(eX(e,t,ex.Table),--u):l>0?(eX(e,t,ex.Stove),--l):u>0?(eX(e,t,ex.Table),--u):f>0&&(eX(e,t,ex.Shelf),--f);if(i){if(n>=5)for(let o=t.posMin[0]+1;o<t.posMax[0]-1;o+=2)for(let r=t.posMin[1]+2;r<t.posMax[1]-2;++r)eX(e,E.fromValues(o,r),ex.Table)}else if(a>=5)for(let o=t.posMin[1]+1;o<t.posMax[1]-1;o+=2)for(let r=t.posMin[0]+2;r<t.posMax[0]-2;++r)eX(e,E.fromValues(r,o),ex.Table)}(r,i,0,a):i.roomType===eI.Treasure?tp(r,i,e,a):i.roomType===eI.TreasureCourtyard?th(r,i,e,a):i.roomType===eI.LockedTreasure?tp(r,i,e,a):i.roomType===eI.LockedTreasureCourtyard?th(r,i,e,a):i.roomType===eI.PublicLibrary||i.roomType===eI.PrivateLibrary?function(e,t,o,r){let a=t.posMin[0],n=t.posMin[1],s=t.posMax[0]-t.posMin[0],i=t.posMax[1]-t.posMin[1];if(s>=i)if((1&s)==1)for(let t=1;t<s;t+=2)for(let o=1;o<i-1;++o)eX(e,E.fromValues(a+t,n+o),ex.Bookshelf);else{let t=s/2-1;for(let o=1;o<t;o+=2)for(let t=1;t<i-1;++t)eX(e,E.fromValues(a+o,n+t),ex.Bookshelf),eX(e,E.fromValues(a+s-(o+1),n+t),ex.Bookshelf);if((1&t)==1)for(let s=n+1;s<n+i-1;++s){let l=[void 0,void 0];l=s>n+1&&(s<n+i-2||4===i)?[ex.Table,ex.Chair]:[eY(o,r),void 0],r.shuffleArray(l),void 0!==l[0]&&eX(e,E.fromValues(a+t,s),l[0]),void 0!==l[1]&&eX(e,E.fromValues(a+t+1,s),l[1])}}else if((1&i)==1)for(let t=1;t<i;t+=2)for(let o=1;o<s-1;++o)eX(e,E.fromValues(a+o,n+t),ex.Bookshelf);else{let t=i/2-1;for(let o=1;o<t;o+=2)for(let t=1;t<s-1;++t)eX(e,E.fromValues(a+t,n+o),ex.Bookshelf),eX(e,E.fromValues(a+t,n+i-(o+1)),ex.Bookshelf);if((1&t)==1)for(let i=a+1;i<a+s-1;++i){let l=[void 0,void 0];l=i>a+1&&(i<a+s-2||4===s)?[ex.Table,ex.Chair]:[eY(o,r),void 0],r.shuffleArray(l),void 0!==l[0]&&eX(e,E.fromValues(i,n+t),l[0]),void 0!==l[1]&&eX(e,E.fromValues(i,n+t+1),l[1])}}}(r,i,e,a):i.roomType===eI.ThroneRoom&&function(e,t,o,r){let a,n,s,i,l,f;t.posMax[1]-t.posMin[1]<t.posMax[0]-t.posMin[0]||0!==tf(t,0,-1)&&0!==tf(t,0,1)?(l=t.posMax[1]-t.posMin[1],f=t.posMax[0]-t.posMin[0],s=0,tu(t,-1,0)>tu(t,1,0)?(a=t.posMin[0],n=t.posMin[1],i=1):(a=t.posMax[0]-1,n=t.posMax[1]-1,i=-1)):(l=t.posMax[0]-t.posMin[0],f=t.posMax[1]-t.posMin[1],i=0,tu(t,0,-1)>tu(t,0,1)?(a=t.posMax[0]-1,n=t.posMin[1],s=-1):(a=t.posMin[0],n=t.posMax[1]-1,s=1));let u=E.fromValues(s,i),c=E.fromValues(i,-s),d=E.fromValues(a,n),p=E.create(),h=(1&l)!=0?1:2,m=Math.floor((l-h)/2);for(let t=0;t<f-1;++t)for(let o=0;o<h;++o)E.scaleAndAdd(p,d,u,m+o),E.scaleAndAdd(p,p,c,t),e.cells.atVec(p).type=ep.GroundMarble;for(let t=0;t<h;++t)E.scaleAndAdd(p,d,u,m+t),eX(e,p,ex.Chair);if(E.scaleAndAdd(p,d,u,m-1),eq(e,p,ex.DrawersShort),E.scaleAndAdd(p,d,u,m+h),eq(e,p,ex.DrawersShort),l>4&&(E.scaleAndAdd(p,d,u,0),eq(e,p,ex.TorchLit),E.scaleAndAdd(p,d,u,l-1),eq(e,p,ex.TorchLit)),f>6)if(l>=5)for(let t=2;t<f-2;++t)E.scaleAndAdd(p,d,u,1),E.scaleAndAdd(p,p,c,t),eq(e,p,ex.Chair),E.scaleAndAdd(p,d,u,l-2),E.scaleAndAdd(p,p,c,t),eq(e,p,ex.Chair);else{if(0===tf(t,-u[0],-u[1]))for(let t=2;t<f-2;++t)E.scaleAndAdd(p,d,u,0),E.scaleAndAdd(p,p,c,t),eq(e,p,ex.Chair);if(0===tf(t,u[0],u[1]))for(let t=2;t<f-2;++t)E.scaleAndAdd(p,d,u,l-1),E.scaleAndAdd(p,p,c,t),eq(e,p,ex.Chair)}E.scaleAndAdd(p,d,u,0),E.scaleAndAdd(p,p,c,f-1),eq(e,p,ex.TorchLit),E.scaleAndAdd(p,d,u,l-1),E.scaleAndAdd(p,p,c,f-1),eq(e,p,ex.TorchLit)}(r,i,0,0),s==ep.GroundWood&&e>3&&function(e,t,o){for(let r=t.posMin[0];r<t.posMax[0];++r)for(let a=t.posMin[1];a<t.posMax[1];++a){if(e.cells.at(r,a).type!=ep.GroundWood||e.items.some(e=>e.pos[0]===r&&e.pos[1]===a&&e.type!==ex.Coin)||eC(e.cells,E.fromValues(r,a))||o.random()>=.02)continue;let n=r>t.posMin[0]&&r<t.posMax[0]-1&&e.cells.at(r-1,a).type===ep.GroundWood&&e.cells.at(r+1,a).type===ep.GroundWood&&!e.items.some(e=>e.pos[0]===r-1&&e.pos[1]===a&&eK(e.type))&&!e.items.some(e=>e.pos[0]===r+1&&e.pos[1]===a&&eK(e.type)),s=a>t.posMin[1]&&a<t.posMax[1]-1&&e.cells.at(r,a-1).type===ep.GroundWood&&e.cells.at(r,a+1).type===ep.GroundWood&&!e.items.some(e=>e.pos[0]===r&&e.pos[1]===a-1&&eK(e.type))&&!e.items.some(e=>e.pos[0]===r&&e.pos[1]===a+1&&eK(e.type));(n||s)&&(e.cells.at(r,a).type=ep.GroundWoodCreaky)}}(r,i,a)}}function tX(e,t,o){for(let e of t){let t=e.roomLeft.roomType,r=e.roomRight.roomType;if(!(tg(t)&&tg(r))&&(t!==eI.Exterior||r!==eI.Exterior))for(let t=0;t<e.length+1;++t){let r=E.create();E.scaleAndAdd(r,e.origin,e.dir,t),o.cells.atVec(r).type=ep.Wall0000}}let r=new Set;for(let n of t){if(r.has(n))continue;let t=eV(n);for(let e of t)r.add(e);for(let r of t){var a;if(r.door)continue;let t=r.roomLeft.roomType,n=r.roomRight.roomType;if(t===eI.Vault||n===eI.Vault||t===eI.Exterior&&n===eI.Exterior)continue;let s=E.clone(r.dir);if(t===eI.Exterior!=(n===eI.Exterior))n==eI.Exterior&&E.negate(s,s);else if(tg(t)===tg(n))continue;else if(tg(n)){if(e===ed.Fortress&&r.roomLeft.depth+1<r.roomRight.depth)continue;E.negate(s,s)}else if(e===ed.Fortress&&r.roomRight.depth+1<r.roomLeft.depth)continue;let i=tq[(a=s)[0]+2*Math.max(0,a[1])+1];if(e===ed.Fortress&&(t===eI.Exterior||n===eI.Exterior)){if(r.length>2&&(1&r.length)==0){let e=E.clone(r.origin).scaleAndAdd(r.dir,r.length/2);o.cells.atVec(e).type=i}}else if(5===r.length){let e=E.clone(r.origin).scaleAndAdd(r.dir,2+(r.origin[0]+r.origin[1]&1));o.cells.atVec(e).type=i}else{let e=1+Math.floor(r.length/2)-(1&r.length);for(let t=2;t<e;t+=2){let e=E.clone(r.origin).scaleAndAdd(r.dir,t),a=E.clone(r.origin).scaleAndAdd(r.dir,r.length-t);o.cells.atVec(e).type=i,o.cells.atVec(a).type=i}}}for(let e of t){if(!e.door)continue;let t=Math.floor(e.length/2),r=E.clone(e.origin).scaleAndAdd(e.dir,t),a=0==e.dir[0],n=e.roomLeft.roomType,s=e.roomRight.roomType;(n!==eI.Exterior||s!==eI.Exterior)&&(e.doorType===eA.GateFront||e.doorType===eA.GateBack?(o.cells.atVec(r).type=a?ep.PortcullisNS:ep.PortcullisEW,eX(o,r,a?ex.PortcullisNS:ex.PortcullisEW)):e.doorType===eA.Locked?(o.cells.atVec(r).type=a?ep.DoorNS:ep.DoorEW,eX(o,r,a?ex.LockedDoorNS:ex.LockedDoorEW)):tg(n)&&tg(s)?o.cells.atVec(r).type=a?ep.GardenDoorNS:ep.GardenDoorEW:tg(n)||tg(s)||!e.roomLeft.privateRoom||!e.roomRight.privateRoom||n===eI.Bedroom!=(s===eI.Bedroom)?(o.cells.atVec(r).type=a?ep.DoorNS:ep.DoorEW,eX(o,r,a?ex.DoorNS:ex.DoorEW)):o.cells.atVec(r).type=a?ep.DoorNS:ep.DoorEW)}}}let tq=[ep.OneWayWindowS,ep.OneWayWindowE,ep.OneWayWindowN,ep.OneWayWindowW];function tY(e){var t,o,r,a,n,s,i;let l,f,u,c,d=e.rng;d.reset();let p=e.level,h=e.levelType;if(h===ed.Warrens)return function(e,t,o,r,a){var n,s,i;let l,f=new ef(t-1,o,!1),u=new ef(t,o-1,!1),c=new ef(t,o,!1),d=new ef(t,o,!0);for(let e=0;e<t;++e)for(let t=0;t<o-1;++t).125>a.random()&&c.set(e,t,!0);for(let e=Math.floor(t*o/8);e>0;--e){let e=a.randomInRange(t),r=a.randomInRange(o-1);e>0&&e<t-1&&.5>a.random()&&(c.set(e,r,!0),d.set(e,r,!1))}for(let e=0;e<t-1;++e)f.set(e,o-1,!0);let p=[];for(let e=0;e<t;++e)for(let t=0;t<o-1;++t)c.get(e,t)||p.push([e,t]);for(let e of(a.shuffleArray(p),p)){if(c.get(e[0],e[1]))continue;let r=[];for(let[a,n]of[[1,0],[0,1],[0,-1]]){let s=e[0]+a,i=e[1]+n;s<0||i<0||s>=t||i>=o||d.get(s,i)&&r.push([a,n])}if(0===r.length)continue;let[n,s]=r[a.randomInRange(r.length)];c.set(e[0],e[1],!0),n<0?(f.set(e[0]-1,e[1],!0),c.set(e[0]-1,e[1],!0)):n>0?(f.set(e[0],e[1],!0),c.set(e[0]+1,e[1],!0)):s<0?(u.set(e[0],e[1]-1,!0),c.set(e[0],e[1]-1,!0)):s>0&&(u.set(e[0],e[1],!0),c.set(e[0],e[1]+1,!0))}let[h,m,x]=function(e,t,o,r){let a=e.sizeX,n=e.sizeY,s=2+r.randomInRange(2),i=3+r.randomInRange(2),l=Array(a+1).fill(6);for(let e=Math.floor(l.length/2);e>0;--e){let e=r.randomInRange(l.length);l[e]+=1}{let e=-1;for(let t=0;t<l.length;++t){let o=e+l[t];l[t]=e,e=o}}let f=Array(n+1).fill(6);for(let e=Math.floor(f.length/2);e>0;--e){let e=r.randomInRange(f.length);f[e]+=1}f[0]+=1,f[f.length-1]+=1;{let e=-1;for(let t=0;t<f.length;++t){let o=e+f[t];f[t]=e,e=o}}let u=new eu(a+1,n,0),c=new eu(a,n+1,0),d=r.randomInRange(2);for(let e=0;e<=a;++e)for(let p=0;p<=n;++p){let h=p>0&&p<n&&(e>0&&o.get(e-1,p-1)||e<a&&o.get(e,p-1)),m=e>0&&e<a&&(p>0&&t.get(e-1,p-1)||p<n&&t.get(e-1,p)),x=e>=a?s:l[e+1]-l[e]-4,g=p>=n?i:f[p+1]-f[p]-4;if(h&&m){u.set(e,p,u.get(e,p-1)),c.set(e,p,c.get(e-1,p));continue}if(h||!m&&(0>r.random()?0===r.randomInRange(2):(e+p+d&1)==0)){if(p<n&&u.set(e,p,p>0?u.get(e,p-1):r.randomInRange(x)+l[e]),e<a){let t=f[p];e<=0?t+=r.randomInRange(g):p!==n?r.random()>=.8?t+=r.randomInRange(g):(t+=r.randomInRange(g-1))>=c.get(e-1,p)&&++t:t=c.get(e-1,p),c.set(e,p,t)}}else{if(p<n){let t=l[e];p<=0?t+=r.randomInRange(x):0!==e&&e!==a?r.random()>=.8?t+=r.randomInRange(x):(t+=r.randomInRange(x-1))>=u.get(e,p-1)&&++t:t=u.get(e,p-1),u.set(e,p,t)}e<a&&c.set(e,p,e>0?c.get(e-1,p):r.randomInRange(g)+f[p])}}let p=2*a-1,h=2*n-1,m=new ef(p,h,!1),x=new eu(p+1,h,0),g=new eu(p,h+1,0);for(let e=0;e<a;++e)for(let t=0;t<n;++t){let o=u.get(e,t),r=u.get(e+1,t)-2;x.set(2*e,2*t,o),x.set(2*e+1,2*t,r),t+1<n&&(x.set(2*e,2*t+1,o),x.set(2*e+1,2*t+1,r));let s=c.get(e,t),i=c.get(e,t+1)-2;g.set(2*e,2*t,s),g.set(2*e,2*t+1,i),e+1<a&&(g.set(2*e+1,2*t,s),g.set(2*e+1,2*t+1,i))}for(let t=0;t<a;++t)for(let o=0;o<n;++o)m.set(2*t,2*o,e.get(t,o));for(let e=1;e<p;e+=2)for(let o=0;o<h;++o)m.set(e,o,!(1&o)&&t.get(Math.floor(e/2),Math.floor(o/2)));for(let e=0;e<p;++e)for(let t=1;t<h;t+=2)m.set(e,t,!(1&e)&&o.get(Math.floor(e/2),Math.floor(t/2)));return[m,x,g]}(d,f,u,a);tB(m,x,1,3);let g=ed.Warrens,[y,v]=tm(h,m,x,g),M=eR(!1,!1,m,x,y,v);eE(M),a.shuffleArray(M);a.shuffleArray(M);for(let e=M.length;e>0;--e){let e=function(e,t,o){let r=[];for(let o of e){let e=o.roomLeft,a=o.roomRight;if(e.roomType!==a.roomType||e===t||a===t)continue;if(0===o.dir[1]){if(o.length!==1+(e.posMax[0]-e.posMin[0])||o.length!==1+(a.posMax[0]-a.posMin[0]))continue}else if(o.length!==1+(e.posMax[1]-e.posMin[1])||o.length!==1+(a.posMax[1]-a.posMin[1]))continue;let n=Math.min(e.posMin[0],a.posMin[0]),s=Math.min(e.posMin[1],a.posMin[1]),i=Math.max(e.posMax[0],a.posMax[0]),l=Math.max(e.posMax[1],a.posMax[1]),f=i-n,u=l-s;if(f*u>750)continue;let c=Math.max(f,u)/Math.min(f,u);e.roomType!==eI.Exterior&&e.roomType!==eI.PublicCourtyard&&c>(Math.min(f,u)>2?2:3)||r.push([o,c])}if(!(r.length<=0))return o.shuffleArray(r),r.sort((e,t)=>e[1]-t[1]),r[0][0]}(M,y[0],a);if(void 0===e)break;eB(y,M,e)}n=y,s=M,i=a,eN(n,s,e=>e.roomLeft.roomType===eI.Exterior&&e.roomRight.roomType===eI.Exterior),eN(n,s,e=>e.roomLeft.roomType===eI.PublicCourtyard&&e.roomRight.roomType===eI.PublicCourtyard),eN(n,s,e=>e.roomLeft.roomType===eI.PublicRoom&&e.roomRight.roomType===eI.PublicRoom&&.8>i.random()),eN(n,s,e=>e.roomLeft.roomType===eI.PublicRoom!=(e.roomRight.roomType===eI.PublicRoom)&&(tv(e.roomLeft)||tv(e.roomRight))&&.5>i.random()),eN(n,s,e=>e.roomLeft.group!==e.roomRight.group),tM(y),tT(y),tw(y,e,g,a);let T=tA(g,y);for(let e of T.cells.values)e.type=ep.GroundNormal;tX(g,M,T),tH(e,g,y,T,a),T.backtrackingCoefficient=tS(y),T.playerStartPos=tC(e,g,M,T),tE(T.cells),tV(T),l=e<1?[]:e<2?eJ(T,y,a):e0(g,e,T,y,M,a);let S=void 0!==T.items.find(e=>e.type===ex.LockedDoorNS||e.type===ex.LockedDoorEW);to(e,T,y,S,l,a);let _=Math.min(Math.floor(e/3),Math.min(l.length-!!S,r));return tk(r-_,y,T,l,g,a),eH(T.bookTitle,y,T.items.filter(e=>e.type===ex.Bookshelf),a),tR(T,y,a),tD(e,T,y,a),tG(e,T,l,_,S,a),T.computeLighting(null),T.recomputeVisibility(T.playerStartPos),T.rooms=y.map(e=>({posMin:e.posMin,posMax:e.posMax})),T.adjacencies=M,T}(p,e.numRoomsX,e.numRoomsY,e.totalLoot,d);let m=function(e,t){let o=new ef(e.numRoomsX,e.numRoomsY,!0);switch(e.levelType){case ed.Manor:case ed.ManorRed:!function(e,t){let o=e.sizeX,r=e.sizeY,a=Math.floor(o*r/4);for(let n=0;n<a;++n){let a=t.randomInRange(o),n=t.randomInRange(r);e.set(a,n,!1)}(1&o)==1&&function(e){let t=e.sizeX,o=e.sizeY;console.assert((1&t)==1);for(let r=(t-1)/2+1;r<t;++r)for(let a=0;a<o;++a)e.set(r,a,e.get(t-1-r,a))}(e),(1&r)==1&&.125>t.random()&&function(e){let t=e.sizeX,o=e.sizeY;console.assert((1&o)==1);let r=(o-1)/2;for(let a=0;a<t;++a)for(let t=r+1;t<o;++t)e.set(a,t,e.get(a,o-1-t))}(e)}(o,t);break;case ed.Mansion:!function(e,t){let o=Math.floor((e.sizeX+1)/3),r=Math.floor((e.sizeY+1)/3);e.fill(!1);for(let t=0;t<o;++t)for(let o=0;o<r;++o)for(let r=0;r<2;++r)for(let a=0;a<2;++a)e.set(3*t+r,3*o+a,!0);let a=[];for(let e=0;e<o;++e)for(let t=0;t<r;++t)a.push(e*r+t);let n=[];for(let e=1;e<o;++e)for(let t=0;t<r;++t){let o=(e-1)*r+t,a=e*r+t;n.push([o,a])}for(let e=0;e<o;++e)for(let t=1;t<r;++t){let o=e*r+(t-1),a=e*r+t;n.push([o,a])}for(let o of(t.shuffleArray(n),n)){let t=o[0],n=o[1],s=a[t],i=a[n],l=t%r,f=Math.floor(t/r),u=n%r,c=Math.floor(n/r);if(s===i)continue;for(let e=0;e<a.length;++e)a[e]===i&&(a[e]=s);let d=3*Math.min(f,c),p=3*Math.max(f,c)+2,h=3*Math.min(l,u),m=3*Math.max(l,u)+2;for(let t=d;t<p;++t)for(let o=h;o<m;++o)e.set(t,o,!0)}}(o,t);break;case ed.Fortress:!function(e,t){let o=.25>t.random();for(let t=0;t<e.sizeX;++t)for(let r=0;r<e.sizeY;++r){let a=Math.min(t,e.sizeX-1-t),n=Math.min(a,Math.min(r,e.sizeY-1-r));e.set(t,r,1!==n||!o&&r>1&&1!==a)}}(o,t)}return o}(e,d),{mirrorRoomsX:x,mirrorRoomsY:g}=(t=e,o=m,r=d,l=(1&t.numRoomsX)==1&&function(e){let t=Math.floor(e.sizeX/2);for(let o=0;o<e.sizeY;++o)for(let r=0;r<t;++r)if(e.get(r,o)!==e.get(e.sizeX-1-r,o))return!1;return!0}(o),f=(1&t.numRoomsY)==1&&function(e){let t=Math.floor(e.sizeY/2);for(let o=0;o<e.sizeX;++o)for(let r=0;r<t;++r)if(e.get(o,r)!==e.get(o,e.sizeY-1-r))return!1;return!0}(o)&&(!l||.5>r.random()),{mirrorRoomsX:l,mirrorRoomsY:f}),{offsetX:y,offsetY:v}=function(e,t,o,r){let a=.25>r.random(),[n,s]=function(e,t,o,r,a,n){let s=new eu(e+1,t,0),i=new eu(e,t+1,0),l=n.randomInRange(2);for(let o=0;o<=e;++o)for(let r=0;r<=t;++r)if(.5>n.random()?0===n.randomInRange(2):(o+r+l&1)==0){if(r<t&&s.set(o,r,r>0?s.get(o,r-1):n.randomInRange(3)+5*o-1),o<e){let e=5*r-1;o<=0?e+=n.randomInRange(3):a&&0===r||a&&r===t?e=i.get(o-1,r):n.random()>=.75?e+=n.randomInRange(3):(e+=n.randomInRange(2))>=i.get(o-1,r)&&++e,i.set(o,r,e)}}else{if(r<t){let t=5*o-1;r<=0?t+=n.randomInRange(3):a&&0===o||a&&o===e?t=s.get(o,r-1):n.random()>=.75?t+=n.randomInRange(3):(t+=n.randomInRange(2))>=s.get(o,r-1)&&++t,s.set(o,r,t)}o<e&&i.set(o,r,o>0?i.get(o-1,r):n.randomInRange(3)+5*r-1)}return[s,i]}(e.numRoomsX,e.numRoomsY,0,0,a,r);return t&&function(e,t){let o=t.sizeX,r=e.sizeY;console.assert(e.sizeX=o+1),console.assert(t.sizeY=r+1),console.assert((1&o)==1);let a=(o-1)/2,n=Math.floor((a+.5)*5+1);for(let t=a+1;t<o+1;++t)for(let a=0;a<r;++a)e.set(t,a,2*n-e.get(o-t,a));for(let e=a+1;e<o;++e)for(let a=0;a<r+1;++a)t.set(e,a,t.get(o-1-e,a))}(n,s),o&&function(e,t){let o=t.sizeX,r=e.sizeY;console.assert(e.sizeX=o+1),console.assert(t.sizeY=r+1),console.assert((1&r)==1);let a=(r-1)/2,n=Math.floor((a+.5)*5+1);for(let t=0;t<o+1;++t)for(let o=a+1;o<r;++o)e.set(t,o,e.get(t,r-1-o));for(let e=0;e<o;++e)for(let o=a+1;o<r+1;++o)t.set(e,o,2*n-t.get(e,r-o))}(n,s),tB(n,s,2,3),{offsetX:n,offsetY:s}}(e,x,g,d),{rooms:M,adjacencies:T}=function(e,t,o,r,a,n,s){let[i,l]=tm(t,a,n,e.levelType),f=s.randomInRange(24)>=e.level,u=eR(o&&f,r&&f,a,n,i,l);eE(u),s.shuffleArray(u),function(e,t,o,r,a){eN(e,t,e=>e.roomLeft.roomType===eI.Exterior&&e.roomRight.roomType===eI.Exterior),eN(e,t,e=>e.roomLeft.roomType===eI.PublicCourtyard&&e.roomRight.roomType===eI.PublicCourtyard),r===ed.Fortress?eN(e,t,e=>e.roomLeft.roomType!==eI.Exterior&&e.roomRight.roomType!==eI.Exterior&&e.roomLeft.group!==e.roomRight.group):(eN(e,t,e=>e.roomLeft.roomType===eI.PublicRoom&&e.roomRight.roomType===eI.PublicRoom&&(e.roomLeft.group!==e.roomRight.group||.4>a.random())),eN(e,t,e=>e.roomLeft.roomType!==eI.Exterior&&e.roomRight.roomType!==eI.Exterior&&e.roomLeft.roomType!==e.roomRight.roomType&&(e.roomLeft.group!==e.roomRight.group||.4>a.random())));let n=function(e){let t=0;for(let o of e)o.roomLeft.roomType===eI.Exterior!=(o.roomRight.roomType===eI.Exterior)&&(t+=o.length);return t}(t),s=function(e){let t,o=1/0,r=-1/0;for(let t of e)t.roomLeft.roomType===eI.Exterior!=(t.roomRight.roomType===eI.Exterior)&&(o=Math.min(o,t.origin[0]),r=Math.max(r,t.origin[0]+t.dir[0]*(t.length+1)));let a=(o+r)/2;for(let o of e)0===o.dir[0]||o.length<3||o.roomLeft.roomType===eI.Exterior||o.roomRight.roomType!==eI.Exterior||o.origin[0]>a||o.origin[0]+o.dir[0]*o.length<=a||void 0!==t&&o.origin[1]>t.origin[1]||(t=o);return t}(t);if(void 0!==s&&(s.door=!0,s.doorType=eA.GateFront,eG(s)),n>80||.2>a.random()){let e=function(e){let t,o=1/0,r=-1/0;for(let t of e)t.roomLeft.roomType===eI.Exterior!=(t.roomRight.roomType===eI.Exterior)&&(o=Math.min(o,t.origin[0]),r=Math.max(r,t.origin[0]+t.dir[0]*(t.length+1)));let a=(o+r)/2,n=1/0;for(let o of e){if(0===o.dir[0]||o.length<3||o.roomLeft.roomType!==eI.Exterior||o.roomRight.roomType===eI.Exterior)continue;let e=Math.max(0,Math.max(a-(o.origin[0]+o.dir[0]*o.length),o.origin[0]-a));(e<n||void 0!==t&&e===n&&o.origin[1]>t.origin[1])&&(n=e,t=o)}return t}(t);void 0!==e&&(e.door=!0,e.doorType=r!==ed.Fortress&&(o<3||.5>a.random())?eA.GateBack:eA.Locked,eG(e))}if(n>120||.2>a.random()){let e=r!==ed.Fortress&&o<3?eA.GateBack:eA.Locked,a=function(e){let t,o=1/0,r=-1/0;for(let t of e)t.roomLeft.roomType===eI.Exterior!=(t.roomRight.roomType===eI.Exterior)&&(o=Math.min(o,t.origin[1]),r=Math.max(r,t.origin[1]+t.dir[1]*(t.length+1)));let a=(o+r)/2,n=1/0;for(let o of e){if(0===o.dir[1]||o.length<3||o.roomLeft.roomType!==eI.Exterior||o.roomRight.roomType===eI.Exterior)continue;let e=Math.max(0,Math.max(a-(o.origin[1]+o.dir[1]*(o.length+1)),o.origin[1]-a));(e<n||void 0!==t&&e===n&&(o.origin[0]<t.origin[0]||o.origin[0]===t.origin[0]&&o.origin[1]<t.origin[1]))&&(n=e,t=o)}return t}(t);if(void 0!==a)for(let t of eV(a))t.door=!0,t.doorType=e;let n=function(e){let t,o=1/0,r=-1/0;for(let t of e)t.roomLeft.roomType===eI.Exterior!=(t.roomRight.roomType===eI.Exterior)&&(o=Math.min(o,t.origin[1]),r=Math.max(r,t.origin[1]+t.dir[1]*(t.length+1)));let a=(o+r)/2,n=1/0;for(let o of e){if(0===o.dir[1]||o.length<3||o.roomLeft.roomType===eI.Exterior||o.roomRight.roomType!==eI.Exterior)continue;let e=Math.max(0,Math.max(a-(o.origin[1]+o.dir[1]*(o.length+1)),o.origin[1]-a));(e<n||void 0!==t&&e===n&&(o.origin[0]>t.origin[0]||o.origin[0]===t.origin[0]&&o.origin[1]<t.origin[1]))&&(n=e,t=o)}return t}(t);if(void 0!==n)for(let t of eV(n))t.door=!0,t.doorType=e}}(i,u,e.level,e.levelType,s);s.shuffleArray(u);for(let e=2*Math.floor(i.length/12);e>0;--e){let e=function(e,t,o){let r=[];for(let o of e){let e=o.roomLeft,a=o.roomRight;if(!o.door||e.roomType!==a.roomType||e===t||a===t)continue;if(0===o.dir[1]){if(o.length!==1+(e.posMax[0]-e.posMin[0])||o.length!==1+(a.posMax[0]-a.posMin[0]))continue}else if(o.length!==1+(e.posMax[1]-e.posMin[1])||o.length!==1+(a.posMax[1]-a.posMin[1]))continue;let n=Math.min(e.posMin[0],a.posMin[0]),s=Math.min(e.posMin[1],a.posMin[1]),i=Math.max(e.posMax[0],a.posMax[0]),l=Math.max(e.posMax[1],a.posMax[1]),f=i-n,u=l-s;if(f*u>750)continue;let c=Math.max(f,u)/Math.min(f,u);e.roomType!==eI.Exterior&&c>2||r.push([o,c])}if(!(r.length<=0))return o.shuffleArray(r),r.sort((e,t)=>e[1]-t[1]),r[0][0]}(u,i[0],s);if(void 0===e)break;eB(i,u,e)}return e.levelType===ed.Fortress&&(tM(i),t_(i,e.level,e.levelType,s),function(e,t){for(let o of e){if(o.door||o.length<2)continue;let e=o.roomLeft,r=o.roomRight;if(e.roomType===eI.Exterior||e.roomType===eI.Vault||r.roomType===eI.Exterior||r.roomType===eI.Vault||ty(e)>1&&ty(r)>1||t.random()>=.4)continue;let a=Math.abs(e.depth-r.depth);o.door=!0,tg(e.roomType)&&tg(r.roomType)||a<2?o.doorType=eA.Standard:o.doorType=eA.Locked}}(u,s)),tM(i),tT(i),tw(i,e.level,e.levelType,s),{rooms:i,adjacencies:u}}(e,m,x,g,y,v,d),{map:S,needKey:_}=(a=e,n=M,s=T,i=d,u=tA(a.levelType,n),tX(a.levelType,s,u),tH(a.level,a.levelType,n,u,i),u.backtrackingCoefficient=tS(n),u.playerStartPos=tC(a.level,a.levelType,s,u),tE(u.cells),tV(u),u.rooms=n.map(e=>({posMin:e.posMin,posMax:e.posMax})),u.adjacencies=s,c=void 0!==u.items.find(e=>e.type===ex.LockedDoorNS||e.type===ex.LockedDoorEW),{map:u,needKey:c}),{patrolRoutes:w,outsidePatrolRoute:b}=function(e,t,o,r,a,n){let s,i={path:function(e,t){let o=[],r=tP(e,t),a=E.clone(r),n=E.fromValues(1,0);for(let e=t.cells.sizeX*t.cells.sizeY;e>0;--e){o.push(E.clone(a));let e=E.fromValues(-n[1],n[0]),s=E.fromValues(n[1],-n[0]);if(t.cells.at(a[0]+n[0],a[1]+n[1]).type>=ep.Wall0000)if(t.cells.at(a[0]+e[0],a[1]+e[1]).type<ep.Wall0000)E.copy(n,e);else if(t.cells.at(a[0]+s[0],a[1]+s[1]).type<ep.Wall0000)E.copy(n,s);else break;else if(!eL(t,a))if(eL(t,E.fromValues(a[0]+e[0],a[1]+e[1])))E.copy(n,e);else if(eL(t,E.fromValues(a[0]+s[0],a[1]+s[1])))E.copy(n,s);else break;if(a.set(a[0]+n[0],a[1]+n[1]),a.equals(r)||a[0]<0||a[1]<0||a[0]>=t.cells.sizeX||a[1]>=t.cells.sizeY)break}return o}(o,r),minRoomDepth:t[0].depth,maxRoomDepth:t[0].depth};if(e.level<1)s=[];else if(e.level<2)s=eJ(r,t,n);else{var l;let a;s=e0(e.levelType,e.level,r,t,o,n),e.level>5&&(l=s,a=i.path.length,l.push({path:e3(i.path,Math.floor(.25*a)),minRoomDepth:i.minRoomDepth,maxRoomDepth:i.maxRoomDepth}),l.push({path:e3(i.path,Math.floor(.75*a)),minRoomDepth:i.minRoomDepth,maxRoomDepth:i.maxRoomDepth}))}return to(e.level,r,t,a,s,n),{outsidePatrolRoute:i,patrolRoutes:s}}(e,M,T,S,_,d),I=Math.min(Math.floor(p/3),Math.min(w.length-!!_,e.totalLoot));tk(e.totalLoot-I,M,S,w,h,d),eH(S.bookTitle,M,S.items.filter(e=>e.type===ex.Bookshelf),d),tR(S,M,d),tD(p,S,M,d),tG(p,S,w,I,_,d),function(e,t,o){let r=e.cells.sizeX,a=e.cells.sizeY;for(let o of t)e.cells.atVec(o).type=ep.GroundNormal;K(e,0,0,r,3,ep.GroundNormal);let n=new ef(e.cells.sizeX,e.cells.sizeY,!1),s=[],i=[E.clone(e.playerStartPos)];for(let t=0;t<i.length;++t){let o=i[t];if(!n.get(o[0],o[1])&&(n.set(o[0],o[1],!0),!(e.cells.atVec(o).type>=ep.Wall0000))){e.cells.atVec(o).type===ep.GroundGrass&&s.push(o);for(let t=-1;t<=1;++t)for(let r=-1;r<=1;++r){let a=E.fromValues(o[0]+t,o[1]+r);a[0]>=0&&a[1]>=0&&a[0]<e.cells.sizeX&&a[1]<e.cells.sizeY&&!n.get(a[0],a[1])&&i.push(a)}}}for(let t of(o.shuffleArray(s),s.length=Math.floor(s.length/3),n.fill(!1),s))if(!n.get(t[0],t[1])){eX(e,t,ex.Bush);for(let e=Math.max(0,t[0]-1);e<Math.min(r,t[0]+2);++e)for(let o=Math.max(0,t[1]-1);o<Math.min(a,t[1]+2);++o)n.set(e,o,!0)}}(S,b.path,d);let A=S.cells.sizeX-1,C=Math.floor(A/2);for(let e=2;e<C;e+=5)S.cells.at(e,1).type=ep.Wall0000,S.cells.at(A-e,1).type=ep.Wall0000;return!function(e){let t=new ef(e.cells.sizeX,e.cells.sizeY,!1),o=[e.playerStartPos];for(let r=0;r<o.length;++r){let a=o[r];if(!t.get(a[0],a[1])&&(t.set(a[0],a[1],!0),e.cells.atVec(a).seen=!0,++e.numPreRevealedCells,!(e.cells.atVec(a).type>=ep.Wall0000)))for(let r=-1;r<=1;++r)for(let n=-1;n<=1;++n){let s=E.fromValues(a[0]+r,a[1]+n);s[0]>=0&&s[1]>=0&&s[0]<e.cells.sizeX&&s[1]<e.cells.sizeY&&!t.get(s[0],s[1])&&o.push(s)}}}(S),S.computeLighting(null),S.recomputeVisibility(S.playerStartPos),S.rooms=M.map(e=>({posMin:e.posMin,posMax:e.posMax})),S.adjacencies=T,S}class tU{start(e,t){}addGlyph(e,t,o,r,a){}addGlyphLit(e,t,o,r,a,n){}addGlyphLit4(e,t,o,r,a,n){}flush(){}constructor(e,t,o,r){this.beginFrame=e=>{};let a=e.getContext("webgl2",{alpha:!1,depth:!1}),n=[r.image,t.image,o.image].map(e=>(function(e,t){let o=t.naturalWidth/16,r=t.naturalHeight/16,a=4*o,n=4*r,s=document.createElement("canvas");s.width=a,s.height=256*n;let i=s.getContext("2d");i.imageSmoothingEnabled=!1;for(let e=0;e<16;++e)for(let s=0;s<16;++s){let l=s*o,f=e*r,u=(16*e+s)*n;i.drawImage(t,l,f,o,r,0,u,a,n)}let l=new Uint8Array(i.getImageData(0,0,s.width,s.height).data.buffer),f=e.createTexture();return e.bindTexture(e.TEXTURE_2D_ARRAY,f),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage3D(e.TEXTURE_2D_ARRAY,0,e.RGBA,a,n,256,0,e.RGBA,e.UNSIGNED_BYTE,l),e.generateMipmap(e.TEXTURE_2D_ARRAY),f})(a,e));this.renderVignette=function(e){let t={vPositionScreen:0},o=tK(e,`#version 300 es
        in vec2 vPositionScreen;

        uniform mat4 uMatDiscFromScreen;

        out highp vec2 fPositionDisc;

        void main() {
            highp vec4 posScreen = vec4(vPositionScreen.xy, 0, 1);
            fPositionDisc = (uMatDiscFromScreen * posScreen).xy;
            gl_Position = posScreen;
        }
    `,`#version 300 es
        in highp vec2 fPositionDisc;

        uniform highp vec4 uColorInner;
        uniform highp vec4 uColorOuter;
        uniform highp float uRadiusInner;

        out lowp vec4 fragColor;

        void main() {
            highp float r = length(fPositionDisc);
            highp float u = smoothstep(uRadiusInner, 1.0, r);
            fragColor = mix(uColorInner, uColorOuter, u);
        }
    `,t),r=e.getUniformLocation(o,"uMatDiscFromScreen"),a=e.getUniformLocation(o,"uColorInner"),n=e.getUniformLocation(o,"uColorOuter"),s=e.getUniformLocation(o,"uRadiusInner"),i=new Float32Array(12);{let e=0;function l(t,o){i[e++]=t,i[e++]=o}l(-1,-1),l(1,-1),l(1,1),l(1,1),l(-1,1),l(-1,-1)}let f=e.createBuffer(),u=e.createVertexArray();return e.bindVertexArray(u),e.enableVertexAttribArray(t.vPositionScreen),e.bindBuffer(e.ARRAY_BUFFER,f),e.vertexAttribPointer(t.vPositionScreen,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW),e.bindVertexArray(null),(t,i,l,f)=>{e.useProgram(o),e.uniformMatrix4fv(r,!1,t),e.uniform1f(s,i),e.uniform4fv(a,l),e.uniform4fv(n,f),e.bindVertexArray(u),e.drawArrays(e.TRIANGLES,0,6),e.bindVertexArray(null)}}(a),this.terrainTileSet=t,this.entityTileSet=o,this.fontTileSet=r;let s={vPosition:0,vTexcoord:1,vColor:2};function i(e,t,o){let r=255&e,a=e>>8&255,n=e>>16&255,s=e>>24&255;return Math.max(0,Math.min(255,Math.trunc(r+((255&t)-r)*o)))+(Math.max(0,Math.min(255,Math.trunc(a+((t>>8&255)-a)*o)))<<8)+(Math.max(0,Math.min(255,Math.trunc(n+((t>>16&255)-n)*o)))<<16)+(Math.max(0,Math.min(255,Math.trunc(s+((t>>24&255)-s)*o)))<<24)}let l=tK(a,`#version 300 es
            in vec2 vPosition;
            in vec3 vTexcoord;
            in vec4 vColor;

            uniform mat4 uMatScreenFromWorld;

            out highp vec3 fTexcoord;
            out highp vec4 fColor;

            void main() {
                fTexcoord = vTexcoord;
                fColor = vColor;
                gl_Position = uMatScreenFromWorld * vec4(vPosition, 0, 1);
            }
        `,`#version 300 es
            in highp vec3 fTexcoord;
            in highp vec4 fColor;

            uniform highp sampler2DArray uOpacity;

            out lowp vec4 fragColor;

            void main() {
                fragColor = fColor * texture(uOpacity, fTexcoord);
            }
        `,s),f=a.getUniformLocation(l,"uMatScreenFromWorld"),u=a.getUniformLocation(l,"uOpacity"),c=2*Float32Array.BYTES_PER_ELEMENT+2*Uint32Array.BYTES_PER_ELEMENT,d=new ArrayBuffer(256*c),p=new Float32Array(d),h=new Uint32Array(d),m=a.createBuffer(),x=0,g=k.create(),y=a.createVertexArray();a.bindVertexArray(y),a.enableVertexAttribArray(s.vPosition),a.enableVertexAttribArray(s.vTexcoord),a.enableVertexAttribArray(s.vColor),a.bindBuffer(a.ARRAY_BUFFER,m),a.vertexAttribPointer(s.vPosition,2,a.FLOAT,!1,c,0),a.vertexAttribPointer(s.vTexcoord,3,a.UNSIGNED_BYTE,!1,c,8),a.vertexAttribPointer(s.vColor,4,a.UNSIGNED_BYTE,!0,c,12),a.bufferData(a.ARRAY_BUFFER,d,a.DYNAMIC_DRAW),function(e,t){let o=new Uint16Array(384);for(let e=0;e<64;++e){let t=6*e,r=4*e;o[t+0]=r+0,o[t+1]=r+1,o[t+2]=r+2,o[t+3]=r+2,o[t+4]=r+1,o[t+5]=r+3}let r=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r),e.bufferData(e.ELEMENT_ARRAY_BUFFER,o,e.STATIC_DRAW)}(a,64),a.bindVertexArray(null),this.start=(e,t)=>{k.copy(g,e),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D_ARRAY,n[t])},this.addGlyph=(e,t,o,r,a)=>{if(void 0===a.textureIndex)return;x>=64&&this.flush(),o=e+(o-e)*1,r=t+(r-t)*1;let n=a.color?a.color:0xffffffff,s=x*c,i=a.textureIndex<<16;p[s+0]=e,p[s+1]=t,h[s+2]=i+256,h[s+3]=n,p[s+4]=o,p[s+5]=t,h[s+6]=i+257,h[s+7]=n,p[s+8]=e,p[s+9]=r,h[s+10]=i,h[s+11]=n,p[s+12]=o,p[s+13]=r,h[s+14]=i+1,h[s+15]=n,++x},this.addGlyphLit=(e,t,o,r,a,n)=>{if(void 0===a.textureIndex)return;x>=64&&this.flush(),o=e+(o-e)*1,r=t+(r-t)*1;let s=a.color?a.color:0xffffffff,l=i(a.unlitColor?a.unlitColor:0xff505050,s,n**.25),f=x*c,u=a.textureIndex<<16;p[f+0]=e,p[f+1]=t,h[f+2]=u+256,h[f+3]=l,p[f+4]=o,p[f+5]=t,h[f+6]=u+257,h[f+7]=l,p[f+8]=e,p[f+9]=r,h[f+10]=u,h[f+11]=l,p[f+12]=o,p[f+13]=r,h[f+14]=u+1,h[f+15]=l,++x},this.addGlyphLit4=(e,t,o,r,a,n)=>{if(void 0===a.textureIndex)return;x>=64&&this.flush();let s=a.color?a.color:0xffffffff,l=a.unlitColor?a.unlitColor:0xff505050;function f(e){return i(l,s,e**.25)}o=e+(o-e)*1,r=t+(r-t)*1;let u=x*c,d=a.textureIndex<<16;p[u+0]=e,p[u+1]=t,h[u+2]=d+256,h[u+3]=f(n[0]),p[u+4]=o,p[u+5]=t,h[u+6]=d+257,h[u+7]=f(n[1]),p[u+8]=e,p[u+9]=r,h[u+10]=d,h[u+11]=f(n[2]),p[u+12]=o,p[u+13]=r,h[u+14]=d+1,h[u+15]=f(n[3]),++x},this.flush=()=>{x<=0||(a.useProgram(l),a.bindVertexArray(y),a.uniform1i(u,0),a.uniformMatrix4fv(f,!1,g),a.bindBuffer(a.ARRAY_BUFFER,m),a.bufferSubData(a.ARRAY_BUFFER,0,p,0),a.drawElements(a.TRIANGLES,6*x,a.UNSIGNED_SHORT,0),a.bindVertexArray(null),x=0)},this.beginFrame=e=>{a.viewport(0,0,e[0],e[1]),a.clear(a.COLOR_BUFFER_BIT)},a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.enable(a.BLEND),a.clearColor(0,0,0,1)}}function tj(e,t,o){let r=e.createShader(t);return e.shaderSource(r,o),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)||(alert("An error occurred compiling the shaders: "+e.getShaderInfoLog(r)),e.deleteShader(r)),r}function tK(e,t,o,r){let a=tj(e,e.VERTEX_SHADER,t),n=tj(e,e.FRAGMENT_SHADER,o),s=e.createProgram();for(let t in e.attachShader(s,a),e.attachShader(s,n),r)e.bindAttribLocation(s,r[t],t);return e.linkProgram(s),e.getProgramParameter(s,e.LINK_STATUS)||alert("Unable to initialize the shader program: "+e.getProgramInfoLog(s)),s}var t$={},tQ=G("cmoHh"),tJ=G("euRi5"),tZ=G("hDsEw"),t0=G("3J2Zm"),t1=G("6Px8M"),t2=G("lDm0S"),t5={};!function(e,t,o){var r,a="random",n=o.pow(256,6),s=o.pow(2,52),i=2*s;function l(l,p,h){var m=[],x=c(function e(t,o){var r,a=[],n=typeof t;if(o&&"object"==n)for(r in t)try{a.push(e(t[r],o-1))}catch(e){}return a.length?a:"string"==n?t:t+"\0"}((p=!0==p?{entropy:!0}:p||{}).entropy?[l,d(t)]:null==l?function(){try{var o;return r&&(o=r.randomBytes)?o=o(256):(o=new Uint8Array(256),(e.crypto||e.msCrypto).getRandomValues(o)),d(o)}catch(o){var a=e.navigator,n=a&&a.plugins;return[+new Date,e,n,e.screen,d(t)]}}():l,3),m),g=new f(m),y=function(){for(var e=g.g(6),t=n,o=0;e<s;)e=(e+o)*256,t*=256,o=g.g(1);for(;e>=i;)e/=2,t/=2,o>>>=1;return(e+o)/t};return y.int32=function(){return 0|g.g(4)},y.quick=function(){return g.g(4)/0x100000000},y.double=y,c(d(g.S),t),(p.pass||h||function(e,t,r,n){return(n&&(n.S&&u(n,g),e.state=function(){return u(g,{})}),r)?(o[a]=e,t):e})(y,x,"global"in p?p.global:this==o,p.state)}function f(e){var t,o=e.length,r=this,a=0,n=r.i=r.j=0,s=r.S=[];for(o||(e=[o++]);a<256;)s[a]=a++;for(a=0;a<256;a++)s[a]=s[n=255&n+e[a%o]+(t=s[a])],s[n]=t;(r.g=function(e){for(var t,o=0,a=r.i,n=r.j,s=r.S;e--;)t=s[a=255&a+1],o=256*o+s[255&(s[a]=s[n=255&n+t])+(s[n]=t)];return r.i=a,r.j=n,o})(256)}function u(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function c(e,t){for(var o,r=e+"",a=0;a<r.length;)t[255&a]=255&(o^=19*t[255&a])+r.charCodeAt(a++);return d(t)}function d(e){return String.fromCharCode.apply(0,e)}if(c(o.random(),t),t5){t5=l;try{r=G("kjyEk")}catch(e){}}else"function"==typeof define&&define.amd?define(function(){return l}):o["seed"+a]=l}("undefined"!=typeof self?self:t5,[],Math),t5.alea=tQ,t5.xor128=tJ,t5.xorwow=tZ,t5.xorshift7=t0,t5.xor4096=t1,t5.tychei=t2,t$=t5;class t4{constructor(t=""){""!==t?(this.seed=t,this.rng=e(t$)(t)):(this.seed="",this.rng=e(t$)())}reset(){this.rng=e(t$)(this.seed)}random(){return this.rng()}randomInRange(e){return Math.floor(this.rng()*e)}shuffleArray(e){for(let t=e.length-1;t>0;--t){let o=this.randomInRange(t+1),r=e[t];e[t]=e[o],e[o]=r}}}function t3(e){for(let t=e.length-1;t>0;--t){let o=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[o],e[o]=r}}var t6={};t6=import.meta.resolve("cdhIw");var t8={};t8=import.meta.resolve("bqehX");var t7={};t7=import.meta.resolve("2LsRa");var t9=((c={})[c.Font=0]="Font",c[c.Terrain=1]="Terrain",c[c.Entity=2]="Entity",c);function oe(e){return 16*e[1]+e[0]}let ot={name:"Basic Font",imageSrc:t7,image:new Image,tileSize:[16,16],offset:[0,0],letterMap:[],background:{textureIndex:219,color:0xff101010},heart:{textureIndex:3},air:{textureIndex:9}},oo={name:"31 Color Terrain Tileset",imageSrc:t8,image:new Image,tileSize:[16,16],cellSize:[16,16],tileRatios:[1,1],offset:[0,0],flattenTexture:!0,terrainTiles:[{textureIndex:oe([4,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([10,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([2,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([11,14]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oe([11,15]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oe([4,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([4,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([4,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([6,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([9,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([12,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([10,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([7,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([14,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([5,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([13,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([11,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([15,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([2,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([3,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([1,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([13,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([11,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([5,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a}],redWallTerrainTiles:[{textureIndex:oe([4,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([10,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([2,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([10,14]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oe([10,15]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oe([4,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([4,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([4,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([6,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([9,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([12,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([10,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([7,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([14,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([5,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([13,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([11,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([15,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([2,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([3,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([1,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([13,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([11,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([5,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a}],manseTerrainTiles:[{textureIndex:oe([5,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([9,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([10,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([0,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([7,14]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oe([7,15]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oe([4,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([3,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([6,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([9,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([12,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([10,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([7,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([14,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([5,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([13,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([11,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([15,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([2,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([3,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([1,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([13,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([11,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([5,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([9,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([9,15]),color:0xffd0f3ff,unlitColor:0xff754a4a}],fortressTerrainTiles:[{textureIndex:oe([5,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([8,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([10,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([0,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([6,14]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oe([6,15]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oe([5,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([3,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([6,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([9,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([12,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([10,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([7,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([14,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([5,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([13,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([11,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([15,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([2,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([3,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([1,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([13,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([11,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([5,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([8,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oe([8,15]),color:0xffd0f3ff,unlitColor:0xff754a4a}],ledgeTiles:[{textureIndex:oe([0,11]),color:0xff736847,unlitColor:0xff483428},{textureIndex:oe([1,11]),color:0xff736847,unlitColor:0xff483428},{textureIndex:oe([2,11]),color:0xff736847,unlitColor:0xff483428},{textureIndex:oe([3,11]),color:0xff736847,unlitColor:0xff483428}],waterAnimation:[{textureIndex:128,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:129,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:130,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:131,color:0xffd0fefe,unlitColor:0xff908080}],manseWaterAnimation:[{textureIndex:144,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:145,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:146,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:147,color:0xffd0fefe,unlitColor:0xff908080}],fortressWaterAnimation:[{textureIndex:160,color:0xff908080,unlitColor:0xff604040},{textureIndex:161,color:0xff908080,unlitColor:0xff604040},{textureIndex:162,color:0xff908080,unlitColor:0xff604040},{textureIndex:163,color:0xff908080,unlitColor:0xff604040}]},or={name:"31 Color Entity Tileset",imageSrc:t6,image:new Image,tileSize:[16,16],cellSize:[16,16],tileRatios:[1,1],offset:[0,0],flattenTexture:!0,unlitTile:{textureIndex:oe([0,0])},namedTiles:{pickTarget:{textureIndex:188,color:0xffffffff},noise:{textureIndex:187,color:0x80ffffff},crossHatch:{textureIndex:3,color:0xffffffff},patrolRoute:{textureIndex:31,color:0xff80ff80},speechBubbleR:{textureIndex:183,color:0xffffffff},speechBubbleL:{textureIndex:184,color:0xffffffff},idleIndicator:{textureIndex:188,color:0xffffffff},playerHint:{textureIndex:185,color:0xffffffff},uiWindowTile:{textureIndex:32,color:0xffffffff},uiCreakyTile:{textureIndex:33,color:0xffffffff},treasureA:{textureIndex:160,color:0xffffffff},treasureB:{textureIndex:161,color:0xffffffff},treasureC:{textureIndex:162,color:0xffffffff},treasureD:{textureIndex:163,color:0xffffffff},treasureE:{textureIndex:164,color:0xffffffff},treasureV:{textureIndex:171,color:0xffffffff}},touchButtons:{menu:{textureIndex:oe([11,1]),color:0xa0ffffff,unlitColor:0x30ffffff},up:{textureIndex:oe([2,1]),color:0xa0ffffff,unlitColor:0x30ffffff},down:{textureIndex:oe([3,1]),color:0xa0ffffff,unlitColor:0x30ffffff},left:{textureIndex:oe([0,1]),color:0xa0ffffff,unlitColor:0x30ffffff},right:{textureIndex:oe([1,1]),color:0xa0ffffff,unlitColor:0x30ffffff},wait:{textureIndex:oe([4,1]),color:0xa0ffffff,unlitColor:0x30ffffff},jump:{textureIndex:oe([5,1]),color:0xa0ffffff,unlitColor:0x30ffffff},bang:{textureIndex:oe([13,1]),color:0xa0ffffff,unlitColor:0x30ffffff},menuAccept:{textureIndex:oe([4,1]),color:0xa0ffffff,unlitColor:0x30ffffff},zoomOut:{textureIndex:oe([6,1]),color:0xa0ffffff,unlitColor:0x30ffffff},zoomIn:{textureIndex:oe([7,1]),color:0xa0ffffff,unlitColor:0x30ffffff},heal:{textureIndex:oe([8,1]),color:0xa0ffffff,unlitColor:0x30ffffff},startLevel:{textureIndex:oe([9,1]),color:0xa0ffffff,unlitColor:0x30ffffff},nextLevel:{textureIndex:oe([9,1]),color:0xa0ffffff,unlitColor:0x30ffffff},forceRestart:{textureIndex:oe([10,1]),color:0xa0ffffff,unlitColor:0x30ffffff},fullscreen:{textureIndex:oe([14,1]),color:0xa0ffffff,unlitColor:0x30ffffff}},vaultGoldAnimationTiles:[{textureIndex:157,color:0xffffffff,unlitColor:0xffffffff},{textureIndex:173,color:0xffffffff,unlitColor:0xffffffff},{textureIndex:174,color:0xffffffff,unlitColor:0xffffffff},{textureIndex:175,color:0xffffffff,unlitColor:0xffffffff}],itemGlows:{[ex.Coin]:{textureIndex:oe([12,9]),color:0xa0ffffff,unlitColor:0xffffff},[ex.TreasureA]:{textureIndex:oe([5,9]),color:0xa0ffffff,unlitColor:0xffffff},[ex.TreasureB]:{textureIndex:oe([6,9]),color:0xa0ffffff,unlitColor:0xffffff},[ex.TreasureC]:{textureIndex:oe([7,9]),color:0xa0ffffff,unlitColor:0xffffff},[ex.TreasureD]:{textureIndex:oe([8,9]),color:0xa0ffffff,unlitColor:0xffffff},[ex.TreasureE]:{textureIndex:oe([9,9]),color:0xa0ffffff,unlitColor:0xffffff},[ex.VaultTreasureBox]:{textureIndex:oe([11,9]),color:0xa0ffffff,unlitColor:0xffffff}},itemTiles:[{textureIndex:oe([3,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([4,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([8,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([10,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([9,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([14,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([6,15]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,11]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([2,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([3,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([1,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([6,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([1,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,13]),color:0xffd0fefe,unlitColor:0xffd0fefe},{textureIndex:oe([0,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([6,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([1,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([11,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,7]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([8,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([6,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([7,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([8,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([9,10]),color:0xffffffff,unlitColor:0xffffffff}],redWallItemTiles:[{textureIndex:oe([3,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([4,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([8,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([10,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([9,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([14,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([6,15]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,11]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([2,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([3,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([1,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([6,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([1,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,13]),color:0xffd0fefe,unlitColor:0xffd0fefe},{textureIndex:oe([0,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([6,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([1,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([11,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,7]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([8,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([6,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([7,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([8,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([9,10]),color:0xffffffff,unlitColor:0xffffffff}],manseItemTiles:[{textureIndex:oe([3,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([4,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([8,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([10,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([9,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([14,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,15]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,11]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([2,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([3,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([1,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([6,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([1,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,13]),color:0xffd0fefe,unlitColor:0xffd0fefe},{textureIndex:oe([0,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([6,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([1,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([11,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,7]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([8,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([6,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([7,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([8,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([9,10]),color:0xffffffff,unlitColor:0xffffffff}],fortressItemTiles:[{textureIndex:oe([3,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([4,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([8,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([10,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([9,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([14,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([8,15]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,11]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([2,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([3,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([1,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([6,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([4,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oe([0,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([1,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([12,13]),color:0xffd0fefe,unlitColor:0xffd0fefe},{textureIndex:oe([0,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([6,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([1,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([11,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([15,7]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([8,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([7,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oe([5,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([6,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([7,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([8,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oe([9,10]),color:0xffffffff,unlitColor:0xffffffff}],npcTiles:[{textureIndex:oe([9,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([8,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([10,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([7,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([9,8]),color:0xff705050},{textureIndex:oe([8,8]),color:0xff705050},{textureIndex:oe([10,8]),color:0xff705050},{textureIndex:oe([7,8]),color:0xff705050},{textureIndex:oe([9,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([8,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([10,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([7,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([6,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([6,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([6,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oe([6,8]),color:0xffffffff,unlitColor:0xff705050}],playerTiles:{normal:{textureIndex:oe([1,8]),color:0xffffffff,unlitColor:0xffa8a8a8},hidden:{textureIndex:oe([0,8]),color:0xffffffff,unlitColor:0xffa8a8a8},right:{textureIndex:oe([2,8]),color:0xffffffff,unlitColor:0xffa8a8a8},left:{textureIndex:oe([3,8]),color:0xffffffff,unlitColor:0xffa8a8a8},down:{textureIndex:oe([1,8]),color:0xffffffff,unlitColor:0xffa8a8a8},up:{textureIndex:oe([4,8]),color:0xffffffff,unlitColor:0xffa8a8a8},dead:{textureIndex:oe([5,8]),color:0xffffffff,unlitColor:0xffa8a8a8},litFace:{textureIndex:176,color:0xffffffff}},guardStateTiles:[{textureIndex:oe([0,11])},{textureIndex:oe([1,11])},{textureIndex:oe([2,11])},{textureIndex:oe([3,11])},{textureIndex:oe([4,11])}],stoveAnimation:[{textureIndex:238,color:0xffffffff,unlitColor:0xff908080},{textureIndex:239,color:0xffffffff,unlitColor:0xff908080}],candleAnimation:[{textureIndex:224,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:225,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:226,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:227,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:208,color:0xffd0fefe,unlitColor:0xff908080}],torchAnimation:[{textureIndex:220},{textureIndex:221},{textureIndex:222},{textureIndex:223},{textureIndex:223}],treasureGateAnimation:[{textureIndex:216},{textureIndex:200},{textureIndex:201},{textureIndex:202},{textureIndex:203}],playerTorchAnimation:[{textureIndex:217},{textureIndex:218},{textureIndex:219},{textureIndex:219}],achievementIcons:{achievementVictory:{textureIndex:75},achievementGhosty:{textureIndex:110},achievementZippy:{textureIndex:77},achievementHungry:{textureIndex:78},achievementThumpy:{textureIndex:79},achievementSofty:{textureIndex:91},achievementSteppy:{textureIndex:94},achievementHealthy:{textureIndex:107},achievementTreasure:{textureIndex:108},achievementMapping:{textureIndex:109},achievementFaceless:{textureIndex:76}},achievementIncompleteIcon:{textureIndex:63},achievementFailedIcon:{textureIndex:0}};(d=function(){this.init()}).prototype={init:function(){var e=this||p;return e._counter=1e3,e._html5AudioPool=[],e.html5PoolSize=10,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.autoUnlock=!0,e._setup(),e},volume:function(e){var t=this||p;if(e=parseFloat(e),t.ctx||T(),void 0!==e&&e>=0&&e<=1){if(t._volume=e,t._muted)return t;t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e,p.ctx.currentTime);for(var o=0;o<t._howls.length;o++)if(!t._howls[o]._webAudio)for(var r=t._howls[o]._getSoundIds(),a=0;a<r.length;a++){var n=t._howls[o]._soundById(r[a]);n&&n._node&&(n._node.volume=n._volume*e)}return t}return t._volume},mute:function(e){var t=this||p;t.ctx||T(),t._muted=e,t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e?0:t._volume,p.ctx.currentTime);for(var o=0;o<t._howls.length;o++)if(!t._howls[o]._webAudio)for(var r=t._howls[o]._getSoundIds(),a=0;a<r.length;a++){var n=t._howls[o]._soundById(r[a]);n&&n._node&&(n._node.muted=!!e||n._muted)}return t},stop:function(){for(var e=this||p,t=0;t<e._howls.length;t++)e._howls[t].stop();return e},unload:function(){for(var e=this||p,t=e._howls.length-1;t>=0;t--)e._howls[t].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,T()),e},codecs:function(e){return(this||p)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||p;if(e.state=e.ctx&&e.ctx.state||"suspended",e._autoSuspend(),!e.usingWebAudio)if("undefined"!=typeof Audio)try{var t=new Audio;void 0===t.oncanplaythrough&&(e._canPlayEvent="canplay")}catch(t){e.noAudio=!0}else e.noAudio=!0;try{var t=new Audio;t.muted&&(e.noAudio=!0)}catch(e){}return e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||p,t=null;try{t="undefined"!=typeof Audio?new Audio:null}catch(t){return e}if(!t||"function"!=typeof t.canPlayType)return e;var o=t.canPlayType("audio/mpeg;").replace(/^no$/,""),r=e._navigator?e._navigator.userAgent:"",a=r.match(/OPR\/(\d+)/g),n=a&&33>parseInt(a[0].split("/")[1],10),s=-1!==r.indexOf("Safari")&&-1===r.indexOf("Chrome"),i=r.match(/Version\/(.*?) /),l=s&&i&&15>parseInt(i[1],10);return e._codecs={mp3:!!(!n&&(o||t.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!o,opus:!!t.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(t.canPlayType('audio/wav; codecs="1"')||t.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!t.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!t.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(t.canPlayType("audio/x-m4b;")||t.canPlayType("audio/m4b;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(t.canPlayType("audio/x-mp4;")||t.canPlayType("audio/mp4;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!l&&t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!l&&t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!t.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(t.canPlayType("audio/x-flac;")||t.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_unlockAudio:function(){var e=this||p;if(!e._audioUnlocked&&e.ctx){e._audioUnlocked=!1,e.autoUnlock=!1,e._mobileUnloaded||44100===e.ctx.sampleRate||(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var t=function(o){for(;e._html5AudioPool.length<e.html5PoolSize;)try{var r=new Audio;r._unlocked=!0,e._releaseHtml5Audio(r)}catch(t){e.noAudio=!0;break}for(var a=0;a<e._howls.length;a++)if(!e._howls[a]._webAudio)for(var n=e._howls[a]._getSoundIds(),s=0;s<n.length;s++){var i=e._howls[a]._soundById(n[s]);i&&i._node&&!i._node._unlocked&&(i._node._unlocked=!0,i._node.load())}e._autoResume();var l=e.ctx.createBufferSource();l.buffer=e._scratchBuffer,l.connect(e.ctx.destination),void 0===l.start?l.noteOn(0):l.start(0),"function"==typeof e.ctx.resume&&e.ctx.resume(),l.onended=function(){l.disconnect(0),e._audioUnlocked=!0,document.removeEventListener("touchstart",t,!0),document.removeEventListener("touchend",t,!0),document.removeEventListener("click",t,!0),document.removeEventListener("keydown",t,!0);for(var o=0;o<e._howls.length;o++)e._howls[o]._emit("unlock")}};return document.addEventListener("touchstart",t,!0),document.addEventListener("touchend",t,!0),document.addEventListener("click",t,!0),document.addEventListener("keydown",t,!0),e}},_obtainHtml5Audio:function(){var e=this||p;if(e._html5AudioPool.length)return e._html5AudioPool.pop();var t=new Audio().play();return t&&"undefined"!=typeof Promise&&(t instanceof Promise||"function"==typeof t.then)&&t.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(e){var t=this||p;return e._unlocked&&t._html5AudioPool.push(e),t},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&void 0!==e.ctx.suspend&&p.usingWebAudio){for(var t=0;t<e._howls.length;t++)if(e._howls[t]._webAudio){for(var o=0;o<e._howls[t]._sounds.length;o++)if(!e._howls[t]._sounds[o]._paused)return e}return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout(function(){if(e.autoSuspend){e._suspendTimer=null,e.state="suspending";var t=function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())};e.ctx.suspend().then(t,t)}},3e4),e}},_autoResume:function(){var e=this;if(e.ctx&&void 0!==e.ctx.resume&&p.usingWebAudio)return"running"===e.state&&"interrupted"!==e.ctx.state&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):"suspended"===e.state||"running"===e.state&&"interrupted"===e.ctx.state?(e.ctx.resume().then(function(){e.state="running";for(var t=0;t<e._howls.length;t++)e._howls[t]._emit("resume")}),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):"suspending"===e.state&&(e._resumeAfterSuspend=!0),e}},p=new d,(h=function(e){e.src&&0!==e.src.length?this.init(e):console.error("An array of source files must be passed with any new Howl.")}).prototype={init:function(e){var t=this;return p.ctx||T(),t._autoplay=e.autoplay||!1,t._format="string"!=typeof e.format?e.format:[e.format],t._html5=e.html5||!1,t._muted=e.mute||!1,t._loop=e.loop||!1,t._pool=e.pool||5,t._preload="boolean"!=typeof e.preload&&"metadata"!==e.preload||e.preload,t._rate=e.rate||1,t._sprite=e.sprite||{},t._src="string"!=typeof e.src?e.src:[e.src],t._volume=void 0!==e.volume?e.volume:1,t._xhr={method:e.xhr&&e.xhr.method?e.xhr.method:"GET",headers:e.xhr&&e.xhr.headers?e.xhr.headers:null,withCredentials:!!e.xhr&&!!e.xhr.withCredentials&&e.xhr.withCredentials},t._duration=0,t._state="unloaded",t._sounds=[],t._endTimers={},t._queue=[],t._playLock=!1,t._onend=e.onend?[{fn:e.onend}]:[],t._onfade=e.onfade?[{fn:e.onfade}]:[],t._onload=e.onload?[{fn:e.onload}]:[],t._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],t._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],t._onpause=e.onpause?[{fn:e.onpause}]:[],t._onplay=e.onplay?[{fn:e.onplay}]:[],t._onstop=e.onstop?[{fn:e.onstop}]:[],t._onmute=e.onmute?[{fn:e.onmute}]:[],t._onvolume=e.onvolume?[{fn:e.onvolume}]:[],t._onrate=e.onrate?[{fn:e.onrate}]:[],t._onseek=e.onseek?[{fn:e.onseek}]:[],t._onunlock=e.onunlock?[{fn:e.onunlock}]:[],t._onresume=[],t._webAudio=p.usingWebAudio&&!t._html5,void 0!==p.ctx&&p.ctx&&p.autoUnlock&&p._unlockAudio(),p._howls.push(t),t._autoplay&&t._queue.push({event:"play",action:function(){t.play()}}),t._preload&&"none"!==t._preload&&t.load(),t},load:function(){var e,t,o=null;if(p.noAudio)return void this._emit("loaderror",null,"No audio support.");"string"==typeof this._src&&(this._src=[this._src]);for(var r=0;r<this._src.length;r++){if(this._format&&this._format[r])e=this._format[r];else{if("string"!=typeof(t=this._src[r])){this._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}(e=/^data:audio\/([^;,]+);/i.exec(t))||(e=/\.([^.]+)$/.exec(t.split("?",1)[0])),e&&(e=e[1].toLowerCase())}if(e||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),e&&p.codecs(e)){o=this._src[r];break}}return o?(this._src=o,this._state="loading","https:"===window.location.protocol&&"http:"===o.slice(0,5)&&(this._html5=!0,this._webAudio=!1),new m(this),this._webAudio&&g(this),this):void this._emit("loaderror",null,"No codec support for selected audio sources.")},play:function(e,t){var o=this,r=null;if("number"==typeof e)r=e,e=null;else if("string"==typeof e&&"loaded"===o._state&&!o._sprite[e])return null;else if(void 0===e&&(e="__default",!o._playLock)){for(var a=0,n=0;n<o._sounds.length;n++)o._sounds[n]._paused&&!o._sounds[n]._ended&&(a++,r=o._sounds[n]._id);1===a?e=null:r=null}var s=r?o._soundById(r):o._inactiveSound();if(!s)return null;if(r&&!e&&(e=s._sprite||"__default"),"loaded"!==o._state){s._sprite=e,s._ended=!1;var i=s._id;return o._queue.push({event:"play",action:function(){o.play(i)}}),i}if(r&&!s._paused)return t||o._loadQueue("play"),s._id;o._webAudio&&p._autoResume();var l=Math.max(0,s._seek>0?s._seek:o._sprite[e][0]/1e3),f=Math.max(0,(o._sprite[e][0]+o._sprite[e][1])/1e3-l),u=1e3*f/Math.abs(s._rate),c=o._sprite[e][0]/1e3,d=(o._sprite[e][0]+o._sprite[e][1])/1e3;s._sprite=e,s._ended=!1;var h=function(){s._paused=!1,s._seek=l,s._start=c,s._stop=d,s._loop=!!(s._loop||o._sprite[e][2])};if(l>=d)return void o._ended(s);var m=s._node;if(o._webAudio){var x=function(){o._playLock=!1,h(),o._refreshBuffer(s);var e=s._muted||o._muted?0:s._volume;m.gain.setValueAtTime(e,p.ctx.currentTime),s._playStart=p.ctx.currentTime,void 0===m.bufferSource.start?s._loop?m.bufferSource.noteGrainOn(0,l,86400):m.bufferSource.noteGrainOn(0,l,f):s._loop?m.bufferSource.start(0,l,86400):m.bufferSource.start(0,l,f),u!==1/0&&(o._endTimers[s._id]=setTimeout(o._ended.bind(o,s),u)),t||setTimeout(function(){o._emit("play",s._id),o._loadQueue()},0)};"running"===p.state&&"interrupted"!==p.ctx.state?x():(o._playLock=!0,o.once("resume",x),o._clearTimer(s._id))}else{var g=function(){m.currentTime=l,m.muted=s._muted||o._muted||p._muted||m.muted,m.volume=s._volume*p.volume(),m.playbackRate=s._rate;try{var r=m.play();if(r&&"undefined"!=typeof Promise&&(r instanceof Promise||"function"==typeof r.then)?(o._playLock=!0,h(),r.then(function(){o._playLock=!1,m._unlocked=!0,t?o._loadQueue():o._emit("play",s._id)}).catch(function(){o._playLock=!1,o._emit("playerror",s._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),s._ended=!0,s._paused=!0})):t||(o._playLock=!1,h(),o._emit("play",s._id)),m.playbackRate=s._rate,m.paused)return void o._emit("playerror",s._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==e||s._loop?o._endTimers[s._id]=setTimeout(o._ended.bind(o,s),u):(o._endTimers[s._id]=function(){o._ended(s),m.removeEventListener("ended",o._endTimers[s._id],!1)},m.addEventListener("ended",o._endTimers[s._id],!1))}catch(e){o._emit("playerror",s._id,e)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===m.src&&(m.src=o._src,m.load());var y=window&&window.ejecta||!m.readyState&&p._navigator.isCocoonJS;if(m.readyState>=3||y)g();else{o._playLock=!0,o._state="loading";var v=function(){o._state="loaded",g(),m.removeEventListener(p._canPlayEvent,v,!1)};m.addEventListener(p._canPlayEvent,v,!1),o._clearTimer(s._id)}}return s._id},pause:function(e){var t=this;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"pause",action:function(){t.pause(e)}}),t;for(var o=t._getSoundIds(e),r=0;r<o.length;r++){t._clearTimer(o[r]);var a=t._soundById(o[r]);if(a&&!a._paused&&(a._seek=t.seek(o[r]),a._rateSeek=0,a._paused=!0,t._stopFade(o[r]),a._node))if(t._webAudio){if(!a._node.bufferSource)continue;void 0===a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),t._cleanBuffer(a._node)}else isNaN(a._node.duration)&&a._node.duration!==1/0||a._node.pause();arguments[1]||t._emit("pause",a?a._id:null)}return t},stop:function(e,t){var o=this;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"stop",action:function(){o.stop(e)}}),o;for(var r=o._getSoundIds(e),a=0;a<r.length;a++){o._clearTimer(r[a]);var n=o._soundById(r[a]);n&&(n._seek=n._start||0,n._rateSeek=0,n._paused=!0,n._ended=!0,o._stopFade(r[a]),n._node&&(o._webAudio?n._node.bufferSource&&(void 0===n._node.bufferSource.stop?n._node.bufferSource.noteOff(0):n._node.bufferSource.stop(0),o._cleanBuffer(n._node)):isNaN(n._node.duration)&&n._node.duration!==1/0||(n._node.currentTime=n._start||0,n._node.pause(),n._node.duration===1/0&&o._clearSound(n._node))),t||o._emit("stop",n._id))}return o},mute:function(e,t){var o=this;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"mute",action:function(){o.mute(e,t)}}),o;if(void 0===t)if("boolean"!=typeof e)return o._muted;else o._muted=e;for(var r=o._getSoundIds(t),a=0;a<r.length;a++){var n=o._soundById(r[a]);n&&(n._muted=e,n._interval&&o._stopFade(n._id),o._webAudio&&n._node?n._node.gain.setValueAtTime(e?0:n._volume,p.ctx.currentTime):n._node&&(n._node.muted=!!p._muted||e),o._emit("mute",n._id))}return o},volume:function(){var e,t,o,r=this,a=arguments;if(0===a.length)return r._volume;if(1===a.length||2===a.length&&void 0===a[1]?r._getSoundIds().indexOf(a[0])>=0?t=parseInt(a[0],10):e=parseFloat(a[0]):a.length>=2&&(e=parseFloat(a[0]),t=parseInt(a[1],10)),void 0===e||!(e>=0)||!(e<=1))return(o=t?r._soundById(t):r._sounds[0])?o._volume:0;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"volume",action:function(){r.volume.apply(r,a)}}),r;void 0===t&&(r._volume=e),t=r._getSoundIds(t);for(var n=0;n<t.length;n++)(o=r._soundById(t[n]))&&(o._volume=e,a[2]||r._stopFade(t[n]),r._webAudio&&o._node&&!o._muted?o._node.gain.setValueAtTime(e,p.ctx.currentTime):o._node&&!o._muted&&(o._node.volume=e*p.volume()),r._emit("volume",o._id));return r},fade:function(e,t,o,r){var a=this;if("loaded"!==a._state||a._playLock)return a._queue.push({event:"fade",action:function(){a.fade(e,t,o,r)}}),a;e=Math.min(Math.max(0,parseFloat(e)),1),t=Math.min(Math.max(0,parseFloat(t)),1),o=parseFloat(o),a.volume(e,r);for(var n=a._getSoundIds(r),s=0;s<n.length;s++){var i=a._soundById(n[s]);if(i){if(r||a._stopFade(n[s]),a._webAudio&&!i._muted){var l=p.ctx.currentTime,f=l+o/1e3;i._volume=e,i._node.gain.setValueAtTime(e,l),i._node.gain.linearRampToValueAtTime(t,f)}a._startFadeInterval(i,e,t,o,n[s],void 0===r)}}return a},_startFadeInterval:function(e,t,o,r,a,n){var s=this,i=t,l=o-t,f=Math.abs(l/.01),u=Math.max(4,f>0?r/f:r),c=Date.now();e._fadeTo=o,e._interval=setInterval(function(){var a=(Date.now()-c)/r;c=Date.now(),i+=l*a,i=Math.round(100*i)/100,i=l<0?Math.max(o,i):Math.min(o,i),s._webAudio?e._volume=i:s.volume(i,e._id,!0),n&&(s._volume=i),(o<t&&i<=o||o>t&&i>=o)&&(clearInterval(e._interval),e._interval=null,e._fadeTo=null,s.volume(o,e._id),s._emit("fade",e._id))},u)},_stopFade:function(e){var t=this._soundById(e);return t&&t._interval&&(this._webAudio&&t._node.gain.cancelScheduledValues(p.ctx.currentTime),clearInterval(t._interval),t._interval=null,this.volume(t._fadeTo,e),t._fadeTo=null,this._emit("fade",e)),this},loop:function(){var e,t,o,r=arguments;if(0===r.length)return this._loop;if(1===r.length)if("boolean"!=typeof r[0])return!!(o=this._soundById(parseInt(r[0],10)))&&o._loop;else e=r[0],this._loop=e;else 2===r.length&&(e=r[0],t=parseInt(r[1],10));for(var a=this._getSoundIds(t),n=0;n<a.length;n++)(o=this._soundById(a[n]))&&(o._loop=e,this._webAudio&&o._node&&o._node.bufferSource&&(o._node.bufferSource.loop=e,e&&(o._node.bufferSource.loopStart=o._start||0,o._node.bufferSource.loopEnd=o._stop,this.playing(a[n])&&(this.pause(a[n],!0),this.play(a[n],!0)))));return this},rate:function(){var e,t,o,r=this,a=arguments;if(0===a.length?t=r._sounds[0]._id:1===a.length?r._getSoundIds().indexOf(a[0])>=0?t=parseInt(a[0],10):e=parseFloat(a[0]):2===a.length&&(e=parseFloat(a[0]),t=parseInt(a[1],10)),"number"!=typeof e)return(o=r._soundById(t))?o._rate:r._rate;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"rate",action:function(){r.rate.apply(r,a)}}),r;void 0===t&&(r._rate=e),t=r._getSoundIds(t);for(var n=0;n<t.length;n++)if(o=r._soundById(t[n])){r.playing(t[n])&&(o._rateSeek=r.seek(t[n]),o._playStart=r._webAudio?p.ctx.currentTime:o._playStart),o._rate=e,r._webAudio&&o._node&&o._node.bufferSource?o._node.bufferSource.playbackRate.setValueAtTime(e,p.ctx.currentTime):o._node&&(o._node.playbackRate=e);var s=r.seek(t[n]),i=1e3*((r._sprite[o._sprite][0]+r._sprite[o._sprite][1])/1e3-s)/Math.abs(o._rate);(r._endTimers[t[n]]||!o._paused)&&(r._clearTimer(t[n]),r._endTimers[t[n]]=setTimeout(r._ended.bind(r,o),i)),r._emit("rate",o._id)}return r},seek:function(){var e,t,o=this,r=arguments;if(0===r.length?o._sounds.length&&(t=o._sounds[0]._id):1===r.length?o._getSoundIds().indexOf(r[0])>=0?t=parseInt(r[0],10):o._sounds.length&&(t=o._sounds[0]._id,e=parseFloat(r[0])):2===r.length&&(e=parseFloat(r[0]),t=parseInt(r[1],10)),void 0===t)return 0;if("number"==typeof e&&("loaded"!==o._state||o._playLock))return o._queue.push({event:"seek",action:function(){o.seek.apply(o,r)}}),o;var a=o._soundById(t);if(a)if("number"==typeof e&&e>=0){var n=o.playing(t);n&&o.pause(t,!0),a._seek=e,a._ended=!1,o._clearTimer(t),o._webAudio||!a._node||isNaN(a._node.duration)||(a._node.currentTime=e);var s=function(){n&&o.play(t,!0),o._emit("seek",t)};if(n&&!o._webAudio){var i=function(){o._playLock?setTimeout(i,0):s()};setTimeout(i,0)}else s()}else{if(!o._webAudio)return a._node.currentTime;var l=o.playing(t)?p.ctx.currentTime-a._playStart:0,f=a._rateSeek?a._rateSeek-a._seek:0;return a._seek+(f+l*Math.abs(a._rate))}return o},playing:function(e){if("number"==typeof e){var t=this._soundById(e);return!!t&&!t._paused}for(var o=0;o<this._sounds.length;o++)if(!this._sounds[o]._paused)return!0;return!1},duration:function(e){var t=this._duration,o=this._soundById(e);return o&&(t=this._sprite[o._sprite][1]/1e3),t},state:function(){return this._state},unload:function(){for(var e=this,t=e._sounds,o=0;o<t.length;o++)t[o]._paused||e.stop(t[o]._id),e._webAudio||(e._clearSound(t[o]._node),t[o]._node.removeEventListener("error",t[o]._errorFn,!1),t[o]._node.removeEventListener(p._canPlayEvent,t[o]._loadFn,!1),t[o]._node.removeEventListener("ended",t[o]._endFn,!1),p._releaseHtml5Audio(t[o]._node)),delete t[o]._node,e._clearTimer(t[o]._id);var r=p._howls.indexOf(e);r>=0&&p._howls.splice(r,1);var a=!0;for(o=0;o<p._howls.length;o++)if(p._howls[o]._src===e._src||e._src.indexOf(p._howls[o]._src)>=0){a=!1;break}return x&&a&&delete x[e._src],p.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,t,o,r){var a=this["_on"+e];return"function"==typeof t&&a.push(r?{id:o,fn:t,once:r}:{id:o,fn:t}),this},off:function(e,t,o){var r=this["_on"+e],a=0;if("number"==typeof t&&(o=t,t=null),t||o)for(a=0;a<r.length;a++){var n=o===r[a].id;if(t===r[a].fn&&n||!t&&n){r.splice(a,1);break}}else if(e)this["_on"+e]=[];else{var s=Object.keys(this);for(a=0;a<s.length;a++)0===s[a].indexOf("_on")&&Array.isArray(this[s[a]])&&(this[s[a]]=[])}return this},once:function(e,t,o){return this.on(e,t,o,1),this},_emit:function(e,t,o){for(var r=this["_on"+e],a=r.length-1;a>=0;a--)(!r[a].id||r[a].id===t||"load"===e)&&(setTimeout((function(e){e.call(this,t,o)}).bind(this,r[a].fn),0),r[a].once&&this.off(e,r[a].fn,r[a].id));return this._loadQueue(e),this},_loadQueue:function(e){if(this._queue.length>0){var t=this._queue[0];t.event===e&&(this._queue.shift(),this._loadQueue()),e||t.action()}return this},_ended:function(e){var t=e._sprite;if(!this._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(this._ended.bind(this,e),100),this;var o=!!(e._loop||this._sprite[t][2]);if(this._emit("end",e._id),!this._webAudio&&o&&this.stop(e._id,!0).play(e._id),this._webAudio&&o){this._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=p.ctx.currentTime;var r=(e._stop-e._start)*1e3/Math.abs(e._rate);this._endTimers[e._id]=setTimeout(this._ended.bind(this,e),r)}return this._webAudio&&!o&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,this._clearTimer(e._id),this._cleanBuffer(e._node),p._autoSuspend()),this._webAudio||o||this.stop(e._id,!0),this},_clearTimer:function(e){if(this._endTimers[e]){if("function"!=typeof this._endTimers[e])clearTimeout(this._endTimers[e]);else{var t=this._soundById(e);t&&t._node&&t._node.removeEventListener("ended",this._endTimers[e],!1)}delete this._endTimers[e]}return this},_soundById:function(e){for(var t=0;t<this._sounds.length;t++)if(e===this._sounds[t]._id)return this._sounds[t];return null},_inactiveSound:function(){this._drain();for(var e=0;e<this._sounds.length;e++)if(this._sounds[e]._ended)return this._sounds[e].reset();return new m(this)},_drain:function(){var e=this._pool,t=0,o=0;if(!(this._sounds.length<e)){for(o=0;o<this._sounds.length;o++)this._sounds[o]._ended&&t++;for(o=this._sounds.length-1;o>=0;o--){if(t<=e)return;this._sounds[o]._ended&&(this._webAudio&&this._sounds[o]._node&&this._sounds[o]._node.disconnect(0),this._sounds.splice(o,1),t--)}}},_getSoundIds:function(e){if(void 0!==e)return[e];for(var t=[],o=0;o<this._sounds.length;o++)t.push(this._sounds[o]._id);return t},_refreshBuffer:function(e){return e._node.bufferSource=p.ctx.createBufferSource(),e._node.bufferSource.buffer=x[this._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,p.ctx.currentTime),this},_cleanBuffer:function(e){var t=p._navigator&&p._navigator.vendor.indexOf("Apple")>=0;if(!e.bufferSource)return this;if(p._scratchBuffer&&e.bufferSource&&(e.bufferSource.onended=null,e.bufferSource.disconnect(0),t))try{e.bufferSource.buffer=p._scratchBuffer}catch(e){}return e.bufferSource=null,this},_clearSound:function(e){/MSIE |Trident\//.test(p._navigator&&p._navigator.userAgent)||(e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}},(m=function(e){this._parent=e,this.init()}).prototype={init:function(){var e=this._parent;return this._muted=e._muted,this._loop=e._loop,this._volume=e._volume,this._rate=e._rate,this._seek=0,this._paused=!0,this._ended=!0,this._sprite="__default",this._id=++p._counter,e._sounds.push(this),this.create(),this},create:function(){var e=this._parent,t=p._muted||this._muted||this._parent._muted?0:this._volume;return e._webAudio?(this._node=void 0===p.ctx.createGain?p.ctx.createGainNode():p.ctx.createGain(),this._node.gain.setValueAtTime(t,p.ctx.currentTime),this._node.paused=!0,this._node.connect(p.masterGain)):p.noAudio||(this._node=p._obtainHtml5Audio(),this._errorFn=this._errorListener.bind(this),this._node.addEventListener("error",this._errorFn,!1),this._loadFn=this._loadListener.bind(this),this._node.addEventListener(p._canPlayEvent,this._loadFn,!1),this._endFn=this._endListener.bind(this),this._node.addEventListener("ended",this._endFn,!1),this._node.src=e._src,this._node.preload=!0===e._preload?"auto":e._preload,this._node.volume=t*p.volume(),this._node.load()),this},reset:function(){var e=this._parent;return this._muted=e._muted,this._loop=e._loop,this._volume=e._volume,this._rate=e._rate,this._seek=0,this._rateSeek=0,this._paused=!0,this._ended=!0,this._sprite="__default",this._id=++p._counter,this},_errorListener:function(){this._parent._emit("loaderror",this._id,this._node.error?this._node.error.code:0),this._node.removeEventListener("error",this._errorFn,!1)},_loadListener:function(){var e=this._parent;e._duration=Math.ceil(10*this._node.duration)/10,0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue()),this._node.removeEventListener(p._canPlayEvent,this._loadFn,!1)},_endListener:function(){var e=this._parent;e._duration===1/0&&(e._duration=Math.ceil(10*this._node.duration)/10,e._sprite.__default[1]===1/0&&(e._sprite.__default[1]=1e3*e._duration),e._ended(this)),this._node.removeEventListener("ended",this._endFn,!1)}},x={},g=function(e){var t=e._src;if(x[t]){e._duration=x[t].duration,M(e);return}if(/^data:[^;]+;base64,/.test(t)){for(var o=atob(t.split(",")[1]),r=new Uint8Array(o.length),a=0;a<o.length;++a)r[a]=o.charCodeAt(a);v(r.buffer,e)}else{var n=new XMLHttpRequest;n.open(e._xhr.method,t,!0),n.withCredentials=e._xhr.withCredentials,n.responseType="arraybuffer",e._xhr.headers&&Object.keys(e._xhr.headers).forEach(function(t){n.setRequestHeader(t,e._xhr.headers[t])}),n.onload=function(){var t=(n.status+"")[0];"0"!==t&&"2"!==t&&"3"!==t?e._emit("loaderror",null,"Failed loading audio file with status: "+n.status+"."):v(n.response,e)},n.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete x[t],e.load())},y(n)}},y=function(e){try{e.send()}catch(t){e.onerror()}},v=function(e,t){var o=function(){t._emit("loaderror",null,"Decoding audio data failed.")},r=function(e){e&&t._sounds.length>0?(x[t._src]=e,M(t,e)):o()};"undefined"!=typeof Promise&&1===p.ctx.decodeAudioData.length?p.ctx.decodeAudioData(e).then(r).catch(o):p.ctx.decodeAudioData(e,r,o)},M=function(e,t){t&&!e._duration&&(e._duration=t.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},T=function(){if(p.usingWebAudio){try{"undefined"!=typeof AudioContext?p.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?p.ctx=new webkitAudioContext:p.usingWebAudio=!1}catch(e){p.usingWebAudio=!1}p.ctx||(p.usingWebAudio=!1);var e=/iP(hone|od|ad)/.test(p._navigator&&p._navigator.platform),t=p._navigator&&p._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),o=t?parseInt(t[1],10):null;if(e&&o&&o<9){var r=/safari/.test(p._navigator&&p._navigator.userAgent.toLowerCase());p._navigator&&!r&&(p.usingWebAudio=!1)}p.usingWebAudio&&(p.masterGain=void 0===p.ctx.createGain?p.ctx.createGainNode():p.ctx.createGain(),p.masterGain.gain.setValueAtTime(p._muted?0:p._volume,p.ctx.currentTime),p.masterGain.connect(p.ctx.destination)),p._setup()}},"function"==typeof define&&define.amd&&define([],function(){return{Howler:p,Howl:h}}),L=p,void 0!==R?(R.HowlerGlobal=d,R.Howler=p,R.Howl=h,R.Sound=m):"undefined"!=typeof window&&(window.HowlerGlobal=d,window.Howler=p,window.Howl=h,window.Sound=m),HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){if(!this.ctx||!this.ctx.listener)return this;for(var t=this._howls.length-1;t>=0;t--)this._howls[t].stereo(e);return this},HowlerGlobal.prototype.pos=function(e,t,o){return this.ctx&&this.ctx.listener?(t="number"!=typeof t?this._pos[1]:t,o="number"!=typeof o?this._pos[2]:o,"number"!=typeof e)?this._pos:(this._pos=[e,t,o],void 0!==this.ctx.listener.positionX?(this.ctx.listener.positionX.setTargetAtTime(this._pos[0],Howler.ctx.currentTime,.1),this.ctx.listener.positionY.setTargetAtTime(this._pos[1],Howler.ctx.currentTime,.1),this.ctx.listener.positionZ.setTargetAtTime(this._pos[2],Howler.ctx.currentTime,.1)):this.ctx.listener.setPosition(this._pos[0],this._pos[1],this._pos[2]),this):this},HowlerGlobal.prototype.orientation=function(e,t,o,r,a,n){if(!this.ctx||!this.ctx.listener)return this;var s=this._orientation;return(t="number"!=typeof t?s[1]:t,o="number"!=typeof o?s[2]:o,r="number"!=typeof r?s[3]:r,a="number"!=typeof a?s[4]:a,n="number"!=typeof n?s[5]:n,"number"!=typeof e)?s:(this._orientation=[e,t,o,r,a,n],void 0!==this.ctx.listener.forwardX?(this.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),this.ctx.listener.forwardY.setTargetAtTime(t,Howler.ctx.currentTime,.1),this.ctx.listener.forwardZ.setTargetAtTime(o,Howler.ctx.currentTime,.1),this.ctx.listener.upX.setTargetAtTime(r,Howler.ctx.currentTime,.1),this.ctx.listener.upY.setTargetAtTime(a,Howler.ctx.currentTime,.1),this.ctx.listener.upZ.setTargetAtTime(n,Howler.ctx.currentTime,.1)):this.ctx.listener.setOrientation(e,t,o,r,a,n),this)},Howl.prototype.init=(S=Howl.prototype.init,function(e){return this._orientation=e.orientation||[1,0,0],this._stereo=e.stereo||null,this._pos=e.pos||null,this._pannerAttr={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:360,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:360,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:0,distanceModel:void 0!==e.distanceModel?e.distanceModel:"inverse",maxDistance:void 0!==e.maxDistance?e.maxDistance:1e4,panningModel:void 0!==e.panningModel?e.panningModel:"HRTF",refDistance:void 0!==e.refDistance?e.refDistance:1,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:1},this._onstereo=e.onstereo?[{fn:e.onstereo}]:[],this._onpos=e.onpos?[{fn:e.onpos}]:[],this._onorientation=e.onorientation?[{fn:e.onorientation}]:[],S.call(this,e)}),Howl.prototype.stereo=function(e,t){var o=this;if(!o._webAudio)return o;if("loaded"!==o._state)return o._queue.push({event:"stereo",action:function(){o.stereo(e,t)}}),o;var r=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===t)if("number"!=typeof e)return o._stereo;else o._stereo=e,o._pos=[e,0,0];for(var a=o._getSoundIds(t),n=0;n<a.length;n++){var s=o._soundById(a[n]);if(s)if("number"!=typeof e)return s._stereo;else s._stereo=e,s._pos=[e,0,0],s._node&&(s._pannerAttr.panningModel="equalpower",s._panner&&s._panner.pan||b(s,r),"spatial"===r?void 0!==s._panner.positionX?(s._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),s._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),s._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):s._panner.setPosition(e,0,0):s._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),o._emit("stereo",s._id)}return o},Howl.prototype.pos=function(e,t,o,r){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"pos",action:function(){a.pos(e,t,o,r)}}),a;if(t="number"!=typeof t?0:t,o="number"!=typeof o?-.5:o,void 0===r)if("number"!=typeof e)return a._pos;else a._pos=[e,t,o];for(var n=a._getSoundIds(r),s=0;s<n.length;s++){var i=a._soundById(n[s]);if(i)if("number"!=typeof e)return i._pos;else i._pos=[e,t,o],i._node&&((!i._panner||i._panner.pan)&&b(i,"spatial"),void 0!==i._panner.positionX?(i._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),i._panner.positionY.setValueAtTime(t,Howler.ctx.currentTime),i._panner.positionZ.setValueAtTime(o,Howler.ctx.currentTime)):i._panner.setPosition(e,t,o)),a._emit("pos",i._id)}return a},Howl.prototype.orientation=function(e,t,o,r){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"orientation",action:function(){a.orientation(e,t,o,r)}}),a;if(t="number"!=typeof t?a._orientation[1]:t,o="number"!=typeof o?a._orientation[2]:o,void 0===r)if("number"!=typeof e)return a._orientation;else a._orientation=[e,t,o];for(var n=a._getSoundIds(r),s=0;s<n.length;s++){var i=a._soundById(n[s]);if(i)if("number"!=typeof e)return i._orientation;else i._orientation=[e,t,o],i._node&&(i._panner||(i._pos||(i._pos=a._pos||[0,0,-.5]),b(i,"spatial")),void 0!==i._panner.orientationX?(i._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),i._panner.orientationY.setValueAtTime(t,Howler.ctx.currentTime),i._panner.orientationZ.setValueAtTime(o,Howler.ctx.currentTime)):i._panner.setOrientation(e,t,o)),a._emit("orientation",i._id)}return a},Howl.prototype.pannerAttr=function(){var e,t,o,r=arguments;if(!this._webAudio)return this;if(0===r.length)return this._pannerAttr;if(1===r.length)if("object"!=typeof r[0])return(o=this._soundById(parseInt(r[0],10)))?o._pannerAttr:this._pannerAttr;else e=r[0],void 0===t&&(e.pannerAttr||(e.pannerAttr={coneInnerAngle:e.coneInnerAngle,coneOuterAngle:e.coneOuterAngle,coneOuterGain:e.coneOuterGain,distanceModel:e.distanceModel,maxDistance:e.maxDistance,refDistance:e.refDistance,rolloffFactor:e.rolloffFactor,panningModel:e.panningModel}),this._pannerAttr={coneInnerAngle:void 0!==e.pannerAttr.coneInnerAngle?e.pannerAttr.coneInnerAngle:this._coneInnerAngle,coneOuterAngle:void 0!==e.pannerAttr.coneOuterAngle?e.pannerAttr.coneOuterAngle:this._coneOuterAngle,coneOuterGain:void 0!==e.pannerAttr.coneOuterGain?e.pannerAttr.coneOuterGain:this._coneOuterGain,distanceModel:void 0!==e.pannerAttr.distanceModel?e.pannerAttr.distanceModel:this._distanceModel,maxDistance:void 0!==e.pannerAttr.maxDistance?e.pannerAttr.maxDistance:this._maxDistance,refDistance:void 0!==e.pannerAttr.refDistance?e.pannerAttr.refDistance:this._refDistance,rolloffFactor:void 0!==e.pannerAttr.rolloffFactor?e.pannerAttr.rolloffFactor:this._rolloffFactor,panningModel:void 0!==e.pannerAttr.panningModel?e.pannerAttr.panningModel:this._panningModel});else 2===r.length&&(e=r[0],t=parseInt(r[1],10));for(var a=this._getSoundIds(t),n=0;n<a.length;n++)if(o=this._soundById(a[n])){var s=o._pannerAttr;s={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:s.coneInnerAngle,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:s.coneOuterAngle,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:s.coneOuterGain,distanceModel:void 0!==e.distanceModel?e.distanceModel:s.distanceModel,maxDistance:void 0!==e.maxDistance?e.maxDistance:s.maxDistance,refDistance:void 0!==e.refDistance?e.refDistance:s.refDistance,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:s.rolloffFactor,panningModel:void 0!==e.panningModel?e.panningModel:s.panningModel};var i=o._panner;i||(o._pos||(o._pos=this._pos||[0,0,-.5]),b(o,"spatial"),i=o._panner),i.coneInnerAngle=s.coneInnerAngle,i.coneOuterAngle=s.coneOuterAngle,i.coneOuterGain=s.coneOuterGain,i.distanceModel=s.distanceModel,i.maxDistance=s.maxDistance,i.refDistance=s.refDistance,i.rolloffFactor=s.rolloffFactor,i.panningModel=s.panningModel}return this},Sound.prototype.init=(_=Sound.prototype.init,function(){var e=this._parent;this._orientation=e._orientation,this._stereo=e._stereo,this._pos=e._pos,this._pannerAttr=e._pannerAttr,_.call(this),this._stereo?e.stereo(this._stereo):this._pos&&e.pos(this._pos[0],this._pos[1],this._pos[2],this._id)}),Sound.prototype.reset=(w=Sound.prototype.reset,function(){var e=this._parent;return this._orientation=e._orientation,this._stereo=e._stereo,this._pos=e._pos,this._pannerAttr=e._pannerAttr,this._stereo?e.stereo(this._stereo):this._pos?e.pos(this._pos[0],this._pos[1],this._pos[2],this._id):this._panner&&(this._panner.disconnect(0),this._panner=void 0,e._refreshBuffer(this)),w.call(this)}),b=function(e,t){"spatial"===(t=t||"spatial")?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,void 0!==e._panner.positionX?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),void 0!==e._panner.orientationX?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)};var oa={};oa=import.meta.resolve("8Qic0");var on={};on=import.meta.resolve("aSqJ5");var os={};os=import.meta.resolve("hMICc");var oi={};oi=import.meta.resolve("cFOzA");var ol={};ol=import.meta.resolve("iP5rH");var of={};of=import.meta.resolve("4cgQm");var ou={};ou=import.meta.resolve("5uP20");var oc={};oc=import.meta.resolve("koWqL");var od={};od=import.meta.resolve("drQCs");var op={};op=import.meta.resolve("aKQuT");let oh=[G("bZifA"),G("9qMhI"),G("fYODv"),G("fZvEG"),G("cbMOk"),G("il31g")],om=[G("86fkK"),G("gc0x6"),G("9y2j6"),G("f6SOA"),G("ky2OH"),G("c4aYR"),G("i9Hc6")],ox=[G("c4aYR")],og=[G("4qPCJ")],oy=[G("cOvAc"),G("l7VP5"),G("GXUFG"),G("ahYBJ"),G("6gEAv")],ov=[G("eAM39"),G("79dd6"),G("kFQ7m"),G("coJNA"),G("5iPq3"),G("7wbJU"),G("es8xU"),G("1tzXL")],oM=[G("3oNvH"),G("6NJnm"),G("913qQ"),G("eR3jk")],oT=[G("kLy4D")],oS=[G("fyy7J")],o_=[G("j1itu")],ow=[G("9EmTp"),G("3IaJ1")],ob=[G("cfnuz"),G("5Eei7")],oI=[G("fbQUH"),G("z6FJY"),G("csNnr"),G("lwVjt"),G("aw75f"),G("gJf4b")],oA=[G("gWaKj"),G("hnMpe"),G("6cGgY"),G("8rnx8"),G("j8GRe")],oC=[G("lvgrG")],oP=[G("kUtJa"),G("alWWz")],ok=[G("goBDs"),G("i8Uwd")],oL=[G("OUSAv"),G("kzjl8")],oR=[G("3bVzR"),G("ePvn4"),G("dp5QF"),G("evxcG")],oD=[G("63vGw")],oW=[G("gE7wT")],oG=[G("2EAaD")],oV=[G("bgV1c")],oE=[G("5eFZQ")],oB=[G("2D0Ne")],oN=[G("buzUW")],oF=[G("azFs4")],oO=[G("fJQmZ")],oz=[G("gLU2l")],oH=[G("5gFXt"),G("9XfEf")],oX=[G("49Btu")],oq=[G("kJjXM")],oY=[G("1tYMJ")],oU=[G("6TE9j")],oj=[G("g38fU"),G("3rS96")],oK=[[G("43O7W"),"Hmm..."],[G("c9jO4"),"What?"],[G("5Kerx"),"Hey!"],[G("iVLRE"),"Hey!"],[G("emH6d"),"Hey!"],[G("3qCyM"),"What was that?"],[G("6vESL"),"What was that?"],[G("fFW7g"),"What was that?"],[G("2sujD"),"What was that?"],[G("feMzH"),"What was that?"],[G("c1jIH"),"Who goes there?"],[G("cKCCq"),"Huh?"],[G("c9jO4"),"What?"],[G("6yygh"),"Wha..."],[G("01KdD"),"Wait!"],[G("eok2J"),"Who's there?"],[G("kvYlb"),"What moved?"],[G("cldiI"),"What's that\nin the shadows?"],[G("eYFx7"),"Did that\nshadow move?"],[G("6qxt0"),"I see\nsomething!"],[G("5lXXf"),"Hello?"],[G("hfY5Y"),"Uhh..."]],o$=[[G("bA3sa"),"Ahh..."],[G("8k0Qi"),"Aww..."],[G("7uKsU"),"Quiet out..."],[G("fmmGn"),"Rest me old\nbones..."]],oQ=[[G("43O7W"),"Hmm..."],[G("c9jO4"),"What?"],[G("3qCyM"),"What was that?"],[G("7uKsU"),"Quiet out\nthere..."],[G("QOeWk"),"Jumpy tonight..."],[G("kZqd6"),"Jumpin' at\nshadows!"],[G("43O7W"),"Hmm..."],[G("7PTXP"),"Oh well..."],[G("bPoGH"),"I've got myself\na case of the\njitters..."],[G("jqF9D"),"I must be\nseein' things..."],[G("jaqDX"),"What'd they put\nin my coffee?"],[G("aPs4K"),"Coffee must be\ntoo strong!"],[G("6yDab"),"Hmm!\nNothing..."],[G("iBHcZ"),"Well, I thought\nI saw something."],[G("kY7X2"),"Nothing..."],[G("9NjUG"),"Hopefully\nnothing."],[G("hlpqA"),"Seein' things,\nI guess."],[G("hlpqA"),"Seein' things,\nI guess."]],oJ=[[G("43O7W"),"Hmm..."],[G("c9jO4"),"What?"],[G("3qCyM"),"What was that?"],[G("QOeWk"),"Jumpy tonight..."],[G("43O7W"),"Hmm..."],[G("7PTXP"),"Oh well..."],[G("bPoGH"),"I've got myself\na case of the\njitters..."],[G("jqF9D"),"I must be\nseein' things..."],[G("jaqDX"),"What'd they put\nin my coffee?"],[G("aPs4K"),"Coffee must be\ntoo strong!"],[G("6yDab"),"Hmm!\nNothing..."],[G("kY7X2"),"Nothing..."],[G("9NjUG"),"Hopefully\nnothing."],[G("hlpqA"),"Seein' things,\nI guess."],[G("hlpqA"),"Seein' things,\nI guess."]],oZ=[[G("43O7W"),"Hmm..."],[G("c9jO4"),"What?"],[G("fFs4W"),"What?"],[G("5Kerx"),"Hey!"],[G("iVLRE"),"Hey!"],[G("emH6d"),"Hey!"],[G("3qCyM"),"What was that?"],[G("6vESL"),"What was that?"],[G("fFW7g"),"What was that?"],[G("2sujD"),"What was that?"],[G("feMzH"),"What was that?"],[G("cKCCq"),"Huh?"],[G("c9jO4"),"What?"],[G("6yygh"),"Wha..."],[G("01KdD"),"Wait!"],[G("eok2J"),"Who's there?"],[G("5lXXf"),"Hello?"],[G("hfY5Y"),"Uhh..."],[G("1JXKA"),"Hark?"],[G("iULM2"),"What was that noise?"],[G("iULM2"),"What was that noise?"],[G("5VcJO"),"I heard something..."],[G("5VcJO"),"I heard something..."]],o0=[[G("43O7W"),"Hmm..."],[G("QOeWk"),"Jumpy tonight..."],[G("7PTXP"),"Oh well..."],[G("bPoGH"),"I've got myself\na case of the\njitters..."],[G("jaqDX"),"What's in my\ncoffee today?"],[G("aPs4K"),"Coffee must be\ntoo strong!"],[G("6yDab"),"Hmm!\nNothing..."],[G("cXQUF"),"Well, I can't\nhear it now."],[G("kY7X2"),"Nothing..."],[G("9NjUG"),"Hopefully\nnothing."],[G("3gHhF"),"I must be\nhearing things."]],o1=[[G("43O7W"),"Hmm..."],[G("5Kerx"),"Hey!"],[G("iVLRE"),"Hey!"],[G("emH6d"),"Hey!"],[G("c9jO4"),"What?"],[G("iHYo6"),"That noise\nagain?"],[G("j20ob"),"Someone's there!"],[G("j9Rz8"),"Who could\nthat be?"],[G("lpSrB"),"Better check\nit out."],[G("8DaLD"),"That better\nbe rats!"],[G("fqr9g"),"Who is that?"],[G("e8ETw"),"Come out, come out\nwherever you are!"]],o2=[[G("43O7W"),"Hmm..."],[G("kZqd6"),"Jumpin' at\nshadows!"],[G("QOeWk"),"Jumpy!"],[G("7PTXP"),"Oh, well."],[G("jr8SH"),"Guess it was\nnothing."],[G("20azL"),"Wonder what it was."],[G("a81ga"),"Back to my post."],[G("6to09"),"All quiet now."],[G("4olbl"),"I'm sure I\nheard something."],[G("adztJ"),"Not there anymore."],[G("bvaO7"),"Probably nothing."],[G("6yDab"),"Hmm!\nNothing."],[G("6GfQf"),"I don't know why\nI work here."],[G("7DKaJ"),"Waste of my time."],[G("irMWQ"),"Why do I\neven try?"],[G("bb9lM"),"At least I'm not\non cleaning duty."],[G("60j7T"),"At least my\nshift ends soon."],[G("i2oiA"),"What do you\nwant me to\ndo about it?"]],o5=[[G("emH6d"),"Hey!"],[G("c9jO4"),"What?"],[G("4lBTY"),"Coming!"],[G("fbmZR"),"To arms!"]],o4=[[G("1VbLw"),"That torch is out!"],[G("gv37W"),"That light\nburned out!"],[G("8IcSg"),"It's too dark\nin here."],[G("1zJJr"),"Let's have\nmore light."]],o3=[[G("cKgmk"),"That's better."],[G("9IP2s"),"There we go."],[G("84YcX"),"Now where was I?"]],o6=[[G("4LBOi"),"(Whistle)"],[G("7wOfL"),"(Whistle)"],[G("dUgaz"),"(Whistle)"],[G("gDkOj"),"Get 'em!"],[G("gwZ7I"),"Intruder!"],[G("dEvUk"),"Oh no...\nIt's a thief!"],[G("5RC1f"),"We're coming\nfor you!"],[G("ef2yI"),"Coming for you!"],[G("9U36H"),"Halt!"],[G("jopYq"),"We see you!"],[G("98tHU"),"I'll get you!"],[G("8R99b"),"You're a goner!"],[G("ih1IF"),"Just you wait!"],[G("6phI5"),"You won't get away!"],[G("3vzqZ"),"No you don't!"],[G("kbVk5"),"Thief!"],[G("hN6aL"),"Thief!"],[G("lpCzF"),"Thief!"],[G("4AA8Z"),"After them!"],[G("hjwgF"),"What is thy business\nwith this gold?"],[G("2L2dz"),"No mercy for\nthe wicked!"]],o8=[[G("lnokg"),"Must have\nrun off..."],[G("7PTXP"),"Oh, well..."],[G("4NcZF"),"Where did they go?"],[G("k91ZK"),"His Holiness would\nnot be pleased!"],[G("5vx2L"),"The boss will\nnot be pleased!"],[G("dUPla"),"I give up!"],[G("dNXo7"),"Gone!"],[G("kWhL5"),"Come back here!"],[G("abc0D"),"Rotten scoundrel!"],[G("bUQ7X"),"Aargh!!"],[G("1UIEn"),"Blast!"],[G("9xXTA"),"Don't come back!"],[G("65bcZ"),"You won't\nget away\nnext time!"],[G("ibeat"),"For His Holiness!"],[G("dOUlx"),"What a lousy day\nat work!"],[G("lnBdv"),"I give up..."],[G("lk4MI"),"What do I do?\nHelp me, help me..."],[G("2xGbt"),"(Guard rant)"]],o7=[[G("2iuwm"),"Someone smacked me!"],[G("4UyVN"),"Someone hit me!"],[G("bkjeq"),"Who hit me!?"],[G("fvBmS"),"Which of you\ndevils hit me!?"]],o9=[[G("crxnL"),"We have a guard down!"],[G("gzzaD"),"Man down!"],[G("iGImZ"),"Guard down!"]],re=[[G("bA3sa"),"Ahh..."]],rt=[[G("jKUkR"),"We must have\nan intruder!"],[G("iY97d"),"I will keep\nan eye out!"],[G("gwZ7I"),"Intruder!"]],ro=[[G("21LRM"),"Take that!!"],[G("8TOse"),"Oof!!"],[G("jYgPh"),"Ugg!!"],[G("idNdC"),"Ahh!!"],[G("c4Ce0"),"Ahh!!"],[G("i8P7h"),"Hi-yah!"],[G("bylK6"),"Hi-yah!"],[G("hBwm9"),"Hi-yah!"]],rr=[[G("43O7W"),"Hmm..."],[G("c9jO4"),"What?"],[G("5Kerx"),"Hey!"],[G("iVLRE"),"Hey!"],[G("emH6d"),"Hey!"],[G("3qCyM"),"What was that?"],[G("6vESL"),"What was that?"],[G("fFW7g"),"What was that?"],[G("2sujD"),"What was that?"],[G("feMzH"),"What was that?"],[G("c1jIH"),"Who goes there?"],[G("cKCCq"),"Huh?"],[G("c9jO4"),"What?"],[G("6yygh"),"Wha..."],[G("01KdD"),"Wait!"],[G("eok2J"),"Who's there?"],[G("5lXXf"),"Hello?"],[G("hfY5Y"),"Uhh..."]],ra=[[G("ixeqe"),"They don't\nstay lit!"],[G("dVRqe"),"That's enough to make\na guy paranoid!"],[G("2mOzt"),"Somebody should\nrelight that."],[G("a3Gmu"),"That torch\nburned out."],[G("jM4en"),"That light\nburned out."],[G("dvEhF"),"It got dark!"],[G("84XP6"),"Wish I had\na torch..."],[G("fOTiD"),"Why did that\nhappen?"]],rn=[[G("cKCCq"),"Huh?"],[G("c9jO4"),"What?"],[G("5Kerx"),"Hey!"],[G("iVLRE"),"Hey!"],[G("emH6d"),"Hey!"]],rs=[[G("2cy5S"),"Someone stole\nthe Treasure!"],[G("dLq2X"),"It's missing!"],[G("1Fbg9"),"Who took it?"],[G("fFqvL"),"The boss won't\nlike this!"]],ri=[[G("cKCCq"),"Huh?"],[G("c9jO4"),"What?"],[G("5Kerx"),"Hey!"],[G("iVLRE"),"Hey!"],[G("emH6d"),"Hey!"]];class rl{constructor(){this.activeHowls=[],this.activeLimit=2,this.fadeTime=1e3}setFadetime(e=1e3){return this.fadeTime=e,this}fade(e,t){return this.fadeTime>0?(e.fade(1,0,this.fadeTime,t),setTimeout(()=>e.stop(t),this.fadeTime)):e.stop(t),this}empty(){for(let e of this.activeHowls)this.fade(...e);return this.activeHowls=[],this}queue(e,t){if(this.activeHowls.unshift([e,t]),this.activeHowls.length>this.activeLimit){let e=this.activeHowls.pop();this.fade(...e)}return this.activeHowls=this.activeHowls.slice(0,this.activeLimit),this}}class rf{constructor(e,t=null){this.howls=e.map(e=>new h({src:[e]})),this.howlNum=0,this.soundPool=t,t3(this.howls)}play(e,t=0,o=!1){let r=this.next();r.loop(o),r.volume(e),r.stereo(t);try{let e=r.play();return null!==this.soundPool&&this.soundPool.queue(r,e),e}catch(e){console.log(`Audio playback error ${r}`,e)}return -1}next(){return this.howlNum++,this.howlNum==this.howls.length&&(this.howlNum=0,t3(this.howls)),this.howls[this.howlNum]}}class ru{constructor(e,t=null){this.sounds=e.map(rc),this.soundNum=0,this.soundPool=t,this.mute=!1,t3(this.sounds)}play(e,t=0){let o=this.next();if(!this.mute){o.sound.volume(e),o.sound.stereo(t);let r=o.sound.play();null!==this.soundPool&&this.soundPool.queue(o.sound,r)}return o}next(){let e=this.sounds[this.soundNum];return++this.soundNum,this.soundNum===this.sounds.length&&(this.soundNum=0,t3(this.sounds)),e}}function rc(e){return{sound:new h({src:[e[0]]}),subtitle:e[1]}}let rd={left:!1,right:!1,up:!1,down:!1,wait:!1,jump:!1,zoomIn:!1,zoomOut:!1,snapToPlayer:!1,menuAccept:!1,panUp:!1,panDown:!1,panLeft:!1,panRight:!1,menu:!1,menuBack:!1,menuToggle:!1,homePlay:!1,homeDaily:!1,homeStats:!1,homeAchievements:!1,homeOptions:!1,jumpToggle:!1,startLevel:!1,guardMute:!1,volumeMute:!1,volumeDown:!1,volumeUp:!1,forceRestart:!1,resetState:!1,seeAll:!1,collectLoot:!1,getKey:!1,markSeen:!1,guardSight:!1,guardPatrols:!1,roomAdjacencies:!1,nextLevel:!1,prevLevel:!1,fullscreen:!1,showSpeech:!1,idleCursorToggle:!1,showFPS:!1,devMenu:!1};var rp=null;let rh={"Alt+Comma":["prevLevel"],"Alt+KeyA":["seeAll"],"Alt+KeyB":["roomAdjacencies"],"Alt+KeyC":["collectLoot"],"Alt+KeyK":["getKey"],"Alt+KeyP":["guardPatrols"],"Alt+KeyR":["resetState"],"Alt+KeyS":["markSeen"],"Alt+KeyV":["guardSight"],"Alt+Period":["nextLevel"],"Alt+KeyF":["showFPS"],ArrowDown:["down"],ArrowLeft:["left"],ArrowRight:["right"],ArrowUp:["up"],BracketLeft:["zoomOut"],BracketRight:["zoomIn"],Digit0:["volumeMute"],Digit9:["guardMute"],Enter:["wait","menuAccept"],Equal:["volumeUp"],Escape:["menu","menuBack"],KeyA:["left","homeAchievements"],KeyC:["credits"],KeyD:["right","homeDaily","keyRepeatDelay"],KeyF:["jumpToggle","fullscreen"],KeyG:["guardMute"],KeyI:["idleCursorToggle"],KeyJ:["down","screenShakeEnabled"],KeyK:["up","keyRepeatRate"],KeyH:["left","helpControls"],KeyL:["right"],KeyM:["helpKey"],KeyN:["homeRestart","startLevel"],KeyO:["homeOptions"],KeyP:["homePlay"],KeyR:["homePlay"],KeyS:["down","homeStats","scorePopup"],KeyW:["up"],KeyX:["devMenu"],KeyZ:["wait","menuAccept"],Period:["wait","menuAccept"],Shift:["jump"],Slash:["menu","menuBack"],Space:["wait","menuAccept"],Minus:["volumeDown"],Numpad2:["down"],Numpad4:["left","menu"],Numpad6:["right","menuAccept"],Numpad8:["up"],Numpad5:["wait"],NumpadAdd:["jumpToggle"],NumpadEnter:["menuAccept"],Tab:["showSpeech"],"Control+ArrowDown":["panDown"],"Control+ArrowLeft":["panLeft"],"Control+ArrowRight":["panRight"],"Control+ArrowUp":["panUp"],"Control+KeyA":["panLeft"],"Control+KeyD":["panRight"],"Control+KeyH":["panLeft"],"Control+KeyJ":["panUp"],"Control+KeyK":["panDown"],"Control+KeyL":["panRight"],"Control+KeyR":["forceRestart"],"Control+KeyS":["panDown"],"Control+KeyW":["panUp"],"Control+Numpad2":["panDown"],"Control+Numpad4":["panLeft"],"Control+Numpad6":["panRight"],"Control+Numpad8":["panUp"],"Control+Z":["snapToPlayer"],"Control+Numpad5":["snapToPlayer"],"Control+Period":["snapToPlayer"],"Control+Space":["snapToPlayer"]};class rm extends Array{constructor(e=0,t=0,o=0,r=0){super(e,t,o,r)}collide(e,t,o=0,r=0){return!(e+o<this[0])&&!(t+r<this[1])&&!(e>=this[0]+this[2])&&!(t>=this[1]+this[3])}}class rx{constructor(){for(let e in this.currentFramePresses=new Set,this.controlStates={...rd},this.controlTimes={},this.controlStates)this.controlTimes[e]=Date.now();window.addEventListener("blur",e=>{this.clearPressedAll()})}setPressed(e,t,o=!0){this.controlStates[e]=t,this.controlTimes[e]=Date.now(),o&&t&&this.currentFramePresses.add(e),rp=this}clearPressedAll(){for(let e in this.controlStates)this.controlStates[e]=!1}endFrame(){this.currentFramePresses.clear()}}class rg extends rx{constructor(e=null){super(),null==e&&(e=rh),this.keyMap=e;let t=this;document.onkeydown=function(e){t.keyDownHandler(e)},document.onkeyup=function(e){t.keyUpHandler(e)}}getCode(e){let t=e.code;return e.altKey&&"AltLeft"!==e.code&&"AltRight"!==e.code&&(t="Alt+"+t),e.ctrlKey&&"ControlLeft"!==e.code&&"ControlRight"!==e.code&&(t="Control+"+t),("AltLeft"==e.code||"AltRight"==e.code)&&(t="Alt"),("ShiftLeft"==e.code||"ShiftRight"==e.code)&&(t="Shift"),("ControlLeft"==e.code||"ControlRight"==e.code)&&(t="Control"),t}updateModifierDown(e){for(let t in this.keyMap)for(let o of this.keyMap[t])!t.includes(e)&&this.controlStates[o]&&(this.controlStates[o]=!1)}updateModifierUp(e){for(let t in this.keyMap)for(let o of this.keyMap[t])t.includes(e)&&this.controlStates[o]&&(this.controlStates[o]=!1)}keyDownHandler(e){rp=this;let t=this.getCode(e);if(["Alt","Control"].includes(t)&&this.updateModifierDown(t),t in this.keyMap)for(let o of(e.preventDefault(),this.keyMap[t]))this.controlStates[o]||this.setPressed(o,!0)}keyUpHandler(e){let t=this.getCode(e);if(["Alt","Control"].includes(t)&&this.updateModifierUp(t),t in this.keyMap)for(let o of(e.preventDefault(),this.keyMap[t]))this.setPressed(o,!1)}}class ry extends rx{constructor(e){super(),this.gamepad=e,this.thresh=.4,this.internalStates={...this.controlStates}}setPressed(e,t){this.internalStates[e]!=t&&(this.internalStates[e]=t,super.setPressed(e,t))}}class rv{constructor(){window.addEventListener("gamepadconnected",e=>this.connected(e)),window.addEventListener("gamepaddisconnected",e=>this.disconnected(e)),this.gamepads={}}connected(e){this.gamepads[e.gamepad.index]=new ry(e.gamepad)}disconnected(e){this.gamepads[e.gamepad.index],delete this.gamepads[e.gamepad.index]}updateGamepadStates(){let e=navigator.getGamepads();if(null!=e)for(let t of e){if(null==t)continue;let e=this.gamepads[t.index];e.gamepad=t,e.setPressed("jump",rM(t,0)),e.setPressed("wait",rM(t,2)),e.setPressed("menuAccept",rM(t,0)||rM(t,2)),e.setPressed("zoomOut",rM(t,6)&&!rM(t,7)),e.setPressed("zoomIn",rM(t,7)&&!rM(t,6)),e.setPressed("menu",rM(t,9)),e.setPressed("left",rM(t,14)&&!rM(t,12)&&!rM(t,13)||t.axes[0]<-e.thresh&&Math.abs(t.axes[1])<.5*Math.abs(t.axes[0])),e.setPressed("right",rM(t,15)&&!rM(t,12)&&!rM(t,13)||t.axes[0]>e.thresh&&Math.abs(t.axes[1])<.5*Math.abs(t.axes[0])),e.setPressed("up",rM(t,12)&&!rM(t,14)&&!rM(t,15)||t.axes[1]<-e.thresh&&Math.abs(t.axes[0])<.5*Math.abs(t.axes[1])),e.setPressed("down",rM(t,13)&&!rM(t,14)&&!rM(t,15)||t.axes[1]>e.thresh&&Math.abs(t.axes[0])<.5*Math.abs(t.axes[1])),e.setPressed("panLeft",t.axes[2]<-e.thresh),e.setPressed("panRight",t.axes[2]>e.thresh),e.setPressed("panUp",t.axes[3]<-e.thresh),e.setPressed("panDown",t.axes[3]>e.thresh),e.setPressed("snapToPlayer",rM(t,5)),e.setPressed("showSpeech",rM(t,4))}}}function rM(e,t){return t<e.buttons.length&&e.buttons[t].pressed}class rT extends rx{constructor(e){super(),this.mouseActive=!1,this.targetOnTouchDown=null,this.canvas=e,e.addEventListener("touchstart",e=>this.process_touchstart(e),!0),e.addEventListener("touchmove",e=>this.process_touchmove(e),!0),e.addEventListener("touchcancel",e=>this.process_touchend(e),!0),e.addEventListener("touchend",e=>this.process_touchend(e),!0),e.addEventListener("mousedown",e=>this.process_mousedown(e),!0),e.addEventListener("mouseup",e=>this.process_mouseup(e),!0),e.addEventListener("mousemove",e=>this.process_mousemove(e),!0),this.lastMotion={id:-1,active:!1,x0:0,y0:0,x:0,y:0},this.coreTouchTargets={up:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!1},down:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!1},left:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!1},right:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!1},wait:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!1},jump:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!1},menuAccept:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!1},pan:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!0},zoomIn:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!0},zoomOut:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!0},forceRestart:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!0},menuToggle:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!0},fullscreen:{id:-1,rect:new rm,touchXY:[0,0],tileInfo:null,mouseable:!0}},this.touchTargets=this.coreTouchTargets}clearMotion(){this.lastMotion.active=!1,this.lastMotion.id=-1,this.lastMotion.x0=0,this.lastMotion.y0=0,this.lastMotion.x=0,this.lastMotion.y=0,this.targetOnTouchDown=null}updateCoreTouchTarget(e,t,o){let r=this.coreTouchTargets[e];r.rect=t,r.tileInfo=o;let a=this.canvas.getBoundingClientRect(),n=r.touchXY[0]-a.left,s=a.bottom-(r.touchXY[1]+1);!r.rect.collide(n,s)&&this.controlStates[e]&&-1!=r.id&&(this.setPressed(e,!1,!1),r.id=-1)}activateTouchTargets(e){let t;for(let[o,r]of(t=void 0===e?this.coreTouchTargets:{...this.coreTouchTargets,...e},Object.entries(this.touchTargets)))o in t||(this.controlStates[o]=!1);this.touchTargets=t}process_mousedown(e){rp=this;let t=this.canvas.getBoundingClientRect(),o=e.clientX-t.left,r=t.bottom-(e.clientY+1);for(let[t,a]of(this.mouseActive=!0,this.lastMotion.id=-2,this.lastMotion.active=!1,this.lastMotion.x0=o,this.lastMotion.y0=r,this.lastMotion.x=o,this.lastMotion.y=r,this.targetOnTouchDown=null,Object.entries(this.touchTargets)))a.mouseable&&a.rect.collide(o,r)&&(a.touchXY=[e.clientX,e.clientY],a.id=-2,this.setPressed(t,!0),this.targetOnTouchDown=t);e.preventDefault()}process_mousemove(e){rp=this,this.mouseActive=!0;let t=this.canvas.getBoundingClientRect(),o=e.clientX-t.left,r=t.bottom-(e.clientY+1);for(let[t,a]of(-2==this.lastMotion.id&&(this.lastMotion.active=!0,this.lastMotion.x=o,this.lastMotion.y=r),Object.entries(this.touchTargets)))a.mouseable&&-2===a.id&&(a.rect.collide(o,r)?a.touchXY=[e.clientX,e.clientY]:(this.setPressed(t,!1,!1),a.id=-1));e.preventDefault()}process_mouseup(e){for(let[e,t]of Object.entries(this.touchTargets))t.mouseable&&this.controlStates[e]&&(t.id=-1,this.setPressed(e,!1,!0),this.controlTimes[e]=0);this.clearMotion(),e.preventDefault()}process_touchstart(e){rp=this,this.mouseActive=!1,this.targetOnTouchDown=null;let t=this.canvas.getBoundingClientRect();for(let o of e.changedTouches){let e=o.clientX-t.left,r=t.bottom-(o.clientY+1);for(let[t,a]of(this.lastMotion.id=o.identifier,this.lastMotion.active=!1,this.lastMotion.x0=e,this.lastMotion.y0=r,this.lastMotion.x=e,this.lastMotion.y=r,Object.entries(this.touchTargets)))a.rect.collide(e,r)&&(a.touchXY=[o.clientX,o.clientY],a.id=o.identifier,this.targetOnTouchDown=t,this.setPressed(t,!0))}e.preventDefault()}process_touchmove(e){this.mouseActive=!1;let t=this.canvas.getBoundingClientRect();for(let o of e.changedTouches){let e=o.clientX-t.left,r=t.bottom-(o.clientY+1);for(let[t,a]of(this.lastMotion.id==o.identifier&&(this.lastMotion.active=!0,this.lastMotion.x=e,this.lastMotion.y=r),Object.entries(this.touchTargets)))a.id==o.identifier&&(a.rect.collide(e,r)?a.touchXY=[o.clientX,o.clientY]:(a.id=-1,this.setPressed(t,!1,!1)))}e.preventDefault()}process_touchend(e){for(let t of(this.mouseActive=!1,e.changedTouches)){for(let[e,o]of Object.entries(this.touchTargets))o.id==t.identifier&&(o.id=-1,this.setPressed(e,!1,!0),this.controlTimes[e]=0);this.lastMotion.id==t.identifier&&this.clearMotion()}e.preventDefault()}}var rS=((I=rS||{})[I.HomeScreen=0]="HomeScreen",I[I.StatsScreen=1]="StatsScreen",I[I.AchievementsScreen=2]="AchievementsScreen",I[I.OptionsScreen=3]="OptionsScreen",I[I.HelpControls=4]="HelpControls",I[I.HelpKey=5]="HelpKey",I[I.Mansion=6]="Mansion",I[I.MansionComplete=7]="MansionComplete",I[I.Dead=8]="Dead",I[I.Win=9]="Win",I[I.DailyHub=10]="DailyHub",I[I.CreditsScreen=11]="CreditsScreen",I[I.DevScreen=12]="DevScreen",I),r_=((A=r_||{})[A.Indoor=0]="Indoor",A[A.Outdoor=1]="Outdoor",A[A.OutdoorWater=2]="OutdoorWater",A[A.Water=3]="Water",A[A.Kitchen=4]="Kitchen",A);let rw=!1;function rb(){document.getElementById("modalDialog").style.display="none",rw=!1}function rI(e,t){var o;o=function(e,t){if(null===e)return"No game played yet!";let o=e.numGhostedLevels,r=e.numSpottings,a=e.numInjuries,n=e.numKnockouts,s=e.totalScore,i=e.turns,l=e.numCompletedLevels,f=e.numLevels,u=l>=f,c=e.daily,d=0===e.numLevels?"":u?"Completed mission in "+i+" turns.":" Died on level "+(l+1)+" after "+i+" turns.",p="";if(u&&null===c){let e;for(e in t)t[e].failed||(p+=t[e].unicodeBadge);p.length>0&&(p="Achievements: "+p+"<br>")}return`\uD83C\uDFDB\uFE0F LLLOOOT! \uD83C\uDFDB\uFE0F<br>${null!==c?" Daily run for "+c:" Random game"}<br>${d}<br>Completed:   ${l} of ${f}<br>Ghosted:     ${o}<br>Spottings:   ${r}<br>Knockouts:   ${n}<br>Injuries:    ${a}<br>Total score: ${s}<br>${p}`}(e,t),document.getElementById("modalText").innerHTML=o,document.getElementById("modalDialog").style.display="block",rw=!0,document.getElementById("modalCloseButton").onclick=()=>{rb()}}class rA{constructor(){this.pages=[],this.activePage=0,this.activePageData=[],this.highlightedAction=0,this.actionSequence=[],this.cachedPageText="",this.screenSize=E.create(),this.state=new Map,this.glyphs=[],this.maxLineLength=0,this.pixelsPerCharX=0,this.pixelsPerCharY=0,this.offsetX=0,this.offsetY=0,this.textW=8,this.textH=16,this.mat=k.create(),this.touchTargets={}}initAction(e){this.touchTargets[e]={id:-1,rect:new rm(0,0,0,0),tileInfo:{},touchXY:[-1,-1],mouseable:!0}}parseImage(e,t,o,r){let a=e.slice(t+2).indexOf("#");if(a<0)return[e,t];let n=Number(e.slice(t+1,t+2+a));return Number.isNaN(n)?[e,t]:(this.glyphs.push([n,new rm(t,r-o-.875,2,1)]),[e=e.slice(0,t)+"  "+e.slice(t+3+a),t+1])}parseButton(e,t,o,r){let a,n,s=t;for(;;){if((a=e.slice(t).indexOf("|"))<0||(a+=t,(n=e.slice(a+1).indexOf("]"))<0))return[e,t];if(n+=a+1,t===a)break;"#"===e[t]&&([e,t]=this.parseImage(e,t,o,r)),t+=1}let i=e.slice(a+1,n);if(void 0!==i&&""!==i){i in this.touchTargets||this.initAction(i);let e=[s,t+1,o],[a,n]=[e[0],e[2]-1/8],[l,f]=[e[1],e[2]+1];this.touchTargets[i].rect=new rm(a,r-f,l-a,f-n),this.actionSequence.push(i)}return[e=e.slice(0,a)+e.slice(n),t=a]}parseUI(e){let t=this.pages[this.activePage];for(let[e,o]of this.state)t=t.replace("$"+e+"$",o);if(t===this.cachedPageText&&this.screenSize.equals(e))return;this.cachedPageText=t,E.copy(this.screenSize,e),this.activePageData=t.split("\n");let o=this.activePageData;this.glyphs.length=0,this.actionSequence=[],this.touchTargets={};for(let e=0;e<o.length;++e){let t=o[e],r=0;for(;r<t.length;){switch(t[r]){case"#":[t,r]=this.parseImage(t,r,e,o.length);break;case"[":[t,r]=this.parseButton(t,r,e,o.length)}r+=1}o[e]=t}for(let e of(this.highlightedAction=Math.max(0,Math.min(this.actionSequence.length-1,this.highlightedAction)),this.maxLineLength=0,this.activePageData))this.maxLineLength=Math.max(this.maxLineLength,e.length);for(let t in this.updateScreenSize(e),this.touchTargets){let e=this.touchTargets[t];e.rect[0]-=this.offsetX,e.rect[1]-=this.offsetY,e.rect[0]*=this.pixelsPerCharX,e.rect[1]*=this.pixelsPerCharY,e.rect[2]*=this.pixelsPerCharX,e.rect[3]*=this.pixelsPerCharY}}updateScreenSize(e){let t=a6(e);this.pixelsPerCharX=this.textW*t,this.pixelsPerCharY=this.textH*t;let o=this.maxLineLength*this.pixelsPerCharX,r=this.activePageData.length*this.pixelsPerCharY,a=e[0]/this.pixelsPerCharX,n=e[1]/this.pixelsPerCharY;this.offsetX=Math.floor(-((e[0]-o)/2))/this.pixelsPerCharX,this.offsetY=Math.floor(-((e[1]-r)/2))/this.pixelsPerCharY,k.ortho(this.mat,this.offsetX,this.offsetX+a,this.offsetY,this.offsetY+n,1,-1)}render(e){let t=this.activePageData,o=this.mat,r=this.maxLineLength,a=ot.background.textureIndex;e.start(o,t9.Font),e.addGlyph(-1.5,-.75,r+1.5,t.length+.75,{textureIndex:a,color:0xffd020b0}),e.addGlyph(-1,-.5,r+1,t.length+.5,{textureIndex:a,color:0xff1a0416}),e.flush();let n=k.create();for(let t in k.ortho(n,0,this.screenSize[0],0,this.screenSize[1],1,-1),e.start(n,t9.Font),this.touchTargets){rp?.controlStates[t]&&(this.highlightedAction=this.actionSequence.indexOf(t));let o=this.touchTargets[t].rect,r=this.highlightedAction<this.actionSequence.length&&this.actionSequence[this.highlightedAction]===t?0xffd020b0:0xff802060;e.addGlyph(o[0],o[1],o[0]+o[2],o[1]+o[3],{textureIndex:a,color:r})}for(let t of(e.flush(),e.start(o,t9.Entity),this.glyphs)){let o=t[1];e.addGlyph(o[0],o[1],o[2]+o[0],o[3]+o[1],{textureIndex:t[0],color:0xffffffff})}e.flush(),e.start(o,t9.Font);for(let o=0;o<t.length;++o){let r=t.length-(1+o);for(let a=0;a<t[o].length;++a){let n=a;if(" "===t[o])continue;let s=t[o].charCodeAt(a);e.addGlyph(n,r,n+1,r+1,{textureIndex:s,color:0xffeef0ff})}}e.flush()}updateData(e){}update(e){}navigateUI(e){let t="";return e("up")?(this.highlightedAction--,this.highlightedAction<0&&(this.highlightedAction=this.actionSequence.length-1)):e("down")?(this.highlightedAction++,this.highlightedAction>=this.actionSequence.length&&(this.highlightedAction=0)):this.highlightedAction<this.actionSequence.length&&e("menuAccept")&&(t=this.actionSequence[this.highlightedAction]),t}onControls(e,t){}}class rC extends rA{constructor(){super(),this.pages=[`LLLOOOT!

$playRestartOrResume$
[H|helpControls]: Controls help
[M|helpKey]: Map key
[D|homeDaily]: Daily challenge
[O|homeOptions]: Options
[S|homeStats]: Statistics
[A|homeAchievements]: Achievements
[C|credits]: Credits$devMode$`],this.devSequence="LRLRUD",this.devSequenceCursor=0}update(e){let t=e.hasStartedGame?null!==e.dailyRun?"[R|homePlay]: Resume daily game\n[N|homeRestart]: New game":"[R|homePlay]: Resume game\n[N|homeRestart]: New game":"[P|homePlay]: Play game\n";this.state.set("playRestartOrResume",t),this.state.set("devMode",e.devMode?"\n[X|devMenu]: Developer menu":"")}onControls(e,t){let o=this.navigateUI(t);t("homePlay")||"homePlay"==o||t("menu")||"menu"==o||t("menuToggle")?(a1(e),this.devSequenceCursor=0):t("devMenu")||"devMenu"==o?e.gameMode=rS.DevScreen:t("homeRestart")||"homeRestart"==o?(e.rng=new t4,e.dailyRun=null,a2(e)):t("homeDaily")||"homeDaily"==o?e.gameMode=rS.DailyHub:t("homeStats")||"homeStats"==o?e.gameMode=rS.StatsScreen:t("homeAchievements")||"homeAchievements"==o?e.gameMode=rS.AchievementsScreen:t("homeOptions")||"homeOptions"==o?e.gameMode=rS.OptionsScreen:t("helpControls")||"helpControls"==o?e.gameMode=rS.HelpControls:t("helpKey")||"helpKey"==o?e.gameMode=rS.HelpKey:(t("credits")||"credits"==o)&&(e.gameMode=rS.CreditsScreen),t("left")&&this.updateCheatCode("L",e),t("right")&&this.updateCheatCode("R",e),t("up")&&this.updateCheatCode("U",e),t("down")&&this.updateCheatCode("D",e)}updateCheatCode(e,t){this.devSequence[this.devSequenceCursor]!==e&&(this.devSequenceCursor=0),this.devSequence[this.devSequenceCursor]===e&&++this.devSequenceCursor,this.devSequenceCursor>=this.devSequence.length&&(t.devMode=!t.devMode,this.devSequenceCursor=0)}}class rP extends rA{constructor(){super(),this.pages=[`Developer Menu

[Alt+<|prevLevel]  Previous level
[Alt+>|nextLevel]  Next level
[Alt+C|collectLoot]  Collect loot 
[Alt+K|getKey]  Get key
[Alt+S|markSeen]  Mark mansion seen
[Alt+A|seeAll]  See entire map: $seeAll$
[Alt+P|guardPatrols]  See guard patrols: $guardPatrols$
[Alt+V|guardSight]  See guard sight: $guardSight$
[Alt+B|roomAdjacencies]  See rooms: $roomAdjacencies$
[Alt+F|showFPS]  Show FPS: $showFPS$

$message$

[Esc|menuBack]    Back to menu`],this.state.set("message","")}update(e){this.state.set("showFPS",e.fpsInfo.enabled?"Yes":"No"),this.state.set("seeAll",e.seeAll?"Yes":"No"),this.state.set("guardPatrols",e.seeGuardPatrols?"Yes":"No"),this.state.set("guardSight",e.seeGuardSight?"Yes":"No"),this.state.set("roomAdjacencies",e.seeRoomAdjacencies?"Yes":"No"),this.state.set("showFPS",e.fpsInfo.enabled?"Yes":"No")}onControls(e,t){let o=this.navigateUI(t);if(t("menuToggle"))a1(e);else if(t("menuBack")||"menuBack"==o)e.gameMode=rS.HomeScreen,this.state.set("message","");else if(t("prevLevel")||"prevLevel"==o)e.hasStartedGame?e.level>0&&(ar(e),as(e,e.level-1)):this.state.set("message","START GAME FIRST");else if(t("nextLevel")||"nextLevel"==o)e.hasStartedGame?e.level<e.gameMapRoughPlans.length-1&&(ar(e),as(e,e.level+1)):this.state.set("message","START GAME FIRST");else if(t("collectLoot")||"collectLoot"==o)if(e.hasStartedGame){let t=e.gameMap.collectAllLoot();e.player.loot+=t,e.lootStolen+=t,aR(e)}else this.state.set("message","START GAME FIRST");else t("getKey")||"getKey"==o?e.player.hasVaultKey=!0:t("markSeen")||"markSeen"==o?e.hasStartedGame?(e.gameMap.markAllSeen(),aR(e)):this.state.set("message","START GAME FIRST"):t("seeAll")||"seeAll"==o?(e.seeAll=!e.seeAll,this.state.set("message","")):t("guardSight")||"guardSight"==o?(e.seeGuardSight=!e.seeGuardSight,this.state.set("message","")):t("guardPatrols")||"guardPatrols"==o?(e.seeGuardPatrols=!e.seeGuardPatrols,this.state.set("message","")):t("roomAdjacencies")||"roomAdjacencies"===o?(e.seeRoomAdjacencies=!e.seeRoomAdjacencies,this.state.set("message","")):(t("showFPS")||"showFPS"==o)&&(e.fpsInfo.enabled=!e.fpsInfo.enabled,this.state.set("message",""))}}class rk extends rA{update(e){this.state.set("volumeLevel",(100*e.soundVolume).toFixed(0)),this.state.set("volumeMute",e.volumeMute?"Yes":"No"),this.state.set("guardMute",e.guardMute?"Yes":"No"),this.state.set("screenShakeEnabled",e.screenShakeEnabled?"Yes":"No"),this.state.set("keyRepeatRate",e.keyRepeatRate.toString()),this.state.set("keyRepeatDelay",e.keyRepeatDelay.toString())}onControls(e,t){let o=this.navigateUI(t);if(t("menuToggle"))a1(e);else if(t("menuBack")||"menuBack"==o)e.gameMode=rS.HomeScreen;else if(t("volumeUp")||"volumeUp"==o){let t=Math.min(1,e.soundVolume+.1);aX(e,t)}else if(t("volumeDown")||"volumeDown"==o){let t=Math.max(.1,e.soundVolume-.1);aX(e,t)}else{var r;t("volumeMute")||"volumeMute"==o?aY(e,!e.volumeMute):t("guardMute")||"guardMute"==o?aU(e,!e.guardMute):t("screenShakeEnabled")||"screenShakeEnabled"===o?(e.screenShakeEnabled=r=!e.screenShakeEnabled,window.localStorage.setItem("LLL/screenShakeEnabled",r?"true":"false")):t("keyRepeatRate")||"keyRepeatRate"==o?(e.keyRepeatRate-=50,e.keyRepeatRate<100&&(e.keyRepeatRate=400),window.localStorage.setItem("LLL/keyRepeatRate",e.keyRepeatRate.toString())):t("keyRepeatDelay")||"keyRepeatDelay"==o?(e.keyRepeatDelay-=50,e.keyRepeatDelay<100&&(e.keyRepeatDelay=500),window.localStorage.setItem("LLL/keyRepeatDelay",e.keyRepeatDelay.toString())):(t("forceRestart")||"forceRestart"==o)&&(window.localStorage.clear(),e.persistedStats=a$(),e.gameMode=rS.HomeScreen,aX(e,1),aY(e,!1),aU(e,!1))}}constructor(...e){super(...e),this.pages=[`Options

         Sound volume: $volumeLevel$%
[=|volumeUp]      Volume up
[-|volumeDown]      Volume down
[0|volumeMute]      Volume mute: $volumeMute$
[9|guardMute]      Guard mute: $guardMute$
[J|screenShakeEnabled]      Jolt screen: $screenShakeEnabled$
[K|keyRepeatRate]      Key repeat rate $keyRepeatRate$ms
[D|keyRepeatDelay]      Key repeat delay $keyRepeatDelay$ms
[Ctrl+R|forceRestart] Reset data

[Esc|menuBack]    Back to menu`]}}class rL extends rA{update(e){this.activePage=rp===e.keyboardController?0:rp===e.touchController?+!e.touchController.mouseActive:2}onControls(e,t){let o=this.navigateUI(t);t("menuToggle")?a1(e):(t("menuBack")||"menuBack"==o)&&(e.gameMode=rS.HomeScreen)}constructor(...e){super(...e),this.pages=[`Help: Keyboard Controls

  Move: Arrows / WASD / HJKL
  Wait: Space / Z / Period / Numpad5
  Leap/Run: Shift + move (unlimited!)
  Leap/Run (Toggle): F / Numpad+
  Zoom View: [ / ]
  Scroll View: Control + move
  Recenter View: Control + wait
  Volume: (Mute/Down/Up) 0 / - / =
  Guard Mute (Toggle): 9
  Show last speech: Tab

Disable NumLock if using numpad
Touch and gamepad also supported

[Esc|menuBack] Back to menu`,`Help: Touch Controls

  Move: #016# / #017# / #018# / #019#
  Wait: #020#
  Leap/Run: #21# + move (unlimited!)
  Zoom View: #22# / #23#
  Scroll View: Touch and drag
  Menu: #27#
  Navigate menu: #018# / #019# / #20#

Keyboard and gamepad also supported

[Esc|menuBack] Back to menu`,`Help: Gamepad Controls

  Move: Left Stick/Pad
  Wait: Button2
  Leap/Run: Button1 + move
  Zoom View: Left / Right trigger
  Scroll View: Right stick
  Recenter View: Right bumper
  Show last speech: Left bumper

Keyboard and touch also supported

[Esc|menuBack] Back to menu`]}}let rR=or.namedTiles.treasureA.textureIndex,rD=or.namedTiles.treasureB.textureIndex,rW=or.namedTiles.treasureC.textureIndex,rG=or.namedTiles.treasureD.textureIndex,rV=or.namedTiles.treasureE.textureIndex,rE=or.namedTiles.treasureV.textureIndex;class rB extends rA{update(e){}onControls(e,t){let o=this.navigateUI(t);t("menuToggle")?a1(e):(t("menuBack")||"menuBack"==o)&&(e.gameMode=rS.HomeScreen)}constructor(...e){super(...e),this.pages=[`Map Key

#${or.playerTiles.normal.textureIndex}# Thief: You!
#${or.npcTiles[3].textureIndex}# Guard: Avoid them!
#${or.itemTiles[ex.Coin].textureIndex}# Loot: Steal it!
#${or.itemTiles[ex.Bush].textureIndex}# Tree: Hiding place
#${or.itemTiles[ex.Table].textureIndex}# Table: Hiding place
#${or.itemTiles[ex.Chair].textureIndex}# Stool: Guards sit here
#${or.itemTiles[ex.TorchLit].textureIndex}# Torch: Douse it
#${or.namedTiles.uiWindowTile.textureIndex}# Window: One-way escape
#${or.namedTiles.uiCreakyTile.textureIndex}# Creaky floor: Alerts guards
Bonus loot: Steal it?
#${rR}##${rD}##${rW}##${rG}##${rV}##${rE}#

[Esc|menuBack] Back to menu`]}}class rN extends rA{update(e){}onControls(e,t){let o=this.navigateUI(t);t("menuToggle")?a1(e):(t("menuBack")||"menuBack"==o)&&(e.gameMode=rS.HomeScreen)}constructor(...e){super(...e),this.pages=[`Credits

Made for 2023 Seven-Day Roguelike Challenge
Expanded Post-Jam Edition

by James McNeill and Damien Moore

Additional voices by Evan Moore
Additional assistance by Mike Gaffney
Testing by Mendi Carroll and Tom Elmer
Special thanks to Mendi Carroll

[Esc|menuBack] Back to menu`]}}class rF extends rA{timeToMidnightUTC(){let e=new Date,t=new Date(e);t.setUTCHours(24,0,0,0);let o=t.getTime()-e.getTime(),r=Math.floor(o/1e3%60),a=Math.floor(o/6e4%60);return Math.floor(o/36e5%24).toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}update(e){let t=e.persistedStats.lastPlayedDailyGame;if(e.persistedStats.currentDailyGameId!==a9()&&(e.persistedStats.currentDailyGameId=a9(),e.persistedStats.currentDailyPlays=0,e.persistedStats.currentDailyWins=0,e.persistedStats.currentDailyWinFirstTry=0,e.persistedStats.currentDailyBestScore=0,aQ(e.persistedStats)),null!==t&&e.persistedStats.currentDailyPlays>0){if(0===e.persistedStats.currentDailyWins)this.state.set("dailyStatus",e.persistedStats.currentDailyGameId+" game played");else if(0===e.persistedStats.currentDailyWinFirstTry)this.state.set("dailyStatus",e.persistedStats.currentDailyGameId+" game won");else{let t=or.itemTiles[ex.TorchLit].textureIndex;this.state.set("dailyStatus",e.persistedStats.currentDailyGameId+` game won first try #${t}#`)}this.state.set("timeLeft","Time to next game: "+this.timeToMidnightUTC()),this.state.set("playMode","[P|homePlay] Play it again")}else this.state.set("dailyStatus",e.persistedStats.currentDailyGameId+" game ready"),this.state.set("timeLeft","Time left to play: "+this.timeToMidnightUTC()),this.state.set("playMode","[P|homePlay] Play now");let o=t?.daily??"None",r=t?.totalScore??0;this.state.set("plays",e.persistedStats.currentDailyPlays.toString()),this.state.set("wins",e.persistedStats.currentDailyWins.toString()),this.state.set("lastPlayed",o),this.state.set("lastScore",r.toString()),this.state.set("bestScore",e.persistedStats.currentDailyBestScore.toString())}onControls(e,t){if(rw)(t("menuAccept")||t("menuBack"))&&rb();else{let o=this.navigateUI(t);t("menuToggle")?a1(e):t("menuBack")||"menuBack"==o?e.gameMode=rS.HomeScreen:t("homePlay")||"homePlay"==o?(a5(e),e.hasStartedGame=!0):(t("scorePopup")||"scorePopup"==o)&&rI(e.persistedStats.lastPlayedDailyGame,e.achievements)}}constructor(...e){super(...e),this.pages=[`The Daily Challenge

Play a new seeded game each day and 
compare results with your rivals.

$dailyStatus$
Plays:             $plays$
Wins:              $wins$
Best score:        $bestScore$

$playMode$
$timeLeft$

Last game played:  $lastPlayed$
Last score:        $lastScore$
[S|scorePopup] Score popup (for copy/paste)

[Esc|menuBack] Back to menu`]}}class rO extends rA{update(e){this.state.set("totalPlays",e.persistedStats.totalPlays.toString()),this.state.set("totalWins",e.persistedStats.totalWins.toString()),this.state.set("totalGhosts",e.persistedStats.totalGhosts.toString()),this.state.set("bestScore",e.persistedStats.bestScore.toString()),this.state.set("allDailyPlays",e.persistedStats.allDailyPlays.toString()),this.state.set("allDailyWins",e.persistedStats.allDailyWins.toString()),this.state.set("allDailyWinsFirstTry",e.persistedStats.allDailyWinsFirstTry.toString())}onControls(e,t){let o=this.navigateUI(t);t("menuToggle")?a1(e):(t("menuBack")||"menuBack"==o)&&(e.gameMode=rS.HomeScreen)}constructor(...e){super(...e),this.pages=[`Play Statistics

All games
Total plays:             $totalPlays$
Total wins:              $totalWins$
Total mansions ghosted:  $totalGhosts$
Best score:              $bestScore$

Daily games
Total plays:             $allDailyPlays$
Total wins:              $allDailyWins$
Total wins first try:    $allDailyWinsFirstTry$

[Esc|menuBack] Back to menu`]}}class rz extends rA{update(e){let t=or.achievementIcons,o=`#${or.achievementIncompleteIcon.textureIndex}#`,r=`#${or.achievementFailedIcon.textureIndex}#`,a=null!==e.dailyRun;function n(e,t,n,s,i){let l=n>0?`#${i.textureIndex}#`:s.failed||a?r:o;e.state.set(t,l)}n(this,"victoryAchieved",e.persistedStats.achievementVictory,e.achievements.achievementVictory,t.achievementVictory),n(this,"ghostyAchieved",e.persistedStats.achievementGhosty,e.achievements.achievementGhosty,t.achievementGhosty),n(this,"zippyAchieved",e.persistedStats.achievementZippy,e.achievements.achievementZippy,t.achievementZippy),n(this,"hungryAchieved",e.persistedStats.achievementHungry,e.achievements.achievementHungry,t.achievementHungry),n(this,"thumpyAchieved",e.persistedStats.achievementThumpy,e.achievements.achievementThumpy,t.achievementThumpy),n(this,"softyAchieved",e.persistedStats.achievementSofty,e.achievements.achievementSofty,t.achievementSofty),n(this,"steppyAchieved",e.persistedStats.achievementSteppy,e.achievements.achievementSteppy,t.achievementSteppy),n(this,"healthyAchieved",e.persistedStats.achievementHealthy,e.achievements.achievementHealthy,t.achievementHealthy),n(this,"treasureAchieved",e.persistedStats.achievementTreasure,e.achievements.achievementTreasure,t.achievementTreasure),n(this,"mappingAchieved",e.persistedStats.achievementMapping,e.achievements.achievementMapping,t.achievementMapping),n(this,"facelessAchieved",e.persistedStats.achievementFaceless,e.achievements.achievementFaceless,t.achievementFaceless)}onControls(e,t){let o=this.navigateUI(t);t("menuToggle")?a1(e):(t("menuBack")||"menuBack"==o)&&(e.gameMode=rS.HomeScreen)}constructor(...e){super(...e),this.pages=[`Achievements

Earn achievements by meeting certain
requirements when you complete a game.

 $victoryAchieved$ Victory: winning is enough...
 $hungryAchieved$ Hungry: collect all food
 $treasureAchieved$ Looty: steal all bonus loot
 $healthyAchieved$ Healthy: take no damage
 $steppyAchieved$ Steppy: no leap where a step works
 $thumpyAchieved$ Thumpy: knock out all guards
 $softyAchieved$ Softy: no knockouts
 $mappingAchieved$ Looky: map 100% before looting anything
 $facelessAchieved$ Ghosty: ghost every level
 $zippyAchieved$ Zippy: under par time on every level
 $ghostyAchieved$ Mosty Ghosty: ghost with no knockouts

[Esc|menuBack] Back to menu`]}}class rH extends rA{update(e){var t;let o=Math.max(0,ai(e)-e.turns),r=10*e.lootStolen,a=af(e),n=5*e.levelStats.extraFoodCollected,s=0===e.levelStats.numSpottings?r:0,i=r+a+n+o+s;this.state.set("levelType",function(e){switch(e){case 0:case 1:return"Manor";case 2:return"Mansion";case 3:return"Fortress";case 4:return"Warrens"}}(e.gameMapRoughPlans[e.level].levelType)),this.state.set("level",(e.level+1).toString()),this.state.set("numLevels",e.gameMapRoughPlans.length.toString()),this.state.set("lootScore",(10*e.lootStolen).toString()),this.state.set("treasureScore",(t=e).gameMap.treasures.length>0||t.gameMap.items.some(e=>e.type===ex.VaultTreasureBox||e.type===ex.EmptyVaultTreasureBox||e.type===ex.LootedVaultTreasureBox)?"\n Bonus Loot:  "+a:""),this.state.set("foodScore",n>0?"\n Food:        "+n:""),this.state.set("timeBonus",o.toString()),this.state.set("ghostBonus",s.toString()),this.state.set("levelScore",i.toString()),this.state.set("totalScore",e.gameStats.totalScore.toString())}onControls(e,t){var o;let r,a,n,s=this.navigateUI(t);(t("startLevel")||"startLevel"==s)&&(e.level>=e.gameMapRoughPlans.length-1?(o=e,L.stop(),r=.1>Math.random()?"easterEgg":"victorySong",o.sounds[r].play(.5),o.persistedStats.totalWins++,a=o.gameStats.totalScore,o.persistedStats.bestScore=Math.max(o.persistedStats.bestScore,a),n={score:a,date:a9(),turns:o.totalTurns,level:o.level+1},an(o,"gameEnd"),o.persistedStats.scores.push(n),o.dailyRun&&(o.persistedStats.currentDailyBestScore=Math.max(o.persistedStats.currentDailyBestScore,a),o.persistedStats.currentDailyWins++,o.persistedStats.currentDailyWinFirstTry=1===o.persistedStats.currentDailyPlays?1:o.persistedStats.currentDailyWinFirstTry,o.persistedStats.lastPlayedDailyGame=structuredClone(o.gameStats),o.persistedStats.allDailyWins++,o.persistedStats.allDailyWinsFirstTry+=+(1===o.persistedStats.currentDailyPlays)),aQ(o.persistedStats),o.dailyRun||function(e){let t;for(t in e.achievements)t in e.persistedStats&&(e.achievements[t].failed||(e.persistedStats[t]++,aK(t,e.persistedStats[t])))}(o),o.gameMode=rS.Win):as(e,e.level+1))}constructor(...e){super(...e),this.pages=[`$levelType$ Looted! ($level$/$numLevels$)

\x9a\x9b Loot:        $lootScore$$treasureScore$$foodScore$
\x86\x87 Ghost:       $ghostBonus$
\x8c\x8d Speed:       $timeBonus$
\x84\x85 Total:       $levelScore$

\x82\x83 Cumulative:  $totalScore$

[N|startLevel]: Next`]}}class rX extends rA{update(e){this.state.set("level",e.gameStats.numCompletedLevels.toString()),this.state.set("numLevels",e.gameStats.numLevels.toString()),this.state.set("numGhostedLevels",e.gameStats.numGhostedLevels.toString()),this.state.set("totalScore",e.gameStats.totalScore.toString()),this.state.set("totalTurns",`${e.gameStats.turns}`),this.state.set("numSpottings",`${e.gameStats.numSpottings}`),this.state.set("numInjuries",`${e.gameStats.numInjuries}`),this.state.set("numKnockouts",`${e.gameStats.numKnockouts}`)}onControls(e,t){if(rw)(t("menuAccept")||t("menuBack"))&&rb();else{let o=this.navigateUI(t);t("homeRestart")||"homeRestart"==o?(e.rng=new t4,e.dailyRun=null,a2(e)):t("menuBack")||"menuBack"==o?(e.rng=new t4,e.dailyRun=null,a2(e),e.gameMode=rS.HomeScreen,e.hasStartedGame=!1):(t("scorePopup")||"scorePopup"==o)&&rI(e.gameStats,e.achievements)}}constructor(...e){super(...e),this.pages=[`         You are dead!

\x84\x85 Total Score:   $totalScore$

Statistics
\x9e\x9f Completed:     $level$ of $numLevels$
\x8c\x8d Total turns:   $totalTurns$
\x94\x95 Spottings:     $numSpottings$
\x92\x93 Injuries:      $numInjuries$
\x96\x97 Knockouts:     $numKnockouts$
\x86\x87 Ghosted:       $numGhostedLevels$

[N|homeRestart]:   New game
[S|scorePopup]:   Score popup (for copy/paste)
[Esc|menuBack]: Exit to home screen`]}}class rq extends rA{update(e){if(this.state.set("level",e.gameStats.numCompletedLevels.toString()),this.state.set("numLevels",e.gameStats.numLevels.toString()),this.state.set("totalTurns",`${e.gameStats.turns}`),this.state.set("numSpottings",`${e.gameStats.numSpottings}`),this.state.set("numInjuries",`${e.gameStats.numInjuries}`),this.state.set("numKnockouts",`${e.gameStats.numKnockouts}`),this.state.set("numGhostedLevels",e.gameStats.numGhostedLevels.toString()),this.state.set("totalScore",e.gameStats.totalScore.toString()),void 0===this.achievementsLine){if(this.achievementsLine="",!e.dailyRun){let t;for(t in e.achievements)e.achievements[t].failed||(this.achievementsLine+=`#${or.achievementIcons[t].textureIndex}#`);this.achievementsLine.length>0&&(this.achievementsLine="\nAchievements:  "+this.achievementsLine)}this.state.set("achievements",this.achievementsLine)}}onControls(e,t){if(rw)(t("menuAccept")||t("menuBack"))&&rb();else{let o=this.navigateUI(t);t("homeRestart")||"homeRestart"==o?(e.rng=new t4,e.dailyRun=null,this.achievementsLine=void 0,a2(e)):t("menuBack")||"menuBack"==o?(e.rng=new t4,e.dailyRun=null,a2(e),e.gameMode=rS.HomeScreen,this.achievementsLine=void 0,e.hasStartedGame=!1):(t("scorePopup")||"scorePopup"==o)&&rI(e.gameStats,e.achievements)}}constructor(...e){super(...e),this.pages=[`Mission Complete!

\x84\x85 Total Score:   $totalScore$$achievements$

Statistics
\x9e\x9f Completed:     $level$ of $numLevels$
\x8c\x8d Total turns:   $totalTurns$
\x94\x95 Spottings:     $numSpottings$
\x92\x93 Injuries:      $numInjuries$
\x96\x97 Knockouts:     $numKnockouts$
\x86\x87 Ghosted:       $numGhostedLevels$

[N|homeRestart]:   New game
[S|scorePopup]:   Score popup (for copy/paste)
[Esc|menuBack]: Exit to home screen`],this.achievementsLine=void 0}}class rY{update(e,t){"gameStart"===t&&(this.failed=!1)}constructor(){this.failed=!1,this.unicodeBadge=""}}class rU extends rY{update(e,t){super.update(e,t)}constructor(...e){super(...e),this.unicodeBadge=""}}class rj extends rY{update(e,t){super.update(e,t),"turnEnd"===t&&(e.levelStats.numSpottings>0||e.levelStats.numKnockouts>0)&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class rK extends rY{update(e,t){super.update(e,t),"turnEnd"===t&&e.turns>ai(e)&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r$ extends rY{update(e,t){super.update(e,t),"turnEnd"===t&&e.levelStats.steppableLeaps>0&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class rQ extends rY{update(e,t){super.update(e,t),"levelEnd"===t&&e.gameMap.guards.some(e=>e.mode!==ee.Unconscious)&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class rJ extends rY{update(e,t){super.update(e,t),"levelEnd"===t&&e.levelStats.numKnockouts>0&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class rZ extends rY{update(e,t){super.update(e,t),"levelEnd"===t&&e.gameMap.items.some(e=>e.type===ex.Health)&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r0 extends rY{update(e,t){super.update(e,t),"turnEnd"===t&&e.player.health<e.player.healthMax&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r1 extends rY{update(e,t){super.update(e,t),"turnEnd"===t?e.gameMap.items.some(e=>e.type===ex.EmptyVaultTreasureBox)&&(this.failed=!0):"levelEnd"===t&&e.gameMap.items.some(e=>e.type>=ex.TreasureA||e.type===ex.VaultTreasureBox||e.type===ex.EmptyVaultTreasureBox)&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r2 extends rY{update(e,t){super.update(e,t),"turnEnd"===t&&!this.failed&&(e.lootStolen>0||e.treasureStolen>0||e.levelStats.extraFoodCollected>0)&&!e.gameMap.allSeen()&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r5 extends rY{update(e,t){super.update(e,t),"turnEnd"===t&&e.levelStats.numSpottings>0&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}function r4(e,t,o,r){let a=[],n=4+o.randomInRange(3),s=n+2+o.randomInRange(7-n),i=.2>o.random()?5:e;i>=n&&++i,i>=s&&++i;let l=e;l>=n&&++l,l>=s&&++l,l>=i&&++l;let f=.5>o.random()?ed.Manor:ed.ManorRed;for(let t=0;t<e;++t){let e,u=new t4("lvl"+t+o.random());f=(e=void 0!==r?r:9===t||t===i?ed.Fortress:t===n||t===s?ed.Mansion:t===l?ed.Warrens:f)===ed.Manor||e===ed.ManorRed?f===ed.Manor?ed.ManorRed:ed.Manor:.5>o.random()?ed.Manor:ed.ManorRed;let[c,d]=function(e,t,o){let r,a,n,s,i,l;[r,a,n,s,i,l]=r3[e];let f=r;for(let e=r;e<a;++e).5>o.random()&&++f;let u=n;for(let e=n;e<s;++e).5>o.random()&&++u;return(1&f)==0&&(f>r&&.5>o.random()?--f:++f),u=Math.max(u=Math.min(Math.floor(l/f),u),Math.ceil(i/f)),t===ed.Mansion&&(f=Math.floor((f+1)/3+.5),u=Math.floor((u+1)/3+.5),f=Math.max(2,f),u=Math.max(2,u),f=3*Math.min(4,f)-1,u=3*Math.min(4,u)-1),[f,u]}(t,e,u);a.push({levelType:e,level:t,numRoomsX:c,numRoomsY:d,totalLoot:0,rng:u,played:!1})}let u=0;for(let e of a)u+=e.numRoomsX*e.numRoomsY;let c=0;for(let e of a){let o=Math.floor(t*(e.numRoomsX*e.numRoomsY)/u);c+=o,e.totalLoot=o}return a[a.length-1].totalLoot+=t-c,a}let r3=[[3,3,2,2,6,6],[3,5,2,5,6,12],[3,5,2,6,9,15],[3,5,2,6,12,18],[3,7,3,6,15,21],[3,7,3,6,18,24],[3,7,3,6,21,30],[5,7,4,6,24,36],[5,9,4,6,30,42],[7,9,5,9,35,63]];var r6=((C=r6||{})[C.Creak=0]="Creak",C[C.Splash=1]="Splash",C[C.Thud=2]="Thud",C[C.Alarm=3]="Alarm",C[C.BangDoor=4]="BangDoor",C[C.BangChair=5]="BangChair",C),r8=((P=r8||{})[P.Normal=0]="Normal",P[P.AttemptedLeap=1]="AttemptedLeap",P[P.AttemptedLeapBounceBack=2]="AttemptedLeapBounceBack",P);let r7,r9=document.querySelector("canvas"),ae=r9.clientWidth,at=r9.clientHeight;function ao(e){var t,o,r,a,n;let s,i,l,f,u,c,d,p,h,m,x,g;document.body.addEventListener("keydown",e=>S()),r9.addEventListener("mousedown",e=>S()),r9.addEventListener("touchstart",e=>S()),window.addEventListener("gamepadconnected",e=>S());let y=new tU(r9,oo,or,ot),v=new rl,M=new rl,T=(t={},o={},r=v,a=M,n=new rT(r9),l=tY((i=r4(10,100,s=new t4,r7))[0]),f=a$(),isNaN(u=parseInt(window.localStorage.getItem("LLL/keyRepeatRate")??"175"))&&(u=175),isNaN(c=parseInt(window.localStorage.getItem("LLL/keyRepeatDelay")??"250"))&&(c=250),isNaN(d=parseFloat(window.localStorage.getItem("LLL/soundVolume")??"1.0"))&&(d=1),p=window.localStorage.getItem("LLL/volumeMute"),h=window.localStorage.getItem("LLL/guardMute"),m=window.localStorage.getItem("LLL/screenShakeEnabled"),x=new ey(l.playerStartPos,!1),g={gameStats:{totalScore:0,turns:0,numLevels:0,numCompletedLevels:0,numGhostedLevels:0,numSpottings:0,numInjuries:0,numKnockouts:0,daily:null,timeStarted:0,timeEnded:0},persistedStats:f,levelStats:{numKnockouts:0,numSpottings:0,damageTaken:0,extraFoodCollected:0,steppableLeaps:0},achievements:{achievementVictory:new rU,achievementHungry:new rZ,achievementTreasure:new r1,achievementHealthy:new r0,achievementSteppy:new r$,achievementThumpy:new rQ,achievementSofty:new rJ,achievementMapping:new r2,achievementFaceless:new r5,achievementZippy:new rK,achievementGhosty:new rj},lightStates:Array(l.lightCount).fill(0),particles:[],tLast:void 0,dt:0,idleTimer:5,rng:s,fpsInfo:{enabled:!1,msgFPS:"FPS: --",frames:0,cumulativeTime:0,worstFrame:0,drops:0},devMode:!1,dailyRun:null,leapToggleActive:!1,healthBarState:{damageDisplayTimer:0,healing:!1,size:1,enlargeTimeRemaining:0,heartFlashRemaining:Array(x.healthMax).fill(0)},gameMode:rS.HomeScreen,textWindows:{[rS.HomeScreen]:new rC,[rS.OptionsScreen]:new rk,[rS.StatsScreen]:new rO,[rS.AchievementsScreen]:new rz,[rS.DailyHub]:new rF,[rS.HelpControls]:new rL,[rS.HelpKey]:new rB,[rS.MansionComplete]:new rH,[rS.Dead]:new rX,[rS.Win]:new rq,[rS.CreditsScreen]:new rN,[rS.DevScreen]:new rP},player:x,ambience:r_.Outdoor,ambientSoundPool:a,oldPlayerPos:E.clone(l.playerStartPos),hintMessage:"",numStepMoves:0,numLeapMoves:0,numWaitMoves:0,numZoomMoves:0,hasEnteredMansion:!1,experiencedPlayer:!1,finishedLevel:!1,hasStartedGame:!1,zoomLevel:4,seeAll:!1,seeGuardSight:!1,seeGuardPatrols:!1,seeRoomAdjacencies:!1,camera:aH(l.playerStartPos,4),level:0,turns:0,totalTurns:0,lootStolen:0,lootAvailable:i[0].totalLoot,treasureStolen:0,gameMapRoughPlans:i,gameMap:l,sounds:t,subtitledSounds:o,activeSoundPool:r,soundVolume:d,guardMute:null!==h&&"true"===h,volumeMute:null!==p&&"true"===p,screenShakeEnabled:null===m||"true"===m,keyRepeatActive:void 0,keyRepeatRate:u,keyRepeatDelay:c,touchController:n,gamepadManager:new rv,keyboardController:new rg,popups:new N},a0(l,g),aJ(l,g),aZ(l,g),er(g),aR(g),aw(g,g.player.pos),g);function S(){if(0==Object.keys(T.sounds).length){var e,t,o,r;for(let a in e=T.sounds,t=T.subtitledSounds,o=T.activeSoundPool,r=T.ambientSoundPool,e.footstepWood=new rf([of]),e.footstepTile=new rf([ou]),e.footstepWater=new rf([oc]),e.footstepGravel=new rf([od]),e.footstepGrass=new rf([op]),e.footstepCreaky=new rf(oh),e.victorySong=new rf([oa]),e.levelRequirementJingle=new rf([on],o),e.levelCompleteJingle=new rf([os],o),e.gameOverJingle=new rf([oi],o),e.easterEgg=new rf([ol],o),e.hitPlayer=new rf(om),e.hitGuard=new rf(ox),e.coin=new rf(oy),e.coinRattle=new rf(og),e.food=new rf(o_),e.grabKey=new rf(ow),e.clockChime=new rf(oT),e.clockTick=new rf(oS),e.doorOpen=new rf(oD),e.doorClose=new rf(oW),e.doorOpenLocked=new rf(oG),e.doorCloseLocked=new rf(oV),e.playerDoorOpen=new rf(oE),e.playerDoorClose=new rf(oB),e.playerDoorOpenLocked=new rf(oN),e.playerDoorCloseLocked=new rf(oF),e.grunt=new rf(ov),e.douse=new rf(oM),e.ignite=new rf(ob),e.hide=new rf(oI),e.gate=new rf(oA),e.thump=new rf(oC),e.splash=new rf(oP),e.waterEnter=new rf(oO),e.waterExit=new rf(oz),e.jump=new rf(oH),e.tooHigh=new rf(oj),e.treasureAlarm=new rf(oX),e.switchProgress=new rf(oq),e.switchReset=new rf(oY),e.switchSuccess=new rf(oU),e.ambienceWater=new rf(ok,r),e.ambienceKitchen=new rf(oL,r),e.ambienceOutdoor=new rf(oR,r),t.guardInvestigate=new ru(o1,o),t.guardFinishInvestigating=new ru(o2,o),t.guardSeeThief=new ru(oK),t.guardFinishLooking=new ru(oQ,o),t.guardFinishLookingAtLitTorch=new ru(oJ,o),t.guardChase=new ru(o6,o),t.guardEndChase=new ru(o8,o),t.guardHearGuard=new ru(o5,o),t.guardSpotDownedGuard=new ru(ri,o),t.guardSeeUnlitTorch=new ru(o4,o),t.guardHearThief=new ru(oZ,o),t.guardAwakesWarning=new ru(o7,o),t.guardDownWarning=new ru(o9,o),t.guardWarningResponse=new ru(rt,o),t.guardFinishListening=new ru(o0,o),t.guardFinishLightingTorch=new ru(o3,o),t.guardDamage=new ru(ro,o),t.guardStirring=new ru(re,o),t.guardRest=new ru(o$,o),t.guardSeeTorchLit=new ru(rr,o),t.guardSeeTorchDoused=new ru(ra,o),t.guardSpotStolenTreasure=new ru(rn,o),t.guardExamineStolenTreasure=new ru(rs,o),L.volume(T.soundVolume),L.mute(aq(T)),T.subtitledSounds)T.subtitledSounds[a].mute=T.guardMute}}window.addEventListener("blur",e=>{L.mute(aq(T))}),window.addEventListener("focus",e=>{L.mute(aq(T))}),new ResizeObserver(e=>{ae=r9.clientWidth,at=r9.clientHeight,T.camera.snapped=!1,screen.orientation.unlock()}).observe(r9),requestAnimationFrame(e=>(function e(t,o,r){var a,n,s,i;let l,f,u,c,d,p=t/1e3,h=void 0===r.tLast?0:Math.min(1/30,p-r.tLast);r.dt=h,r.tLast=p,r.fpsInfo.enabled&&(r.fpsInfo.frames++,r.fpsInfo.cumulativeTime+=h,r.fpsInfo.worstFrame<h&&(r.fpsInfo.worstFrame=h),h>.017&&r.fpsInfo.drops++,r.fpsInfo.cumulativeTime>1&&(r.fpsInfo.msgFPS=`FPS: ${Math.round(r.fpsInfo.frames/r.fpsInfo.cumulativeTime*10)/10} (worst: ${Math.round(1e3*r.fpsInfo.worstFrame)}ms, # drops: ${r.fpsInfo.drops})`,r.fpsInfo.cumulativeTime=0,r.fpsInfo.frames=0,r.fpsInfo.worstFrame=0,r.fpsInfo.drops=0)),r9.width=ae,r9.height=at;let m=E.fromValues(ae,at);r.oldPlayerPos=E.clone(r.player.pos);if(r.gamepadManager.updateGamepadStates(),null!==rp)for(let e in r.gameMode===rS.Mansion?function(e){var t,o,a,n;if(e.controlStates.panLeft&&(r.camera.panning=!0,r.camera.position[0]-=1/r.camera.zoom),e.controlStates.panRight&&(r.camera.panning=!0,r.camera.position[0]+=1/r.camera.zoom),e.controlStates.panUp&&(r.camera.panning=!0,r.camera.position[1]+=1/r.camera.zoom),e.controlStates.panDown&&(r.camera.panning=!0,r.camera.position[1]-=1/r.camera.zoom),e.controlStates.snapToPlayer&&(r.camera.panning=!1),x("left"))r.leapToggleActive!==e.controlStates.jump?aI(r,-1,0):aS(r,-1,0,0);else if(x("right"))r.leapToggleActive!==e.controlStates.jump?aI(r,1,0):aS(r,1,0,0);else if(x("down"))r.leapToggleActive!==e.controlStates.jump?aI(r,0,-1):aS(r,0,-1,0);else if(x("up"))r.leapToggleActive!==e.controlStates.jump?aI(r,0,1):aS(r,0,1,0);else if(x("wait")){let e;(e=(t=r).player).health<=0?ab(t):(e.idle=!1,t.idleTimer=5,t.camera.panning=!1,t.touchController.clearMotion(),ak(t),t.gameMap.identifyAdjacentCells(e.pos),e.pickTarget=null,e.preNoisy=!1,++t.numWaitMoves,aL(t),aw(t,t.player.pos))}else if(x("menu")||x("menuToggle"))r.player.health>0?r.gameMode=rS.HomeScreen:r.gameMode=rS.Dead;else if(x("jumpToggle"))r.leapToggleActive=!r.leapToggleActive;else if(x("seeAll"))r.devMode&&(r.seeAll=!r.seeAll);else if(x("collectLoot")){if(r.devMode){let e=r.gameMap.collectAllLoot();r.player.loot+=e,r.lootStolen+=e,aR(r)}}else if(x("getKey")){if(r.devMode)for(let e of(r.player.hasVaultKey=!0,r.gameMap.guards))e.hasVaultKey=!1}else if(x("forceRestart"))r.dailyRun?a5(r):(r.rng=new t4,r.dailyRun=null,a2(r));else if(x("nextLevel"))r.devMode&&r.level<r.gameMapRoughPlans.length-1&&(ar(r),as(r,r.level+1),r.camera.zoomed=!1);else if(x("resetState")){let e;r.devMode&&(e=tY((o=r).gameMapRoughPlans[o.level]),o.player=new ey(e.playerStartPos,null!==o.dailyRun),o.lightStates=Array(e.lightCount).fill(0),a0(e,o),aJ(e,o),aZ(e,o),o.turns=0,o.totalTurns=0,o.lootStolen=0,o.lootAvailable=o.gameMapRoughPlans[o.level].totalLoot,o.treasureStolen=0,aa(o.levelStats),an(o,"gameStart"),o.hintMessage="",aE(o),o.finishedLevel=!1,o.ambience=r_.Outdoor,o.camera=aH(e.playerStartPos,o.zoomLevel),o.gameMap=e,o.popups.reset(),o.activeSoundPool.empty(),o.ambientSoundPool.empty(),er(o),aR(o),aw(o,o.player.pos),L.stop(),am(o),null===o.player.torchAnimation&&console.log("WARNING: No player torch added"))}else if(x("prevLevel"))r.devMode&&r.level>0&&(ar(r),as(r,r.level-1),r.camera.zoomed=!1);else if(x("showFPS"))r.devMode&&(r.fpsInfo.enabled=!r.fpsInfo.enabled);else if(x("guardSight"))r.devMode&&(r.seeGuardSight=!r.seeGuardSight);else if(x("guardPatrols"))r.devMode&&(r.seeGuardPatrols=!r.seeGuardPatrols);else if(x("roomAdjacencies"))r.devMode&&(r.seeRoomAdjacencies=!r.seeRoomAdjacencies);else if(x("markSeen"))r.devMode&&(r.gameMap.markAllSeen(),aR(r));else if(x("zoomIn")){(a=r).zoomLevel=Math.min(16,a.zoomLevel+1),a.camera.panning=!1,++a.numZoomMoves,aR(a)}else if(x("zoomOut")){(n=r).zoomLevel=Math.max(-4,n.zoomLevel-1),n.camera.panning=!1,++n.numZoomMoves,aR(n)}else if(x("guardMute"))aU(r,!r.guardMute),r.popups.setNotification("Guard speech: "+(r.guardMute?"disabled":"enabled"),r.player,3,2);else if(x("idleCursorToggle")){switch(r.player.idleCursorType){case"orbs":r.player.idleCursorType="off";break;case"off":r.player.idleCursorType="orbs"}r.player.idle=!1,r.idleTimer=2,r.popups.setNotification("Player idle cursor: "+r.player.idleCursorType,r.player,3,2)}else if(x("volumeMute"))aY(r,!r.volumeMute),r.popups.setNotification("Sound: "+(r.volumeMute?"disabled":"enabled"),r.player,3,2);else if(x("volumeDown")){let e=Math.max(.1,r.soundVolume-.1);aX(r,e),r.popups.setNotification("Sound volume: "+Math.floor(100*r.soundVolume+.5)+"%",r.player,3,2)}else if(x("volumeUp")){let e=Math.min(1,r.soundVolume+.1);aX(r,e),r.popups.setNotification("Sound volume: "+Math.floor(100*r.soundVolume+.5)+"%",r.player,3,2)}else x("showSpeech")&&r.popups.toggleShow(r.player.pos)}(rp):r.textWindows[r.gameMode]?.onControls(r,function(e){let t=!1;return null!==rp&&e in rp.controlStates&&((t=rp.currentFramePresses.has(e))&&(rp.controlTimes[e],Date.now()),t)}),r.touchController.endFrame(),r.keyboardController.endFrame(),r.gamepadManager.gamepads)r.gamepadManager.gamepads[e].endFrame();function x(e){let t=Date.now(),o=!1;if(null===rp)return!1;let a=rp.controlStates;if(!(e in a))return!1;let n=r.keyRepeatActive===e?r.keyRepeatRate:r.keyRepeatDelay;return(o=rp.currentFramePresses.has(e)||a[e]&&t-rp.controlTimes[e]>n)&&(a[e]&&t-rp.controlTimes[e]>n&&(r.keyRepeatActive=e),rp.controlTimes[e]=t),a[e]||r.keyRepeatActive!==e||(r.keyRepeatActive=void 0),o}r.camera.zoomed||(r.camera.zoomed=!0,a=r,l=16*a6(n=m),f=n[0]/16,u=(n[1]-2*l)/16,c=a.gameMap.cells.sizeX,f*(d=a.gameMap.cells.sizeY)<u*c?a.zoomLevel=Math.log(f/c)/Math.log(1.1892):a.zoomLevel=Math.log(u/d)/Math.log(1.1892),a.zoomLevel=Math.max(0,Math.floor(a.zoomLevel))),r.camera.snapped||(r.camera.panning=!1,r.camera.snapped=!0,s=r,i=m,s.camera.zoom=s.zoomLevel,s.camera.zoomVelocity=0,s.camera.scale=Math.pow(1.1892,s.camera.zoom),a4(E.fromValues(s.gameMap.cells.sizeX,s.gameMap.cells.sizeY),i,s.camera.scale,rp===s.touchController&&!s.touchController.mouseActive,s.camera.position,s.player.pos),E.zero(s.camera.velocity),E.zero(s.camera.joltOffset),E.zero(s.camera.joltVelocity)),h>0&&function(e,t,o){(function(e,t,o){let r=e.zoomLevel-e.camera.zoom,a=-e.camera.zoomVelocity,n=e.camera.zoomVelocity+(2*a+8*r)*8*o;e.camera.zoom+=(e.camera.zoomVelocity+n)*(.5*o),e.camera.zoomVelocity=n,e.camera.scale=Math.pow(1.1892,e.camera.zoom);let s=E.create();if(!e.camera.panning){let r=E.create(),a=Math.pow(1.1892,e.zoomLevel);a4(E.fromValues(e.gameMap.cells.sizeX,e.gameMap.cells.sizeY),t,a,rp===e.touchController&&!e.touchController.mouseActive,r,e.player.pos);let n=E.create();E.subtract(n,r,e.camera.position);let i=E.create();E.negate(i,e.camera.velocity);let l=E.create();E.scale(l,n,64),E.scaleAndAdd(l,l,i,16),E.scaleAndAdd(s,e.camera.velocity,l,o)}E.scaleAndAdd(e.camera.position,e.camera.position,e.camera.velocity,.5*o),E.scaleAndAdd(e.camera.position,e.camera.position,s,.5*o),E.copy(e.camera.velocity,s);let i=E.create();E.scale(i,e.camera.joltOffset,-576),E.scaleAndAdd(i,i,e.camera.joltVelocity,-48);let l=E.create();E.scaleAndAdd(l,e.camera.joltVelocity,i,o),E.scaleAndAdd(e.camera.joltOffset,e.camera.joltOffset,e.camera.joltVelocity,.5*o),E.scaleAndAdd(e.camera.joltOffset,e.camera.joltOffset,l,.5*o),E.copy(e.camera.joltVelocity,l)})(e,t,o),function(e,t){let o,r,a=e.player;if(e.player.health<=0||e.gameMode!==rS.Mansion||null!==e.player.animation||(e.idleTimer-=t,e.idleTimer>0))return;let n=E.create(),s=E.fromValues(-.125,0),i=E.fromValues(.125,0),l=E.fromValues(0,.125),f=a.hidden(e.gameMap),u=or.playerTiles;f||Math.random()>.5?(o=[{pt0:n,pt1:l,duration:.1,fn:F.easeInQuad},{pt0:l,pt1:n,duration:.05,fn:F.easeOutQuad},{pt0:n,pt1:n,duration:.1,fn:F.easeOutQuad},{pt0:n,pt1:l,duration:.1,fn:F.easeInQuad},{pt0:l,pt1:n,duration:.05,fn:F.easeOutQuad}],r=f?[u.hidden]:[u.normal]):(o=[{pt0:n,pt1:s,duration:.1,fn:F.easeOutQuad},{pt0:s,pt1:s,duration:.5,fn:F.easeOutQuad},{pt0:s,pt1:n,duration:.1,fn:F.easeInQuad},{pt0:n,pt1:i,duration:.1,fn:F.easeOutQuad},{pt0:i,pt1:i,duration:.5,fn:F.easeOutQuad},{pt0:i,pt1:n,duration:.1,fn:F.easeInQuad}],r=[u.left,u.left,u.normal,u.right,u.right,u.normal]),a.animation=new X(o,r),a.idle||("orbs"===a.idleCursorType?a.idleCursorAnimation=[new Y(or.namedTiles.idleIndicator,.6,Math.PI,0,0),new Y(or.namedTiles.idleIndicator,.6,Math.PI,2*Math.PI/3,0),new Y(or.namedTiles.idleIndicator,.6,Math.PI,4*Math.PI/3,0)]:a.idleCursorAnimation=[]),a.idle=!0,e.idleTimer=5}(e,o);e.healthBarState.damageDisplayTimer=Math.max(0,e.healthBarState.damageDisplayTimer-o),e.healthBarState.enlargeTimeRemaining=Math.max(0,e.healthBarState.enlargeTimeRemaining-1.5*o);let r=1;r=e.healthBarState.enlargeTimeRemaining>.85?1-((e.healthBarState.enlargeTimeRemaining-.85)/.15000000000000002)**2:(r=e.healthBarState.enlargeTimeRemaining/.85)*r*(3-2*r),e.healthBarState.size=1+r/2,r=o/1;for(let t=0;t<e.healthBarState.heartFlashRemaining.length;++t)e.healthBarState.heartFlashRemaining[t]=Math.max(0,e.healthBarState.heartFlashRemaining[t]-r);for(let t of(e.popups.animate(o),void 0!==e.popups.currentSpeaker&&(e.popups.currentSpeechAbove?e.player.pos[1]>e.popups.currentSpeaker.pos[1]&&(e.popups.currentSpeechAbove=!1):e.player.pos[1]<e.popups.currentSpeaker.pos[1]&&(e.popups.currentSpeechAbove=!0)),e.player.noisyAnim+=2*o,e.player.noisyAnim-=Math.floor(e.player.noisyAnim),e.player.animation&&e.player.animation.update(o)&&(e.player.animation=null),e.player.lightActive&&e.player.torchAnimation?.update(o)&&(e.player.torchAnimation=null),e.player.idle&&e.player.idleCursorAnimation&&(e.player.idleCursorAnimation=e.player.idleCursorAnimation.filter(e=>!e.update(o))),e.gameMap.cells.values))t.animation?.update(o);for(let t of e.gameMap.items)t.animation?.update(o);for(let t of e.gameMap.guards)t.animation?.update(o)&&(t.animation=null),t.torchAnimation?.update(o)&&(t.torchAnimation=null);if(e.gameMapRoughPlans[e.level].levelType===ed.Fortress&&!e.oldPlayerPos.equals(e.player.pos)){let t=e.gameMap.items.find(t=>t.pos.equals(e.oldPlayerPos));if(t&&t.type===ex.Bush){let e=aO(ed.Fortress,or)[t.type],o={...e},r={...e},a={...e};o.textureIndex=e.textureIndex?e.textureIndex+1:0,r.textureIndex=e.textureIndex?e.textureIndex+2:0,a.textureIndex=e.textureIndex?e.textureIndex+3:0,t.animation=new H([e,o,r,a,a,a,r,o,e],1,0,1)}}e.gameMap.items=e.gameMap.items.filter(e=>{let t=e.animation?.update(o);return!0===t&&(e.animation=void 0),!(e instanceof X)&&!(e instanceof H)||!e.removeOnFinish||!0!==t}),e.particles=e.particles.filter(e=>{let t=e.animation?.update(o);return!(e.animation instanceof X)&&!(e.animation instanceof H)||!e.animation.removeOnFinish||!0!==t})}(r,m,h);let g=r.textWindows[r.gameMode];void 0!==g&&(g.update(r),g.parseUI(m)),function(e,t,o,r){if(rp!==e)return;let a=r.textWindows[r.gameMode];if(-1!==e.lastMotion.id&&void 0===a&&null===e.targetOnTouchDown&&e.lastMotion.active){let t=e.lastMotion.x-e.lastMotion.x0,o=e.lastMotion.y-e.lastMotion.y0,a=t/(16*r.camera.scale),n=o/(16*r.camera.scale);r.camera.panning=!0,r.camera.position[0]-=a-r.camera.anchor[0],r.camera.position[1]-=n-r.camera.anchor[1],r.camera.anchor[0]=a,r.camera.anchor[1]=n}else r.camera.anchor[0]=0,r.camera.anchor[1]=0;(function(e,t,o,r){let a=void 0!==t.entityTileSet.touchButtons?t.entityTileSet.touchButtons:{},n=16*a6(o),s=o[0],i=o[1]-n,l=Math.min(80,Math.floor(Math.min(s,i)/5)),f=r.gameMode===rS.Mansion,u=[{action:"menuToggle",rect:new rm(0,n+i-l-0,l,l),tileInfo:a.menu,visible:!0},{action:"zoomIn",rect:new rm(0+s-l-0,n+i-l-0,l,l),tileInfo:a.zoomIn,visible:f},{action:"zoomOut",rect:new rm(0+s-l-0,n+i-2*l-0,l,l),tileInfo:a.zoomOut,visible:f},{action:"left",rect:new rm(0,n+l+0,l,l),tileInfo:a.left,visible:!0},{action:"right",rect:new rm(0+2*l+0,n+l+0,l,l),tileInfo:a.right,visible:!0},{action:"up",rect:new rm(0+l+0,n+2*l+0,l,l),tileInfo:a.up,visible:!0},{action:"down",rect:new rm(0+l+0,n+0,l,l),tileInfo:a.down,visible:!0},{action:"wait",rect:new rm(0+l+0,n+l+0,l,l),tileInfo:a.wait,visible:f},{action:"jump",rect:new rm(0+s-1.5*l-0,n+0,1.5*l,1.5*l),tileInfo:a.jump,visible:f},{action:"menuAccept",rect:new rm(0+s-1.5*l-0,n+0,1.5*l,1.5*l),tileInfo:a.menuAccept,visible:!f}],c=new rm;for(let t of u)e.updateCoreTouchTarget(t.action,t.visible?t.rect:c,t.tileInfo)})(e,t,o,r),e.activateTouchTargets(a?a.touchTargets:void 0)}(r.touchController,o,m,r),function(e,t,o){let r,a,n;e.beginFrame(t);let s=k.create();if(function(e,t,o){let r=16*a6(t),[a,n]=a3(E.fromValues(t[0],t[1]-r),e.camera.scale),s=e.camera.position[0]+e.camera.joltOffset[0],i=e.camera.position[1]+e.camera.joltOffset[1],l=r/(16*e.camera.scale),f=s-a/2,u=i-n/2;k.ortho(o,f,f+a,u-l,u+n,1,-1)}(o,t,s),function(e,t,o){for(let r=0;r<e.sizeX;r++)for(let a=0;a<e.sizeY;a++){let n=e.at(r,a);n.type<ep.Wall0000||n.type>ep.DoorEW?e.at(r,a).litAnim=aN(n.lit,t,n.litSrc,o||n.seen):e.at(r,a).litAnim=0}}(o.gameMap.cells,o.lightStates,o.seeAll),e.start(s,t9.Terrain),function(e,t){let o=function(e,t){switch(e){case ed.Manor:return t.terrainTiles;case ed.ManorRed:return t.redWallTerrainTiles;case ed.Mansion:return t.manseTerrainTiles;case ed.Fortress:return t.fortressTerrainTiles;case ed.Warrens:return t.redWallTerrainTiles}}(e.gameMapRoughPlans[e.level].levelType,t.terrainTileSet);for(let r=0;r<e.gameMap.cells.sizeX;++r)for(let a=e.gameMap.cells.sizeY-1;a>=0;--a){let n=e.gameMap.cells.at(r,a);if(!n.seen&&!e.seeAll)continue;let s=n.type;s!=ep.GroundWoodCreaky||n.lit||n.identified||e.seeAll||(s=ep.GroundWood);let i=aF(r,a,e.gameMap.cells),l=n.animation?n.animation.currentTile():o[s];if(s!==ep.DoorEW&&s!==ep.DoorNS||n.blocksSight||void 0===l.textureIndex||(l={textureIndex:l.textureIndex+1,color:l.color,unlitColor:l.unlitColor}),t.addGlyphLit4(r,a,r+1,a+1,l,i),s===ep.GroundWater){let o=t.terrainTileSet.ledgeTiles,n=0;for(let s of[[0,1],[0,-1],[-1,0],[1,0]])e.gameMap.cells.at(r+s[0],a+s[1]).type!==ep.GroundWater&&t.addGlyphLit4(r,a,r+1,a+1,o[n],i),n++}}}(o,e),e.flush(),e.start(s,t9.Entity),az(o,e,!1),function(e,t){if(!e.seeGuardSight)return;let o=e.gameMap.cells.sizeX,r=e.gameMap.cells.sizeY,a=new ef(o,r,!1),n=E.create(),s=E.create();for(let t of e.gameMap.guards){let i=Math.max(0,Math.floor(t.pos[0]-10)),l=Math.min(o,Math.floor(t.pos[0]+10)+1),f=Math.max(0,Math.floor(t.pos[1]-10)),u=Math.min(r,Math.floor(t.pos[1]+10)+1);for(let o=f;o<u;++o)for(let r=i;r<l;++r){if(a.get(r,o))continue;E.set(n,r,o),E.subtract(s,n,t.pos);let i=e.gameMap.cells.atVec(n);!(!e.seeAll&&!i.seen||i.blocksPlayerMove||t.mode!==ee.ChaseVisibleTarget&&0>E.dot(t.dir,s)||E.squaredLen(s)>=t.sightCutoff(i.lit>0)&&(s[0]!==2*t.dir[0]||s[1]!==2*t.dir[1])||i.hidesPlayer&&(Math.abs(s[0])>1||Math.abs(s[1])>1||eo(t.mode)))&&es(e.gameMap,t.pos,n)&&a.set(r,o,!0)}}for(let o=0;o<e.gameMap.cells.sizeY;++o)for(let r=0;r<e.gameMap.cells.sizeX;++r)a.get(r,o)&&t.addGlyph(r,o,r+1,o+1,or.namedTiles.crossHatch)}(o,e),o.seeGuardPatrols)for(let t of o.gameMap.guards)for(let o of t.patrolPath)e.addGlyph(o[0],o[1],o[0]+1,o[1]+1,or.namedTiles.patrolRoute);!function(e,t){for(let r of e.gameMap.guards){var o;let a=0+((o=r.dir)[1]>0?1:o[1]<0?3:o[0]>0?0:o[0]<0?2:3),n=e.gameMap.cells.atVec(r.pos),s=aN(n.lit,e.lightStates,n.litSrc,e.seeAll||n.seen),i=e.seeAll||n.seen||r.speaking;if(!i&&E.squaredDistance(e.player.pos,r.pos)>36)continue;i||r.mode===ee.Unconscious?r.mode!==ee.Patrol||r.speaking||0!=n.lit?r.mode===ee.Unconscious?a+=12:a+=8:s=0:a+=4;let l=structuredClone(t.entityTileSet.npcTiles[a]);r.mode===ee.Unconscious&&r.hidden(e.gameMap)&&(l.color=0xff705050,l.unlitColor=0xff604040);let f=e.gameMap.items.find(e=>[ex.PortcullisEW,ex.PortcullisNS].includes(e.type)),u=void 0!==f&&f.pos.equals(r.pos)?.25:0,c=r.animation?.offset??E.create(),d=r.pos[0]+c[0]+u,p=r.pos[1]+c[1];if(r.hasTorch||r.hasPurse||r.hasVaultKey){let e=d+.375*r.dir[0]+.375*r.dir[1],o=p-.125,a=r.mode!==ee.Unconscious&&r.torchAnimation?r.torchAnimation.currentTile():t.entityTileSet.itemTiles[ex.TorchCarry],n=d-.25*r.dir[0]+.375*(r.dir[1]<0),i=p-.125,f=r.hasVaultKey?or.itemTiles[ex.KeyCarry]:t.entityTileSet.itemTiles[ex.PurseCarry];r.dir[1]>0?(r.hasTorch&&t.addGlyphLit(e,o,e+1,o+1,a,s),t.addGlyphLit(d,p,d+1,p+1,l,s),(r.hasPurse||r.hasVaultKey)&&t.addGlyphLit(n,i,n+1,i+1,f,s)):r.dir[1]<0?((r.hasPurse||r.hasVaultKey)&&t.addGlyphLit(n,i,n+1,i+1,f,s),t.addGlyphLit(d,p,d+1,p+1,l,s),r.hasTorch&&t.addGlyphLit(e,o,e+1,o+1,a,s)):(t.addGlyphLit(d,p,d+1,p+1,l,s),r.hasTorch&&t.addGlyphLit(e,o,e+1,o+1,a,s),(r.hasPurse||r.hasVaultKey)&&t.addGlyphLit(n,i,n+1,i+1,f,s))}else t.addGlyphLit(d,p,d+1,p+1,l,s)}}(o,e),(o.gameMode!==rS.MansionComplete&&o.gameMode!==rS.Win||o.player.animation)&&function(e,t){let o,r=e.player,a=r.animation,n=a&&a instanceof X?a.offset:E.create(),s=r.pos[0]+n[0],i=r.pos[1]+n[1],l=r.pos[0],f=r.pos[1],u=e.gameMap.cells.at(l,f),c=aN(u.lit,e.lightStates,u.litSrc,e.seeAll||u.seen),d=r.hidden(e.gameMap),p=r.health<=0;if(a)o=a.currentTile();else{let e=t.entityTileSet.playerTiles;o=p?e.dead:d||u.type===ep.GroundWater?e.hidden:e.normal}let h=[],m=structuredClone(o);if(!p){if(r.idle){if(null!==r.idleCursorAnimation&&1===r.idleCursorAnimation.length&&r.idleCursorAnimation[0]instanceof q){let e=r.idleCursorAnimation[0].currentTile();t.addGlyphLit(l,f,l+1,f+1,e,1)}if(null!==r.idleCursorAnimation&&r.idleCursorAnimation.length>1){for(let e of r.idleCursorAnimation)if(e instanceof Y){let o=e.currentTile(),r=e.offset;r[1]>0?t.addGlyphLit(l+r[0],f+r[1]/4-.125,l+r[0]+1,f+r[1]/4+1-.125,o,1):h.push([l+r[0],f+r[1]/4-.125,l+r[0]+1,f+r[1]/4+1-.125,o,1])}}}r.damagedLastTurn?(m.color=0xff5454fe,m.unlitColor=0xff0000a8):d&&(m.color=0xff705050,m.unlitColor=0xff604040)}if(t.addGlyphLit(s,i,s+1,i+1,m,c),d&&r.idle&&t.addGlyphLit(s,i,s+1,i+1,t.entityTileSet.playerTiles.litFace,.15),r.lightActive){let e=null!==r.torchAnimation?r.torchAnimation.currentTile():t.entityTileSet.itemTiles[ex.TorchCarry];t.addGlyphLit(s,i,s+1,i+1,e,c)}for(let e of h)t.addGlyphLit(...e)}(o,e),az(o,e,!0),o.seeRoomAdjacencies&&function(e,t,o){let r={textureIndex:4,color:0xffffffff,unlitColor:0xffffffff},a={textureIndex:4,color:0xff4040ff,unlitColor:0xffffffff},n={textureIndex:4,color:0xffffffff,unlitColor:0xffffffff},s=1/16;for(let t of e){let e=t.posMin[0],a=t.posMin[1],n=t.posMax[0],i=t.posMax[1];o.addGlyph(e,a,n,a+s,r),o.addGlyph(e,i-s,n,i,r),o.addGlyph(e,a+s,e+s,i-s,r),o.addGlyph(n-s,a+s,n,i-s,r)}for(let e of t){let t=.5+e.origin[0],r=.5+e.origin[1],i=t+e.dir[0]*e.length,l=r+e.dir[1]*e.length,f=Math.abs(e.dir[0])*(1-s),u=Math.abs(e.dir[1])*(1-s),c=Math.min(t,i)+f-(.5-s),d=Math.min(r,l)+u-(.5-s),p=Math.max(t,i)-f+(.5-s),h=Math.max(r,l)-u+(.5-s),m=e.door?n:a;o.addGlyph(c,d,p,d+s,m),o.addGlyph(c,h-s,p,h,m),o.addGlyph(c,d+s,c+s,h-s,m),o.addGlyph(p-s,d+s,p,h-s,m)}}(o.gameMap.rooms,o.gameMap.adjacencies,e),function(e,t){for(let o of e.particles)if(o.animation&&(e.seeAll||e.gameMap.cells.atVec(o.pos).seen)){let e=o.animation,r=e instanceof X||e instanceof Y?e.offset:E.create(),a=o.pos[0]+r[0],n=o.pos[1]+r[1],s=e.currentTile();o.animation instanceof X&&!(o.animation.time>=0)||t.addGlyph(a,n,a+1,n+1,s)}}(o,e),o.gameMode===rS.Mansion&&function(e,t){let o=e.player,r=t.entityTileSet.namedTiles.speechBubbleR,a=t.entityTileSet.namedTiles.speechBubbleL;for(let n of e.gameMap.guards){let s=e.gameMap.cells.atVec(n.pos);if(!(e.seeAll||s.seen||n.speaking)&&E.squaredDistance(e.player.pos,n.pos)>36)continue;let i=n.animation?.offset??E.create(),l=n.pos[0]+i[0],f=n.pos[1]+i[1];n.speaking&&!e.popups.isSpeechBubbleVisible()&&(n.dir[0]>=0?t.addGlyph(l+1,f,l+2,f+1,r):t.addGlyph(l-1,f,l,f+1,a));let u=n.overheadIcon();if(u!==em.Relaxed){let e=t.entityTileSet.guardStateTiles[u];t.addGlyph(l,f+.625,l+1,f+1.625,e)}if(n===o.pickTarget){let e=or.namedTiles.pickTarget;t.addGlyph(l,f+.625,l+1,f+1.625,e)}}if(o.preNoisy||o.noisy){let e=o.animation,r=e&&e instanceof X?e.offset:E.create();if(.5>Math.abs(r[0])&&.5>Math.abs(r[1])){let e=o.pos[0]+o.noiseOffset[0]/2,r=o.pos[1]+o.noiseOffset[1]/2;if(o.preNoisy)t.addGlyph(e,r,e+1,r+1,or.namedTiles.pickTarget);else{let a=.0625*Math.sin(o.noisyAnim*Math.PI*2);t.addGlyph(e-a,r-a,e+1+a,r+1+a,or.namedTiles.noise)}}}}(o,e),r=o.gameMap.cells.sizeX,a=o.gameMap.cells.sizeY,n={textureIndex:0,color:0xffffffff,unlitColor:0xffffffff},e.addGlyph(-1,0,0,a,n),e.addGlyph(r,0,r+1,a,n),e.addGlyph(-1,-1,r+1,0,n),e.addGlyph(-1,a,r+1,a+1,n),e.flush(),function(e,t,o,r,a,n){let s=Math.max(1,t-e)*Math.max(0,r)/.5;if(s<=0)return;let i=+!o,l=+!!o,f=+!!o,u=[i,l,f,Math.min(1,.05*s)],c=[i,l,f,Math.min(1,.5*s)],d=k.create();n[0]<n[1]?(d[0]=n[0]/n[1],d[5]=1):(d[0]=1,d[5]=n[1]/n[0]),d[0]/=1.5,d[5]/=1.5,d[10]=1,d[15]=1,a.renderVignette(d,.8/1.5,u,c)}(o.player.health,o.player.healthMax,o.healthBarState.healing,o.healthBarState.damageDisplayTimer,e,t),(o.gameMode===rS.Mansion||o.gameMode===rS.MansionComplete)&&(function(e,t,o){if(!o.popups.isSpeechBubbleVisible()||void 0===o.popups.currentSpeaker)return;let r=o.popups.currentSpeech;if(0===r.length)return;let a=a6(t),n=8*a,s=16*a,i=16*o.camera.scale,l=16*o.camera.scale,[f,u]=a3(E.fromValues(t[0],t[1]-s),o.camera.scale),c=o.camera.position[0]+o.camera.joltOffset[0],d=o.camera.position[1]+o.camera.joltOffset[1],p=o.popups.currentSpeaker.posAnimated(),h=Math.floor((p[0]+.5-c+f/2)*i),m=Math.floor((p[1]+.5-d+u/2)*l)+s,x=r.split("\n"),g=x.reduce((e,t)=>Math.max(e,t.length),0),y=x.length,v=k.create();k.ortho(v,0,t[0],0,t[1],1,-1);let M=4*a,T=2*a,S=2*a,_=g*n+2*(M+S),w=y*s+2*(T+S),b=h-_/2,I=(w/2+.625*l)*(o.popups.currentSpeechAbove?1:-1)+m-w/2;b=Math.min(b=Math.max(b,0),t[0]-_),I=Math.min(I=Math.max(I,s),t[1]-w),e.start(v,t9.Font),e.addGlyph(b,I,b+g*n+2*(M+S),I+y*s+2*(T+S),{textureIndex:219,color:0xff080808}),e.addGlyph(b+S,I+S,b+g*n+2*M+S,I+y*s+2*T+S,{textureIndex:219,color:0xffd0d0d0});let A=I+(y-1)*s+T+S;for(let t of x){let o=Math.floor(b+M+S+(g-t.length)*n/2);for(let r=0;r<t.length;++r){let a=t.charCodeAt(r);e.addGlyph(o,A,o+n,A+s,{textureIndex:a,color:0xff080808}),o+=n}A-=s}e.flush()}(e,t,o),function(e,t,o){if(!o.popups.isNotificationVisible())return;let r=o.popups.notification;if(0===r.length)return;let a=a6(t),n=8*a,s=16*a,i=16*o.camera.scale,l=16*o.camera.scale,[f,u]=a3(E.fromValues(t[0],t[1]-s),o.camera.scale),c=o.camera.position[0]+o.camera.joltOffset[0],d=o.camera.position[1]+o.camera.joltOffset[1],p=o.popups.notificationWorldPos,h=p instanceof ey?p.animation?p.pos.add(p.animation.offset):p.pos:p,m=(h[0]+.5-c+f/2)*i,x=(h[1]+.5-d+u/2)*l+s,g=r.split("\n"),y=g.reduce((e,t)=>Math.max(e,t.length),0),v=g.length,M=k.create();k.ortho(M,0,t[0],0,t[1],1,-1);let T=8*a,S=4*a,_=y*n+2*T,w=v*s+2*S,b=m-_/2,I=.5*(w+.875*l*2)+x-w/2,A=8*a;b=Math.min(b=Math.max(b,A),t[0]-(_+A)),I=Math.min(I=Math.max(I,s+A),t[1]-(w+A)),e.start(M,t9.Font),e.addGlyph(b,I,b+y*n+2*T,I+v*s+2*S,{textureIndex:219,color:0xb0080808});let C=I+(v-1)*s+S;for(let t of g){let o=b+T+(y-t.length)*n/2;for(let r=0;r<t.length;++r){let a=t.charCodeAt(r);e.addGlyph(o,C,o+n,C+s,{textureIndex:a,color:0xffffffff}),o+=n}C-=s}e.flush()}(e,t,o)),(o.gameMode===rS.Mansion||o.gameMode===rS.MansionComplete)&&function(e,t,o){let r=o.hintMessage;if(0===r.length)return;let a=a6(t),n=t[0]/(8*a),s=t[1]/(16*a),i=k.create(),l=-((n-r.length)/2);k.ortho(i,l,n+l,-1.75,s+-1.75,1,-1),e.start(i,t9.Font),e.addGlyph(-1,-.25,r.length+1,1.25,{textureIndex:ot.background.textureIndex,color:0xb0080808,unlitColor:0xb0080808}),a7(e,0,r,0xffffffff),e.flush()}(e,t,o);let i=o.textWindows[o.gameMode];if(void 0!==i&&i.render(e),function(e,t,o){let r=a6(t),a=t[0]/(8*r),n=t[1]/(16*r),s=k.create();k.ortho(s,0,a,0,n,1,-1),e.start(s,t9.Font),e.addGlyph(0,0,a,1,ot.background);let i=(o.dailyRun?"Daily Lvl ":"Lvl ")+(o.level+1),l=ai(o),f=""+o.turns+"/"+l,u=o.turns>l?0xff5454fe:o.turns>.75*l?0xff54fefe:0xff54fe54;0!==o.levelStats.numSpottings&&(f+="!");let c=o.fpsInfo.enabled?o.fpsInfo.msgFPS:"",d=o.fpsInfo.enabled?2:1,p=i.length+f.length+c.length+d,h=1;if(o.gameMap.cells.atVec(o.player.pos).type==ep.GroundWater&&o.player.turnsRemainingUnderwater>0){let t=ot.air.textureIndex;for(let r=0;r<5;++r){let a=r<o.player.turnsRemainingUnderwater-1?0xfffefe54:0xff705050;e.addGlyph(h,0,h+1,1,{textureIndex:t,color:a}),++h}}else{let t=o.healthBarState.size,r=ot.heart.textureIndex;for(let a=0;a<o.player.healthMax;++a){let n=o.healthBarState.heartFlashRemaining[a],s=a<o.player.health?a8(0xff0000a8,0xffffffff,n):a8(0xff705050,0xff5454fe,n);e.addGlyph(h,0,h+t,t,{textureIndex:r,color:s}),h+=t}}++h;let m="Leap";o.leapToggleActive&&a7(e,h,m,0xff54fe54),h=o.player.healthMax+m.length+2;let x=a,g=Math.floor(100*o.gameMap.fractionRevealed()),y=o.player.hasVaultKey?"Key ":"",v="Map "+g+"% ",M="Loot "+o.lootStolen+"/"+(g<100?"?":o.lootAvailable)+" ",T=o.finishedLevel&&o.player.health>0&&o.gameMode===rS.Mansion?"Escape! ":"",S=x-(h+p+y.length+1);v.length+M.length+T.length>S&&(g<100?M="":v=""),v.length+M.length+T.length>S&&(M="",v=""),v.length+M.length+T.length>S&&(T=""),a7(e,x-=M.length,M,0xfffe54fe),a7(e,x-=v.length,v,0xffffffff),a7(e,x-=y.length,y,0xfffefe54),a7(e,x-=T.length,T,0xffffffff);let _=(h+x-p)/2;a7(e,_,i,0xffa8a8a8),a7(e,_+i.length+1,f,u),""!==c&&a7(e,_+i.length+f.length+2,c,0xffa8a8a8),e.flush()}(e,t,o),rp===o.touchController){let r=k.create();k.ortho(r,0,t[0],0,t[1],1,-1),e.start(r,t9.Entity);var l=o.touchController;for(let t in l.coreTouchTargets){if(!(t in l.controlStates))continue;let o=l.coreTouchTargets[t];if(!o.mouseable&&l.mouseActive||null===o.tileInfo||0===o.rect[2]||0===o.rect[3])continue;let r=+!!l.controlStates[t];e.addGlyphLit(o.rect[0],o.rect[1],o.rect[0]+o.rect[2],o.rect[1]+o.rect[3],o.tileInfo,r)}e.flush(),e.flush()}}(o,m,r),requestAnimationFrame(t=>e(t,o,r))})(e,y,T))}function ar(e){if(e.gameMapRoughPlans[e.level].played)return;e.gameMapRoughPlans[e.level].played=!0;let t=0===e.levelStats.numSpottings,o=Math.max(0,ai(e)-e.turns),r=10*e.lootStolen,a=af(e),n=5*e.levelStats.extraFoodCollected;e.gameStats.totalScore+=r+a+n+o+(t?r:0),e.gameStats.turns=e.totalTurns,e.gameStats.numLevels=e.gameMapRoughPlans.length,e.gameStats.numCompletedLevels=e.level+1,e.gameStats.numGhostedLevels+=+!!t,e.gameStats.numInjuries+=e.levelStats.damageTaken,e.gameStats.numKnockouts+=e.levelStats.numKnockouts,e.gameStats.numSpottings+=e.levelStats.numSpottings,e.gameStats.daily=e.dailyRun,e.gameStats.timeEnded=Date.now()}function aa(e){e.numKnockouts=0,e.numSpottings=0,e.damageTaken=0,e.extraFoodCollected=0,e.steppableLeaps=0}function an(e,t){let o;for(o in e.achievements)e.achievements[o].update(e,t)}function as(e,t){(e.level=t,e.level>=e.gameMapRoughPlans.length)?a2(e):(e.popups.reset(),e.activeSoundPool.empty(),e.ambientSoundPool.empty(),e.gameMap=tY(e.gameMapRoughPlans[e.level]),e.lightStates=Array(e.gameMap.lightCount).fill(0),a0(e.gameMap,e),aJ(e.gameMap,e),aZ(e.gameMap,e),e.hintMessage="",aE(e),e.finishedLevel=!1,e.turns=0,e.lootStolen=0,e.treasureStolen=0,e.lootAvailable=e.gameMapRoughPlans[e.level].totalLoot,aa(e.levelStats),E.copy(e.player.pos,e.gameMap.playerStartPos),e.player.dir=E.fromValues(0,-1),e.player.noisy=!1,e.player.preNoisy=!1,e.player.hasVaultKey=!1,e.player.damagedLastTurn=!1,e.player.turnsRemainingUnderwater=7,e.player.animation=null,e.popups.reset(),e.camera=aH(e.gameMap.playerStartPos,e.zoomLevel),e.camera.zoomed=0!==t,e.gameMode=rS.Mansion,e.hasEnteredMansion=!1,er(e),aR(e),aw(e,e.player.pos),am(e))}function ai(e){let t=(e.gameMap.numCells()-e.gameMap.numPreRevealedCells)*e.gameMap.backtrackingCoefficient,o=e.gameMap.guards.length;return 10*Math.ceil((t/3.5+(8*o+o/t*1e3))/10)}function al(e,t){return e.reduce((e,o)=>e+ +!!t(o),0)}function af(e){let t=10*e.lootStolen;return 0+t*al(e.gameMap.treasures,e=>e.stolen&&e.switches.length>0)+t/2*al(e.gameMap.treasures,e=>e.stolen&&e.switches.length<=0)+30*al(e.gameMap.items,e=>e.type===ex.LootedVaultTreasureBox)}window.onload=function(){window.focus(),Promise.all([aB(ot.imageSrc,ot.image),aB(oo.imageSrc,oo.image),aB(or.imageSrc,or.image)]).then(ao)},window.onclick=()=>{window.focus()};let au=["Use darkness or hiding places to avoid guards","Escape out windows with Shift+Dir","Knock out adjacent, unaware guards with Shift+Dir","Pickpocket by following exactly for two turns","Zoom view with [ and ]","Bang walls to make noise with Dir, then Shift+Dir","'Ghost' by never being fully seen","Knock out spotting guard by leaping onto them"];function ac(e){ar(e),an(e,"levelEnd"),e.activeSoundPool.empty(),e.ambientSoundPool.empty(),L.stop(),e.sounds.levelCompleteJingle.play(.35),0===e.levelStats.numSpottings&&(e.persistedStats.totalGhosts++,aK("totalGhosts",e.persistedStats.totalGhosts)),e.level<au.length?e.hintMessage="Hint: "+au[e.level]:e.hintMessage="",e.gameMode=rS.MansionComplete}function ad(e,t){return e.gameMap.hasLootAt(t)&&!e.gameMap.items.find(e=>e.type===ex.TreasureLock&&e.pos.equals(t))}function ap(e,t,o){let r=e.gameMap.collectLootAt(t);if(0===r.length)return!1;let a=!1,n=!1;for(let s of r){let r=s.type,i=0,l=1;if(s.type===ex.Coin)++e.player.loot,++e.lootStolen,a=!0;else if(s.type>=ex.TreasureA){for(let o of(a=!0,++e.treasureStolen,e.gameMap.treasures))o.posTreasure.equals(s.pos)&&(o.stolen=!0,e.gameMapRoughPlans[e.level].levelType===ed.Fortress&&e.level===e.gameMapRoughPlans.length-1&&aP(e.gameMap,e.player,e.popups,3,t[0]-e.player.pos[0],t[1]-e.player.pos[1],e.sounds,46,!0));i=.5}else if(s.type===ex.VaultTreasureBox){a=!0,r=ex.Coin,l=3,e.gameMap.items.push({type:ex.LootedVaultTreasureBox,pos:E.clone(t),topLayer:!1});let o=new H(or.vaultGoldAnimationTiles,.15,0,1);o.removeOnFinish=!0,e.particles.push({pos:E.clone(s.pos),animation:o}),aP(e.gameMap,e.player,e.popups,3,t[0]-e.player.pos[0],t[1]-e.player.pos[1],e.sounds,46,!0)}else s.type===ex.Health&&(aG(e),e.player.health>=e.player.healthMax?++e.levelStats.extraFoodCollected:(++e.player.health,aV(e,e.player.health-1)),n=!0);let f=aO(e.gameMapRoughPlans[e.level].levelType,or);for(let t=0;t<l;t++){let a={type:r,pos:E.clone(s.pos),topLayer:!1},n=E.create(),l=E.fromValues(o[0]-s.pos[0],o[1]-s.pos[1]+i),u=l.scale(.3333).add(E.fromValues(0,.5+i/2)),c=new X([{pt0:n,pt1:u,duration:.1,fn:F.easeOutQuad},{pt0:u,pt1:l,duration:.1,fn:F.easeInQuad}],[f[r],f[r]]);c.time=-(.2*t),c.removeOnFinish=!0,a.animation=c,e.particles.push(a)}}return a&&e.sounds.coin.play(1),n&&e.sounds.food.play(.25),!0}function ah(e,t){if((t[0]<0||t[0]>=e.gameMap.cells.sizeX||t[1]<0||t[1]>=e.gameMap.cells.sizeY)&&!e.finishedLevel)return!1;let o=e.gameMap.cells.atVec(t);return!(o.blocksPlayerMove||aC(o.type)||o.type===ep.PortcullisNS||o.type===ep.PortcullisEW||(o.type===ep.DoorNS||o.type===ep.DoorEW)&&e.gameMap.items.some(e=>e.pos.equals(t)&&ej(e.type))||e.gameMap.items.some(e=>e.pos.equals(t)&&!function(e){switch(e){case ex.DrawersShort:case ex.VaultTreasureBox:case ex.EmptyVaultTreasureBox:case ex.LootedVaultTreasureBox:case ex.TorchUnlit:case ex.TorchLit:case ex.TreasureLock:case ex.TreasurePlinth:case ex.TreasureA:case ex.TreasureB:case ex.TreasureC:case ex.TreasureD:case ex.TreasureE:return!1;default:return!0}}(e.type))||e.gameMap.guards.some(o=>o.pos.equals(t)&&!o.allowsMoveOntoFrom(e.player.pos)))}function am(e){switch(e.ambientSoundPool.empty(),e.ambience){case r_.Indoor:break;case r_.Outdoor:e.sounds.ambienceOutdoor.play(1,0,!0);break;case r_.Kitchen:e.sounds.ambienceKitchen.play(1,0,!0);break;case r_.Water:e.sounds.ambienceWater.play(.5,0,!0);break;case r_.OutdoorWater:e.sounds.ambienceWater.play(.5,0,!0),e.sounds.ambienceOutdoor.play(1,0,!0)}}function ax(e,t,o){let r,a,n,s,i,l;if(e.player.pos.distance(e.oldPlayerPos)>1){let t=e.oldPlayerPos.add(e.player.pos).scale(.5);e.gameMap.cells.atVec(t)}if(r=1/0,a=1/0,n=1/0,s=e.gameMap.items.filter(e=>e.type===ex.Stove),function e(t,o,i,l){let f=[];for(let e of[[1,0],[0,1],[-1,0],[0,-1]]){let u=i.add(E.fromValues(e[0],e[1]));if(o.has(u[1]*t.sizeX+u[0]))continue;let c=t.atVec(u);c.type<=ep.Wall0000&&(f.push(u),o.add(u[1]*t.sizeX+u[0]),c.type===ep.GroundGrass&&r===1/0&&(r=10-l),c.type===ep.GroundWater&&a===1/0&&(a=10-l),n===1/0&&s.find(e=>e.pos.equals(u))&&(n=10-l))}if(l>0&&n===1/0&&(r===1/0||a===1/0))for(let r of f)e(t,o,r,l-1)}(e.gameMap.cells,new Set,e.player.pos,10),(l=(i=Math.min(r,n,a))===1/0?r_.Indoor:a<1/0&&r<1/0?r_.OutdoorWater:a<1/0?r_.Water:n<1/0?r_.Kitchen:i===r?r_.Outdoor:r_.Indoor)!==e.ambience&&(e.ambience=l,am(e)),o.hidesPlayer&&!t.hidesPlayer)return void e.sounds.hide.play(.2);let f=.5+Math.random()/2,u=t.type!==o.type;if(u){if(t.type===ep.GroundWater)return void e.sounds.waterExit.play(.5*f);else if(o.type===ep.GroundWater)return void e.sounds.waterEnter.play(.5*f)}if(o.type===ep.DoorEW||o.type===ep.DoorNS){let t=e.gameMap.items.find(t=>t.pos.equals(e.player.pos));t&&(t.type===ex.DoorEW||t.type===ex.DoorNS?e.sounds.playerDoorOpen.play(f):(t.type===ex.LockedDoorEW||t.type===ex.LockedDoorNS)&&e.sounds.playerDoorOpenLocked.play(f))}if(t.type===ep.DoorEW||t.type===ep.DoorNS){let t=e.gameMap.items.find(t=>t.pos.equals(e.oldPlayerPos));t&&(t.type===ex.DoorEW||t.type===ex.DoorNS?e.sounds.playerDoorClose.play(f):(t.type===ex.LockedDoorEW||t.type===ex.LockedDoorNS)&&e.sounds.playerDoorCloseLocked.play(f))}switch(o.type){case ep.GroundWoodCreaky:e.sounds.footstepCreaky.play(.15*f);break;case ep.GroundWood:(u||Math.random()>.9)&&e.sounds.footstepWood.play(.15*f);break;case ep.GroundNormal:(u||Math.random()>.5)&&e.sounds.footstepGravel.play(.03*f);break;case ep.GroundGrass:(u||Math.random()>.75)&&e.sounds.footstepGrass.play(.05*f);break;case ep.GroundWater:(u||Math.random()>.6)&&e.sounds.footstepWater.play(.02*f);break;case ep.GroundMarble:case ep.GroundVault:(u||Math.random()>.8)&&e.sounds.footstepTile.play(.05*f);break;default:(u||Math.random()>.8)&&e.sounds.footstepTile.play(.02*f)}}function ag(e,t,o){let r=E.create(),a=E.fromValues(t/4,o/4);e.player.animation=new X([{pt0:r,pt1:a,duration:.05,fn:F.linear},{pt0:a,pt1:r,duration:.05,fn:F.linear}],[or.playerTiles.normal])}function ay(e,t,o){e.sounds.footstepTile.play(.1),ag(e,t,o)}function av(e,t,o,r,a=0){let n=null;t.pickTarget=null,o.hasPurse&&(o.hasPurse=!1,t.loot+=1,e.lootStolen+=1,n={pos:E.clone(o.pos),type:ex.Coin,topLayer:eg[ex.Coin]}),o.hasVaultKey&&(o.hasVaultKey=!1,t.hasVaultKey=!0,n={pos:E.clone(o.pos),type:ex.Key,topLayer:eg[ex.Key]});let s=aO(e.gameMapRoughPlans[e.level].levelType,or);if(n){let t=E.create(),o=r.subtract(n.pos),i=o.scale(.3333).add(E.fromValues(0,.5)),l=a>0?new X([{pt0:t,pt1:t,duration:.1,fn:F.easeOutQuad},{pt0:t,pt1:i,duration:.1,fn:F.easeOutQuad},{pt0:i,pt1:o,duration:.1,fn:F.easeInQuad}],[s[n.type],s[n.type],s[n.type]]):new X([{pt0:t,pt1:i,duration:.1,fn:F.easeOutQuad},{pt0:i,pt1:o,duration:.1,fn:F.easeInQuad}],[s[n.type],s[n.type]]);l.removeOnFinish=!0,n.animation=l,e.particles.push(n),n.type===ex.Key?e.sounds.grabKey.play(1):e.sounds.coin.play(1)}}function aM(e,t,o){e.screenShakeEnabled&&E.scaleAndAdd(e.camera.joltVelocity,e.camera.joltVelocity,E.fromValues(t,o),-8)}function aT(e,t,o,r){if(1===r)return void(e.player.preNoisy&&t===e.player.noiseOffset[0]&&o===e.player.noiseOffset[1]?(ak(e),e.player.pickTarget=null,ag(e,1.25*t,1.25*o),aM(e,t,o),aP(e.gameMap,e.player,e.popups,4,t,o,e.sounds),aL(e),0===e.gameMapRoughPlans[e.level].level&&e.popups.setNotification("Noise\nattracts\npeople",e.player.pos)):(e.player.preNoisy=!1,ay(e,t,o)));let a=e.player.pos[0]+t,n=e.player.pos[1]+o,s=e.gameMap.items.find(e=>e.pos[0]===a&&e.pos[1]===n&&(e.type===ex.Bookshelf||e.type===ex.Note));if(void 0===s){e.player.preNoisy=!0,e.player.noiseOffset[0]=t,e.player.noiseOffset[1]=o,e.player.pickTarget=null,0!==e.gameMapRoughPlans[e.level].level||e.experiencedPlayer||J(e.gameMap.cells.at(a,n).type)||e.popups.setNotification("Make Noise:\nShift+"+aW(t,o),e.player.pos),ay(e,t,o);return}ak(e);let i=e.player.pickTarget!==s;if(e.player.pickTarget=i&&e.gameMap.treasures.some(e=>e.switches.some(e=>e.equals(s.pos)))?s:null,e.gameMap.cells.at(a,n).lit||(e.player.lightActive=!0),ag(e,t,o),aL(e),e.player.preNoisy=!0,e.player.noiseOffset[0]=t,e.player.noiseOffset[1]=o,i){let t=e.gameMap.bookTitle.get(s);void 0===t&&(t="Untitled"),s.type===ex.Bookshelf&&(t='"'+t+'"'),e.popups.setNotification(t,e.player.pos);return}let l=0;for(let t of e.gameMap.treasures){let o=t.switches.findIndex(e=>e.equals(s.pos));if(!(o<0))if(t.numSwitchesUsed>=t.switches.length)l=Math.max(l,1);else if(o===t.numSwitchesUsed)if(++t.numSwitchesUsed,t.numSwitchesUsed>=t.switches.length){let o=e.gameMap.items.filter(e=>e.type===ex.TreasureLock&&e.pos.equals(t.posTreasure));for(let r of(e.gameMap.items=e.gameMap.items.filter(e=>!(e.type===ex.TreasureLock&&e.pos.equals(t.posTreasure))),e.gameMap.cells.atVec(t.posTreasure).blocksPlayerMove=!1,o)){let t=new H(or.treasureGateAnimation,.3,0,1);t.removeOnFinish=!0,r.animation=t,e.particles.push(r)}l=Math.max(l,4)}else l=Math.max(l,3);else 0===o?(t.numSwitchesUsed=1,l=Math.max(l,3)):(t.numSwitchesUsed=0,l=Math.max(l,2))}switch(l){case 0:break;case 1:case 2:e.sounds.switchReset.play(.5),e.popups.setNotification("(clunk)",e.player.pos);break;case 3:e.sounds.switchProgress.play(.5),e.popups.setNotification("(click)",e.player.pos);break;case 4:e.sounds.switchSuccess.play(.5),e.popups.setNotification("(rumble)",e.player.pos),aM(e,t,o)}}function aS(e,t,o,r){let a,n=e.player;if(n.health<=0)return void ab(e);1!==r&&(n.preNoisy=!1),n.idle=!1,e.idleTimer=5,e.camera.panning=!1,e.touchController.clearMotion();let s=E.clone(n.pos),i=E.fromValues(n.pos[0]+t,n.pos[1]+o);if(i[0]<0||i[0]>=e.gameMap.cells.sizeX||i[1]<0||i[1]>=e.gameMap.cells.sizeY){if(e.finishedLevel){ak(e),ac(e);let r=E.create(),a=E.clone(i).subtract(s),l=r.add(a).scale(.5).add(E.fromValues(0,.0625)),f=[{pt0:r,pt1:l,duration:.1,fn:F.easeInQuad},{pt0:l,pt1:a,duration:.1,fn:F.easeOutQuad},{pt0:a,pt1:a,duration:o>0?.5:.1,fn:F.easeOutQuad}],u=t<0?or.playerTiles.left:t>0?or.playerTiles.right:o>0?or.playerTiles.up:or.playerTiles.down;n.animation=new X(f,[u,u,u,u])}else 1>e.gameMap.fractionRevealed()?e.popups.setNotification("Map and loot\nbefore leaving",e.player.pos):e.popups.setNotification("Collect all loot\nbefore leaving",e.player.pos),ay(e,t,o);return}let l=e.gameMap.cells.atVec(i);if(l.blocksPlayerMove)return void(ad(e,i)?(ak(e),ap(e,i,n.pos),n.pickTarget=null,ag(e,t,o),aL(e)):(0===r&&e.gameMap.items.some(e=>e.type===ex.TreasureLock&&e.pos.equals(i))&&e.popups.setNotification("Locked!",e.player.pos),aT(e,t,o,r)));if(l.type==ep.OneWayWindowE&&i[0]<=s[0]||l.type==ep.OneWayWindowW&&i[0]>=s[0]||l.type==ep.OneWayWindowN&&i[1]<=s[1]||l.type==ep.OneWayWindowS&&i[1]>=s[1]){e.popups.setNotification("Window is\nimpassable\nfrom here",e.player.pos),0===e.gameMapRoughPlans[e.level].level&&setTimeout(()=>e.sounds.tooHigh.play(.3),250),aT(e,t,o,r);return}if(aC(l.type)){aD(e,t,o),0===e.gameMapRoughPlans[e.level].level&&setTimeout(()=>e.sounds.jump.play(.3),250),ay(e,t,o);return}for(let a of e.gameMap.items.filter(e=>e.pos.equals(i)))switch(a.type){case ex.DrawersShort:case ex.VaultTreasureBox:case ex.EmptyVaultTreasureBox:case ex.LootedVaultTreasureBox:case ex.TreasurePlinth:ad(e,i)?(ak(e),ap(e,i,n.pos),n.pickTarget=null,ag(e,t,o),aL(e)):ah(e,E.fromValues(s[0]+2*t,s[1]+2*o))?aD(e,t,o):aT(e,t,o,r);return;case ex.TorchUnlit:ak(e),e.sounds.ignite.play(.08),a.type=ex.TorchLit,n.pickTarget=null,n.itemUsed=a,ag(e,t,o),aL(e);return;case ex.TorchLit:ak(e),e.sounds.douse.play(.05),a.type=ex.TorchUnlit,n.pickTarget=null,n.itemUsed=a,ag(e,t,o),aL(e);return;case ex.PortcullisEW:case ex.PortcullisNS:1!==r&&aD(e,t,o),e.sounds.gate.play(.3),0===e.gameMapRoughPlans[e.level].level&&setTimeout(()=>e.sounds.jump.play(.3),1e3),ag(e,t,o);return;case ex.LockedDoorEW:case ex.LockedDoorNS:if(!n.hasVaultKey){0===r&&e.popups.setNotification("Locked!",e.player.pos),aT(e,t,o,r);return}}let f=e.gameMap.guards.find(e=>e.pos.equals(i));if(void 0===f)ak(e),n.pickTarget=null;else if(f.mode===ee.Unconscious)ak(e),n.pickTarget=null,function(e,t){let o,r=E.clone(t.pos),a=E.clone(e.player.pos),n=E.create();E.subtract(n,r,a),E.add(n,n,r);let s=!1;(function(e,t){if(t[0]<0||t[1]<0||t[0]>=e.gameMap.cells.sizeX||t[1]>=e.gameMap.cells.sizeY||e.gameMap.cells.atVec(t).moveCost===1/0||e.gameMap.guards.find(e=>e.pos.equals(t)))return!0;for(let o of e.gameMap.items.filter(e=>e.pos.equals(t)))switch(o.type){case ex.PortcullisEW:case ex.PortcullisNS:return!0;case ex.LockedDoorEW:case ex.LockedDoorNS:if(!e.player.hasVaultKey)return!0}return!1})(e,n)&&(E.copy(n,a),s=!0),E.copy(t.pos,n),e.gameMap.cells.atVec(t.pos).type===ep.GroundWater&&(t.modeTimeout=0);let i=E.clone(r).subtract(t.pos),l=E.create();if(s)o=[{pt0:i,pt1:l,duration:.2,fn:F.easeOutQuad}];else{let e=E.fromValues(.5*(r[0]-t.pos[0]),.5*(r[1]-t.pos[1]));o=[{pt0:i,pt1:e,duration:.2,fn:F.easeInQuad},{pt0:e,pt1:l,duration:.1,fn:F.easeOutQuad}]}t.animation=new X(o,[])}(e,f);else{if(f.mode===ee.ChaseVisibleTarget)return void ay(e,t,o);ak(e);let r=!1;if((f.hasPurse||f.hasVaultKey)&&(n.pickTarget===f?r=!0:n.pickTarget=f),!f.allowsMoveOntoFrom(n.pos)){r&&av(e,n,f,s),aL(e),aw(e,s);return}r&&av(e,n,f,i)}let u=n.hidden(e.gameMap)||e.gameMap.cells.atVec(n.pos).type===ep.GroundWater;E.copy(n.pos,i),++e.numStepMoves,e.gameMap.identifyAdjacentCells(n.pos);let c=E.clone(s).subtract(i),d=E.create(),p=c.add(d).scale(.5).add(E.fromValues(0,.0625)),h=n.hidden(e.gameMap)||l.type===ep.GroundWater;if(void 0!==f&&f.mode===ee.Unconscious){let e=E.fromValues(.5*(s[0]-i[0]),.5*(s[1]-i[1]));a=[{pt0:c,pt1:e,duration:.2,fn:F.easeInQuad},{pt0:e,pt1:d,duration:.1,fn:F.easeOutQuad}]}else{let e=2===r?.05:.1;a=[{pt0:c,pt1:p,duration:e,fn:F.easeInQuad},{pt0:p,pt1:d,duration:e,fn:F.easeOutQuad},{pt0:d,pt1:d,duration:o>0&&!h?.5:.1,fn:F.easeOutQuad}],o>0&&!h&&a.push({pt0:d,pt1:d,duration:.1,fn:F.easeOutQuad})}let m=t<0?or.playerTiles.left:t>0?or.playerTiles.right:o>0?or.playerTiles.up:or.playerTiles.down,x=u?or.playerTiles.hidden:m,g=h?or.playerTiles.hidden:m;n.animation=new X(a,[x,g,g,h?or.playerTiles.hidden:or.playerTiles.left]),ap(e,n.pos,i),l.type===ep.GroundWoodCreaky&&aP(e.gameMap,n,e.popups,0,0,-1,e.sounds),aL(e),aw(e,s),ax(e,e.gameMap.cells.atVec(s),l)}function a_(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])===1}function aw(e,t){if(e.popups.isNotificationVisible())return;let o=e.gameMapRoughPlans[e.level].level;if(3===o)return void function(e){let t,o;if(e.lootStolen>=e.lootAvailable)return;let r=e.gameMap.allSeen(),a=(t=e.gameMap.items.reduce((e,t)=>e+ +(t.type===ex.Coin),0),o=e.gameMap.guards.reduce((e,t)=>e+ +!!t.hasPurse,0),0===t&&o>0);if(e.experiencedPlayer&&(!r||!a)||e.gameMap.guards.some(e=>!eo(e.mode)&&e.mode!==ee.Unconscious))return;let n=e.gameMap.guards.filter(e=>e.hasPurse);if(0===n.length)return;n.sort((t,o)=>E.squaredDistance(e.player.pos,t.pos)-E.squaredDistance(e.player.pos,o.pos));let s=n[0];if(eo(s.mode)&&a_(e.player.pos,s.pos)){let t=s.pos[0]-e.player.pos[0],o=s.pos[1]-e.player.pos[1],r=E.fromValues(s.pos[0],Math.max(s.pos[1],e.player.pos[1])),a=e.player.pickTarget===s?"Loot: ":"Loot (1/2): ";e.popups.setNotificationHold(a+aW(t,o)+"\nKnockout: Shift+"+aW(t,o),r);return}if(function(e,t){let o=t.pos[0]-e.player.pos[0],r=t.pos[1]-e.player.pos[1];if((2!==Math.abs(o)||0!==r)&&(0!==o||2!==Math.abs(r))||e.gameMap.cells.atVec(e.player.pos).type===ep.GroundWater)return!1;let a=E.fromValues(e.player.pos[0]+o/2,e.player.pos[1]+r/2),n=e.gameMap.cells.atVec(a);return!(n.blocksPlayerMove||(n.type===ep.DoorNS||n.type===ep.DoorEW)&&e.gameMap.items.some(e=>e.pos.equals(a)&&ej(e.type)))&&(n.type!=ep.OneWayWindowE||!(o<=0))&&(n.type!=ep.OneWayWindowW||!(o>=0))&&(n.type!=ep.OneWayWindowN||!(r<=0))&&(n.type!=ep.OneWayWindowS||!(r>=0))&&!!ah(e,t.pos)&&!0}(e,s)){let t=s.pos[0]-e.player.pos[0],o=s.pos[1]-e.player.pos[1],r=E.fromValues(s.pos[0],Math.max(s.pos[1],e.player.pos[1]));e.popups.setNotificationHold("Leap: Shift+"+aW(t,o),r);return}r&&a&&e.popups.setNotificationHold("Loot",s.pos)}(e);if(e.experiencedPlayer)return;if(2===o&&!e.hasEnteredMansion&&e.player.pos.equals(e.gameMap.playerStartPos)){let t=E.create();E.copy(t,e.player.pos),t[1]+=1,e.popups.setNotificationHold("Zoom view: [ or ]",t);return}if(1===o&&!e.hasEnteredMansion){let t,o=1/0;for(let r of e.gameMap.guards){let a=E.squaredDistance(r.pos,e.player.pos);a<o&&(o=a,t=r)}void 0!==t&&o<16&&e.popups.setNotificationHold("Wait: Z\nor Period/Space",t.pos);return}if(0!==o)return;let r=e.gameMap.items.find(t=>t.type===ex.Coin&&a_(t.pos,e.player.pos));if(void 0!==r)return void e.popups.setNotificationHold("Loot: "+aW(r.pos[0]-e.player.pos[0],r.pos[1]-e.player.pos[1]),r.pos);let a=e.gameMap.allSeen(),n=e.lootStolen>=e.lootAvailable;if(a&&n){if(0===e.player.pos[0]&&0!==t[0])return void e.popups.setNotificationHold("Exit: "+aW(-1,0),e.player.pos);if(e.player.pos[0]===e.gameMap.cells.sizeX-1&&t[0]!==e.gameMap.cells.sizeX-1)return void e.popups.setNotificationHold("Exit: "+aW(1,0),e.player.pos);if(0===e.player.pos[1]&&0!==t[1])return void e.popups.setNotificationHold("Exit: "+aW(0,-1),e.player.pos);if(e.player.pos[1]===e.gameMap.cells.sizeY-1&&t[1]!==e.gameMap.cells.sizeY-1)return void e.popups.setNotificationHold("Exit: "+aW(0,1),e.player.pos);for(let[t,o,r]of[[1,0,ep.OneWayWindowE],[-1,0,ep.OneWayWindowW],[0,1,ep.OneWayWindowN],[0,-1,ep.OneWayWindowS]])if(e.gameMap.cells.at(e.player.pos[0]+t,e.player.pos[1]+o).type===r)return void aD(e,t,o)}if(e.gameMap.cells.atVec(e.player.pos).type==ep.GroundWater){if(e.gameMap.cells.atVec(t).type!==ep.GroundWater)return void e.popups.setNotification("Hide underwater",e.player.pos);if(1===e.player.turnsRemainingUnderwater)return void e.popups.setNotification("Out of breath;\nsurfacing",e.player.pos)}if(!e.player.pos.equals(t)){let t=e.gameMap.items.filter(t=>t.pos.equals(e.player.pos));if(t.some(e=>e.type===ex.Bush))return void e.popups.setNotification("Hide in bushes",e.player.pos);if(t.some(e=>e.type===ex.Table))return void e.popups.setNotification("Hide under tables",e.player.pos);if(t.some(e=>e.type===ex.BedL||e.type===ex.BedR))return void e.popups.setNotification("Hide under beds",e.player.pos)}if(0===e.numLeapMoves&&!e.hasEnteredMansion){let t,o=e.gameMap.items.find(t=>(t.type===ex.PortcullisEW||t.type===ex.PortcullisNS)&&2>E.squaredDistance(e.player.pos,t.pos));if(void 0!==o){var s,i,l;let t=o.pos[0]-e.player.pos[0],r=o.pos[1]-e.player.pos[1];s=e,i=t,l=r,s.popups.setNotificationHold("Leap: Shift+"+aW(i,l),s.player.pos);return}for(let o of e.gameMap.items)(o.type===ex.PortcullisEW||o.type===ex.PortcullisNS)&&(void 0===t||t.pos[1]>o.pos[1])&&(t=o);if(void 0!==t)return void e.popups.setNotificationHold("Move: \x18\x19\x1b\x1a",t.pos)}if(!(a&&n)&&e.numLeapMoves<=1){let o=E.fromValues(Math.floor((e.player.pos[0]+t[0])/2),Math.floor((e.player.pos[1]+t[1])/2));if(e.gameMap.items.some(e=>e.pos.equals(o)&&e.type===ex.PortcullisEW))return void e.popups.setNotificationHold("Leap over open\nground or low\nfurniture too",e.player.pos)}}function ab(e){e.popups.setNotification(e.dailyRun?"Retry: Ctrl+R\nMenu: Esc/Slash":"New Game: Ctrl+R\nMenu: Esc/Slash",e.player.pos)}function aI(e,t,o){let r=e.player;if(r.health<=0)return void ab(e);r.idle=!1,e.idleTimer=5,e.camera.panning=!1,e.touchController.clearMotion();let a=E.clone(r.pos),n=E.fromValues(r.pos[0]+t,r.pos[1]+o),s=E.fromValues(r.pos[0]+2*t,r.pos[1]+2*o),i=e.gameMap.cells.atVec(a),l=e.gameMap.cells.atVec(n),f=e.gameMap.cells.atVec(s),u=e.gameMap.guards.find(e=>e.pos.equals(n)&&e.mode!==ee.Unconscious);if(u){if(l.type===ep.PortcullisEW||l.type===ep.PortcullisNS||!r.hasVaultKey&&aA(e.gameMap,n))return void aS(e,t,o,1);if(u.mode===ee.ChaseVisibleTarget){let r;r=E.clone(u.pos),E.copy(u.pos,e.player.pos),u.animation=new X([{pt0:E.clone(r).subtract(e.player.pos),pt1:E.create(),duration:.2,fn:F.easeOutQuad}],[]),aS(e,t,o,1)}else ak(e),u.mode=ee.Unconscious,u.modeTimeout=Math.max(1,40-2*e.level)+e.rng.randomInRange(20),(u.hasPurse||u.hasVaultKey)&&av(e,r,u,a),r.pickTarget=null,++e.levelStats.numKnockouts,e.sounds.hitGuard.play(.25),aL(e),ag(e,t,o),aM(e,t,o);return}if(i.type===ep.GroundWater||s[0]<0||s[1]<0||s[0]>=e.gameMap.cells.sizeX||s[1]>=e.gameMap.cells.sizeY||l.blocksPlayerMove||(l.type===ep.DoorNS||l.type===ep.DoorEW)&&e.gameMap.items.find(e=>e.pos.equals(n)&&ej(e.type))||l.type==ep.OneWayWindowE&&s[0]<=a[0]||l.type==ep.OneWayWindowW&&s[0]>=a[0]||l.type==ep.OneWayWindowN&&s[1]<=a[1]||l.type==ep.OneWayWindowS&&s[1]>=a[1])return void aS(e,t,o,1);let c=function(e,t){if((t[0]<0||t[0]>=e.gameMap.cells.sizeX||t[1]<0||t[1]>=e.gameMap.cells.sizeY)&&!e.finishedLevel)return!1;let o=e.gameMap.cells.atVec(t);if(o.blocksPlayerMove||aC(o.type))return!1;for(let o of e.gameMap.items.filter(e=>e.pos.equals(t)))switch(o.type){case ex.DrawersShort:case ex.VaultTreasureBox:case ex.EmptyVaultTreasureBox:case ex.LootedVaultTreasureBox:case ex.TorchUnlit:case ex.TorchLit:case ex.PortcullisEW:case ex.PortcullisNS:case ex.TreasureLock:case ex.TreasurePlinth:case ex.TreasureA:case ex.TreasureB:case ex.TreasureC:case ex.TreasureD:case ex.TreasureE:return!1}return!e.gameMap.guards.find(e=>e.pos.equals(t))}(e,n),d=e.gameMap.guards.find(e=>e.pos.equals(s));if(!ah(e,s)){var p,h,m,x,g,y,v,M;let i,l,u,T,S,_,w,b;return void(c?void 0!==d&&d.overheadIcon()===em.Alerted&&f.type!==ep.PortcullisEW&&f.type!==ep.PortcullisNS&&(r.hasVaultKey||!aA(e.gameMap,s))?(p=e,h=r,m=d,x=t,g=o,y=a,v=n,M=s,ak(p),ap(p,v,M),E.copy(h.pos,v),++p.numLeapMoves,m.mode=ee.Unconscious,m.modeTimeout=Math.max(1,40-2*p.level)+p.rng.randomInRange(20),(m.hasPurse||m.hasVaultKey)&&av(p,h,m,v,.15),h.pickTarget=null,++p.levelStats.numKnockouts,p.sounds.hitGuard.play(.25),(i=p.gameMap.cells.atVec(v)).identified=!0,l=E.clone(y).subtract(v),u=E.clone(M).subtract(v).scale(.5).add(E.fromValues(0,.25)),T=E.create(),S=x<0?or.playerTiles.left:x>0?or.playerTiles.right:g>0?or.playerTiles.up:or.playerTiles.down,_=h.hidden(p.gameMap),w=[{pt0:l,pt1:u,duration:.15,fn:F.easeInQuad},{pt0:u,pt1:T,duration:.1,fn:F.easeOutQuad},{pt0:T,pt1:T,duration:g>0&&!_?.5:.1,fn:F.easeOutQuad}],g>0&&!_&&w.push({pt0:T,pt1:T,duration:.1,fn:F.easeOutQuad}),b=_?or.playerTiles.hidden:S,h.animation=new X(w,[S,b,b,or.playerTiles.left]),i.type===ep.GroundWoodCreaky?aP(p.gameMap,h,p.popups,0,0,-1,p.sounds):i.type===ep.GroundWater&&aP(p.gameMap,h,p.popups,1,0,0,p.sounds),aM(p,x,g),aP(p.gameMap,h,p.popups,2,x,g,p.sounds),aL(p),ax(p,p.gameMap.cells.atVec(y),i)):aS(e,t,o,2):aS(e,t,o,1))}void 0!==d&&(d.hasPurse||d.hasVaultKey)?r.pickTarget=d:r.pickTarget=null,ak(e),ap(e,n,s);let T=e.gameMap.items.find(e=>e.pos.equals(n)&&e.type===ex.TorchLit);if(void 0!==T?(e.sounds.douse.play(.05),T.type=ex.TorchUnlit,r.itemUsed=T):c&&l.type!==ep.GroundWoodCreaky&&++e.levelStats.steppableLeaps,s[0]<0||s[1]<0||s[0]>=e.gameMap.cells.sizeX||s[1]>=e.gameMap.cells.sizeY){ac(e);let n=E.create(),i=E.clone(s).subtract(a),l=n.add(i).scale(.5).add(E.fromValues(0,.25)),f=t<0?or.playerTiles.left:t>0?or.playerTiles.right:o>0?or.playerTiles.up:or.playerTiles.down;r.animation=new X([{pt0:n,pt1:l,duration:.1,fn:F.easeInQuad},{pt0:l,pt1:i,duration:.1,fn:F.easeOutQuad},{pt0:i,pt1:i,duration:o>0?.5:.1,fn:F.easeOutQuad}],[f,f,f]);return}E.copy(r.pos,s),++e.numLeapMoves,f.identified=!0;let S=E.clone(a).subtract(s),_=E.create(),w=S.add(_).scale(.5).add(E.fromValues(0,.25)),b=t<0?or.playerTiles.left:t>0?or.playerTiles.right:o>0?or.playerTiles.up:or.playerTiles.down,I=r.hidden(e.gameMap),A=[{pt0:S,pt1:w,duration:.1,fn:F.easeInQuad},{pt0:w,pt1:_,duration:.1,fn:F.easeOutQuad},{pt0:_,pt1:_,duration:o>0&&!I?.5:.1,fn:F.easeOutQuad}];o>0&&!I&&A.push({pt0:_,pt1:_,duration:.1,fn:F.easeOutQuad});let C=I?or.playerTiles.hidden:b;r.animation=new X(A,[b,C,C,or.playerTiles.left]);let P=l.type===ep.PortcullisNS||l.type===ep.PortcullisEW;P?e.hasEnteredMansion=!0:0!==e.gameMapRoughPlans[e.level].level||e.hasEnteredMansion||(e.experiencedPlayer=!0),ap(e,s,s),f.type===ep.GroundWoodCreaky?aP(e.gameMap,r,e.popups,0,0,-1,e.sounds):f.type===ep.GroundWater&&aP(e.gameMap,r,e.popups,1,0,0,e.sounds),aL(e),aw(e,a),ax(e,e.gameMap.cells.atVec(a),f),P&&e.sounds.gate.play(.3)}function aA(e,t){return e.items.some(e=>e.pos.equals(t)&&(e.type===ex.LockedDoorEW||e.type===ex.LockedDoorNS))}function aC(e){switch(e){case ep.OneWayWindowE:case ep.OneWayWindowW:case ep.OneWayWindowN:case ep.OneWayWindowS:return!0;default:return!1}}function aP(e,t,o,r,a,n,s,i=23,l=!1){switch(t.noisy=!0,t.noiseOffset[0]=a,t.noiseOffset[1]=n,r){case 0:s.footstepCreaky.play(.6),o.setNotification("Creak!",t.pos);break;case 1:s.splash.play(.5),o.setNotification("Splash!",t.pos);break;case 2:o.setNotification("Thud!",t.pos);break;case 3:s.treasureAlarm.play(1);let f=E.fromValues(t.pos[0]+a,t.pos[1]+n);o.setNotificationHold("ALARM! ALARM! ALARM!",f);break;case 4:s.thump.play(.5),o.setNotification("Thud!",t.pos)}let u=!1;for(let o of e.guardsInEarshot(t.pos,i))o.heardThief=!0,u||(u=!0,o.heardThiefClosest=!0,o.heardAlarm=3===r),l&&(o.angry=!0,o.mode===ee.Unconscious&&(o.modeTimeout=0))}function ak(e){e.player.noisy=!1,e.player.damagedLastTurn=!1,e.player.itemUsed=null,e.player.lightActive=!1,e.popups.updateNotification()}function aL(e){let t=e.player.health;if(e.player.preNoisy=!1,++e.turns,++e.totalTurns,e.gameMap.cells.atVec(e.player.pos).type==ep.GroundWater?e.player.turnsRemainingUnderwater>0&&(--e.player.turnsRemainingUnderwater,e.player.turnsRemainingUnderwater<=0&&e.sounds.waterExit.play(.25)):e.player.turnsRemainingUnderwater=7,e.gameMap.computeLighting(e.player),!function(e){var t,o;let r,a,n,s=e.gameMap,i=e.player;for(let e of s.guards)e.modePrev=e.mode,e.heardGuard=e.hearingGuard,e.hearingGuard=!1,e.speaking=!1,e.hasMoved=!1;s.guards.sort((e,t)=>{let o=4===e.mode;return o!==(4===t.mode)?o?-1:1:t.patrolPath.length-e.patrolPath.length});let l=[],f=[];for(let t of s.guards){let o=E.clone(t.pos);t.act(e,l),t.hasMoved=!0,o.equals(t.pos)||f.push([t.pos,o])}s.computeLighting(i);let u=[];for(let t of s.guards)t.postActSense(s,i,e.levelStats,l,u,e.rng);if(l.length>0){l.sort((e,t)=>{if(e.speechType<t.speechType)return -1;if(e.speechType>t.speechType)return 1;let o=e.speaker.pos,r=t.speaker.pos,a=E.squaredDistance(o,i.pos),n=E.squaredDistance(r,i.pos);return a<n?-1:+(a>n)});let t=l[0],o=function(e){switch(e){case B.Damage:return"guardDamage";case B.GuardChase:return"guardChase";case B.GuardSeeThief:return"guardSeeThief";case B.GuardHearThief:return"guardHearThief";case B.GuardHearGuard:return"guardHearGuard";case B.GuardSpotDownedGuard:return"guardSpotDownedGuard";case B.GuardSeeTorchLit:return"guardSeeTorchLit";case B.GuardSeeUnlitTorch:return"guardSeeUnlitTorch";case B.GuardDownWarning:return"guardDownWarning";case B.GuardAwakesWarning:return"guardAwakesWarning";case B.GuardWarningResponse:return"guardWarningResponse";case B.GuardInvestigate:return"guardInvestigate";case B.GuardEndChase:return"guardEndChase";case B.GuardFinishInvestigating:return"guardFinishInvestigating";case B.GuardFinishLooking:return"guardFinishLooking";case B.GuardFinishListening:return"guardFinishListening";case B.GuardFinishLightingTorch:return"guardFinishLightingTorch";case B.GuardFinishLookingAtLitTorch:return"guardFinishLookingAtLitTorch";case B.GuardStirring:return"guardStirring";case B.GuardSeeTorchDoused:return"guardSeeTorchDoused";case B.GuardSpotStolenTreasure:return"guardSpotStolenTreasure";case B.GuardExamineStolenTreasure:return"guardExamineStolenTreasure"}}(t.speechType),r=Math.max(Math.min((t.speaker.pos[0]-i.pos[0])/12,1),0),a=Math.max(1-t.speaker.pos.distance(i.pos)/12,0),n=e.subtitledSounds[o].play(.3+.3*a,r),s=l[0].speaker,f=s.pos[1]>=i.pos[1];e.popups.setSpeech(n.subtitle,s,f),s.speaking=!0}for(let e of u){var c=s,d=e;for(let e of c.guardsInEarshot(d.posShouter,25))15!==e.mode&&(e.pos.equals(d.posShouter)||(e.hearingGuard=!0,d.angry&&(e.angry=!0),E.copy(e.heardGuardPos,d.posGoal)))}null!==i.pickTarget&&i.pickTarget instanceof et&&(4===i.pickTarget.mode||!i.pickTarget.cardinallyAdjacentTo(i.pos))&&(i.pickTarget=null);let p=(t=e.player.pos,r=(o=e.gameMap).cells,a=o.items.filter(e=>e.type>=ex.DoorNS&&e.type<=ex.PortcullisEW),!function e(t,o,s,i){let l=[];for(let e of[[1,0],[0,1],[-1,0],[0,-1]]){let s=o.add(E.fromValues(e[0],e[1]));if(t.has(s[1]*r.sizeX+s[0]))continue;t.add(s[1]*r.sizeX+s[0]);let u=r.atVec(s);if(u.type===ep.DoorEW||u.type===ep.DoorNS||u.type===ep.PortcullisEW||u.type===ep.PortcullisNS){let e=a.find(e=>e.pos.equals(s)),o=f.find(e=>e[0].equals(s));if(void 0!==e&&o){let a=o[1],i=a[1]*r.sizeX+a[0];if(!t.has(i))switch(e.type){case ex.DoorEW:case ex.DoorNS:n=["doorOpen",s];break;case ex.LockedDoorEW:case ex.LockedDoorNS:n=["doorOpenLocked",s];break;case ex.PortcullisEW:case ex.PortcullisNS:n=["gate",s]}}if(void 0!==n||e&&!i)return}(u.type<ep.Wall0000||u.type>ep.Wall1111)&&l.push(s)}if(s>0&&void 0===n)for(let o of l)e(t,o,s-1,!1)}(new Set,t,20,!0),n);if(p){let[t,o]=p,r=Math.max(Math.min((o[0]-i.pos[0])/12,1),0),a=Math.max(1-o.distance(i.pos)/12,0);e.sounds[t].play(.2+.3*a,r)}}(e),e.gameMap.recomputeVisibility(e.player.pos),er(e),aR(e),t>e.player.health&&(e.sounds.hitPlayer.play(.5),e.player.health<=0)){setTimeout(()=>e.sounds.gameOverJingle.play(.5),1e3),function(e){if(e.gameMapRoughPlans[e.level].played)return;e.gameMapRoughPlans[e.level].played=!0;let t=10*e.lootStolen+5*e.levelStats.extraFoodCollected;e.gameStats.totalScore+=t,e.gameStats.turns=e.totalTurns,e.gameStats.numLevels=e.gameMapRoughPlans.length,e.gameStats.numCompletedLevels=e.level,e.gameStats.numInjuries+=e.levelStats.damageTaken,e.gameStats.numKnockouts+=e.levelStats.numKnockouts,e.gameStats.numSpottings+=e.levelStats.numSpottings,e.gameStats.daily=e.dailyRun,e.gameStats.timeEnded=Date.now()}(e),e.persistedStats.bestScore=Math.max(e.persistedStats.bestScore,e.gameStats.totalScore);let t={score:e.gameStats.totalScore,date:a9(),turns:e.totalTurns,level:e.level+1};e.persistedStats.scores.push(t),e.dailyRun&&(e.persistedStats.currentDailyBestScore=Math.max(e.persistedStats.currentDailyBestScore,e.gameStats.totalScore),e.persistedStats.lastPlayedDailyGame=structuredClone(e.gameStats)),aQ(e.persistedStats)}an(e,"turnEnd")}function aR(e){let t=e.gameMap.allSeen(),o=e.lootStolen>=e.lootAvailable;t&&o&&(e.finishedLevel||(e.sounds.levelRequirementJingle.play(.5),e.popups.setNotification("Escape!",e.player,3,5)),e.finishedLevel=!0);let r=ai(e);if(e.level>0&&(e.turns===Math.floor(.75*r)||e.turns===r-10&&r>100)&&(e.popups.setNotification("Tick tock!",e.player,3,5),e.sounds.clockTick.play(1)),e.turns===r+1){let t=[],o=!1;for(let r of(e.gameMap.items=e.gameMap.items.filter(e=>e.type!==ex.VaultTreasureBox||(t.push(e),o=!0,!1)),t)){e.gameMap.items.push({type:ex.EmptyVaultTreasureBox,pos:r.pos,topLayer:!1});let t=new H(or.vaultGoldAnimationTiles,.2,0,1);t.removeOnFinish=!0,e.particles.push({pos:E.clone(r.pos),animation:t})}o?(e.popups.setNotification("Late!\nVaults were cleared.",e.player,3,5),e.sounds.coinRattle.play(1),e.sounds.clockChime.play(.5)):e.level>0&&(e.popups.setNotification("Late!",e.player,3,5),e.sounds.clockChime.play(1))}}function aD(e,t,o){e.popups.setNotification("Leap: Shift+"+aW(t,o),e.player.pos)}function aW(e,t){return e>0?"\x1a":e<0?"\x1b":t>0?"\x18":t<0?"\x19":"\x07"}function aG(e){e.healthBarState.enlargeTimeRemaining=1}function aV(e,t){t<0||t>=e.healthBarState.heartFlashRemaining.length||(e.healthBarState.heartFlashRemaining[t]=1,e.healthBarState.damageDisplayTimer=.5,e.healthBarState.healing=t<e.player.health)}function aE(e){e.healthBarState.damageDisplayTimer=0,e.healthBarState.healing=!1,e.healthBarState.enlargeTimeRemaining=0,e.healthBarState.size=1,e.healthBarState.heartFlashRemaining.length=e.player.healthMax,e.healthBarState.heartFlashRemaining.fill(0)}function aB(e,t){return new Promise((o,r)=>{t.onload=()=>o(t),t.onerror=r,t.src=e})}function aN(e,t,o,r){if(0==o.size)return e;if(!r)return 0;let a=0;for(let e of[...o])a+=t[e];return e**(1+a/o.size)}function aF(e,t,o){let r=(o.at(e,t).lit?1:.1)/4,a=o.at(e-1,t-1).litAnim,n=o.at(e,t-1).litAnim,s=o.at(e+1,t-1).litAnim,i=o.at(e-1,t).litAnim,l=o.at(e,t).litAnim,f=o.at(e+1,t).litAnim,u=o.at(e-1,t+1).litAnim,c=o.at(e,t+1).litAnim;return[r*(a+n+i+l),r*(s+n+f+l),r*(u+c+i+l),r*(o.at(e+1,t+1).litAnim+c+f+l)]}function aO(e,t){switch(e){case ed.Manor:return t.itemTiles;case ed.ManorRed:return t.redWallItemTiles;case ed.Mansion:return t.manseItemTiles;case ed.Fortress:return t.fortressItemTiles;case ed.Warrens:return t.redWallItemTiles}}function az(e,t,o){let r=aO(e.gameMapRoughPlans[e.level].levelType,t.entityTileSet);for(let a of e.gameMap.items.filter(e=>e.topLayer===o)){let o=a.pos[0],n=a.pos[1],s=e.gameMap.cells.at(o,n);if(!s.seen&&!e.seeAll)continue;let i=s.type,l=aF(o,n,e.gameMap.cells);if(i===ep.PortcullisEW||i===ep.PortcullisNS)if(e.gameMap.guards.find(e=>e.pos[0]===o&&e.pos[1]===n)){let e=r[a.type];void 0!==e.textureIndex&&(e={textureIndex:e.textureIndex+1,color:e.color,unlitColor:e.unlitColor}),t.addGlyphLit4(o,n,o+1,n+1,e,l)}else t.addGlyphLit4(o,n,o+1,n+1,r[a.type],l);else if(i===ep.DoorEW||i===ep.DoorNS)e.gameMap.guards.find(e=>e.pos[0]===o&&e.pos[1]===n)||e.player.pos[0]===o&&e.player.pos[1]===n||t.addGlyphLit4(o,n,o+1,n+1,r[a.type],l);else if(a.type>=ex.TreasureA)t.addGlyph(o,n+.5,o+1,n+1.5,r[a.type]),a.animation&&t.addGlyph(o,n+.5,o+1,n+1.5,a.animation.currentTile());else if(a.type===ex.VaultTreasureBox)t.addGlyph(o,n,o+1,n+1,r[a.type]),a.animation&&t.addGlyph(o,n,o+1,n+1,a.animation.currentTile());else if(a.type===ex.Coin)t.addGlyph(o,n,o+1,n+1,r[a.type]),a.animation&&t.addGlyph(o,n,o+1,n+1,a.animation.currentTile());else{let e=a.animation?a.animation.currentTile():r[a.type];if(a.animation instanceof X){let e=a.animation.offset;o+=e[0],n+=e[1]}t.addGlyphLit4(o,n,o+1,n+1,e,l)}}}function aH(e,t){let o={position:E.create(),velocity:E.create(),joltOffset:E.create(),joltVelocity:E.create(),zoom:t,zoomVelocity:0,scale:Math.pow(1.1892,t),anchor:E.create(),snapped:!1,zoomed:!1,panning:!1};return E.copy(o.position,e),E.zero(o.velocity),o}function aX(e,t){e.soundVolume=t,L.volume(t),window.localStorage.setItem("LLL/soundVolume",t.toString())}function aq(e){return e.volumeMute||!document.hasFocus()}function aY(e,t){e.volumeMute=t,L.mute(aq(e)),window.localStorage.setItem("LLL/volumeMute",t?"true":"false")}function aU(e,t){for(let o in e.guardMute=t,window.localStorage.setItem("LLL/guardMute",t?"true":"false"),e.subtitledSounds)e.subtitledSounds[o].mute=t}function aj(e){let t=window.localStorage.getItem("LLL/stat/"+e);if(null!=t&&"undefined"!==t)return JSON.parse(String(t))}function aK(e,t){let o=JSON.stringify(t);window.localStorage.setItem("LLL/stat/"+e,o)}function a$(){return{scores:aj("highScores")??[],lastPlayedDailyGame:aj("lastPlayedDailyGame")??null,currentDailyGameId:aj("currentDailyGameId")??"",currentDailyPlays:aj("currentDailyPlays")??0,currentDailyWins:aj("currentDailyWins")??0,currentDailyBestScore:aj("currentDailyBestScore")??0,currentDailyWinFirstTry:aj("currentDailyWinFirstTry")??0,bestScore:aj("bestScore")??0,totalPlays:aj("totalPlays")??0,totalWins:aj("totalWins")??0,totalGhosts:aj("totalGhosts")??0,allDailyPlays:aj("allDailyPlays")??0,allDailyWins:aj("allDailyWins")??0,allDailyWinsFirstTry:aj("allDailyWinsFirstTry")??0,achievementGhosty:aj("achievementGhosty")??0,achievementZippy:aj("achievementZippy")??0,achievementHungry:aj("achievementHungry")??0,achievementThumpy:aj("achievementThumpy")??0,achievementSofty:aj("achievementSofty")??0,achievementNoisy:aj("achievementNoisy")??0,achievementLeapy:aj("achievementLeapy")??0,achievementSteppy:aj("achievementSteppy")??0,achievementHurty:aj("achievementHurty")??0,achievementVictory:aj("achievementVictory")??0,achievementHealthy:aj("achievementHealthy")??0,achievementTreasure:aj("achievementTreasure")??0,achievementMapping:aj("achievementMapping")??0,achievementFaceless:aj("achievementFaceless")??0}}function aQ(e){aK("currentDailyGameId",e.currentDailyGameId),aK("currentDailyPlays",e.currentDailyPlays),aK("currentDailyWins",e.currentDailyWins),aK("currentDailyBestScore",e.currentDailyBestScore),aK("currentDailyWinFirstTry",e.currentDailyWinFirstTry),aK("lastPlayedDailyGame",e.lastPlayedDailyGame),aK("allDailyPlays",e.allDailyPlays),aK("allDailyWins",e.allDailyWins),aK("allDailyWinsFirstTry",e.allDailyWinsFirstTry),aK("scores",e.scores),aK("bestScore",e.bestScore),aK("totalPlays",e.totalPlays),aK("totalWins",e.totalWins),aK("totalGhosts",e.totalGhosts),aK("achievementGhosty",e.achievementGhosty),aK("achievementZippy",e.achievementZippy),aK("achievementHungry",e.achievementHungry),aK("achievementThumpy",e.achievementThumpy),aK("achievementSofty",e.achievementSofty),aK("achievementNoisy",e.achievementNoisy),aK("achievementLeapy",e.achievementLeapy),aK("achievementSteppy",e.achievementSteppy),aK("achievementHurty",e.achievementHurty),aK("achievementHealthy",e.achievementHealthy),aK("achievementTreasure",e.achievementTreasure),aK("achievementMapping",e.achievementMapping),aK("achievementFaceless",e.achievementFaceless)}function aJ(e,t){let o=t.gameMapRoughPlans[t.level].levelType,r=1;for(let t of e.cells.values)t.type===ep.GroundWater&&(t.animation=new H(function(e,t){switch(e){case ed.Manor:case ed.ManorRed:return t.waterAnimation;case ed.Mansion:return t.manseWaterAnimation;case ed.Fortress:return t.fortressWaterAnimation;case ed.Warrens:return t.waterAnimation}}(o,oo),1,1369*r%4),r++)}function aZ(e,t){for(let t of e.items){let e=or.itemGlows[t.type];if(void 0!==e){let o=t.type===ex.Coin?.75:1.25;t.animation=new q(e,0,o)}}}function a0(e,t){let o=0;if(or.candleAnimation.length>=3){let r=or.stoveAnimation.slice(0,2).map(e=>[e,.5]),a=r[0][0],n=r[0][0],s=or.candleAnimation.slice(0,3).map(e=>[e,.5]),i=or.candleAnimation.at(-2),l=or.candleAnimation.at(-1);for(let f of e.items)f.type===ex.Stove?(f.animation=new j(U.idle,o,t.lightStates,f,r,a,n),o++):f.type===ex.TorchLit?(f.animation=new j(U.idle,o,t.lightStates,f,s,i,l),o++):f.type===ex.TorchUnlit&&(f.animation=new j(U.off,o,t.lightStates,f,s,i,l),o++)}if(or.torchAnimation.length>=3){let r=or.torchAnimation.slice(0,3).map(e=>[e,.5]),a=or.torchAnimation.at(-2),n=or.torchAnimation.at(-1);for(let s of e.guards)s.hasTorch&&(s.torchAnimation=new j(U.idle,o,t.lightStates,null,r,a,n),o++)}if(or.playerTorchAnimation.length>=2){let e=or.playerTorchAnimation.slice(0,2).map(e=>[e,.5]),r=or.playerTorchAnimation.at(-2),a=or.playerTorchAnimation.at(-1);t.player.torchAnimation=new j(U.idle,o,t.lightStates,null,e,r,a),o++}}function a1(e){e.gameMode=rS.Mansion,e.hasStartedGame||(e.persistedStats.totalPlays++,aK("totalPlays",e.persistedStats.totalPlays),e.hasStartedGame=!0),am(e)}function a2(e){let t=null!==e.dailyRun;if(t){var o;let t,r,a,n;t=r4(10,100,o=e.rng,void 0),r=3+o.randomInRange(2),a=5+o.randomInRange(2),n=7+o.randomInRange(3),e.gameMapRoughPlans=[t[r],t[a],t[n]]}else e.gameMapRoughPlans=r4(10,100,e.rng,r7);e.level=Math.min(e.gameMapRoughPlans.length-1,0),e.persistedStats.totalPlays++,aK("totalPlays",e.persistedStats.totalPlays),t&&(e.persistedStats.currentDailyPlays++,aK("currentDailyPlays",e.persistedStats.currentDailyPlays),e.persistedStats.allDailyPlays++,aK("allDailyPlays",e.persistedStats.allDailyPlays)),e.gameStats={totalScore:0,turns:0,numLevels:0,numCompletedLevels:0,numGhostedLevels:0,numSpottings:0,numInjuries:0,numKnockouts:0,daily:e.dailyRun,timeStarted:Date.now(),timeEnded:0};let r=tY(e.gameMapRoughPlans[e.level]);e.player=new ey(r.playerStartPos,t),e.lightStates=Array(r.lightCount).fill(0),a0(r,e),aJ(r,e),aZ(r,e),e.gameMode=rS.Mansion,e.hintMessage="",aE(e),e.numStepMoves=0,e.numLeapMoves=0,e.numWaitMoves=0,e.numZoomMoves=0,e.hasEnteredMansion=!1,e.experiencedPlayer=t||!1,e.finishedLevel=!1,e.turns=0,e.totalTurns=0,e.lootStolen=0,e.lootAvailable=e.gameMapRoughPlans[e.level].totalLoot,e.treasureStolen=0,aa(e.levelStats),an(e,"gameStart"),e.ambience=r_.Outdoor,e.camera=aH(r.playerStartPos,e.zoomLevel),e.gameMap=r,e.activeSoundPool.empty(),e.ambientSoundPool.empty(),e.popups.reset(),er(e),aR(e),aw(e,e.player.pos),L.stop(),am(e)}function a5(e){let t=a9();e.rng=new t4("Daily "+t),e.dailyRun=t,a2(e)}function a4(e,t,o,r,a,n){var s,i,l,f,u,c;let d,p,h,m,x,g,y,v,M,T,S=E.create(),_=E.create();s=e,i=t,l=o,f=r,u=S,c=_,x=16*a6(i),v=Math.min(80,Math.floor(Math.min(g=i[0],y=i[1]-x)/5))/(16*l),M=g/(16*l),T=y/(16*l),d=M/2,p=s[0]-M/2,f&&g>y&&(d-=2*v,p+=2*v),d>p&&(d=p=s[0]/2),h=T/2,m=s[1]-T/2,f&&g<=y&&(h-=2*v,m+=2*v),h>m&&(h=m=s[1]/2),u[0]=d,u[1]=h,c[0]=p,c[1]=m,a[0]=Math.max(S[0],Math.min(_[0],n[0]+.5)),a[1]=Math.max(S[1],Math.min(_[1],n[1]+.5))}function a3(e,t){return[e[0]/(16*t),e[1]/(16*t)]}function a6(e){return Math.floor(2*Math.min(Math.max(1,e[0]/448),Math.max(1,e[1]/400)))/2}function a8(e,t,o){let r=255&e,a=e>>8&255,n=e>>16&255,s=e>>24&255;return Math.max(0,Math.min(255,Math.trunc(r+((255&t)-r)*o)))+(Math.max(0,Math.min(255,Math.trunc(a+((t>>8&255)-a)*o)))<<8)+(Math.max(0,Math.min(255,Math.trunc(n+((t>>16&255)-n)*o)))<<16)+(Math.max(0,Math.min(255,Math.trunc(s+((t>>24&255)-s)*o)))<<24)}function a7(e,t,o,r){for(let a=0;a<o.length;++a){let n=o.charCodeAt(a);10===n&&(n=32),e.addGlyph(t,0,t+1,1,{textureIndex:n,color:r}),++t}}function a9(e=null,t=!0){let o=e??new Date,r=t?o.getUTCFullYear():o.getFullYear(),a=1+(t?o.getUTCMonth():o.getMonth()),n=t?o.getUTCDate():o.getDate(),s=String(r),i=String(a).padStart(2,"0"),l=String(n).padStart(2,"0");return`${s}/${i}/${l}`}
//# sourceMappingURL=thief-game.d853906c.js.map
